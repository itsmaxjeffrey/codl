(()=>{var t={619:(t,e,i)=>{"use strict";i.r(e);var r=i(940);!function(t){("undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:this).muxjs=function(){function t(e,i,r){function s(a,o){if(!i[a]){if(!e[a]){if(n)return n(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var h=i[a]={exports:{}};e[a][0].call(h.exports,(function(t){return s(e[a][1][t]||t)}),h,h.exports,t,e,i,r)}return i[a].exports}for(var n=void 0,a=0;a<r.length;a++)s(r[a]);return s}return t}()({1:[function(t,e,i){var r,s=t(31),n=t(2);(r=function(){var t=new Uint8Array,e=0;r.prototype.init.call(this),this.setTimestamp=function(t){e=t},this.push=function(i){var r,s,a,o,l=0,h=0;for(t.length?(o=t.length,(t=new Uint8Array(i.byteLength+o)).set(t.subarray(0,o)),t.set(i,o)):t=i;t.length-h>=3;)if(t[h]!=="I".charCodeAt(0)||t[h+1]!=="D".charCodeAt(0)||t[h+2]!=="3".charCodeAt(0))if(255!=(255&t[h])||240!=(240&t[h+1]))h++;else{if(t.length-h<7)break;if(h+(l=n.parseAdtsSize(t,h))>t.length)break;a={type:"audio",data:t.subarray(h,h+l),pts:e,dts:e},this.trigger("data",a),h+=l}else{if(t.length-h<10)break;if(h+(l=n.parseId3TagSize(t,h))>t.length)break;s={type:"timed-metadata",data:t.subarray(h,h+l)},this.trigger("data",s),h+=l}r=t.length-h,t=r>0?t.subarray(h):new Uint8Array},this.reset=function(){t=new Uint8Array,this.trigger("reset")},this.endTimeline=function(){t=new Uint8Array,this.trigger("endedtimeline")}}).prototype=new s,e.exports=r},{2:2,31:31}],2:[function(t,e,i){var r=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],s=function(t,e){var i=t[e+6]<<21|t[e+7]<<14|t[e+8]<<7|t[e+9];return i=i>=0?i:0,(16&t[e+5])>>4?i+20:i+10},n=function t(e,i){return e.length-i<10||e[i]!=="I".charCodeAt(0)||e[i+1]!=="D".charCodeAt(0)||e[i+2]!=="3".charCodeAt(0)?i:t(e,i+=s(e,i))},a=function(t){var e=n(t,0);return t.length>=e+2&&255==(255&t[e])&&240==(240&t[e+1])&&16==(22&t[e+1])},o=function(t){return t[0]<<21|t[1]<<14|t[2]<<7|t[3]},l=function(t,e,i){var r,s="";for(r=e;r<i;r++)s+="%"+("00"+t[r].toString(16)).slice(-2);return s},h=function(t,e,i){return unescape(l(t,e,i))},d=function(t,e){var i=(224&t[e+5])>>5,r=t[e+4]<<3;return 6144&t[e+3]|r|i},c=function(t,e){return t[e]==="I".charCodeAt(0)&&t[e+1]==="D".charCodeAt(0)&&t[e+2]==="3".charCodeAt(0)?"timed-metadata":!0&t[e]&&240==(240&t[e+1])?"audio":null},u=function(t){for(var e=0;e+5<t.length;){if(255===t[e]&&240==(246&t[e+1]))return r[(60&t[e+2])>>>2];e++}return null},f=function(t){var e,i,r;e=10,64&t[5]&&(e+=4,e+=o(t.subarray(10,14)));do{if((i=o(t.subarray(e+4,e+8)))<1)return null;if("PRIV"===String.fromCharCode(t[e],t[e+1],t[e+2],t[e+3])){r=t.subarray(e+10,e+i+10);for(var s=0;s<r.byteLength;s++)if(0===r[s]){if("com.apple.streaming.transportStreamTimestamp"===h(r,0,s)){var n=r.subarray(s+1),a=(1&n[3])<<30|n[4]<<22|n[5]<<14|n[6]<<6|n[7]>>>2;return a*=4,a+=3&n[7]}break}}e+=10,e+=i}while(e<t.byteLength);return null};e.exports={isLikelyAacData:a,parseId3TagSize:s,parseAdtsSize:d,parseType:c,parseSampleRate:u,parseAacTimestamp:f}},{}],3:[function(t,e,i){var r,s=t(31),n=t(29).ONE_SECOND_IN_TS,a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];(r=function(t){var e,i=0;r.prototype.init.call(this),this.push=function(r){var s,o,l,h,d,c,u=0;if(t||(i=0),"audio"===r.type)for(e?(h=e,(e=new Uint8Array(h.byteLength+r.data.byteLength)).set(h),e.set(r.data,h.byteLength)):e=r.data;u+5<e.length;)if(255===e[u]&&240==(246&e[u+1])){if(o=2*(1&~e[u+1]),s=(3&e[u+3])<<11|e[u+4]<<3|(224&e[u+5])>>5,c=(d=1024*(1+(3&e[u+6])))*n/a[(60&e[u+2])>>>2],l=u+s,e.byteLength<l)return;if(this.trigger("data",{pts:r.pts+i*c,dts:r.dts+i*c,sampleCount:d,audioobjecttype:1+(e[u+2]>>>6&3),channelcount:(1&e[u+2])<<2|(192&e[u+3])>>>6,samplerate:a[(60&e[u+2])>>>2],samplingfrequencyindex:(60&e[u+2])>>>2,samplesize:16,data:e.subarray(u+7+o,l)}),i++,e.byteLength===l)return void(e=void 0);e=e.subarray(l)}else u++},this.flush=function(){i=0,this.trigger("done")},this.reset=function(){e=void 0,this.trigger("reset")},this.endTimeline=function(){e=void 0,this.trigger("endedtimeline")}}).prototype=new s,e.exports=r},{29:29,31:31}],4:[function(t,e,i){var r,s,n,a=t(31),o=t(30);(s=function(){var t,e,i=0;s.prototype.init.call(this),this.push=function(r){var s;e?((s=new Uint8Array(e.byteLength+r.data.byteLength)).set(e),s.set(r.data,e.byteLength),e=s):e=r.data;for(var n=e.byteLength;i<n-3;i++)if(1===e[i+2]){t=i+5;break}for(;t<n;)switch(e[t]){case 0:if(0!==e[t-1]){t+=2;break}if(0!==e[t-2]){t++;break}i+3!==t-2&&this.trigger("data",e.subarray(i+3,t-2));do{t++}while(1!==e[t]&&t<n);i=t-2,t+=3;break;case 1:if(0!==e[t-1]||0!==e[t-2]){t+=3;break}this.trigger("data",e.subarray(i+3,t-2)),i=t-2,t+=3;break;default:t+=3}e=e.subarray(i),t-=i,i=0},this.reset=function(){e=null,i=0,this.trigger("reset")},this.flush=function(){e&&e.byteLength>3&&this.trigger("data",e.subarray(i+3)),e=null,i=0,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")}}).prototype=new a,n={100:!0,110:!0,122:!0,244:!0,44:!0,83:!0,86:!0,118:!0,128:!0,138:!0,139:!0,134:!0},(r=function(){var t,e,i,a,l,h,d,c=new s;r.prototype.init.call(this),t=this,this.push=function(t){"video"===t.type&&(e=t.trackId,i=t.pts,a=t.dts,c.push(t))},c.on("data",(function(r){var s={trackId:e,pts:i,dts:a,data:r};switch(31&r[0]){case 5:s.nalUnitType="slice_layer_without_partitioning_rbsp_idr";break;case 6:s.nalUnitType="sei_rbsp",s.escapedRBSP=l(r.subarray(1));break;case 7:s.nalUnitType="seq_parameter_set_rbsp",s.escapedRBSP=l(r.subarray(1)),s.config=h(s.escapedRBSP);break;case 8:s.nalUnitType="pic_parameter_set_rbsp";break;case 9:s.nalUnitType="access_unit_delimiter_rbsp"}t.trigger("data",s)})),c.on("done",(function(){t.trigger("done")})),c.on("partialdone",(function(){t.trigger("partialdone")})),c.on("reset",(function(){t.trigger("reset")})),c.on("endedtimeline",(function(){t.trigger("endedtimeline")})),this.flush=function(){c.flush()},this.partialFlush=function(){c.partialFlush()},this.reset=function(){c.reset()},this.endTimeline=function(){c.endTimeline()},d=function(t,e){var i,r=8,s=8;for(i=0;i<t;i++)0!==s&&(s=(r+e.readExpGolomb()+256)%256),r=0===s?r:s},l=function(t){for(var e,i,r=t.byteLength,s=[],n=1;n<r-2;)0===t[n]&&0===t[n+1]&&3===t[n+2]?(s.push(n+2),n+=2):n++;if(0===s.length)return t;e=r-s.length,i=new Uint8Array(e);var a=0;for(n=0;n<e;a++,n++)a===s[0]&&(a++,s.shift()),i[n]=t[a];return i},h=function(t){var e,i,r,s,a,l,h,c,u,f,p,m,g,y=0,v=0,_=0,S=0,T=1;if(i=(e=new o(t)).readUnsignedByte(),s=e.readUnsignedByte(),r=e.readUnsignedByte(),e.skipUnsignedExpGolomb(),n[i]&&(3===(a=e.readUnsignedExpGolomb())&&e.skipBits(1),e.skipUnsignedExpGolomb(),e.skipUnsignedExpGolomb(),e.skipBits(1),e.readBoolean()))for(p=3!==a?8:12,g=0;g<p;g++)e.readBoolean()&&d(g<6?16:64,e);if(e.skipUnsignedExpGolomb(),0===(l=e.readUnsignedExpGolomb()))e.readUnsignedExpGolomb();else if(1===l)for(e.skipBits(1),e.skipExpGolomb(),e.skipExpGolomb(),h=e.readUnsignedExpGolomb(),g=0;g<h;g++)e.skipExpGolomb();if(e.skipUnsignedExpGolomb(),e.skipBits(1),c=e.readUnsignedExpGolomb(),u=e.readUnsignedExpGolomb(),0===(f=e.readBits(1))&&e.skipBits(1),e.skipBits(1),e.readBoolean()&&(y=e.readUnsignedExpGolomb(),v=e.readUnsignedExpGolomb(),_=e.readUnsignedExpGolomb(),S=e.readUnsignedExpGolomb()),e.readBoolean()&&e.readBoolean()){switch(e.readUnsignedByte()){case 1:m=[1,1];break;case 2:m=[12,11];break;case 3:m=[10,11];break;case 4:m=[16,11];break;case 5:m=[40,33];break;case 6:m=[24,11];break;case 7:m=[20,11];break;case 8:m=[32,11];break;case 9:m=[80,33];break;case 10:m=[18,11];break;case 11:m=[15,11];break;case 12:m=[64,33];break;case 13:m=[160,99];break;case 14:m=[4,3];break;case 15:m=[3,2];break;case 16:m=[2,1];break;case 255:m=[e.readUnsignedByte()<<8|e.readUnsignedByte(),e.readUnsignedByte()<<8|e.readUnsignedByte()]}m&&(T=m[0]/m[1])}return{profileIdc:i,levelIdc:r,profileCompatibility:s,width:Math.ceil((16*(c+1)-2*y-2*v)*T),height:(2-f)*(u+1)*16-2*_-2*S,sarRatio:m}}}).prototype=new a,e.exports={H264Stream:r,NalByteStream:s}},{30:30,31:31}],5:[function(t,e,i){var r=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"];e.exports=r},{}],6:[function(t,e,i){var r=["width","height","profileIdc","levelIdc","profileCompatibility","sarRatio"];e.exports=r},{}],7:[function(t,e,i){var r,s=[33,16,5,32,164,27],n=[33,65,108,84,1,2,4,8,168,2,4,8,17,191,252],a=function(t){for(var e=[];t--;)e.push(0);return e},o=function(t){return Object.keys(t).reduce((function(e,i){return e[i]=new Uint8Array(t[i].reduce((function(t,e){return t.concat(e)}),[])),e}),{})};e.exports=function(){if(!r){var t={96e3:[s,[227,64],a(154),[56]],88200:[s,[231],a(170),[56]],64e3:[s,[248,192],a(240),[56]],48e3:[s,[255,192],a(268),[55,148,128],a(54),[112]],44100:[s,[255,192],a(268),[55,163,128],a(84),[112]],32e3:[s,[255,192],a(268),[55,234],a(226),[112]],24e3:[s,[255,192],a(268),[55,255,128],a(268),[111,112],a(126),[224]],16e3:[s,[255,192],a(268),[55,255,128],a(268),[111,255],a(269),[223,108],a(195),[1,192]],12e3:[n,a(268),[3,127,248],a(268),[6,255,240],a(268),[13,255,224],a(268),[27,253,128],a(259),[56]],11025:[n,a(268),[3,127,248],a(268),[6,255,240],a(268),[13,255,224],a(268),[27,255,192],a(268),[55,175,128],a(108),[112]],8e3:[n,a(268),[3,121,16],a(47),[7]]};r=o(t)}return r}},{}],8:[function(t,e,i){var r=t(31),s=t(23),n=function t(){t.prototype.init.call(this),this.captionPackets_=[],this.ccStreams_=[new c(0,0),new c(0,1),new c(1,0),new c(1,1)],this.reset(),this.ccStreams_.forEach((function(t){t.on("data",this.trigger.bind(this,"data")),t.on("partialdone",this.trigger.bind(this,"partialdone")),t.on("done",this.trigger.bind(this,"done"))}),this)};n.prototype=new r,n.prototype.push=function(t){var e,i,r;if("sei_rbsp"===t.nalUnitType&&(e=s.parseSei(t.escapedRBSP)).payloadType===s.USER_DATA_REGISTERED_ITU_T_T35&&(i=s.parseUserData(e)))if(t.dts<this.latestDts_)this.ignoreNextEqualDts_=!0;else{if(t.dts===this.latestDts_&&this.ignoreNextEqualDts_)return this.numSameDts_--,void(this.numSameDts_||(this.ignoreNextEqualDts_=!1));r=s.parseCaptionPackets(t.pts,i),this.captionPackets_=this.captionPackets_.concat(r),this.latestDts_!==t.dts&&(this.numSameDts_=0),this.numSameDts_++,this.latestDts_=t.dts}},n.prototype.flushCCStreams=function(t){this.ccStreams_.forEach((function(e){return"flush"===t?e.flush():e.partialFlush()}),this)},n.prototype.flushStream=function(t){this.captionPackets_.length?(this.captionPackets_.forEach((function(t,e){t.presortIndex=e})),this.captionPackets_.sort((function(t,e){return t.pts===e.pts?t.presortIndex-e.presortIndex:t.pts-e.pts})),this.captionPackets_.forEach((function(t){t.type<2&&this.dispatchCea608Packet(t)}),this),this.captionPackets_.length=0,this.flushCCStreams(t)):this.flushCCStreams(t)},n.prototype.flush=function(){return this.flushStream("flush")},n.prototype.partialFlush=function(){return this.flushStream("partialFlush")},n.prototype.reset=function(){this.latestDts_=null,this.ignoreNextEqualDts_=!1,this.numSameDts_=0,this.activeCea608Channel_=[null,null],this.ccStreams_.forEach((function(t){t.reset()}))},n.prototype.dispatchCea608Packet=function(t){this.setsTextOrXDSActive(t)?this.activeCea608Channel_[t.type]=null:this.setsChannel1Active(t)?this.activeCea608Channel_[t.type]=0:this.setsChannel2Active(t)&&(this.activeCea608Channel_[t.type]=1),null!==this.activeCea608Channel_[t.type]&&this.ccStreams_[(t.type<<1)+this.activeCea608Channel_[t.type]].push(t)},n.prototype.setsChannel1Active=function(t){return 4096==(30720&t.ccData)},n.prototype.setsChannel2Active=function(t){return 6144==(30720&t.ccData)},n.prototype.setsTextOrXDSActive=function(t){return 256==(28928&t.ccData)||4138==(30974&t.ccData)||6186==(30974&t.ccData)};var a={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,304:174,305:176,306:189,307:191,308:8482,309:162,310:163,311:9834,312:224,313:160,314:232,315:226,316:234,317:238,318:244,319:251,544:193,545:201,546:211,547:218,548:220,549:252,550:8216,551:161,552:42,553:39,554:8212,555:169,556:8480,557:8226,558:8220,559:8221,560:192,561:194,562:199,563:200,564:202,565:203,566:235,567:206,568:207,569:239,570:212,571:217,572:249,573:219,574:171,575:187,800:195,801:227,802:205,803:204,804:236,805:210,806:242,807:213,808:245,809:123,810:125,811:92,812:94,813:95,814:124,815:126,816:196,817:228,818:214,819:246,820:223,821:165,822:164,823:9474,824:197,825:229,826:216,827:248,828:9484,829:9488,830:9492,831:9496},o=function(t){return null===t?"":(t=a[t]||t,String.fromCharCode(t))},l=14,h=[4352,4384,4608,4640,5376,5408,5632,5664,5888,5920,4096,4864,4896,5120,5152],d=function(){for(var t=[],e=l+1;e--;)t.push("");return t},c=function t(e,i){t.prototype.init.call(this),this.field_=e||0,this.dataChannel_=i||0,this.name_="CC"+(1+(this.field_<<1|this.dataChannel_)),this.setConstants(),this.reset(),this.push=function(t){var e,i,r,s,n;if((e=32639&t.ccData)!==this.lastControlCode_){if(4096==(61440&e)?this.lastControlCode_=e:e!==this.PADDING_&&(this.lastControlCode_=null),r=e>>>8,s=255&e,e!==this.PADDING_)if(e===this.RESUME_CAPTION_LOADING_)this.mode_="popOn";else if(e===this.END_OF_CAPTION_)this.mode_="popOn",this.clearFormatting(t.pts),this.flushDisplayed(t.pts),i=this.displayed_,this.displayed_=this.nonDisplayed_,this.nonDisplayed_=i,this.startPts_=t.pts;else if(e===this.ROLL_UP_2_ROWS_)this.rollUpRows_=2,this.setRollUp(t.pts);else if(e===this.ROLL_UP_3_ROWS_)this.rollUpRows_=3,this.setRollUp(t.pts);else if(e===this.ROLL_UP_4_ROWS_)this.rollUpRows_=4,this.setRollUp(t.pts);else if(e===this.CARRIAGE_RETURN_)this.clearFormatting(t.pts),this.flushDisplayed(t.pts),this.shiftRowsUp_(),this.startPts_=t.pts;else if(e===this.BACKSPACE_)"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1);else if(e===this.ERASE_DISPLAYED_MEMORY_)this.flushDisplayed(t.pts),this.displayed_=d();else if(e===this.ERASE_NON_DISPLAYED_MEMORY_)this.nonDisplayed_=d();else if(e===this.RESUME_DIRECT_CAPTIONING_)"paintOn"!==this.mode_&&(this.flushDisplayed(t.pts),this.displayed_=d()),this.mode_="paintOn",this.startPts_=t.pts;else if(this.isSpecialCharacter(r,s))n=o((r=(3&r)<<8)|s),this[this.mode_](t.pts,n),this.column_++;else if(this.isExtCharacter(r,s))"popOn"===this.mode_?this.nonDisplayed_[this.row_]=this.nonDisplayed_[this.row_].slice(0,-1):this.displayed_[this.row_]=this.displayed_[this.row_].slice(0,-1),n=o((r=(3&r)<<8)|s),this[this.mode_](t.pts,n),this.column_++;else if(this.isMidRowCode(r,s))this.clearFormatting(t.pts),this[this.mode_](t.pts," "),this.column_++,14==(14&s)&&this.addFormatting(t.pts,["i"]),1==(1&s)&&this.addFormatting(t.pts,["u"]);else if(this.isOffsetControlCode(r,s))this.column_+=3&s;else if(this.isPAC(r,s)){var a=h.indexOf(7968&e);"rollUp"===this.mode_&&(a-this.rollUpRows_+1<0&&(a=this.rollUpRows_-1),this.setRollUp(t.pts,a)),a!==this.row_&&(this.clearFormatting(t.pts),this.row_=a),1&s&&-1===this.formatting_.indexOf("u")&&this.addFormatting(t.pts,["u"]),16==(16&e)&&(this.column_=4*((14&e)>>1)),this.isColorPAC(s)&&14==(14&s)&&this.addFormatting(t.pts,["i"])}else this.isNormalChar(r)&&(0===s&&(s=null),n=o(r),n+=o(s),this[this.mode_](t.pts,n),this.column_+=n.length)}else this.lastControlCode_=null}};c.prototype=new r,c.prototype.flushDisplayed=function(t){var e=this.displayed_.map((function(t){try{return t.trim()}catch(t){return""}})).join("\n").replace(/^\n+|\n+$/g,"");e.length&&this.trigger("data",{startPts:this.startPts_,endPts:t,text:e,stream:this.name_})},c.prototype.reset=function(){this.mode_="popOn",this.topRow_=0,this.startPts_=0,this.displayed_=d(),this.nonDisplayed_=d(),this.lastControlCode_=null,this.column_=0,this.row_=l,this.rollUpRows_=2,this.formatting_=[]},c.prototype.setConstants=function(){0===this.dataChannel_?(this.BASE_=16,this.EXT_=17,this.CONTROL_=(20|this.field_)<<8,this.OFFSET_=23):1===this.dataChannel_&&(this.BASE_=24,this.EXT_=25,this.CONTROL_=(28|this.field_)<<8,this.OFFSET_=31),this.PADDING_=0,this.RESUME_CAPTION_LOADING_=32|this.CONTROL_,this.END_OF_CAPTION_=47|this.CONTROL_,this.ROLL_UP_2_ROWS_=37|this.CONTROL_,this.ROLL_UP_3_ROWS_=38|this.CONTROL_,this.ROLL_UP_4_ROWS_=39|this.CONTROL_,this.CARRIAGE_RETURN_=45|this.CONTROL_,this.RESUME_DIRECT_CAPTIONING_=41|this.CONTROL_,this.BACKSPACE_=33|this.CONTROL_,this.ERASE_DISPLAYED_MEMORY_=44|this.CONTROL_,this.ERASE_NON_DISPLAYED_MEMORY_=46|this.CONTROL_},c.prototype.isSpecialCharacter=function(t,e){return t===this.EXT_&&e>=48&&e<=63},c.prototype.isExtCharacter=function(t,e){return(t===this.EXT_+1||t===this.EXT_+2)&&e>=32&&e<=63},c.prototype.isMidRowCode=function(t,e){return t===this.EXT_&&e>=32&&e<=47},c.prototype.isOffsetControlCode=function(t,e){return t===this.OFFSET_&&e>=33&&e<=35},c.prototype.isPAC=function(t,e){return t>=this.BASE_&&t<this.BASE_+8&&e>=64&&e<=127},c.prototype.isColorPAC=function(t){return t>=64&&t<=79||t>=96&&t<=127},c.prototype.isNormalChar=function(t){return t>=32&&t<=127},c.prototype.setRollUp=function(t,e){if("rollUp"!==this.mode_&&(this.row_=l,this.mode_="rollUp",this.flushDisplayed(t),this.nonDisplayed_=d(),this.displayed_=d()),void 0!==e&&e!==this.row_)for(var i=0;i<this.rollUpRows_;i++)this.displayed_[e-i]=this.displayed_[this.row_-i],this.displayed_[this.row_-i]="";void 0===e&&(e=this.row_),this.topRow_=e-this.rollUpRows_+1},c.prototype.addFormatting=function(t,e){this.formatting_=this.formatting_.concat(e);var i=e.reduce((function(t,e){return t+"<"+e+">"}),"");this[this.mode_](t,i)},c.prototype.clearFormatting=function(t){if(this.formatting_.length){var e=this.formatting_.reverse().reduce((function(t,e){return t+"</"+e+">"}),"");this.formatting_=[],this[this.mode_](t,e)}},c.prototype.popOn=function(t,e){var i=this.nonDisplayed_[this.row_];i+=e,this.nonDisplayed_[this.row_]=i},c.prototype.rollUp=function(t,e){var i=this.displayed_[this.row_];i+=e,this.displayed_[this.row_]=i},c.prototype.shiftRowsUp_=function(){var t;for(t=0;t<this.topRow_;t++)this.displayed_[t]="";for(t=this.row_+1;t<l+1;t++)this.displayed_[t]="";for(t=this.topRow_;t<this.row_;t++)this.displayed_[t]=this.displayed_[t+1];this.displayed_[this.row_]=""},c.prototype.paintOn=function(t,e){var i=this.displayed_[this.row_];i+=e,this.displayed_[this.row_]=i},e.exports={CaptionStream:n,Cea608Stream:c}},{23:23,31:31}],9:[function(t,e,i){var r,s,n,a=t(31),o=t(8),l=t(11),h=t(12).TimestampRolloverStream,d=188,c=71;(r=function(){var t=new Uint8Array(d),e=0;r.prototype.init.call(this),this.push=function(i){var r,s=0,n=d;for(e?((r=new Uint8Array(i.byteLength+e)).set(t.subarray(0,e)),r.set(i,e),e=0):r=i;n<r.byteLength;)r[s]!==c||r[n]!==c?(s++,n++):(this.trigger("data",r.subarray(s,n)),s+=d,n+=d);s<r.byteLength&&(t.set(r.subarray(s),0),e=r.byteLength-s)},this.flush=function(){e===d&&t[0]===c&&(this.trigger("data",t),e=0),this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.reset=function(){e=0,this.trigger("reset")}}).prototype=new a,(s=function(){var t,e,i,r;s.prototype.init.call(this),r=this,this.packetsWaitingForPmt=[],this.programMapTable=void 0,t=function(t,r){var s=0;r.payloadUnitStartIndicator&&(s+=t[s]+1),"pat"===r.type?e(t.subarray(s),r):i(t.subarray(s),r)},e=function(t,e){e.section_number=t[7],e.last_section_number=t[8],r.pmtPid=(31&t[10])<<8|t[11],e.pmtPid=r.pmtPid},i=function(t,e){var i,s;if(1&t[5]){for(r.programMapTable={video:null,audio:null,"timed-metadata":{}},i=3+((15&t[1])<<8|t[2])-4,s=12+((15&t[10])<<8|t[11]);s<i;){var n=t[s],a=(31&t[s+1])<<8|t[s+2];n===l.H264_STREAM_TYPE&&null===r.programMapTable.video?r.programMapTable.video=a:n===l.ADTS_STREAM_TYPE&&null===r.programMapTable.audio?r.programMapTable.audio=a:n===l.METADATA_STREAM_TYPE&&(r.programMapTable["timed-metadata"][a]=n),s+=5+((15&t[s+3])<<8|t[s+4])}e.programMapTable=r.programMapTable}},this.push=function(e){var i={},r=4;if(i.payloadUnitStartIndicator=!!(64&e[1]),i.pid=31&e[1],i.pid<<=8,i.pid|=e[2],(48&e[3])>>>4>1&&(r+=e[r]+1),0===i.pid)i.type="pat",t(e.subarray(r),i),this.trigger("data",i);else if(i.pid===this.pmtPid)for(i.type="pmt",t(e.subarray(r),i),this.trigger("data",i);this.packetsWaitingForPmt.length;)this.processPes_.apply(this,this.packetsWaitingForPmt.shift());else void 0===this.programMapTable?this.packetsWaitingForPmt.push([e,r,i]):this.processPes_(e,r,i)},this.processPes_=function(t,e,i){i.pid===this.programMapTable.video?i.streamType=l.H264_STREAM_TYPE:i.pid===this.programMapTable.audio?i.streamType=l.ADTS_STREAM_TYPE:i.streamType=this.programMapTable["timed-metadata"][i.pid],i.type="pes",i.data=t.subarray(e),this.trigger("data",i)}}).prototype=new a,s.STREAM_TYPES={h264:27,adts:15},n=function(){var t,e=this,i={data:[],size:0},r={data:[],size:0},s={data:[],size:0},a=function(t,e){var i;e.packetLength=6+(t[4]<<8|t[5]),e.dataAlignmentIndicator=0!=(4&t[6]),192&(i=t[7])&&(e.pts=(14&t[9])<<27|(255&t[10])<<20|(254&t[11])<<12|(255&t[12])<<5|(254&t[13])>>>3,e.pts*=4,e.pts+=(6&t[13])>>>1,e.dts=e.pts,64&i&&(e.dts=(14&t[14])<<27|(255&t[15])<<20|(254&t[16])<<12|(255&t[17])<<5|(254&t[18])>>>3,e.dts*=4,e.dts+=(6&t[18])>>>1)),e.data=t.subarray(9+t[8])},o=function(t,i,r){var s,n=new Uint8Array(t.size),o={type:i},l=0,h=0,d=!1;if(t.data.length&&!(t.size<9)){for(o.trackId=t.data[0].pid,l=0;l<t.data.length;l++)s=t.data[l],n.set(s.data,h),h+=s.data.byteLength;a(n,o),d="video"===i||o.packetLength<=t.size,(r||d)&&(t.size=0,t.data.length=0),d&&e.trigger("data",o)}};n.prototype.init.call(this),this.push=function(n){({pat:function(){},pes:function(){var t,e;switch(n.streamType){case l.H264_STREAM_TYPE:t=i,e="video";break;case l.ADTS_STREAM_TYPE:t=r,e="audio";break;case l.METADATA_STREAM_TYPE:t=s,e="timed-metadata";break;default:return}n.payloadUnitStartIndicator&&o(t,e,!0),t.data.push(n),t.size+=n.data.byteLength},pmt:function(){var i={type:"metadata",tracks:[]};null!==(t=n.programMapTable).video&&i.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+t.video,codec:"avc",type:"video"}),null!==t.audio&&i.tracks.push({timelineStartInfo:{baseMediaDecodeTime:0},id:+t.audio,codec:"adts",type:"audio"}),e.trigger("data",i)}})[n.type]()},this.reset=function(){i.size=0,i.data.length=0,r.size=0,r.data.length=0,this.trigger("reset")},this.flushStreams_=function(){o(i,"video"),o(r,"audio"),o(s,"timed-metadata")},this.flush=function(){this.flushStreams_(),this.trigger("done")}},n.prototype=new a;var u={PAT_PID:0,MP2T_PACKET_LENGTH:d,TransportPacketStream:r,TransportParseStream:s,ElementaryStream:n,TimestampRolloverStream:h,CaptionStream:o.CaptionStream,Cea608Stream:o.Cea608Stream,MetadataStream:t(10)};for(var f in l)l.hasOwnProperty(f)&&(u[f]=l[f]);e.exports=u},{10:10,11:11,12:12,31:31,8:8}],10:[function(t,e,i){var r,s=t(31),n=t(11),a=function(t,e,i){var r,s="";for(r=e;r<i;r++)s+="%"+("00"+t[r].toString(16)).slice(-2);return s},o=function(t,e,i){return decodeURIComponent(a(t,e,i))},l=function(t,e,i){return unescape(a(t,e,i))},h=function(t){return t[0]<<21|t[1]<<14|t[2]<<7|t[3]},d={TXXX:function(t){var e;if(3===t.data[0]){for(e=1;e<t.data.length;e++)if(0===t.data[e]){t.description=o(t.data,1,e),t.value=o(t.data,e+1,t.data.length).replace(/\0*$/,"");break}t.data=t.value}},WXXX:function(t){var e;if(3===t.data[0])for(e=1;e<t.data.length;e++)if(0===t.data[e]){t.description=o(t.data,1,e),t.url=o(t.data,e+1,t.data.length);break}},PRIV:function(t){var e;for(e=0;e<t.data.length;e++)if(0===t.data[e]){t.owner=l(t.data,0,e);break}t.privateData=t.data.subarray(e+1),t.data=t.privateData}};(r=function(t){var e,i={debug:!(!t||!t.debug),descriptor:t&&t.descriptor},s=0,a=[],o=0;if(r.prototype.init.call(this),this.dispatchType=n.METADATA_STREAM_TYPE.toString(16),i.descriptor)for(e=0;e<i.descriptor.length;e++)this.dispatchType+=("00"+i.descriptor[e].toString(16)).slice(-2);this.push=function(t){var e,r,n,l,c;if("timed-metadata"===t.type)if(t.dataAlignmentIndicator&&(o=0,a.length=0),0===a.length&&(t.data.length<10||t.data[0]!=="I".charCodeAt(0)||t.data[1]!=="D".charCodeAt(0)||t.data[2]!=="3".charCodeAt(0)))i.debug;else if(a.push(t),o+=t.data.byteLength,1===a.length&&(s=h(t.data.subarray(6,10)),s+=10),!(o<s)){for(e={data:new Uint8Array(s),frames:[],pts:a[0].pts,dts:a[0].dts},c=0;c<s;)e.data.set(a[0].data.subarray(0,s-c),c),c+=a[0].data.byteLength,o-=a[0].data.byteLength,a.shift();r=10,64&e.data[5]&&(r+=4,r+=h(e.data.subarray(10,14)),s-=h(e.data.subarray(16,20)));do{if((n=h(e.data.subarray(r+4,r+8)))<1)return;if((l={id:String.fromCharCode(e.data[r],e.data[r+1],e.data[r+2],e.data[r+3]),data:e.data.subarray(r+10,r+n+10)}).key=l.id,d[l.id]&&(d[l.id](l),"com.apple.streaming.transportStreamTimestamp"===l.owner)){var u=l.data,f=(1&u[3])<<30|u[4]<<22|u[5]<<14|u[6]<<6|u[7]>>>2;f*=4,f+=3&u[7],l.timeStamp=f,void 0===e.pts&&void 0===e.dts&&(e.pts=l.timeStamp,e.dts=l.timeStamp),this.trigger("timestamp",l)}e.frames.push(l),r+=10,r+=n}while(r<s);this.trigger("data",e)}}}).prototype=new s,e.exports=r},{11:11,31:31}],11:[function(t,e,i){e.exports={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21}},{}],12:[function(t,e,i){var r=t(31),s=8589934592,n=4294967296,a="shared",o=function(t,e){var i=1;for(t>e&&(i=-1);Math.abs(e-t)>n;)t+=i*s;return t},l=function t(e){var i,r;t.prototype.init.call(this),this.type_=e||a,this.push=function(t){this.type_!==a&&t.type!==this.type_||(void 0===r&&(r=t.dts),t.dts=o(t.dts,r),t.pts=o(t.pts,r),i=t.dts,this.trigger("data",t))},this.flush=function(){r=i,this.trigger("done")},this.endTimeline=function(){this.flush(),this.trigger("endedtimeline")},this.discontinuity=function(){r=void 0,i=void 0},this.reset=function(){this.discontinuity(),this.trigger("reset")}};l.prototype=new r,e.exports={TimestampRolloverStream:l,handleRollover:o}},{31:31}],13:[function(t,e,i){var r=t(7),s=t(29),n=function(t){var e,i=0;for(e=0;e<t.length;e++)i+=t[e].data.byteLength;return i},a=function(t,e,i,n){var a,o,l,h,d=0,c=0,u=0,f=0;if(e.length&&(a=s.audioTsToVideoTs(t.baseMediaDecodeTime,t.samplerate),d=Math.ceil(s.ONE_SECOND_IN_TS/(t.samplerate/1024)),i&&n&&(c=a-Math.max(i,n),f=(u=Math.floor(c/d))*d),!(u<1||f>s.ONE_SECOND_IN_TS/2))){for((o=r()[t.samplerate])||(o=e[0].data),l=0;l<u;l++)h=e[0],e.splice(0,0,{data:o,dts:h.dts-d,pts:h.pts-d});t.baseMediaDecodeTime-=Math.floor(s.videoTsToAudioTs(f,t.samplerate))}},o=function(t,e,i){return e.minSegmentDts>=i?t:(e.minSegmentDts=1/0,t.filter((function(t){return t.dts>=i&&(e.minSegmentDts=Math.min(e.minSegmentDts,t.dts),e.minSegmentPts=e.minSegmentDts,!0)})))},l=function(t){var e,i,r=[];for(e=0;e<t.length;e++)i=t[e],r.push({size:i.data.byteLength,duration:1024});return r},h=function(t){var e,i,r=0,s=new Uint8Array(n(t));for(e=0;e<t.length;e++)i=t[e],s.set(i.data,r),r+=i.data.byteLength;return s};e.exports={prefixWithSilence:a,trimAdtsFramesByEarliestDts:o,generateSampleTable:l,concatenateFrameData:h}},{29:29,7:7}],14:[function(t,e,i){var s=t(23).discardEmulationPreventionBytes,n=t(8).CaptionStream,a=t(15),o=t(25),l=t(27),h=t(26),d=function(t,e){for(var i=t,r=0;r<e.length;r++){var s=e[r];if(i<s.size)return s;i-=s.size}return null},c=function(t,e,i){var r,n,a,o,l=new DataView(t.buffer,t.byteOffset,t.byteLength),h=[];for(n=0;n+4<t.length;n+=a)if(a=l.getUint32(n),n+=4,!(a<=0))switch(31&t[n]){case 6:var c=t.subarray(n+1,n+1+a),u=d(n,e);if(r={nalUnitType:"sei_rbsp",size:a,data:c,escapedRBSP:s(c),trackId:i},u)r.pts=u.pts,r.dts=u.dts,o=u;else{if(!o)break;r.pts=o.pts,r.dts=o.dts}h.push(r)}return h},u=function(t,e,i){var r=e,s=i.defaultSampleDuration||0,n=i.defaultSampleSize||0,a=i.trackId,o=[];return t.forEach((function(t){var e=l(t).samples;e.forEach((function(t){void 0===t.duration&&(t.duration=s),void 0===t.size&&(t.size=n),t.trackId=a,t.dts=r,void 0===t.compositionTimeOffset&&(t.compositionTimeOffset=0),t.pts=r+t.compositionTimeOffset,r+=t.duration})),o=o.concat(e)})),o},f=function(t,e){var i=a(t,["moof","traf"]),r=a(t,["mdat"]),s={},n=[];return r.forEach((function(t,e){var r=i[e];n.push({mdat:t,traf:r})})),n.forEach((function(t){var i,r,n=t.mdat,l=t.traf,d=a(l,["tfhd"]),f=h(d[0]),p=f.trackId,m=a(l,["tfdt"]),g=m.length>0?o(m[0]).baseMediaDecodeTime:0,y=a(l,["trun"]);e===p&&y.length>0&&(i=u(y,g,f),r=c(n,i,p),s[p]||(s[p]=[]),s[p]=s[p].concat(r))})),s},p=function(t,e,i){return null===e?null:{seiNals:f(t,e)[e],timescale:i}},m=function(){var t,e,i,s,a,o,l=!1;this.isInitialized=function(){return l},this.init=function(e){t=new n,l=!0,o=!!e&&e.isPartial,t.on("data",(function(t){t.startTime=t.startPts/s,t.endTime=t.endPts/s,a.captions.push(t),a.captionStreams[t.stream]=!0}))},this.isNewInit=function(t,e){return!(t&&0===t.length||e&&"object"===(0,r.Z)(e)&&0===Object.keys(e).length||i===t[0]&&s===e[i])},this.parse=function(t,r,n){var o;if(!this.isInitialized())return null;if(!r||!n)return null;if(this.isNewInit(r,n))i=r[0],s=n[i];else if(null===i||!s)return e.push(t),null;for(;e.length>0;){var l=e.shift();this.parse(l,r,n)}return null!==(o=p(t,i,s))&&o.seiNals?(this.pushNals(o.seiNals),this.flushStream(),a):null},this.pushNals=function(e){if(!this.isInitialized()||!e||0===e.length)return null;e.forEach((function(e){t.push(e)}))},this.flushStream=function(){if(!this.isInitialized())return null;o?t.partialFlush():t.flush()},this.clearParsedCaptions=function(){a.captions=[],a.captionStreams={}},this.resetCaptionStream=function(){if(!this.isInitialized())return null;t.reset()},this.clearAllCaptions=function(){this.clearParsedCaptions(),this.resetCaptionStream()},this.reset=function(){e=[],i=null,s=null,a?this.clearParsedCaptions():a={captions:[],captionStreams:{}},this.resetCaptionStream()},this.reset()};e.exports=m},{15:15,23:23,25:25,26:26,27:27,8:8}],15:[function(t,e,i){var r=t(28).toUnsigned,s=t(19),n=function t(e,i){var n,a,o,l,h,d=[];if(!i.length)return null;for(n=0;n<e.byteLength;)a=r(e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3]),o=s(e.subarray(n+4,n+8)),l=a>1?n+a:e.byteLength,o===i[0]&&(1===i.length?d.push(e.subarray(n+8,l)):(h=t(e.subarray(n+8,l),i.slice(1))).length&&(d=d.concat(h))),n=l;return d};e.exports=n},{19:19,28:28}],16:[function(t,e,i){var r=function(t){var e,i,r=[],s=[];for(s.byteLength=0,s.nalCount=0,s.duration=0,r.byteLength=0,e=0;e<t.length;e++)"access_unit_delimiter_rbsp"===(i=t[e]).nalUnitType?(r.length&&(r.duration=i.dts-r.dts,s.byteLength+=r.byteLength,s.nalCount+=r.length,s.duration+=r.duration,s.push(r)),(r=[i]).byteLength=i.data.byteLength,r.pts=i.pts,r.dts=i.dts):("slice_layer_without_partitioning_rbsp_idr"===i.nalUnitType&&(r.keyFrame=!0),r.duration=i.dts-r.dts,r.byteLength+=i.data.byteLength,r.push(i));return s.length&&(!r.duration||r.duration<=0)&&(r.duration=s[s.length-1].duration),s.byteLength+=r.byteLength,s.nalCount+=r.length,s.duration+=r.duration,s.push(r),s},s=function(t){var e,i,r=[],s=[];for(r.byteLength=0,r.nalCount=0,r.duration=0,r.pts=t[0].pts,r.dts=t[0].dts,s.byteLength=0,s.nalCount=0,s.duration=0,s.pts=t[0].pts,s.dts=t[0].dts,e=0;e<t.length;e++)(i=t[e]).keyFrame?(r.length&&(s.push(r),s.byteLength+=r.byteLength,s.nalCount+=r.nalCount,s.duration+=r.duration),(r=[i]).nalCount=i.length,r.byteLength=i.byteLength,r.pts=i.pts,r.dts=i.dts,r.duration=i.duration):(r.duration+=i.duration,r.nalCount+=i.length,r.byteLength+=i.byteLength,r.push(i));return s.length&&r.duration<=0&&(r.duration=s[s.length-1].duration),s.byteLength+=r.byteLength,s.nalCount+=r.nalCount,s.duration+=r.duration,s.push(r),s},n=function(t){var e;return!t[0][0].keyFrame&&t.length>1&&(e=t.shift(),t.byteLength-=e.byteLength,t.nalCount-=e.nalCount,t[0][0].dts=e.dts,t[0][0].pts=e.pts,t[0][0].duration+=e.duration),t},a=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0,isNonSyncSample:1}}},o=function(t,e){var i=a();return i.dataOffset=e,i.compositionTimeOffset=t.pts-t.dts,i.duration=t.duration,i.size=4*t.length,i.size+=t.byteLength,t.keyFrame&&(i.flags.dependsOn=2,i.flags.isNonSyncSample=0),i},l=function(t,e){var i,r,s,n,a,l=e||0,h=[];for(i=0;i<t.length;i++)for(n=t[i],r=0;r<n.length;r++)a=n[r],l+=(s=o(a,l)).size,h.push(s);return h},h=function(t){var e,i,r,s,n,a,o=0,l=t.byteLength,h=t.nalCount,d=new Uint8Array(l+4*h),c=new DataView(d.buffer);for(e=0;e<t.length;e++)for(s=t[e],i=0;i<s.length;i++)for(n=s[i],r=0;r<n.length;r++)a=n[r],c.setUint32(o,a.data.byteLength),o+=4,d.set(a.data,o),o+=a.data.byteLength;return d},d=function(t,e){var i,r=[];return i=o(t,e||0),r.push(i),r},c=function(t){var e,i,r=0,s=t.byteLength,n=t.length,a=new Uint8Array(s+4*n),o=new DataView(a.buffer);for(e=0;e<t.length;e++)i=t[e],o.setUint32(r,i.data.byteLength),r+=4,a.set(i.data,r),r+=i.data.byteLength;return a};e.exports={groupNalsIntoFrames:r,groupFramesIntoGops:s,extendFirstKeyFrame:n,generateSampleTable:l,concatenateNalData:h,generateSampleTableForFrame:d,concatenateNalDataForFrame:c}},{}],17:[function(t,e,i){e.exports={generator:t(18),probe:t(20),Transmuxer:t(22).Transmuxer,AudioSegmentStream:t(22).AudioSegmentStream,VideoSegmentStream:t(22).VideoSegmentStream,CaptionParser:t(14)}},{14:14,18:18,20:20,22:22}],18:[function(t,e,i){var r,s,n,a,o,l,h,d,c,u,f,p,m,g,y,v,_,S,T,E,b,w,L,A,x,k,R,D,I,C,U,P,M,F,O,B,N,G,$,z,H,V=Math.pow(2,32)-1,K=4294967295;!function(){var t;if(L={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],pasp:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[]},"undefined"!=typeof Uint8Array){for(t in L)L.hasOwnProperty(t)&&(L[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);A=new Uint8Array(["i".charCodeAt(0),"s".charCodeAt(0),"o".charCodeAt(0),"m".charCodeAt(0)]),k=new Uint8Array(["a".charCodeAt(0),"v".charCodeAt(0),"c".charCodeAt(0),"1".charCodeAt(0)]),x=new Uint8Array([0,0,0,1]),R=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),D=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),I={video:R,audio:D},P=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),U=new Uint8Array([0,0,0,0,0,0,0,0]),M=new Uint8Array([0,0,0,0,0,0,0,0]),F=M,O=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),B=M,C=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}}(),r=function(t){var e,i,r=[],s=0;for(e=1;e<arguments.length;e++)r.push(arguments[e]);for(e=r.length;e--;)s+=r[e].byteLength;for(i=new Uint8Array(s+8),new DataView(i.buffer,i.byteOffset,i.byteLength).setUint32(0,i.byteLength),i.set(t,4),e=0,s=8;e<r.length;e++)i.set(r[e],s),s+=r[e].byteLength;return i},s=function(){return r(L.dinf,r(L.dref,P))},n=function(t){return r(L.esds,new Uint8Array([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,t.audioobjecttype<<3|t.samplingfrequencyindex>>>1,t.samplingfrequencyindex<<7|t.channelcount<<3,6,1,2]))},a=function(){return r(L.ftyp,A,x,A,k)},v=function(t){return r(L.hdlr,I[t])},o=function(t){return r(L.mdat,t)},y=function(t){var e=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,t.duration>>>24&255,t.duration>>>16&255,t.duration>>>8&255,255&t.duration,85,196,0,0]);return t.samplerate&&(e[12]=t.samplerate>>>24&255,e[13]=t.samplerate>>>16&255,e[14]=t.samplerate>>>8&255,e[15]=255&t.samplerate,t.duration=t.duration/9e4*t.samplerate,e[16]=t.duration>>>24&255,e[17]=t.duration>>>16&255,e[18]=t.duration>>>8&255,e[19]=255&t.duration),r(L.mdhd,e)},g=function(t){return r(L.mdia,y(t),v(t.type),h(t))},l=function(t){return r(L.mfhd,new Uint8Array([0,0,0,0,(4278190080&t)>>24,(16711680&t)>>16,(65280&t)>>8,255&t]))},h=function(t){return r(L.minf,"video"===t.type?r(L.vmhd,C):r(L.smhd,U),s(),S(t))},d=function(t,e){for(var i=[],s=e.length;s--;)i[s]=E(e[s]);return r.apply(null,[L.moof,l(t)].concat(i))},c=function(t){for(var e=t.length,i=[];e--;)i[e]=p(t[e]);return r.apply(null,[L.moov,f(K)].concat(i).concat(u(t)))},u=function(t){for(var e=t.length,i=[];e--;)i[e]=b(t[e]);return r.apply(null,[L.mvex].concat(i))},f=function(t){var e=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(4278190080&t)>>24,(16711680&t)>>16,(65280&t)>>8,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return r(L.mvhd,e)},_=function(t){var e,i,s=t.samples||[],n=new Uint8Array(4+s.length);for(i=0;i<s.length;i++)e=s[i].flags,n[i+4]=e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy;return r(L.sdtp,n)},S=function(t){return r(L.stbl,T(t),r(L.stts,B),r(L.stsc,F),r(L.stsz,O),r(L.stco,M))},T=function(t){return r(L.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),"video"===t.type?N(t):G(t))},N=function(t){var e,i,s=t.sps||[],n=t.pps||[],a=[],o=[];for(e=0;e<s.length;e++)a.push((65280&s[e].byteLength)>>>8),a.push(255&s[e].byteLength),a=a.concat(Array.prototype.slice.call(s[e]));for(e=0;e<n.length;e++)o.push((65280&n[e].byteLength)>>>8),o.push(255&n[e].byteLength),o=o.concat(Array.prototype.slice.call(n[e]));if(i=[L.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(65280&t.width)>>8,255&t.width,(65280&t.height)>>8,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),r(L.avcC,new Uint8Array([1,t.profileIdc,t.profileCompatibility,t.levelIdc,255].concat([s.length],a,[n.length],o))),r(L.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]))],t.sarRatio){var l=t.sarRatio[0],h=t.sarRatio[1];i.push(r(L.pasp,new Uint8Array([(4278190080&l)>>24,(16711680&l)>>16,(65280&l)>>8,255&l,(4278190080&h)>>24,(16711680&h)>>16,(65280&h)>>8,255&h])))}return r.apply(null,i)},G=function(t){return r(L.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(65280&t.channelcount)>>8,255&t.channelcount,(65280&t.samplesize)>>8,255&t.samplesize,0,0,0,0,(65280&t.samplerate)>>8,255&t.samplerate,0,0]),n(t))},m=function(t){var e=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,(4278190080&t.id)>>24,(16711680&t.id)>>16,(65280&t.id)>>8,255&t.id,0,0,0,0,(4278190080&t.duration)>>24,(16711680&t.duration)>>16,(65280&t.duration)>>8,255&t.duration,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(65280&t.width)>>8,255&t.width,0,0,(65280&t.height)>>8,255&t.height,0,0]);return r(L.tkhd,e)},E=function(t){var e,i,s,n,a,o,l;return e=r(L.tfhd,new Uint8Array([0,0,0,58,(4278190080&t.id)>>24,(16711680&t.id)>>16,(65280&t.id)>>8,255&t.id,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0])),o=Math.floor(t.baseMediaDecodeTime/(V+1)),l=Math.floor(t.baseMediaDecodeTime%(V+1)),i=r(L.tfdt,new Uint8Array([1,0,0,0,o>>>24&255,o>>>16&255,o>>>8&255,255&o,l>>>24&255,l>>>16&255,l>>>8&255,255&l])),a=92,"audio"===t.type?(s=w(t,a),r(L.traf,e,i,s)):(n=_(t),s=w(t,n.length+a),r(L.traf,e,i,s,n))},p=function(t){return t.duration=t.duration||K,r(L.trak,m(t),g(t))},b=function(t){var e=new Uint8Array([0,0,0,0,(4278190080&t.id)>>24,(16711680&t.id)>>16,(65280&t.id)>>8,255&t.id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return"video"!==t.type&&(e[e.length-1]=0),r(L.trex,e)},H=function(t,e){var i=0,r=0,s=0,n=0;return t.length&&(void 0!==t[0].duration&&(i=1),void 0!==t[0].size&&(r=2),void 0!==t[0].flags&&(s=4),void 0!==t[0].compositionTimeOffset&&(n=8)),[0,0,i|r|s|n,1,(4278190080&t.length)>>>24,(16711680&t.length)>>>16,(65280&t.length)>>>8,255&t.length,(4278190080&e)>>>24,(16711680&e)>>>16,(65280&e)>>>8,255&e]},z=function(t,e){var i,s,n,a,o,l;for(e+=20+16*(a=t.samples||[]).length,n=H(a,e),(s=new Uint8Array(n.length+16*a.length)).set(n),i=n.length,l=0;l<a.length;l++)o=a[l],s[i++]=(4278190080&o.duration)>>>24,s[i++]=(16711680&o.duration)>>>16,s[i++]=(65280&o.duration)>>>8,s[i++]=255&o.duration,s[i++]=(4278190080&o.size)>>>24,s[i++]=(16711680&o.size)>>>16,s[i++]=(65280&o.size)>>>8,s[i++]=255&o.size,s[i++]=o.flags.isLeading<<2|o.flags.dependsOn,s[i++]=o.flags.isDependedOn<<6|o.flags.hasRedundancy<<4|o.flags.paddingValue<<1|o.flags.isNonSyncSample,s[i++]=61440&o.flags.degradationPriority,s[i++]=15&o.flags.degradationPriority,s[i++]=(4278190080&o.compositionTimeOffset)>>>24,s[i++]=(16711680&o.compositionTimeOffset)>>>16,s[i++]=(65280&o.compositionTimeOffset)>>>8,s[i++]=255&o.compositionTimeOffset;return r(L.trun,s)},$=function(t,e){var i,s,n,a,o,l;for(e+=20+8*(a=t.samples||[]).length,n=H(a,e),(i=new Uint8Array(n.length+8*a.length)).set(n),s=n.length,l=0;l<a.length;l++)o=a[l],i[s++]=(4278190080&o.duration)>>>24,i[s++]=(16711680&o.duration)>>>16,i[s++]=(65280&o.duration)>>>8,i[s++]=255&o.duration,i[s++]=(4278190080&o.size)>>>24,i[s++]=(16711680&o.size)>>>16,i[s++]=(65280&o.size)>>>8,i[s++]=255&o.size;return r(L.trun,i)},w=function(t,e){return"audio"===t.type?$(t,e):z(t,e)},e.exports={ftyp:a,mdat:o,moof:d,moov:c,setDuration:function(t){t&&(K=9e4*t)},initSegment:function(t){var e,i=a(),r=c(t);return(e=new Uint8Array(i.byteLength+r.byteLength)).set(i),e.set(r,i.byteLength),e}}},{}],19:[function(t,e,i){var r=function(t){var e="";return e+=String.fromCharCode(t[0]),e+=String.fromCharCode(t[1]),e+=String.fromCharCode(t[2]),e+=String.fromCharCode(t[3])};e.exports=r},{}],20:[function(t,e,i){var r,s,n,a,o,l,h=t(28).toUnsigned,d=t(28).toHexString,c=t(15),u=t(19),f=t(26),p=t(27),m=t(25);r=function(t){var e={};return c(t,["moov","trak"]).reduce((function(t,e){var i,r,s,n,a;return(i=c(e,["tkhd"])[0])?(r=i[0],n=h(i[s=0===r?12:20]<<24|i[s+1]<<16|i[s+2]<<8|i[s+3]),(a=c(e,["mdia","mdhd"])[0])?(s=0===(r=a[0])?12:20,t[n]=h(a[s]<<24|a[s+1]<<16|a[s+2]<<8|a[s+3]),t):null):null}),e)},s=function(t,e){var i,r,s;return i=c(e,["moof","traf"]),r=[].concat.apply([],i.map((function(e){return c(e,["tfhd"]).map((function(i){var r,s,n;return r=h(i[4]<<24|i[5]<<16|i[6]<<8|i[7]),s=t[r]||9e4,n=c(e,["tfdt"]).map((function(t){var e,i;return e=t[0],i=h(t[4]<<24|t[5]<<16|t[6]<<8|t[7]),1===e&&(i*=Math.pow(2,32),i+=h(t[8]<<24|t[9]<<16|t[10]<<8|t[11])),i}))[0],(n=n||1/0)/s}))}))),s=Math.min.apply(null,r),isFinite(s)?s:0},n=function(t,e){var i,r=c(e,["moof","traf"]),s=0,n=0;if(r&&r.length){var a=c(r[0],["tfhd"])[0],o=c(r[0],["trun"])[0],l=c(r[0],["tfdt"])[0];if(a&&(i=f(a).trackId),l&&(s=m(l).baseMediaDecodeTime),o){var h=p(o);h.samples&&h.samples.length&&(n=h.samples[0].compositionTimeOffset||0)}}return(s+n)/(t[i]||9e4)},a=function(t){var e=c(t,["moov","trak"]),i=[];return e.forEach((function(t){var e=c(t,["mdia","hdlr"]),r=c(t,["tkhd"]);e.forEach((function(t,e){var s,n,a=u(t.subarray(8,12)),o=r[e];"vide"===a&&(n=0===(s=new DataView(o.buffer,o.byteOffset,o.byteLength)).getUint8(0)?s.getUint32(12):s.getUint32(20),i.push(n))}))})),i},l=function(t){var e=0===t[0]?12:20;return h(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])},o=function(t){var e=c(t,["moov","trak"]),i=[];return e.forEach((function(t){var e,r,s={},n=c(t,["tkhd"])[0];n&&(r=(e=new DataView(n.buffer,n.byteOffset,n.byteLength)).getUint8(0),s.id=0===r?e.getUint32(12):e.getUint32(20));var a=c(t,["mdia","hdlr"])[0];if(a){var o=u(a.subarray(8,12));s.type="vide"===o?"video":"soun"===o?"audio":o}var h=c(t,["mdia","minf","stbl","stsd"])[0];if(h){var f=h.subarray(8);s.codec=u(f.subarray(4,8));var p,m=c(f,[s.codec])[0];m&&(/^[a-z]vc[1-9]$/i.test(s.codec)?(p=m.subarray(78),"avcC"===u(p.subarray(4,8))&&p.length>11?(s.codec+=".",s.codec+=d(p[9]),s.codec+=d(p[10]),s.codec+=d(p[11])):s.codec="avc1.4d400d"):/^mp4[a,v]$/i.test(s.codec)&&(p=m.subarray(28),"esds"===u(p.subarray(4,8))&&p.length>20&&0!==p[19]?(s.codec+="."+d(p[19]),s.codec+="."+d(p[20]>>>2&63).replace(/^0/,"")):s.codec="mp4a.40.2"))}var g=c(t,["mdia","mdhd"])[0];g&&(s.timescale=l(g)),i.push(s)})),i},e.exports={findBox:c,parseType:u,timescale:r,startTime:s,compositionStartTime:n,videoTrackIds:a,tracks:o,getTimescaleFromMediaHeader:l}},{15:15,19:19,25:25,26:26,27:27,28:28}],21:[function(t,e,i){var r=t(29).ONE_SECOND_IN_TS,s=function(t,e){"number"==typeof e.pts&&(void 0===t.timelineStartInfo.pts&&(t.timelineStartInfo.pts=e.pts),void 0===t.minSegmentPts?t.minSegmentPts=e.pts:t.minSegmentPts=Math.min(t.minSegmentPts,e.pts),void 0===t.maxSegmentPts?t.maxSegmentPts=e.pts:t.maxSegmentPts=Math.max(t.maxSegmentPts,e.pts)),"number"==typeof e.dts&&(void 0===t.timelineStartInfo.dts&&(t.timelineStartInfo.dts=e.dts),void 0===t.minSegmentDts?t.minSegmentDts=e.dts:t.minSegmentDts=Math.min(t.minSegmentDts,e.dts),void 0===t.maxSegmentDts?t.maxSegmentDts=e.dts:t.maxSegmentDts=Math.max(t.maxSegmentDts,e.dts))},n=function(t){delete t.minSegmentDts,delete t.maxSegmentDts,delete t.minSegmentPts,delete t.maxSegmentPts},a=function(t,e){var i,s=t.minSegmentDts;return e||(s-=t.timelineStartInfo.dts),i=t.timelineStartInfo.baseMediaDecodeTime,i+=s,i=Math.max(0,i),"audio"===t.type&&(i*=t.samplerate/r,i=Math.floor(i)),i};e.exports={clearDtsInfo:n,calculateTrackBaseMediaDecodeTime:a,collectDtsInfo:s}},{29:29}],22:[function(t,e,i){var r,s,n,a,o=t(31),l=t(18),h=t(16),d=t(13),c=t(21),u=t(9),f=t(29),p=t(3),m=t(4).H264Stream,g=t(1),y=t(2).isLikelyAacData,v=t(29).ONE_SECOND_IN_TS,_=t(5),S=t(6),T=function(t,e){var i;if(t.length!==e.length)return!1;for(i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0},E=function(t,e,i,r,s,n){return{start:{dts:t,pts:t+(i-e)},end:{dts:t+(r-e),pts:t+(s-i)},prependedContentDuration:n,baseMediaDecodeTime:t}};(s=function(t,e){var i=[],r=0,n=0,a=0,o=1/0;e=e||{},s.prototype.init.call(this),this.push=function(e){c.collectDtsInfo(t,e),t&&_.forEach((function(i){t[i]=e[i]})),i.push(e)},this.setEarliestDts=function(t){n=t},this.setVideoBaseMediaDecodeTime=function(t){o=t},this.setAudioAppendStart=function(t){a=t},this.flush=function(){var s,h,u,f,p;0!==i.length?(s=d.trimAdtsFramesByEarliestDts(i,t,n),t.baseMediaDecodeTime=c.calculateTrackBaseMediaDecodeTime(t,e.keepOriginalTimestamps),d.prefixWithSilence(t,s,a,o),t.samples=d.generateSampleTable(s),u=l.mdat(d.concatenateFrameData(s)),i=[],h=l.moof(r,[t]),f=new Uint8Array(h.byteLength+u.byteLength),r++,f.set(h),f.set(u,h.byteLength),c.clearDtsInfo(t),p=Math.ceil(1024*v/t.samplerate),s.length&&this.trigger("timingInfo",{start:s[0].pts,end:s[0].pts+s.length*p}),this.trigger("data",{track:t,boxes:f}),this.trigger("done","AudioSegmentStream")):this.trigger("done","AudioSegmentStream")},this.reset=function(){c.clearDtsInfo(t),i=[],this.trigger("reset")}}).prototype=new o,(r=function(t,e){var i,s,n=0,a=[],o=[];e=e||{},r.prototype.init.call(this),delete t.minPTS,this.gopCache_=[],this.push=function(e){c.collectDtsInfo(t,e),"seq_parameter_set_rbsp"!==e.nalUnitType||i||(i=e.config,t.sps=[e.data],S.forEach((function(e){t[e]=i[e]}),this)),"pic_parameter_set_rbsp"!==e.nalUnitType||s||(s=e.data,t.pps=[e.data]),a.push(e)},this.flush=function(){for(var i,r,s,d,u,f,p,m,g=0;a.length&&"access_unit_delimiter_rbsp"!==a[0].nalUnitType;)a.shift();if(0===a.length)return this.resetStream_(),void this.trigger("done","VideoSegmentStream");if(i=h.groupNalsIntoFrames(a),(s=h.groupFramesIntoGops(i))[0][0].keyFrame||((r=this.getGopForFusion_(a[0],t))?(g=r.duration,s.unshift(r),s.byteLength+=r.byteLength,s.nalCount+=r.nalCount,s.pts=r.pts,s.dts=r.dts,s.duration+=r.duration):s=h.extendFirstKeyFrame(s)),o.length){var y;if(!(y=e.alignGopsAtEnd?this.alignGopsAtEnd_(s):this.alignGopsAtStart_(s)))return this.gopCache_.unshift({gop:s.pop(),pps:t.pps,sps:t.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),a=[],this.resetStream_(),void this.trigger("done","VideoSegmentStream");c.clearDtsInfo(t),s=y}c.collectDtsInfo(t,s),t.samples=h.generateSampleTable(s),u=l.mdat(h.concatenateNalData(s)),t.baseMediaDecodeTime=c.calculateTrackBaseMediaDecodeTime(t,e.keepOriginalTimestamps),this.trigger("processedGopsInfo",s.map((function(t){return{pts:t.pts,dts:t.dts,byteLength:t.byteLength}}))),p=s[0],m=s[s.length-1],this.trigger("segmentTimingInfo",E(t.baseMediaDecodeTime,p.dts,p.pts,m.dts+m.duration,m.pts+m.duration,g)),this.trigger("timingInfo",{start:s[0].pts,end:s[s.length-1].pts+s[s.length-1].duration}),this.gopCache_.unshift({gop:s.pop(),pps:t.pps,sps:t.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),a=[],this.trigger("baseMediaDecodeTime",t.baseMediaDecodeTime),this.trigger("timelineStartInfo",t.timelineStartInfo),d=l.moof(n,[t]),f=new Uint8Array(d.byteLength+u.byteLength),n++,f.set(d),f.set(u,d.byteLength),this.trigger("data",{track:t,boxes:f}),this.resetStream_(),this.trigger("done","VideoSegmentStream")},this.reset=function(){this.resetStream_(),a=[],this.gopCache_.length=0,o.length=0,this.trigger("reset")},this.resetStream_=function(){c.clearDtsInfo(t),i=void 0,s=void 0},this.getGopForFusion_=function(e){var i,r,s,n,a,o=45e3,l=1e4,h=1/0;for(a=0;a<this.gopCache_.length;a++)s=(n=this.gopCache_[a]).gop,t.pps&&T(t.pps[0],n.pps[0])&&t.sps&&T(t.sps[0],n.sps[0])&&(s.dts<t.timelineStartInfo.dts||(i=e.dts-s.dts-s.duration)>=-l&&i<=o&&(!r||h>i)&&(r=n,h=i));return r?r.gop:null},this.alignGopsAtStart_=function(t){var e,i,r,s,n,a,l,h;for(n=t.byteLength,a=t.nalCount,l=t.duration,e=i=0;e<o.length&&i<t.length&&(r=o[e],s=t[i],r.pts!==s.pts);)s.pts>r.pts?e++:(i++,n-=s.byteLength,a-=s.nalCount,l-=s.duration);return 0===i?t:i===t.length?null:((h=t.slice(i)).byteLength=n,h.duration=l,h.nalCount=a,h.pts=h[0].pts,h.dts=h[0].dts,h)},this.alignGopsAtEnd_=function(t){var e,i,r,s,n,a,l;for(e=o.length-1,i=t.length-1,n=null,a=!1;e>=0&&i>=0;){if(r=o[e],s=t[i],r.pts===s.pts){a=!0;break}r.pts>s.pts?e--:(e===o.length-1&&(n=i),i--)}if(!a&&null===n)return null;if(0===(l=a?i:n))return t;var h=t.slice(l),d=h.reduce((function(t,e){return t.byteLength+=e.byteLength,t.duration+=e.duration,t.nalCount+=e.nalCount,t}),{byteLength:0,duration:0,nalCount:0});return h.byteLength=d.byteLength,h.duration=d.duration,h.nalCount=d.nalCount,h.pts=h[0].pts,h.dts=h[0].dts,h},this.alignGopsWith=function(t){o=t}}).prototype=new o,(a=function(t,e){this.numberOfTracks=0,this.metadataStream=e,void 0!==(t=t||{}).remux?this.remuxTracks=!!t.remux:this.remuxTracks=!0,"boolean"==typeof t.keepOriginalTimestamps?this.keepOriginalTimestamps=t.keepOriginalTimestamps:this.keepOriginalTimestamps=!1,this.pendingTracks=[],this.videoTrack=null,this.pendingBoxes=[],this.pendingCaptions=[],this.pendingMetadata=[],this.pendingBytes=0,this.emittedTracks=0,a.prototype.init.call(this),this.push=function(t){return t.text?this.pendingCaptions.push(t):t.frames?this.pendingMetadata.push(t):(this.pendingTracks.push(t.track),this.pendingBytes+=t.boxes.byteLength,"video"===t.track.type&&(this.videoTrack=t.track,this.pendingBoxes.push(t.boxes)),void("audio"===t.track.type&&(this.audioTrack=t.track,this.pendingBoxes.unshift(t.boxes))))}}).prototype=new o,a.prototype.flush=function(t){var e,i,r,s,n=0,a={captions:[],captionStreams:{},metadata:[],info:{}},o=0;if(this.pendingTracks.length<this.numberOfTracks){if("VideoSegmentStream"!==t&&"AudioSegmentStream"!==t)return;if(this.remuxTracks)return;if(0===this.pendingTracks.length)return this.emittedTracks++,void(this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0))}if(this.videoTrack?(o=this.videoTrack.timelineStartInfo.pts,S.forEach((function(t){a.info[t]=this.videoTrack[t]}),this)):this.audioTrack&&(o=this.audioTrack.timelineStartInfo.pts,_.forEach((function(t){a.info[t]=this.audioTrack[t]}),this)),this.videoTrack||this.audioTrack){for(1===this.pendingTracks.length?a.type=this.pendingTracks[0].type:a.type="combined",this.emittedTracks+=this.pendingTracks.length,r=l.initSegment(this.pendingTracks),a.initSegment=new Uint8Array(r.byteLength),a.initSegment.set(r),a.data=new Uint8Array(this.pendingBytes),s=0;s<this.pendingBoxes.length;s++)a.data.set(this.pendingBoxes[s],n),n+=this.pendingBoxes[s].byteLength;for(s=0;s<this.pendingCaptions.length;s++)(e=this.pendingCaptions[s]).startTime=f.metadataTsToSeconds(e.startPts,o,this.keepOriginalTimestamps),e.endTime=f.metadataTsToSeconds(e.endPts,o,this.keepOriginalTimestamps),a.captionStreams[e.stream]=!0,a.captions.push(e);for(s=0;s<this.pendingMetadata.length;s++)(i=this.pendingMetadata[s]).cueTime=f.metadataTsToSeconds(i.pts,o,this.keepOriginalTimestamps),a.metadata.push(i);for(a.metadata.dispatchType=this.metadataStream.dispatchType,this.pendingTracks.length=0,this.videoTrack=null,this.pendingBoxes.length=0,this.pendingCaptions.length=0,this.pendingBytes=0,this.pendingMetadata.length=0,this.trigger("data",a),s=0;s<a.captions.length;s++)e=a.captions[s],this.trigger("caption",e);for(s=0;s<a.metadata.length;s++)i=a.metadata[s],this.trigger("id3Frame",i)}this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0)},a.prototype.setRemux=function(t){this.remuxTracks=t},(n=function(t){var e,i,o=this,h=!0;n.prototype.init.call(this),t=t||{},this.baseMediaDecodeTime=t.baseMediaDecodeTime||0,this.transmuxPipeline_={},l.setDuration(t.duration),this.setupAacPipeline=function(){var r={};this.transmuxPipeline_=r,r.type="aac",r.metadataStream=new u.MetadataStream,r.aacStream=new g,r.audioTimestampRolloverStream=new u.TimestampRolloverStream("audio"),r.timedMetadataTimestampRolloverStream=new u.TimestampRolloverStream("timed-metadata"),r.adtsStream=new p,r.coalesceStream=new a(t,r.metadataStream),r.headOfPipeline=r.aacStream,r.aacStream.pipe(r.audioTimestampRolloverStream).pipe(r.adtsStream),r.aacStream.pipe(r.timedMetadataTimestampRolloverStream).pipe(r.metadataStream).pipe(r.coalesceStream),r.metadataStream.on("timestamp",(function(t){r.aacStream.setTimestamp(t.timeStamp)})),r.aacStream.on("data",(function(n){"timed-metadata"!==n.type&&"audio"!==n.type||r.audioSegmentStream||(i=i||{timelineStartInfo:{baseMediaDecodeTime:o.baseMediaDecodeTime},codec:"adts",type:"audio"},r.coalesceStream.numberOfTracks++,r.audioSegmentStream=new s(i,t),r.audioSegmentStream.on("timingInfo",o.trigger.bind(o,"audioTimingInfo")),r.adtsStream.pipe(r.audioSegmentStream).pipe(r.coalesceStream),o.trigger("trackinfo",{hasAudio:!!i,hasVideo:!!e}))})),r.coalesceStream.on("data",this.trigger.bind(this,"data")),r.coalesceStream.on("done",this.trigger.bind(this,"done"))},this.setupTsPipeline=function(){var n={};this.transmuxPipeline_=n,n.type="ts",n.metadataStream=new u.MetadataStream,n.packetStream=new u.TransportPacketStream,n.parseStream=new u.TransportParseStream,n.elementaryStream=new u.ElementaryStream,n.timestampRolloverStream=new u.TimestampRolloverStream,n.adtsStream=new p,n.h264Stream=new m,n.captionStream=new u.CaptionStream,n.coalesceStream=new a(t,n.metadataStream),n.headOfPipeline=n.packetStream,n.packetStream.pipe(n.parseStream).pipe(n.elementaryStream).pipe(n.timestampRolloverStream),n.timestampRolloverStream.pipe(n.h264Stream),n.timestampRolloverStream.pipe(n.adtsStream),n.timestampRolloverStream.pipe(n.metadataStream).pipe(n.coalesceStream),n.h264Stream.pipe(n.captionStream).pipe(n.coalesceStream),n.elementaryStream.on("data",(function(a){var l;if("metadata"===a.type){for(l=a.tracks.length;l--;)e||"video"!==a.tracks[l].type?i||"audio"!==a.tracks[l].type||((i=a.tracks[l]).timelineStartInfo.baseMediaDecodeTime=o.baseMediaDecodeTime):(e=a.tracks[l]).timelineStartInfo.baseMediaDecodeTime=o.baseMediaDecodeTime;e&&!n.videoSegmentStream&&(n.coalesceStream.numberOfTracks++,n.videoSegmentStream=new r(e,t),n.videoSegmentStream.on("timelineStartInfo",(function(e){i&&!t.keepOriginalTimestamps&&(i.timelineStartInfo=e,n.audioSegmentStream.setEarliestDts(e.dts-o.baseMediaDecodeTime))})),n.videoSegmentStream.on("processedGopsInfo",o.trigger.bind(o,"gopInfo")),n.videoSegmentStream.on("segmentTimingInfo",o.trigger.bind(o,"videoSegmentTimingInfo")),n.videoSegmentStream.on("baseMediaDecodeTime",(function(t){i&&n.audioSegmentStream.setVideoBaseMediaDecodeTime(t)})),n.videoSegmentStream.on("timingInfo",o.trigger.bind(o,"videoTimingInfo")),n.h264Stream.pipe(n.videoSegmentStream).pipe(n.coalesceStream)),i&&!n.audioSegmentStream&&(n.coalesceStream.numberOfTracks++,n.audioSegmentStream=new s(i,t),n.audioSegmentStream.on("timingInfo",o.trigger.bind(o,"audioTimingInfo")),n.adtsStream.pipe(n.audioSegmentStream).pipe(n.coalesceStream)),o.trigger("trackinfo",{hasAudio:!!i,hasVideo:!!e})}})),n.coalesceStream.on("data",this.trigger.bind(this,"data")),n.coalesceStream.on("id3Frame",(function(t){t.dispatchType=n.metadataStream.dispatchType,o.trigger("id3Frame",t)})),n.coalesceStream.on("caption",this.trigger.bind(this,"caption")),n.coalesceStream.on("done",this.trigger.bind(this,"done"))},this.setBaseMediaDecodeTime=function(r){var s=this.transmuxPipeline_;t.keepOriginalTimestamps||(this.baseMediaDecodeTime=r),i&&(i.timelineStartInfo.dts=void 0,i.timelineStartInfo.pts=void 0,c.clearDtsInfo(i),s.audioTimestampRolloverStream&&s.audioTimestampRolloverStream.discontinuity()),e&&(s.videoSegmentStream&&(s.videoSegmentStream.gopCache_=[]),e.timelineStartInfo.dts=void 0,e.timelineStartInfo.pts=void 0,c.clearDtsInfo(e),s.captionStream.reset()),s.timestampRolloverStream&&s.timestampRolloverStream.discontinuity()},this.setAudioAppendStart=function(t){i&&this.transmuxPipeline_.audioSegmentStream.setAudioAppendStart(t)},this.setRemux=function(e){var i=this.transmuxPipeline_;t.remux=e,i&&i.coalesceStream&&i.coalesceStream.setRemux(e)},this.alignGopsWith=function(t){e&&this.transmuxPipeline_.videoSegmentStream&&this.transmuxPipeline_.videoSegmentStream.alignGopsWith(t)},this.push=function(t){if(h){var e=y(t);e&&"aac"!==this.transmuxPipeline_.type?this.setupAacPipeline():e||"ts"===this.transmuxPipeline_.type||this.setupTsPipeline(),h=!1}this.transmuxPipeline_.headOfPipeline.push(t)},this.flush=function(){h=!0,this.transmuxPipeline_.headOfPipeline.flush()},this.endTimeline=function(){this.transmuxPipeline_.headOfPipeline.endTimeline()},this.reset=function(){this.transmuxPipeline_.headOfPipeline&&this.transmuxPipeline_.headOfPipeline.reset()},this.resetCaptions=function(){this.transmuxPipeline_.captionStream&&this.transmuxPipeline_.captionStream.reset()}}).prototype=new o,e.exports={Transmuxer:n,VideoSegmentStream:r,AudioSegmentStream:s,AUDIO_PROPERTIES:_,VIDEO_PROPERTIES:S,generateVideoSegmentTimingInfo:E}},{1:1,13:13,16:16,18:18,2:2,21:21,29:29,3:3,31:31,4:4,5:5,6:6,9:9}],23:[function(t,e,i){var r=4,s=128,n=function(t){for(var e=0,i={payloadType:-1,payloadSize:0},n=0,a=0;e<t.byteLength&&t[e]!==s;){for(;255===t[e];)n+=255,e++;for(n+=t[e++];255===t[e];)a+=255,e++;if(a+=t[e++],!i.payload&&n===r){if("GA94"===String.fromCharCode(t[e+3],t[e+4],t[e+5],t[e+6])){i.payloadType=n,i.payloadSize=a,i.payload=t.subarray(e,e+a);break}i.payload=void 0}e+=a,n=0,a=0}return i},a=function(t){return 181!==t.payload[0]||49!=(t.payload[1]<<8|t.payload[2])||"GA94"!==String.fromCharCode(t.payload[3],t.payload[4],t.payload[5],t.payload[6])||3!==t.payload[7]?null:t.payload.subarray(8,t.payload.length-1)},o=function(t,e){var i,r,s,n,a=[];if(!(64&e[0]))return a;for(r=31&e[0],i=0;i<r;i++)n={type:3&e[2+(s=3*i)],pts:t},4&e[s+2]&&(n.ccData=e[s+3]<<8|e[s+4],a.push(n));return a},l=function(t){for(var e,i,r=t.byteLength,s=[],n=1;n<r-2;)0===t[n]&&0===t[n+1]&&3===t[n+2]?(s.push(n+2),n+=2):n++;if(0===s.length)return t;e=r-s.length,i=new Uint8Array(e);var a=0;for(n=0;n<e;a++,n++)a===s[0]&&(a++,s.shift()),i[n]=t[a];return i};e.exports={parseSei:n,parseUserData:a,parseCaptionPackets:o,discardEmulationPreventionBytes:l,USER_DATA_REGISTERED_ITU_T_T35:r}},{}],24:[function(t,e,i){var r=function(t){return{isLeading:(12&t[0])>>>2,dependsOn:3&t[0],isDependedOn:(192&t[1])>>>6,hasRedundancy:(48&t[1])>>>4,paddingValue:(14&t[1])>>>1,isNonSyncSample:1&t[1],degradationPriority:t[2]<<8|t[3]}};e.exports=r},{}],25:[function(t,e,i){var r=t(28).toUnsigned,s=function(t){var e={version:t[0],flags:new Uint8Array(t.subarray(1,4)),baseMediaDecodeTime:r(t[4]<<24|t[5]<<16|t[6]<<8|t[7])};return 1===e.version&&(e.baseMediaDecodeTime*=Math.pow(2,32),e.baseMediaDecodeTime+=r(t[8]<<24|t[9]<<16|t[10]<<8|t[11])),e};e.exports=s},{28:28}],26:[function(t,e,i){var r=function(t){var e,i=new DataView(t.buffer,t.byteOffset,t.byteLength),r={version:t[0],flags:new Uint8Array(t.subarray(1,4)),trackId:i.getUint32(4)},s=1&r.flags[2],n=2&r.flags[2],a=8&r.flags[2],o=16&r.flags[2],l=32&r.flags[2],h=65536&r.flags[0],d=131072&r.flags[0];return e=8,s&&(e+=4,r.baseDataOffset=i.getUint32(12),e+=4),n&&(r.sampleDescriptionIndex=i.getUint32(e),e+=4),a&&(r.defaultSampleDuration=i.getUint32(e),e+=4),o&&(r.defaultSampleSize=i.getUint32(e),e+=4),l&&(r.defaultSampleFlags=i.getUint32(e)),h&&(r.durationIsEmpty=!0),!s&&d&&(r.baseDataOffsetIsMoof=!0),r};e.exports=r},{}],27:[function(t,e,i){var r=t(24),s=function(t){var e,i={version:t[0],flags:new Uint8Array(t.subarray(1,4)),samples:[]},s=new DataView(t.buffer,t.byteOffset,t.byteLength),n=1&i.flags[2],a=4&i.flags[2],o=1&i.flags[1],l=2&i.flags[1],h=4&i.flags[1],d=8&i.flags[1],c=s.getUint32(4),u=8;for(n&&(i.dataOffset=s.getInt32(u),u+=4),a&&c&&(e={flags:r(t.subarray(u,u+4))},u+=4,o&&(e.duration=s.getUint32(u),u+=4),l&&(e.size=s.getUint32(u),u+=4),d&&(1===i.version?e.compositionTimeOffset=s.getInt32(u):e.compositionTimeOffset=s.getUint32(u),u+=4),i.samples.push(e),c--);c--;)e={},o&&(e.duration=s.getUint32(u),u+=4),l&&(e.size=s.getUint32(u),u+=4),h&&(e.flags=r(t.subarray(u,u+4)),u+=4),d&&(1===i.version?e.compositionTimeOffset=s.getInt32(u):e.compositionTimeOffset=s.getUint32(u),u+=4),i.samples.push(e);return i};e.exports=s},{24:24}],28:[function(t,e,i){var r=function(t){return t>>>0},s=function(t){return("00"+t.toString(16)).slice(-2)};e.exports={toUnsigned:r,toHexString:s}},{}],29:[function(t,e,i){var r,s,n,a,o,l,h,d=9e4;r=function(t){return t*d},s=function(t,e){return t*e},n=function(t){return t/d},a=function(t,e){return t/e},o=function(t,e){return r(a(t,e))},l=function(t,e){return s(n(t),e)},h=function(t,e,i){return n(i?t:t-e)},e.exports={ONE_SECOND_IN_TS:d,secondsToVideoTs:r,secondsToAudioTs:s,videoTsToSeconds:n,audioTsToSeconds:a,audioTsToVideoTs:o,videoTsToAudioTs:l,metadataTsToSeconds:h}},{}],30:[function(t,e,i){var r;r=function(t){var e=t.byteLength,i=0,r=0;this.length=function(){return 8*e},this.bitsAvailable=function(){return 8*e+r},this.loadWord=function(){var s=t.byteLength-e,n=new Uint8Array(4),a=Math.min(4,e);if(0===a)throw new Error("no bytes available");n.set(t.subarray(s,s+a)),i=new DataView(n.buffer).getUint32(0),r=8*a,e-=a},this.skipBits=function(t){var s;r>t?(i<<=t,r-=t):(t-=r,t-=8*(s=Math.floor(t/8)),e-=s,this.loadWord(),i<<=t,r-=t)},this.readBits=function(t){var s=Math.min(r,t),n=i>>>32-s;return(r-=s)>0?i<<=s:e>0&&this.loadWord(),(s=t-s)>0?n<<s|this.readBits(s):n},this.skipLeadingZeros=function(){var t;for(t=0;t<r;++t)if(0!=(i&2147483648>>>t))return i<<=t,r-=t,t;return this.loadWord(),t+this.skipLeadingZeros()},this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.readUnsignedExpGolomb=function(){var t=this.skipLeadingZeros();return this.readBits(t+1)-1},this.readExpGolomb=function(){var t=this.readUnsignedExpGolomb();return 1&t?1+t>>>1:-1*(t>>>1)},this.readBoolean=function(){return 1===this.readBits(1)},this.readUnsignedByte=function(){return this.readBits(8)},this.loadWord()},e.exports=r},{}],31:[function(t,e,i){var r=function(){this.init=function(){var t={};this.on=function(e,i){t[e]||(t[e]=[]),t[e]=t[e].concat(i)},this.off=function(e,i){var r;return!!t[e]&&(r=t[e].indexOf(i),t[e]=t[e].slice(),t[e].splice(r,1),r>-1)},this.trigger=function(e){var i,r,s,n;if(i=t[e])if(2===arguments.length)for(s=i.length,r=0;r<s;++r)i[r].call(this,arguments[1]);else{for(n=[],r=arguments.length,r=1;r<arguments.length;++r)n.push(arguments[r]);for(s=i.length,r=0;r<s;++r)i[r].apply(this,n)}},this.dispose=function(){t={}}}};r.prototype.pipe=function(t){return this.on("data",(function(e){t.push(e)})),this.on("done",(function(e){t.flush(e)})),this.on("partialdone",(function(e){t.partialFlush(e)})),this.on("endedtimeline",(function(e){t.endTimeline(e)})),this.on("reset",(function(e){t.reset(e)})),t},r.prototype.push=function(t){this.trigger("data",t)},r.prototype.flush=function(t){this.trigger("done",t)},r.prototype.partialFlush=function(t){this.trigger("partialdone",t)},r.prototype.endTimeline=function(t){this.trigger("endedtimeline",t)},r.prototype.reset=function(t){this.trigger("reset",t)},e.exports=r},{}]},{},[17])(17)}()},500:(t,e,i)=>{"use strict";i.d(e,{mu:()=>l,tZ:()=>u});var r=i(809),s=i(649);function n(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function a(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?n(Object(i),!0).forEach((function(e){(0,s.Z)(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var o={initSyncComplete:!1,initLocalComplete:!1},l={init:!0};if(o.blackList=new Set,o.requestHeaders=new Map,o.customFoundUrls=new Map,chrome.tabs&&chrome.tabs.query({active:!0,currentWindow:!0},(function(t){t[0]&&t[0].id?o.tabId=t[0].id:o.tabId=-1})),o.OptionLists={Ext:[{ext:"flv",size:0,state:!0},{ext:"hlv",size:0,state:!0},{ext:"f4v",size:0,state:!0},{ext:"mp4",size:0,state:!0},{ext:"mp3",size:0,state:!0},{ext:"wma",size:0,state:!0},{ext:"wav",size:0,state:!0},{ext:"m4a",size:0,state:!0},{ext:"letv",size:0,state:!0},{ext:"ts",size:0,state:!1},{ext:"webm",size:0,state:!0},{ext:"ogg",size:0,state:!0},{ext:"ogv",size:0,state:!0},{ext:"acc",size:0,state:!0},{ext:"mov",size:0,state:!0},{ext:"mkv",size:0,state:!0},{ext:"m4s",size:0,state:!1},{ext:"m3u8",size:0,state:!0},{ext:"m3u",size:0,state:!0},{ext:"mpeg",size:0,state:!0},{ext:"avi",size:0,state:!0},{ext:"wmv",size:0,state:!0},{ext:"asf",size:0,state:!0},{ext:"movie",size:0,state:!0},{ext:"divx",size:0,state:!0},{ext:"mpeg4",size:0,state:!0},{ext:"vid",size:0,state:!0},{ext:"aac",size:0,state:!0},{ext:"mpd",size:0,state:!0}],Type:[{type:"audio/*",size:0,state:!0},{type:"video/*",size:0,state:!0},{type:"application/ogg",size:0,state:!0},{type:"application/vnd.apple.mpegurl",size:0,state:!0},{type:"application/x-mpegurl",size:0,state:!0},{type:"application/mpegurl",size:0,state:!0},{type:"application/octet-stream-m3u8",size:0,state:!0},{type:"application/dash+xml",size:0,state:!0},{type:"application/m4s",size:0,state:!0}],Regex:[{type:"ig",regex:"https://cache\\.video\\.[a-z]*\\.com/dash\\?tvid=.*",ext:"json",state:!1},{type:"ig",regex:".*\\.bilivideo\\.(com|cn).*\\/live-bvc\\/.*m4s",ext:"",blackList:!0,state:!1}],TitleName:!0,Player:"",MobileUserAgent:"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1",playbackRate:2,autoClearMode:2,userAgent:"",checkDuplicates:!0,enable:!0,BlockedDomains:null,popListCount:30,ShowCountOnIcon:!0},o.LocalVar={featMobileTabId:[],mediaControl:{tabid:0,index:-1}},o.isFirefox=!1,o.version=93,navigator.userAgent.includes("Chrome/")){var h=navigator.userAgent.match(/Chrome\/([\d]+)/);h&&h[1]&&(o.version=parseInt(h[1]))}else navigator.userAgent.includes("Firefox/")&&(o.isFirefox=!0);o.scriptList=new Map,o.scriptList.set("deepsearch.js",{key:"deepsearch",refresh:!0,allFrames:!0,world:"MAIN",name:"DeepSearch",off:"Close Search",tabId:new Set}),o.scriptList.set("screenrecorder.js",{key:"screenrecorder",refresh:!1,allFrames:!1,world:"ISOLATED",name:"ScreenRecorder",off:"Close Screen Recorder",tabId:new Set}),o.scriptList.set("webrtc.js",{key:"webrtc",refresh:!0,allFrames:!0,world:"MAIN",name:"Webrtc",off:"Close Webrtc",tabId:new Set});var d=/['\\:\*\?"<\/>\|~]/g;function c(){chrome.storage.local.get({MediaData:{}},(function(t){l=t.MediaData.init?{}:t.MediaData})),chrome.storage.sync.get(o.OptionLists,(function(t){chrome.runtime.lastError&&(t=o.OptionLists),t.Ext=new Map(t.Ext.map((function(t){return[t.ext,t]}))),t.Type=new Map(t.Type.map((function(t){return[t.type,{size:t.size,state:t.state}]}))),t.Regex=t.Regex.map((function(t){var e=void 0;try{e=new RegExp(t.regex,t.type)}catch(e){t.state=!1}return{regex:e,ext:t.ext,blackList:t.blackList,state:t.state}})),(o=a({},t,{},o)).popListCount||(o.popListCount=30),o.TitleName||(o.TitleName=!0),o.ShowCountOnIcon||(o.ShowCountOnIcon=!0);var e={path:o.enable?"assets/icons/64x64.png":"assets/icons/64x64_gray.png"};o.isFirefox?browser.browserAction&&browser.browserAction.setIcon(e):chrome.action&&chrome.action.setIcon(e),o.initSyncComplete=!0})),chrome.storage.local.get(o.LocalVar,(function(t){t.featMobileTabId=new Set(t.featMobileTabId),(o=a({},t,{},o)).initLocalComplete=!0}))}function u(t){return t?(d.lastIndex=0,(t=t.replaceAll(/\u200B/g,"").replaceAll(/\u200C/g,"").replaceAll(/\u200D/g,"")).replace(d,(function(t){return{"'":"&#39;","\\":"&#92;","/":"&#47;",":":"&#58;","*":"&#42;","?":"&#63;",'"':"&quot;","<":"&lt;",">":"&gt;","|":"&#124;","~":"_"}[t]}))):t}c(),chrome.storage.onChanged.addListener((function(t,e){var i;if(t.MediaData)null!==(i=t.MediaData.newValue)&&void 0!==i&&i.init&&(l={});else for(var s=0,n=Object.entries(t);s<n.length;s++){var a=(0,r.Z)(n[s],2),h=a[0],d=a[1],c=(d.oldValue,d.newValue);c??=o.OptionLists[h],"Ext"!=h?"Type"!=h?"Regex"!=h?o[h]="featMobileTabId"!=h?c:new Set(c):o.Regex=c.map((function(t){var e=void 0;try{e=new RegExp(t.regex,t.type)}catch(e){t.state=!1}return{regex:e,ext:t.ext,blackList:t.blackList,state:t.state}})):o.Type=new Map(c.map((function(t){return[t.type,{size:t.size,state:t.state}]}))):o.Ext=new Map(c.map((function(t){return[t.ext,t]})))}})),chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener((function(t){"update"==t.reason&&(chrome.storage.local.clear((function(){c()})),chrome.alarms.create("nowClear",{when:Date.now()+3e3}))}))},34:(t,e)=>{var i=function(){new Date;return{setLogLevel:function(t){t==this.debug?1:t==this.info?2:t==this.warn?3:(this.error,4)},debug:function(t,e){void 0===console.debug&&(console.debug=console.log)},log:function(t,e){this.debug(t.msg)},info:function(t,e){},warn:function(t,e){},error:function(t,e){}}}();i.getDurationString=function(t,e){var i;function r(t,e){for(var i=(""+t).split(".");i[0].length<e;)i[0]="0"+i[0];return i.join(".")}t<0?(i=!0,t=-t):i=!1;var s=t/(e||1),n=Math.floor(s/3600);s-=3600*n;var a=Math.floor(s/60),o=1e3*(s-=60*a);return o-=1e3*(s=Math.floor(s)),o=Math.floor(o),(i?"-":"")+n+":"+r(a,2)+":"+r(s,2)+"."+r(o,3)},i.printRanges=function(t){var e=t.length;if(e>0){for(var r="",s=0;s<e;s++)s>0&&(r+=","),r+="["+i.getDurationString(t.start(s))+","+i.getDurationString(t.end(s))+"]";return r}return"(empty)"},e.Log=i;var r=function(t){if(!(t instanceof ArrayBuffer))throw"Needs an array buffer";this.buffer=t,this.dataview=new DataView(t),this.position=0};r.prototype.getPosition=function(){return this.position},r.prototype.getEndPosition=function(){return this.buffer.byteLength},r.prototype.getLength=function(){return this.buffer.byteLength},r.prototype.seek=function(t){var e=Math.max(0,Math.min(this.buffer.byteLength,t));return this.position=isNaN(e)||!isFinite(e)?0:e,!0},r.prototype.isEos=function(){return this.getPosition()>=this.getEndPosition()},r.prototype.readAnyInt=function(t,e){var i=0;if(this.position+t<=this.buffer.byteLength){switch(t){case 1:i=e?this.dataview.getInt8(this.position):this.dataview.getUint8(this.position);break;case 2:i=e?this.dataview.getInt16(this.position):this.dataview.getUint16(this.position);break;case 3:if(e)throw"No method for reading signed 24 bits values";i=this.dataview.getUint8(this.position)<<16,i|=this.dataview.getUint8(this.position+1)<<8,i|=this.dataview.getUint8(this.position+2);break;case 4:i=e?this.dataview.getInt32(this.position):this.dataview.getUint32(this.position);break;case 8:if(e)throw"No method for reading signed 64 bits values";i=this.dataview.getUint32(this.position)<<32,i|=this.dataview.getUint32(this.position+4);break;default:throw"readInt method not implemented for size: "+t}return this.position+=t,i}throw"Not enough bytes in buffer"},r.prototype.readUint8=function(){return this.readAnyInt(1,!1)},r.prototype.readUint16=function(){return this.readAnyInt(2,!1)},r.prototype.readUint24=function(){return this.readAnyInt(3,!1)},r.prototype.readUint32=function(){return this.readAnyInt(4,!1)},r.prototype.readUint64=function(){return this.readAnyInt(8,!1)},r.prototype.readString=function(t){if(this.position+t<=this.buffer.byteLength){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readUint8());return e}throw"Not enough bytes in buffer"},r.prototype.readCString=function(){for(var t=[];;){var e=this.readUint8();if(0===e)break;t.push(e)}return String.fromCharCode.apply(null,t)},r.prototype.readInt8=function(){return this.readAnyInt(1,!0)},r.prototype.readInt16=function(){return this.readAnyInt(2,!0)},r.prototype.readInt32=function(){return this.readAnyInt(4,!0)},r.prototype.readInt64=function(){return this.readAnyInt(8,!1)},r.prototype.readUint8Array=function(t){for(var e=new Uint8Array(t),i=0;i<t;i++)e[i]=this.readUint8();return e},r.prototype.readInt16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readInt16();return e},r.prototype.readUint16Array=function(t){for(var e=new Int16Array(t),i=0;i<t;i++)e[i]=this.readUint16();return e},r.prototype.readUint32Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUint32();return e},r.prototype.readInt32Array=function(t){for(var e=new Int32Array(t),i=0;i<t;i++)e[i]=this.readInt32();return e},e.MP4BoxStream=r;var s=function(t,e,i){this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new ArrayBuffer(t||0),this.position=0,this.endianness=null==i?s.LITTLE_ENDIAN:i};s.prototype={},s.prototype.getPosition=function(){return this.position},s.prototype._realloc=function(t){if(this._dynamicSize){var e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i)e>this._byteLength&&(this._byteLength=e);else{for(i<1&&(i=1);e>i;)i*=2;var r=new ArrayBuffer(i),s=new Uint8Array(this._buffer);new Uint8Array(r,0,s.length).set(s),this.buffer=r,this._byteLength=e}}},s.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var t=new ArrayBuffer(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}},s.BIG_ENDIAN=!1,s.LITTLE_ENDIAN=!0,s.prototype._byteLength=0,Object.defineProperty(s.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(s.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(t){this._buffer=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(s.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(s.prototype,"dataView",{get:function(){return this._dataView},set:function(t){this._byteOffset=t.byteOffset,this._buffer=t.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}}),s.prototype.seek=function(t){var e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e},s.prototype.isEof=function(){return this.position>=this._byteLength},s.prototype.mapUint8Array=function(t){this._realloc(1*t);var e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},s.prototype.readInt32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Int32Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readInt16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Int16Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readInt8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Int8Array(t);return s.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},s.prototype.readUint32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Uint32Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readUint16Array=function(t,e){t=null==t?this.byteLength-this.position/2:t;var i=new Uint16Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readUint8Array=function(t){t=null==t?this.byteLength-this.position:t;var e=new Uint8Array(t);return s.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e},s.prototype.readFloat64Array=function(t,e){t=null==t?this.byteLength-this.position/8:t;var i=new Float64Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readFloat32Array=function(t,e){t=null==t?this.byteLength-this.position/4:t;var i=new Float32Array(t);return s.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),s.arrayToNative(i,null==e?this.endianness:e),this.position+=i.byteLength,i},s.prototype.readInt32=function(t){var e=this._dataView.getInt32(this.position,null==t?this.endianness:t);return this.position+=4,e},s.prototype.readInt16=function(t){var e=this._dataView.getInt16(this.position,null==t?this.endianness:t);return this.position+=2,e},s.prototype.readInt8=function(){var t=this._dataView.getInt8(this.position);return this.position+=1,t},s.prototype.readUint32=function(t){var e=this._dataView.getUint32(this.position,null==t?this.endianness:t);return this.position+=4,e},s.prototype.readUint16=function(t){var e=this._dataView.getUint16(this.position,null==t?this.endianness:t);return this.position+=2,e},s.prototype.readUint8=function(){var t=this._dataView.getUint8(this.position);return this.position+=1,t},s.prototype.readFloat32=function(t){var e=this._dataView.getFloat32(this.position,null==t?this.endianness:t);return this.position+=4,e},s.prototype.readFloat64=function(t){var e=this._dataView.getFloat64(this.position,null==t?this.endianness:t);return this.position+=8,e},s.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,s.memcpy=function(t,e,i,r,s){var n=new Uint8Array(t,e,s),a=new Uint8Array(i,r,s);n.set(a)},s.arrayToNative=function(t,e){return e==this.endianness?t:this.flipArrayEndianness(t)},s.nativeToEndian=function(t,e){return this.endianness==e?t:this.flipArrayEndianness(t)},s.flipArrayEndianness=function(t){for(var e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(var r=i+t.BYTES_PER_ELEMENT-1,s=i;r>s;r--,s++){var n=e[s];e[s]=e[r],e[r]=n}return t},s.prototype.failurePosition=0,String.fromCharCodeUint8=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return String.fromCharCode.apply(null,e)},s.prototype.readString=function(t,e){return null==e||"ASCII"==e?String.fromCharCodeUint8.apply(null,[this.mapUint8Array(null==t?this.byteLength-this.position:t)]):new TextDecoder(e).decode(this.mapUint8Array(t))},s.prototype.readCString=function(t){var e=this.byteLength-this.position,i=new Uint8Array(this._buffer,this._byteOffset+this.position),r=e;null!=t&&(r=Math.min(t,e));for(var s=0;s<r&&0!==i[s];s++);var n=String.fromCharCodeUint8.apply(null,[this.mapUint8Array(s)]);return null!=t?this.position+=r-s:s!=e&&(this.position+=1),n};var n=Math.pow(2,32);s.prototype.readInt64=function(){return this.readInt32()*n+this.readUint32()},s.prototype.readUint64=function(){return this.readUint32()*n+this.readUint32()},s.prototype.readInt64=function(){return this.readUint32()*n+this.readUint32()},s.prototype.readUint24=function(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()},e.DataStream=s,s.prototype.save=function(t){var e=new Blob([this.buffer]);if(!window.URL||!URL.createObjectURL)throw"DataStream.save: Can't create object URL.";var i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",i),r.setAttribute("download",t),r.setAttribute("target","_self"),r.click(),window.URL.revokeObjectURL(i)},s.prototype._dynamicSize=!0,Object.defineProperty(s.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(t){t||this._trimAlloc(),this._dynamicSize=t}}),s.prototype.shift=function(t){var e=new ArrayBuffer(this._byteLength-t),i=new Uint8Array(e),r=new Uint8Array(this._buffer,t,i.length);i.set(r),this.buffer=e,this.position-=t},s.prototype.writeInt32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt32(t[i],e)},s.prototype.writeInt16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeInt16(t[i],e)},s.prototype.writeInt8Array=function(t){if(this._realloc(1*t.length),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(var e=0;e<t.length;e++)this.writeInt8(t[e])},s.prototype.writeUint32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint32(t[i],e)},s.prototype.writeUint16Array=function(t,e){if(this._realloc(2*t.length),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeUint16(t[i],e)},s.prototype.writeUint8Array=function(t){if(this._realloc(1*t.length),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(var e=0;e<t.length;e++)this.writeUint8(t[e])},s.prototype.writeFloat64Array=function(t,e){if(this._realloc(8*t.length),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat64(t[i],e)},s.prototype.writeFloat32Array=function(t,e){if(this._realloc(4*t.length),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)s.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(var i=0;i<t.length;i++)this.writeFloat32(t[i],e)},s.prototype.writeInt32=function(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,null==e?this.endianness:e),this.position+=4},s.prototype.writeInt16=function(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,null==e?this.endianness:e),this.position+=2},s.prototype.writeInt8=function(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1},s.prototype.writeUint32=function(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,null==e?this.endianness:e),this.position+=4},s.prototype.writeUint16=function(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,null==e?this.endianness:e),this.position+=2},s.prototype.writeUint8=function(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1},s.prototype.writeFloat32=function(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,null==e?this.endianness:e),this.position+=4},s.prototype.writeFloat64=function(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,null==e?this.endianness:e),this.position+=8},s.prototype.writeUCS2String=function(t,e,i){null==i&&(i=t.length);for(var r=0;r<t.length&&r<i;r++)this.writeUint16(t.charCodeAt(r),e);for(;r<i;r++)this.writeUint16(0)},s.prototype.writeString=function(t,e,i){var r=0;if(null==e||"ASCII"==e)if(null!=i){var s=Math.min(t.length,i);for(r=0;r<s;r++)this.writeUint8(t.charCodeAt(r));for(;r<i;r++)this.writeUint8(0)}else for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))},s.prototype.writeCString=function(t,e){var i=0;if(null!=e){var r=Math.min(t.length,e);for(i=0;i<r;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}},s.prototype.writeStruct=function(t,e){for(var i=0;i<t.length;i+=2){var r=t[i+1];this.writeType(r,e[t[i]],e)}},s.prototype.writeType=function(t,e,i){var r;if("function"==typeof t)return t(this,e);if("object"==typeof t&&!(t instanceof Array))return t.set(this,e,i);var n=null,a="ASCII",o=this.position;switch("string"==typeof t&&/:/.test(t)&&(r=t.split(":"),t=r[0],n=parseInt(r[1])),"string"==typeof t&&/,/.test(t)&&(r=t.split(","),t=r[0],a=parseInt(r[1])),t){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,s.BIG_ENDIAN);break;case"int16be":this.writeInt16(e,s.BIG_ENDIAN);break;case"uint32be":this.writeUint32(e,s.BIG_ENDIAN);break;case"int32be":this.writeInt32(e,s.BIG_ENDIAN);break;case"float32be":this.writeFloat32(e,s.BIG_ENDIAN);break;case"float64be":this.writeFloat64(e,s.BIG_ENDIAN);break;case"uint16le":this.writeUint16(e,s.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(e,s.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(e,s.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(e,s.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(e,s.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(e,s.LITTLE_ENDIAN);break;case"cstring":this.writeCString(e,n);break;case"string":this.writeString(e,a,n);break;case"u16string":this.writeUCS2String(e,this.endianness,n);break;case"u16stringle":this.writeUCS2String(e,s.LITTLE_ENDIAN,n);break;case"u16stringbe":this.writeUCS2String(e,s.BIG_ENDIAN,n);break;default:if(3==t.length){for(var l=t[1],h=0;h<e.length;h++)this.writeType(l,e[h]);break}this.writeStruct(t,e)}null!=n&&(this.position=o,this._realloc(n),this.position=o+n)},s.prototype.writeUint64=function(t){var e=Math.floor(t/n);this.writeUint32(e),this.writeUint32(4294967295&t)},s.prototype.writeUint24=function(t){this.writeUint8((16711680&t)>>16),this.writeUint8((65280&t)>>8),this.writeUint8(255&t)},s.prototype.adjustUint32=function(t,e){var i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)},s.prototype.mapInt32Array=function(t,e){this._realloc(4*t);var i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},s.prototype.mapInt16Array=function(t,e){this._realloc(2*t);var i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},s.prototype.mapInt8Array=function(t){this._realloc(1*t);var e=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=1*t,e},s.prototype.mapUint32Array=function(t,e){this._realloc(4*t);var i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i},s.prototype.mapUint16Array=function(t,e){this._realloc(2*t);var i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=2*t,i},s.prototype.mapFloat64Array=function(t,e){this._realloc(8*t);var i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=8*t,i},s.prototype.mapFloat32Array=function(t,e){this._realloc(4*t);var i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return s.arrayToNative(i,null==e?this.endianness:e),this.position+=4*t,i};var a=function(t){this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)};(a.prototype=new s(new ArrayBuffer,0,s.BIG_ENDIAN)).initialized=function(){var t;return this.bufferIndex>-1||(this.buffers.length>0?0===(t=this.buffers[0]).fileStart?(this.buffer=t,this.bufferIndex=0,i.debug("MultiBufferStream","Stream ready for parsing"),!0):(i.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1):(i.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1))},ArrayBuffer.concat=function(t,e){i.debug("ArrayBuffer","Trying to create a new buffer of size: "+(t.byteLength+e.byteLength));var r=new Uint8Array(t.byteLength+e.byteLength);return r.set(new Uint8Array(t),0),r.set(new Uint8Array(e),t.byteLength),r.buffer},a.prototype.reduceBuffer=function(t,e,i){var r;return(r=new Uint8Array(i)).set(new Uint8Array(t,e,i)),r.buffer.fileStart=t.fileStart+e,r.buffer.usedBytes=0,r.buffer},a.prototype.insertBuffer=function(t){for(var e=!0,r=0;r<this.buffers.length;r++){var s=this.buffers[r];if(t.fileStart<=s.fileStart){if(t.fileStart===s.fileStart){if(t.byteLength>s.byteLength){this.buffers.splice(r,1),r--;continue}i.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring")}else t.fileStart+t.byteLength<=s.fileStart||(t=this.reduceBuffer(t,0,s.fileStart-t.fileStart)),i.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(r,0,t),0===r&&(this.buffer=t);e=!1;break}if(t.fileStart<s.fileStart+s.byteLength){var n=s.fileStart+s.byteLength-t.fileStart,a=t.byteLength-n;if(!(a>0)){e=!1;break}t=this.reduceBuffer(t,n,a)}}e&&(i.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),0===r&&(this.buffer=t))},a.prototype.logBufferLevel=function(t){var e,r,s,n,a,o=[],l="";for(s=0,n=0,e=0;e<this.buffers.length;e++)r=this.buffers[e],0===e?(a={},o.push(a),a.start=r.fileStart,a.end=r.fileStart+r.byteLength,l+="["+a.start+"-"):a.end===r.fileStart?a.end=r.fileStart+r.byteLength:((a={}).start=r.fileStart,l+=o[o.length-1].end-1+"], ["+a.start+"-",a.end=r.fileStart+r.byteLength,o.push(a)),s+=r.usedBytes,n+=r.byteLength;o.length>0&&(l+=a.end-1+"]");var h=t?i.info:i.debug;0===this.buffers.length?h("MultiBufferStream","No more buffer in memory"):h("MultiBufferStream",this.buffers.length+" stored buffer(s) ("+s+"/"+n+" bytes), continuous ranges: "+l)},a.prototype.cleanBuffers=function(){var t,e;for(t=0;t<this.buffers.length;t++)(e=this.buffers[t]).usedBytes===e.byteLength&&(i.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)},a.prototype.mergeNextBuffer=function(){var t;if(this.bufferIndex+1<this.buffers.length){if((t=this.buffers[this.bufferIndex+1]).fileStart===this.buffer.fileStart+this.buffer.byteLength){var e=this.buffer.byteLength,r=this.buffer.usedBytes,s=this.buffer.fileStart;return this.buffers[this.bufferIndex]=ArrayBuffer.concat(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=r,this.buffer.fileStart=s,i.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}return!1}return!1},a.prototype.findPosition=function(t,e,r){var s,n=null,a=-1;for(s=!0===t?0:this.bufferIndex;s<this.buffers.length&&(n=this.buffers[s]).fileStart<=e;)a=s,r&&(n.fileStart+n.byteLength<=e?n.usedBytes=n.byteLength:n.usedBytes=e-n.fileStart,this.logBufferLevel()),s++;return-1!==a&&(n=this.buffers[a]).fileStart+n.byteLength>=e?(i.debug("MultiBufferStream","Found position in existing buffer #"+a),a):-1},a.prototype.findEndContiguousBuf=function(t){var e,i,r,s=void 0!==t?t:this.bufferIndex;if(i=this.buffers[s],this.buffers.length>s+1)for(e=s+1;e<this.buffers.length&&(r=this.buffers[e]).fileStart===i.fileStart+i.byteLength;e++)i=r;return i.fileStart+i.byteLength},a.prototype.getEndFilePositionAfter=function(t){var e=this.findPosition(!0,t,!1);return-1!==e?this.findEndContiguousBuf(e):t},a.prototype.addUsedBytes=function(t){this.buffer.usedBytes+=t,this.logBufferLevel()},a.prototype.setAllUsedBytes=function(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()},a.prototype.seek=function(t,e,r){var s;return-1!==(s=this.findPosition(e,t,r))?(this.buffer=this.buffers[s],this.bufferIndex=s,this.position=t-this.buffer.fileStart,i.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(i.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)},a.prototype.getPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.position},a.prototype.getLength=function(){return this.byteLength},a.prototype.getEndPosition=function(){if(-1===this.bufferIndex||null===this.buffers[this.bufferIndex])throw"Error accessing position in the MultiBufferStream";return this.buffers[this.bufferIndex].fileStart+this.byteLength},e.MultiBufferStream=a;var o=function(){var t=[];t[3]="ES_Descriptor",t[4]="DecoderConfigDescriptor",t[5]="DecoderSpecificInfo",t[6]="SLConfigDescriptor",this.getDescriptorName=function(e){return t[e]};var e=this,r={};return this.parseOneDescriptor=function(e){var s,n,a,o=0;for(s=e.readUint8(),a=e.readUint8();128&a;)o=(127&a)<<7,a=e.readUint8();return o+=127&a,i.debug("MPEG4DescriptorParser","Found "+(t[s]||"Descriptor "+s)+", size "+o+" at position "+e.getPosition()),(n=t[s]?new r[t[s]](o):new r.Descriptor(o)).parse(e),n},r.Descriptor=function(t,e){this.tag=t,this.size=e,this.descs=[]},r.Descriptor.prototype.parse=function(t){this.data=t.readUint8Array(this.size)},r.Descriptor.prototype.findDescriptor=function(t){for(var e=0;e<this.descs.length;e++)if(this.descs[e].tag==t)return this.descs[e];return null},r.Descriptor.prototype.parseRemainingDescriptors=function(t){for(var i=t.position;t.position<i+this.size;){var r=e.parseOneDescriptor(t);this.descs.push(r)}},r.ES_Descriptor=function(t){r.Descriptor.call(this,3,t)},r.ES_Descriptor.prototype=new r.Descriptor,r.ES_Descriptor.prototype.parse=function(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,128&this.flags?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,64&this.flags){var e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";32&this.flags?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)},r.ES_Descriptor.prototype.getOTI=function(t){var e=this.findDescriptor(4);return e?e.oti:0},r.ES_Descriptor.prototype.getAudioConfig=function(t){var e=this.findDescriptor(4);if(!e)return null;var i=e.findDescriptor(5);if(i&&i.data){var r=(248&i.data[0])>>3;return 31===r&&i.data.length>=2&&(r=32+((7&i.data[0])<<3)+((224&i.data[1])>>5)),r}return null},r.DecoderConfigDescriptor=function(t){r.Descriptor.call(this,4,t)},r.DecoderConfigDescriptor.prototype=new r.Descriptor,r.DecoderConfigDescriptor.prototype.parse=function(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)},r.DecoderSpecificInfo=function(t){r.Descriptor.call(this,5,t)},r.DecoderSpecificInfo.prototype=new r.Descriptor,r.SLConfigDescriptor=function(t){r.Descriptor.call(this,6,t)},r.SLConfigDescriptor.prototype=new r.Descriptor,this};e.MPEG4DescriptorParser=o;var l={ERR_INVALID_DATA:-1,ERR_NOT_ENOUGH_DATA:0,OK:1,BASIC_BOXES:["mdat","idat","free","skip","meco","strk"],FULL_BOXES:["hmhd","nmhd","iods","xml ","bxml","ipro","mere"],CONTAINER_BOXES:[["moov",["trak","pssh"]],["trak"],["edts"],["mdia"],["minf"],["dinf"],["stbl",["sgpd","sbgp"]],["mvex",["trex"]],["moof",["traf"]],["traf",["trun","sgpd","sbgp"]],["vttc"],["tref"],["iref"],["mfra",["tfra"]],["meco"],["hnti"],["hinf"],["strk"],["strd"],["sinf"],["rinf"],["schi"],["trgr"],["udta",["kind"]],["iprp",["ipma"]],["ipco"]],boxCodes:[],fullBoxCodes:[],containerBoxCodes:[],sampleEntryCodes:{},sampleGroupEntryCodes:[],trackGroupTypes:[],UUIDBoxes:{},UUIDs:[],initialize:function(){l.FullBox.prototype=new l.Box,l.ContainerBox.prototype=new l.Box,l.SampleEntry.prototype=new l.Box,l.TrackGroupTypeBox.prototype=new l.FullBox,l.BASIC_BOXES.forEach((function(t){l.createBoxCtor(t)})),l.FULL_BOXES.forEach((function(t){l.createFullBoxCtor(t)})),l.CONTAINER_BOXES.forEach((function(t){l.createContainerBoxCtor(t[0],null,t[1])}))},Box:function(t,e,i){this.type=t,this.size=e,this.uuid=i},FullBox:function(t,e,i){l.Box.call(this,t,e,i),this.flags=0,this.version=0},ContainerBox:function(t,e,i){l.Box.call(this,t,e,i),this.boxes=[]},SampleEntry:function(t,e,i,r){l.ContainerBox.call(this,t,e),this.hdr_size=i,this.start=r},SampleGroupEntry:function(t){this.grouping_type=t},TrackGroupTypeBox:function(t,e){l.FullBox.call(this,t,e)},createBoxCtor:function(t,e){l.boxCodes.push(t),l[t+"Box"]=function(e){l.Box.call(this,t,e)},l[t+"Box"].prototype=new l.Box,e&&(l[t+"Box"].prototype.parse=e)},createFullBoxCtor:function(t,e){l[t+"Box"]=function(e){l.FullBox.call(this,t,e)},l[t+"Box"].prototype=new l.FullBox,l[t+"Box"].prototype.parse=function(t){this.parseFullHeader(t),e&&e.call(this,t)}},addSubBoxArrays:function(t){if(t){this.subBoxNames=t;for(var e=t.length,i=0;i<e;i++)this[t[i]+"s"]=[]}},createContainerBoxCtor:function(t,e,i){l[t+"Box"]=function(e){l.ContainerBox.call(this,t,e),l.addSubBoxArrays.call(this,i)},l[t+"Box"].prototype=new l.ContainerBox,e&&(l[t+"Box"].prototype.parse=e)},createMediaSampleEntryCtor:function(t,e,i){l.sampleEntryCodes[t]=[],l[t+"SampleEntry"]=function(t,e){l.SampleEntry.call(this,t,e),l.addSubBoxArrays.call(this,i)},l[t+"SampleEntry"].prototype=new l.SampleEntry,e&&(l[t+"SampleEntry"].prototype.parse=e)},createSampleEntryCtor:function(t,e,i,r){l.sampleEntryCodes[t].push(e),l[e+"SampleEntry"]=function(i){l[t+"SampleEntry"].call(this,e,i),l.addSubBoxArrays.call(this,r)},l[e+"SampleEntry"].prototype=new l[t+"SampleEntry"],i&&(l[e+"SampleEntry"].prototype.parse=i)},createEncryptedSampleEntryCtor:function(t,e,i){l.createSampleEntryCtor.call(this,t,e,i,["sinf"])},createSampleGroupCtor:function(t,e){l[t+"SampleGroupEntry"]=function(e){l.SampleGroupEntry.call(this,t,e)},l[t+"SampleGroupEntry"].prototype=new l.SampleGroupEntry,e&&(l[t+"SampleGroupEntry"].prototype.parse=e)},createTrackGroupCtor:function(t,e){l[t+"TrackGroupTypeBox"]=function(e){l.TrackGroupTypeBox.call(this,t,e)},l[t+"TrackGroupTypeBox"].prototype=new l.TrackGroupTypeBox,e&&(l[t+"TrackGroupTypeBox"].prototype.parse=e)},createUUIDBox:function(t,e,i,r){l.UUIDs.push(t),l.UUIDBoxes[t]=function(r){e?l.FullBox.call(this,"uuid",r,t):i?l.ContainerBox.call(this,"uuid",r,t):l.Box.call(this,"uuid",r,t)},l.UUIDBoxes[t].prototype=e?new l.FullBox:i?new l.ContainerBox:new l.Box,r&&(l.UUIDBoxes[t].prototype.parse=e?function(t){this.parseFullHeader(t),r&&r.call(this,t)}:r)}};l.initialize(),l.TKHD_FLAG_ENABLED=1,l.TKHD_FLAG_IN_MOVIE=2,l.TKHD_FLAG_IN_PREVIEW=4,l.TFHD_FLAG_BASE_DATA_OFFSET=1,l.TFHD_FLAG_SAMPLE_DESC=2,l.TFHD_FLAG_SAMPLE_DUR=8,l.TFHD_FLAG_SAMPLE_SIZE=16,l.TFHD_FLAG_SAMPLE_FLAGS=32,l.TFHD_FLAG_DUR_EMPTY=65536,l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF=131072,l.TRUN_FLAGS_DATA_OFFSET=1,l.TRUN_FLAGS_FIRST_FLAG=4,l.TRUN_FLAGS_DURATION=256,l.TRUN_FLAGS_SIZE=512,l.TRUN_FLAGS_FLAGS=1024,l.TRUN_FLAGS_CTS_OFFSET=2048,l.Box.prototype.add=function(t){return this.addBox(new l[t+"Box"])},l.Box.prototype.addBox=function(t){return this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t},l.Box.prototype.set=function(t,e){return this[t]=e,this},l.Box.prototype.addEntry=function(t,e){var i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this},e.BoxParser=l,l.parseUUID=function(t){return l.parseHex16(t)},l.parseHex16=function(t){for(var e="",i=0;i<16;i++){var r=t.readUint8().toString(16);e+=1===r.length?"0"+r:r}return e},l.parseOneBox=function(t,e,r){var s,n,a,o=t.getPosition(),h=0;if(t.getEndPosition()-o<8)return i.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:l.ERR_NOT_ENOUGH_DATA};if(r&&r<8)return i.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:l.ERR_NOT_ENOUGH_DATA};var d=t.readUint32(),c=t.readString(4),u=c;if(i.debug("BoxParser","Found box of type '"+c+"' and size "+d+" at position "+o),h=8,"uuid"==c){if(t.getEndPosition()-t.getPosition()<16||r-h<16)return t.seek(o),i.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:l.ERR_NOT_ENOUGH_DATA};h+=16,u=a=l.parseUUID(t)}if(1==d){if(t.getEndPosition()-t.getPosition()<8||r&&r-h<8)return t.seek(o),i.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+c+'" box'),{code:l.ERR_NOT_ENOUGH_DATA};d=t.readUint64(),h+=8}else if(0===d)if(r)d=r;else if("mdat"!==c)return i.error("BoxParser","Unlimited box size not supported for type: '"+c+"'"),s=new l.Box(c,d),{code:l.OK,box:s,size:s.size};return 0!==d&&d<h?(i.error("BoxParser","Box of type "+c+" has an invalid size "+d+" (too small to be a box)"),{code:l.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:h,start:o}):0!==d&&r&&d>r?(i.error("BoxParser","Box of type '"+c+"' has a size "+d+" greater than its container size "+r),{code:l.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:h,start:o}):0!==d&&o+d>t.getEndPosition()?(t.seek(o),i.info("BoxParser","Not enough data in stream to parse the entire '"+c+"' box"),{code:l.ERR_NOT_ENOUGH_DATA,type:c,size:d,hdr_size:h,start:o}):e?{code:l.OK,type:c,size:d,hdr_size:h,start:o}:(l[c+"Box"]?s=new l[c+"Box"](d):"uuid"!==c?(i.warn("BoxParser","Unknown box type: '"+c+"'"),(s=new l.Box(c,d)).has_unparsed_data=!0):l.UUIDBoxes[a]?s=new l.UUIDBoxes[a](d):(i.warn("BoxParser","Unknown uuid type: '"+a+"'"),(s=new l.Box(c,d)).uuid=a,s.has_unparsed_data=!0),s.hdr_size=h,s.start=o,s.write===l.Box.prototype.write&&"mdat"!==s.type&&(i.info("BoxParser","'"+u+"' box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(t)),s.parse(t),(n=t.getPosition()-(s.start+s.size))<0?(i.warn("BoxParser","Parsing of box '"+u+"' did not read the entire indicated box data size (missing "+-n+" bytes), seeking forward"),t.seek(s.start+s.size)):n>0&&(i.error("BoxParser","Parsing of box '"+u+"' read "+n+" more bytes than the indicated box data size, seeking backwards"),0!==s.size&&t.seek(s.start+s.size)),{code:l.OK,box:s,size:s.size})},l.Box.prototype.parse=function(t){"mdat"!=this.type?this.data=t.readUint8Array(this.size-this.hdr_size):0===this.size?t.seek(t.getEndPosition()):t.seek(this.start+this.size)},l.Box.prototype.parseDataAndRewind=function(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.position-=this.size-this.hdr_size},l.FullBox.prototype.parseDataAndRewind=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,t.position-=this.size-this.hdr_size},l.FullBox.prototype.parseFullHeader=function(t){this.version=t.readUint8(),this.flags=t.readUint24(),this.hdr_size+=4},l.FullBox.prototype.parse=function(t){this.parseFullHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},l.ContainerBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;if(r=e.box,this.boxes.push(r),this.subBoxNames&&-1!=this.subBoxNames.indexOf(r.type))this[this.subBoxNames[this.subBoxNames.indexOf(r.type)]+"s"].push(r);else{var s="uuid"!==r.type?r.type:r.uuid;this[s]?i.warn("Box of type "+s+" already stored in field of this type"):this[s]=r}}},l.Box.prototype.parseLanguage=function(t){this.language=t.readUint16();var e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=31&this.language,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)},l.SAMPLE_ENTRY_TYPE_VISUAL="Visual",l.SAMPLE_ENTRY_TYPE_AUDIO="Audio",l.SAMPLE_ENTRY_TYPE_HINT="Hint",l.SAMPLE_ENTRY_TYPE_METADATA="Metadata",l.SAMPLE_ENTRY_TYPE_SUBTITLE="Subtitle",l.SAMPLE_ENTRY_TYPE_SYSTEM="System",l.SAMPLE_ENTRY_TYPE_TEXT="Text",l.SampleEntry.prototype.parseHeader=function(t){t.readUint8Array(6),this.data_reference_index=t.readUint16(),this.hdr_size+=8},l.SampleEntry.prototype.parse=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size)},l.SampleEntry.prototype.parseDataAndRewind=function(t){this.parseHeader(t),this.data=t.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,t.position-=this.size-this.hdr_size},l.SampleEntry.prototype.parseFooter=function(t){l.ContainerBox.prototype.parse.call(this,t)},l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_HINT),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_METADATA),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SYSTEM),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_TEXT),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,(function(t){var e;this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16(),e=Math.min(31,t.readUint8()),this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)})),l.createMediaSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,(function(t){this.parseHeader(t),t.readUint32Array(2),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"avc1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"avc2"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"avc3"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"avc4"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"av01"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"hvc1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"hev1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vvc1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vvi1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vvs1"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vvcN"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vp08"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"vp09"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,"mp4a"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,"ac-3"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,"ec-3"),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,"Opus"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_VISUAL,"encv"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_AUDIO,"enca"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE,"encu"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SYSTEM,"encs"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_TEXT,"enct"),l.createEncryptedSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_METADATA,"encm"),l.createBoxCtor("a1lx",(function(t){var e=16*(1+(1&(1&t.readUint8())));this.layer_size=[];for(var i=0;i<3;i++)this.layer_size[i]=16==e?t.readUint16():t.readUint32()})),l.createBoxCtor("a1op",(function(t){this.op_index=t.readUint8()})),l.createFullBoxCtor("auxC",(function(t){this.aux_type=t.readCString();var e=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=t.readUint8Array(e)})),l.createBoxCtor("av1C",(function(t){var e=t.readUint8();if(e>>7&!1)i.error("av1C marker problem");else if(this.version=127&e,1===this.version)if(e=t.readUint8(),this.seq_profile=e>>5&7,this.seq_level_idx_0=31&e,e=t.readUint8(),this.seq_tier_0=e>>7&1,this.high_bitdepth=e>>6&1,this.twelve_bit=e>>5&1,this.monochrome=e>>4&1,this.chroma_subsampling_x=e>>3&1,this.chroma_subsampling_y=e>>2&1,this.chroma_sample_position=3&e,e=t.readUint8(),this.reserved_1=e>>5&7,0===this.reserved_1){if(this.initial_presentation_delay_present=e>>4&1,1===this.initial_presentation_delay_present)this.initial_presentation_delay_minus_one=15&e;else if(this.reserved_2=15&e,0!==this.reserved_2)return void i.error("av1C reserved_2 parsing problem");var r=this.size-this.hdr_size-4;this.configOBUs=t.readUint8Array(r)}else i.error("av1C reserved_1 parsing problem");else i.error("av1C version "+this.version+" not supported")})),l.createBoxCtor("avcC",(function(t){var e,i;for(this.configurationVersion=t.readUint8(),this.AVCProfileIndication=t.readUint8(),this.profile_compatibility=t.readUint8(),this.AVCLevelIndication=t.readUint8(),this.lengthSizeMinusOne=3&t.readUint8(),this.nb_SPS_nalus=31&t.readUint8(),i=this.size-this.hdr_size-6,this.SPS=[],e=0;e<this.nb_SPS_nalus;e++)this.SPS[e]={},this.SPS[e].length=t.readUint16(),this.SPS[e].nalu=t.readUint8Array(this.SPS[e].length),i-=2+this.SPS[e].length;for(this.nb_PPS_nalus=t.readUint8(),i--,this.PPS=[],e=0;e<this.nb_PPS_nalus;e++)this.PPS[e]={},this.PPS[e].length=t.readUint16(),this.PPS[e].nalu=t.readUint8Array(this.PPS[e].length),i-=2+this.PPS[e].length;i>0&&(this.ext=t.readUint8Array(i))})),l.createBoxCtor("btrt",(function(t){this.bufferSizeDB=t.readUint32(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32()})),l.createBoxCtor("clap",(function(t){this.cleanApertureWidthN=t.readUint32(),this.cleanApertureWidthD=t.readUint32(),this.cleanApertureHeightN=t.readUint32(),this.cleanApertureHeightD=t.readUint32(),this.horizOffN=t.readUint32(),this.horizOffD=t.readUint32(),this.vertOffN=t.readUint32(),this.vertOffD=t.readUint32()})),l.createBoxCtor("clli",(function(t){this.max_content_light_level=t.readUint16(),this.max_pic_average_light_level=t.readUint16()})),l.createFullBoxCtor("co64",(function(t){var e,i;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(i=0;i<e;i++)this.chunk_offsets.push(t.readUint64())})),l.createFullBoxCtor("CoLL",(function(t){this.maxCLL=t.readUint16(),this.maxFALL=t.readUint16()})),l.createBoxCtor("colr",(function(t){if(this.colour_type=t.readString(4),"nclx"===this.colour_type){this.colour_primaries=t.readUint16(),this.transfer_characteristics=t.readUint16(),this.matrix_coefficients=t.readUint16();var e=t.readUint8();this.full_range_flag=e>>7}else("rICC"===this.colour_type||"prof"===this.colour_type)&&(this.ICC_profile=t.readUint8Array(this.size-4))})),l.createFullBoxCtor("cprt",(function(t){this.parseLanguage(t),this.notice=t.readCString()})),l.createFullBoxCtor("cslg",(function(t){0===this.version&&(this.compositionToDTSShift=t.readInt32(),this.leastDecodeToDisplayDelta=t.readInt32(),this.greatestDecodeToDisplayDelta=t.readInt32(),this.compositionStartTime=t.readInt32(),this.compositionEndTime=t.readInt32())})),l.createFullBoxCtor("ctts",(function(t){var e,r;if(e=t.readUint32(),this.sample_counts=[],this.sample_offsets=[],0===this.version)for(r=0;r<e;r++){this.sample_counts.push(t.readUint32());var s=t.readInt32();s<0&&i.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(1==this.version)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),this.sample_offsets.push(t.readInt32())})),l.createBoxCtor("dac3",(function(t){var e=t.readUint8(),i=t.readUint8(),r=t.readUint8();this.fscod=e>>6,this.bsid=e>>1&31,this.bsmod=(1&e)<<2|i>>6&3,this.acmod=i>>3&7,this.lfeon=i>>2&1,this.bit_rate_code=3&i|r>>5&7})),l.createBoxCtor("dec3",(function(t){var e=t.readUint16();this.data_rate=e>>3,this.num_ind_sub=7&e,this.ind_subs=[];for(var i=0;i<this.num_ind_sub+1;i++){var r={};this.ind_subs.push(r);var s=t.readUint8(),n=t.readUint8(),a=t.readUint8();r.fscod=s>>6,r.bsid=s>>1&31,r.bsmod=(1&s)<<4|n>>4&15,r.acmod=n>>1&7,r.lfeon=1&n,r.num_dep_sub=a>>1&15,r.num_dep_sub>0&&(r.chan_loc=(1&a)<<8|t.readUint8())}})),l.createFullBoxCtor("dfLa",(function(t){var e=[],i=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"];for(this.parseFullHeader(t);;){var r=t.readUint8(),s=Math.min(127&r,i.length-1);if(s?t.readUint8Array(t.readUint24()):(t.readUint8Array(13),this.samplerate=t.readUint32()>>12,t.readUint8Array(20)),e.push(i[s]),128&r)break}this.numMetadataBlocks=e.length+" ("+e.join(", ")+")"})),l.createBoxCtor("dimm",(function(t){this.bytessent=t.readUint64()})),l.createBoxCtor("dmax",(function(t){this.time=t.readUint32()})),l.createBoxCtor("dmed",(function(t){this.bytessent=t.readUint64()})),l.createBoxCtor("dOps",(function(t){if(this.Version=t.readUint8(),this.OutputChannelCount=t.readUint8(),this.PreSkip=t.readUint16(),this.InputSampleRate=t.readUint32(),this.OutputGain=t.readInt16(),this.ChannelMappingFamily=t.readUint8(),0!==this.ChannelMappingFamily){this.StreamCount=t.readUint8(),this.CoupledCount=t.readUint8(),this.ChannelMapping=[];for(var e=0;e<this.OutputChannelCount;e++)this.ChannelMapping[e]=t.readUint8()}})),l.createFullBoxCtor("dref",(function(t){var e,i;this.entries=[];for(var r=t.readUint32(),s=0;s<r;s++){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;i=e.box,this.entries.push(i)}})),l.createBoxCtor("drep",(function(t){this.bytessent=t.readUint64()})),l.createFullBoxCtor("elng",(function(t){this.extended_language=t.readString(this.size-this.hdr_size)})),l.createFullBoxCtor("elst",(function(t){this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.entries.push(r),1===this.version?(r.segment_duration=t.readUint64(),r.media_time=t.readInt64()):(r.segment_duration=t.readUint32(),r.media_time=t.readInt32()),r.media_rate_integer=t.readInt16(),r.media_rate_fraction=t.readInt16()}})),l.createFullBoxCtor("emsg",(function(t){1==this.version?(this.timescale=t.readUint32(),this.presentation_time=t.readUint64(),this.event_duration=t.readUint32(),this.id=t.readUint32(),this.scheme_id_uri=t.readCString(),this.value=t.readCString()):(this.scheme_id_uri=t.readCString(),this.value=t.readCString(),this.timescale=t.readUint32(),this.presentation_time_delta=t.readUint32(),this.event_duration=t.readUint32(),this.id=t.readUint32());var e=this.size-this.hdr_size-(16+(this.scheme_id_uri.length+1)+(this.value.length+1));1==this.version&&(e-=4),this.message_data=t.readUint8Array(e)})),l.createFullBoxCtor("esds",(function(t){var e=t.readUint8Array(this.size-this.hdr_size);if(void 0!==o){var i=new o;this.esd=i.parseOneDescriptor(new s(e.buffer,0,s.BIG_ENDIAN))}})),l.createBoxCtor("fiel",(function(t){this.fieldCount=t.readUint8(),this.fieldOrdering=t.readUint8()})),l.createBoxCtor("frma",(function(t){this.data_format=t.readString(4)})),l.createBoxCtor("ftyp",(function(t){var e=this.size-this.hdr_size;this.major_brand=t.readString(4),this.minor_version=t.readUint32(),e-=8,this.compatible_brands=[];for(var i=0;e>=4;)this.compatible_brands[i]=t.readString(4),e-=4,i++})),l.createFullBoxCtor("hdlr",(function(t){0===this.version&&(t.readUint32(),this.handler=t.readString(4),t.readUint32Array(3),this.name=t.readString(this.size-this.hdr_size-20),"\0"===this.name[this.name.length-1]&&(this.name=this.name.slice(0,-1)))})),l.createBoxCtor("hvcC",(function(t){var e,i,r,s;this.configurationVersion=t.readUint8(),s=t.readUint8(),this.general_profile_space=s>>6,this.general_tier_flag=(32&s)>>5,this.general_profile_idc=31&s,this.general_profile_compatibility=t.readUint32(),this.general_constraint_indicator=t.readUint8Array(6),this.general_level_idc=t.readUint8(),this.min_spatial_segmentation_idc=4095&t.readUint16(),this.parallelismType=3&t.readUint8(),this.chroma_format_idc=3&t.readUint8(),this.bit_depth_luma_minus8=7&t.readUint8(),this.bit_depth_chroma_minus8=7&t.readUint8(),this.avgFrameRate=t.readUint16(),s=t.readUint8(),this.constantFrameRate=s>>6,this.numTemporalLayers=(13&s)>>3,this.temporalIdNested=(4&s)>>2,this.lengthSizeMinusOne=3&s,this.nalu_arrays=[];var n=t.readUint8();for(e=0;e<n;e++){var a=[];this.nalu_arrays.push(a),s=t.readUint8(),a.completeness=(128&s)>>7,a.nalu_type=63&s;var o=t.readUint16();for(i=0;i<o;i++){var l={};a.push(l),r=t.readUint16(),l.data=t.readUint8Array(r)}}})),l.createFullBoxCtor("iinf",(function(t){var e;0===this.version?this.entry_count=t.readUint16():this.entry_count=t.readUint32(),this.item_infos=[];for(var r=0;r<this.entry_count;r++){if((e=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;"infe"!==e.box.type&&i.error("BoxParser","Expected 'infe' box, got "+e.box.type),this.item_infos[r]=e.box}})),l.createFullBoxCtor("iloc",(function(t){var e;e=t.readUint8(),this.offset_size=e>>4&15,this.length_size=15&e,e=t.readUint8(),this.base_offset_size=e>>4&15,1===this.version||2===this.version?this.index_size=15&e:this.index_size=0,this.items=[];var i=0;if(this.version<2)i=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";i=t.readUint32()}for(var r=0;r<i;r++){var s={};if(this.items.push(s),this.version<2)s.item_ID=t.readUint16();else{if(2!==this.version)throw"version of iloc box not supported";s.item_ID=t.readUint16()}switch(1===this.version||2===this.version?s.construction_method=15&t.readUint16():s.construction_method=0,s.data_reference_index=t.readUint16(),this.base_offset_size){case 0:s.base_offset=0;break;case 4:s.base_offset=t.readUint32();break;case 8:s.base_offset=t.readUint64();break;default:throw"Error reading base offset size"}var n=t.readUint16();s.extents=[];for(var a=0;a<n;a++){var o={};if(s.extents.push(o),1===this.version||2===this.version)switch(this.index_size){case 0:o.extent_index=0;break;case 4:o.extent_index=t.readUint32();break;case 8:o.extent_index=t.readUint64();break;default:throw"Error reading extent index"}switch(this.offset_size){case 0:o.extent_offset=0;break;case 4:o.extent_offset=t.readUint32();break;case 8:o.extent_offset=t.readUint64();break;default:throw"Error reading extent index"}switch(this.length_size){case 0:o.extent_length=0;break;case 4:o.extent_length=t.readUint32();break;case 8:o.extent_length=t.readUint64();break;default:throw"Error reading extent index"}}}})),l.createBoxCtor("imir",(function(t){var e=t.readUint8();this.reserved=e>>7,this.axis=1&e})),l.createFullBoxCtor("infe",(function(t){if(0!==this.version&&1!==this.version||(this.item_ID=t.readUint16(),this.item_protection_index=t.readUint16(),this.item_name=t.readCString(),this.content_type=t.readCString(),this.content_encoding=t.readCString()),1===this.version)return this.extension_type=t.readString(4),i.warn("BoxParser","Cannot parse extension type"),void t.seek(this.start+this.size);this.version>=2&&(2===this.version?this.item_ID=t.readUint16():3===this.version&&(this.item_ID=t.readUint32()),this.item_protection_index=t.readUint16(),this.item_type=t.readString(4),this.item_name=t.readCString(),"mime"===this.item_type?(this.content_type=t.readCString(),this.content_encoding=t.readCString()):"uri "===this.item_type&&(this.item_uri_type=t.readCString()))})),l.createFullBoxCtor("ipma",(function(t){var e,i;for(entry_count=t.readUint32(),this.associations=[],e=0;e<entry_count;e++){var r={};this.associations.push(r),this.version<1?r.id=t.readUint16():r.id=t.readUint32();var s=t.readUint8();for(r.props=[],i=0;i<s;i++){var n=t.readUint8(),a={};r.props.push(a),a.essential=(128&n)>>7==1,1&this.flags?a.property_index=(127&n)<<8|t.readUint8():a.property_index=127&n}}})),l.createFullBoxCtor("iref",(function(t){var e,r;for(this.references=[];t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;(r=0===this.version?new l.SingleItemTypeReferenceBox(e.type,e.size,e.hdr_size,e.start):new l.SingleItemTypeReferenceBoxLarge(e.type,e.size,e.hdr_size,e.start)).write===l.Box.prototype.write&&"mdat"!==r.type&&(i.warn("BoxParser",r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.references.push(r)}})),l.createBoxCtor("irot",(function(t){this.angle=3&t.readUint8()})),l.createFullBoxCtor("ispe",(function(t){this.image_width=t.readUint32(),this.image_height=t.readUint32()})),l.createFullBoxCtor("kind",(function(t){this.schemeURI=t.readCString(),this.value=t.readCString()})),l.createFullBoxCtor("leva",(function(t){var e=t.readUint8();this.levels=[];for(var r=0;r<e;r++){var s={};this.levels[r]=s,s.track_ID=t.readUint32();var n=t.readUint8();switch(s.padding_flag=n>>7,s.assignment_type=127&n,s.assignment_type){case 0:s.grouping_type=t.readString(4);break;case 1:s.grouping_type=t.readString(4),s.grouping_type_parameter=t.readUint32();break;case 2:case 3:break;case 4:s.sub_track_id=t.readUint32();break;default:i.warn("BoxParser","Unknown leva assignement type")}}})),l.createBoxCtor("lsel",(function(t){this.layer_id=t.readUint16()})),l.createBoxCtor("maxr",(function(t){this.period=t.readUint32(),this.bytes=t.readUint32()})),l.createBoxCtor("mdcv",(function(t){this.display_primaries=[],this.display_primaries[0]={},this.display_primaries[0].x=t.readUint16(),this.display_primaries[0].y=t.readUint16(),this.display_primaries[1]={},this.display_primaries[1].x=t.readUint16(),this.display_primaries[1].y=t.readUint16(),this.display_primaries[2]={},this.display_primaries[2].x=t.readUint16(),this.display_primaries[2].y=t.readUint16(),this.white_point={},this.white_point.x=t.readUint16(),this.white_point.y=t.readUint16(),this.max_display_mastering_luminance=t.readUint32(),this.min_display_mastering_luminance=t.readUint32()})),l.createFullBoxCtor("mdhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.parseLanguage(t),t.readUint16()})),l.createFullBoxCtor("mehd",(function(t){1&this.flags&&(i.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),1==this.version?this.fragment_duration=t.readUint64():this.fragment_duration=t.readUint32()})),l.createFullBoxCtor("meta",(function(t){this.boxes=[],l.ContainerBox.prototype.parse.call(this,t)})),l.createFullBoxCtor("mfhd",(function(t){this.sequence_number=t.readUint32()})),l.createFullBoxCtor("mfro",(function(t){this._size=t.readUint32()})),l.createFullBoxCtor("mvhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.timescale=t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.timescale=t.readUint32(),this.duration=t.readUint32()),this.rate=t.readUint32(),this.volume=t.readUint16()>>8,t.readUint16(),t.readUint32Array(2),this.matrix=t.readUint32Array(9),t.readUint32Array(6),this.next_track_id=t.readUint32()})),l.createBoxCtor("npck",(function(t){this.packetssent=t.readUint32()})),l.createBoxCtor("nump",(function(t){this.packetssent=t.readUint64()})),l.createFullBoxCtor("padb",(function(t){var e=t.readUint32();this.padbits=[];for(var i=0;i<Math.floor((e+1)/2);i++)this.padbits=t.readUint8()})),l.createBoxCtor("pasp",(function(t){this.hSpacing=t.readUint32(),this.vSpacing=t.readUint32()})),l.createBoxCtor("payl",(function(t){this.text=t.readString(this.size-this.hdr_size)})),l.createBoxCtor("payt",(function(t){this.payloadID=t.readUint32();var e=t.readUint8();this.rtpmap_string=t.readString(e)})),l.createFullBoxCtor("pdin",(function(t){var e=(this.size-this.hdr_size)/8;this.rate=[],this.initial_delay=[];for(var i=0;i<e;i++)this.rate[i]=t.readUint32(),this.initial_delay[i]=t.readUint32()})),l.createFullBoxCtor("pitm",(function(t){0===this.version?this.item_id=t.readUint16():this.item_id=t.readUint32()})),l.createFullBoxCtor("pixi",(function(t){var e;for(this.num_channels=t.readUint8(),this.bits_per_channels=[],e=0;e<this.num_channels;e++)this.bits_per_channels[e]=t.readUint8()})),l.createBoxCtor("pmax",(function(t){this.bytes=t.readUint32()})),l.createFullBoxCtor("prft",(function(t){this.ref_track_id=t.readUint32(),this.ntp_timestamp=t.readUint64(),0===this.version?this.media_time=t.readUint32():this.media_time=t.readUint64()})),l.createFullBoxCtor("pssh",(function(t){if(this.system_id=l.parseHex16(t),this.version>0){var e=t.readUint32();this.kid=[];for(var i=0;i<e;i++)this.kid[i]=l.parseHex16(t)}var r=t.readUint32();r>0&&(this.data=t.readUint8Array(r))})),l.createFullBoxCtor("clef",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),l.createFullBoxCtor("enof",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),l.createFullBoxCtor("prof",(function(t){this.width=t.readUint32(),this.height=t.readUint32()})),l.createContainerBoxCtor("tapt",null,["clef","prof","enof"]),l.createBoxCtor("rtp ",(function(t){this.descriptionformat=t.readString(4),this.sdptext=t.readString(this.size-this.hdr_size-4)})),l.createFullBoxCtor("saio",(function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32());var e=t.readUint32();this.offset=[];for(var i=0;i<e;i++)0===this.version?this.offset[i]=t.readUint32():this.offset[i]=t.readUint64()})),l.createFullBoxCtor("saiz",(function(t){1&this.flags&&(this.aux_info_type=t.readUint32(),this.aux_info_type_parameter=t.readUint32()),this.default_sample_info_size=t.readUint8();var e=t.readUint32();if(this.sample_info_size=[],0===this.default_sample_info_size)for(var i=0;i<e;i++)this.sample_info_size[i]=t.readUint8()})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_METADATA,"mett",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_METADATA,"metx",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE,"sbtt",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE,"stpp",(function(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE,"stxt",(function(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_SUBTITLE,"tx3g",(function(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)})),l.createSampleEntryCtor(l.SAMPLE_ENTRY_TYPE_METADATA,"wvtt",(function(t){this.parseHeader(t),this.parseFooter(t)})),l.createSampleGroupCtor("alst",(function(t){var e,i=t.readUint16();for(this.first_output_sample=t.readUint16(),this.sample_offset=[],e=0;e<i;e++)this.sample_offset[e]=t.readUint32();var r=this.description_length-4-4*i;for(this.num_output_samples=[],this.num_total_samples=[],e=0;e<r/4;e++)this.num_output_samples[e]=t.readUint16(),this.num_total_samples[e]=t.readUint16()})),l.createSampleGroupCtor("avll",(function(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()})),l.createSampleGroupCtor("avss",(function(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();var e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];for(var i=t.readUint8(),r=0;r<i;r++){var s={};this.dependency.push(s),s.subSeqDirectionFlag=t.readUint8(),s.layerNumber=t.readUint8(),s.subSequenceIdentifier=t.readUint16()}})),l.createSampleGroupCtor("dtrt",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("mvif",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("prol",(function(t){this.roll_distance=t.readInt16()})),l.createSampleGroupCtor("rap ",(function(t){var e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=127&e})),l.createSampleGroupCtor("rash",(function(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(1===this.operation_point_count?2:6*this.operation_point_count)+9)i.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(1===this.operation_point_count)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(var e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}})),l.createSampleGroupCtor("roll",(function(t){this.roll_distance=t.readInt16()})),l.SampleGroupEntry.prototype.parse=function(t){i.warn("BoxParser","Unknown Sample Group type: "+this.grouping_type),this.data=t.readUint8Array(this.description_length)},l.createSampleGroupCtor("scif",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("scnm",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("seig",(function(t){this.reserved=t.readUint8();var e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=15&e,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=l.parseHex16(t),this.constant_IV_size=0,this.constant_IV=0,1===this.isProtected&&0===this.Per_Sample_IV_Size&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))})),l.createSampleGroupCtor("stsa",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("sync",(function(t){var e=t.readUint8();this.NAL_unit_type=63&e})),l.createSampleGroupCtor("tele",(function(t){var e=t.readUint8();this.level_independently_decodable=e>>7})),l.createSampleGroupCtor("tsas",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("tscl",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createSampleGroupCtor("vipr",(function(t){i.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")})),l.createFullBoxCtor("sbgp",(function(t){this.grouping_type=t.readString(4),1===this.version?this.grouping_type_parameter=t.readUint32():this.grouping_type_parameter=0,this.entries=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.entries.push(r),r.sample_count=t.readInt32(),r.group_description_index=t.readInt32()}})),l.createFullBoxCtor("schm",(function(t){this.scheme_type=t.readString(4),this.scheme_version=t.readUint32(),1&this.flags&&(this.scheme_uri=t.readString(this.size-this.hdr_size-8))})),l.createBoxCtor("sdp ",(function(t){this.sdptext=t.readString(this.size-this.hdr_size)})),l.createFullBoxCtor("sdtp",(function(t){var e,i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(var r=0;r<i;r++)e=t.readUint8(),this.is_leading[r]=e>>6,this.sample_depends_on[r]=e>>4&3,this.sample_is_depended_on[r]=e>>2&3,this.sample_has_redundancy[r]=3&e})),l.createFullBoxCtor("senc"),l.createFullBoxCtor("sgpd",(function(t){this.grouping_type=t.readString(4),i.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),1===this.version?this.default_length=t.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=t.readUint32()),this.entries=[];for(var e=t.readUint32(),r=0;r<e;r++){var s;s=l[this.grouping_type+"SampleGroupEntry"]?new l[this.grouping_type+"SampleGroupEntry"](this.grouping_type):new l.SampleGroupEntry(this.grouping_type),this.entries.push(s),1===this.version&&0===this.default_length?s.description_length=t.readUint32():s.description_length=this.default_length,s.write===l.SampleGroupEntry.prototype.write&&(i.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=t.readUint8Array(s.description_length),t.position-=s.description_length),s.parse(t)}})),l.createFullBoxCtor("sidx",(function(t){this.reference_ID=t.readUint32(),this.timescale=t.readUint32(),0===this.version?(this.earliest_presentation_time=t.readUint32(),this.first_offset=t.readUint32()):(this.earliest_presentation_time=t.readUint64(),this.first_offset=t.readUint64()),t.readUint16(),this.references=[];for(var e=t.readUint16(),i=0;i<e;i++){var r={};this.references.push(r);var s=t.readUint32();r.reference_type=s>>31&1,r.referenced_size=2147483647&s,r.subsegment_duration=t.readUint32(),s=t.readUint32(),r.starts_with_SAP=s>>31&1,r.SAP_type=s>>28&7,r.SAP_delta_time=268435455&s}})),l.SingleItemTypeReferenceBox=function(t,e,i,r){l.Box.call(this,t,e),this.hdr_size=i,this.start=r},l.SingleItemTypeReferenceBox.prototype=new l.Box,l.SingleItemTypeReferenceBox.prototype.parse=function(t){this.from_item_ID=t.readUint16();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint16()},l.SingleItemTypeReferenceBoxLarge=function(t,e,i,r){l.Box.call(this,t,e),this.hdr_size=i,this.start=r},l.SingleItemTypeReferenceBoxLarge.prototype=new l.Box,l.SingleItemTypeReferenceBoxLarge.prototype.parse=function(t){this.from_item_ID=t.readUint32();var e=t.readUint16();this.references=[];for(var i=0;i<e;i++)this.references[i]=t.readUint32()},l.createFullBoxCtor("SmDm",(function(t){this.primaryRChromaticity_x=t.readUint16(),this.primaryRChromaticity_y=t.readUint16(),this.primaryGChromaticity_x=t.readUint16(),this.primaryGChromaticity_y=t.readUint16(),this.primaryBChromaticity_x=t.readUint16(),this.primaryBChromaticity_y=t.readUint16(),this.whitePointChromaticity_x=t.readUint16(),this.whitePointChromaticity_y=t.readUint16(),this.luminanceMax=t.readUint32(),this.luminanceMin=t.readUint32()})),l.createFullBoxCtor("smhd",(function(t){this.balance=t.readUint16(),t.readUint16()})),l.createFullBoxCtor("ssix",(function(t){this.subsegments=[];for(var e=t.readUint32(),i=0;i<e;i++){var r={};this.subsegments.push(r),r.ranges=[];for(var s=t.readUint32(),n=0;n<s;n++){var a={};r.ranges.push(a),a.level=t.readUint8(),a.range_size=t.readUint24()}}})),l.createFullBoxCtor("stco",(function(t){var e;if(e=t.readUint32(),this.chunk_offsets=[],0===this.version)for(var i=0;i<e;i++)this.chunk_offsets.push(t.readUint32())})),l.createFullBoxCtor("stdp",(function(t){var e=(this.size-this.hdr_size)/2;this.priority=[];for(var i=0;i<e;i++)this.priority[i]=t.readUint16()})),l.createFullBoxCtor("sthd"),l.createFullBoxCtor("stri",(function(t){this.switch_group=t.readUint16(),this.alternate_group=t.readUint16(),this.sub_track_id=t.readUint32();var e=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()})),l.createFullBoxCtor("stsc",(function(t){var e,i;if(e=t.readUint32(),this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],0===this.version)for(i=0;i<e;i++)this.first_chunk.push(t.readUint32()),this.samples_per_chunk.push(t.readUint32()),this.sample_description_index.push(t.readUint32())})),l.createFullBoxCtor("stsd",(function(t){var e,r,s,n;for(this.entries=[],s=t.readUint32(),e=1;e<=s;e++){if((r=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;l[r.type+"SampleEntry"]?((n=new l[r.type+"SampleEntry"](r.size)).hdr_size=r.hdr_size,n.start=r.start):(i.warn("BoxParser","Unknown sample entry type: "+r.type),n=new l.SampleEntry(r.type,r.size,r.hdr_size,r.start)),n.write===l.SampleEntry.prototype.write&&(i.info("BoxParser","SampleEntry "+n.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),n.parseDataAndRewind(t)),n.parse(t),this.entries.push(n)}})),l.createFullBoxCtor("stsg",(function(t){this.grouping_type=t.readUint32();var e=t.readUint16();this.group_description_index=[];for(var i=0;i<e;i++)this.group_description_index[i]=t.readUint32()})),l.createFullBoxCtor("stsh",(function(t){var e,i;if(e=t.readUint32(),this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],0===this.version)for(i=0;i<e;i++)this.shadowed_sample_numbers.push(t.readUint32()),this.sync_sample_numbers.push(t.readUint32())})),l.createFullBoxCtor("stss",(function(t){var e,i;if(i=t.readUint32(),0===this.version)for(this.sample_numbers=[],e=0;e<i;e++)this.sample_numbers.push(t.readUint32())})),l.createFullBoxCtor("stsz",(function(t){var e;if(this.sample_sizes=[],0===this.version)for(this.sample_size=t.readUint32(),this.sample_count=t.readUint32(),e=0;e<this.sample_count;e++)0===this.sample_size?this.sample_sizes.push(t.readUint32()):this.sample_sizes[e]=this.sample_size})),l.createFullBoxCtor("stts",(function(t){var e,r,s;if(e=t.readUint32(),this.sample_counts=[],this.sample_deltas=[],0===this.version)for(r=0;r<e;r++)this.sample_counts.push(t.readUint32()),(s=t.readInt32())<0&&(i.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)})),l.createFullBoxCtor("stvi",(function(t){var e=t.readUint32();this.single_view_allowed=3&e,this.stereo_scheme=t.readUint32();var i,r,s=t.readUint32();for(this.stereo_indication_type=t.readString(s),this.boxes=[];t.getPosition()<this.start+this.size;){if((i=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start))).code!==l.OK)return;r=i.box,this.boxes.push(r),this[r.type]=r}})),l.createBoxCtor("styp",(function(t){l.ftypBox.prototype.parse.call(this,t)})),l.createFullBoxCtor("stz2",(function(t){var e,r;if(this.sample_sizes=[],0===this.version)if(this.reserved=t.readUint24(),this.field_size=t.readUint8(),r=t.readUint32(),4===this.field_size)for(e=0;e<r;e+=2){var s=t.readUint8();this.sample_sizes[e]=s>>4&15,this.sample_sizes[e+1]=15&s}else if(8===this.field_size)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint8();else if(16===this.field_size)for(e=0;e<r;e++)this.sample_sizes[e]=t.readUint16();else i.error("BoxParser","Error in length field in stz2 box")})),l.createFullBoxCtor("subs",(function(t){var e,i,r,s;for(r=t.readUint32(),this.entries=[],e=0;e<r;e++){var n={};if(this.entries[e]=n,n.sample_delta=t.readUint32(),n.subsamples=[],(s=t.readUint16())>0)for(i=0;i<s;i++){var a={};n.subsamples.push(a),1==this.version?a.size=t.readUint32():a.size=t.readUint16(),a.priority=t.readUint8(),a.discardable=t.readUint8(),a.codec_specific_parameters=t.readUint32()}}})),l.createFullBoxCtor("tenc",(function(t){if(t.readUint8(),0===this.version)t.readUint8();else{var e=t.readUint8();this.default_crypt_byte_block=e>>4&15,this.default_skip_byte_block=15&e}this.default_isProtected=t.readUint8(),this.default_Per_Sample_IV_Size=t.readUint8(),this.default_KID=l.parseHex16(t),1===this.default_isProtected&&0===this.default_Per_Sample_IV_Size&&(this.default_constant_IV_size=t.readUint8(),this.default_constant_IV=t.readUint8Array(this.default_constant_IV_size))})),l.createFullBoxCtor("tfdt",(function(t){1==this.version?this.baseMediaDecodeTime=t.readUint64():this.baseMediaDecodeTime=t.readUint32()})),l.createFullBoxCtor("tfhd",(function(t){var e=0;this.track_id=t.readUint32(),this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET?(this.base_data_offset=t.readUint64(),e+=8):this.base_data_offset=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_DESC?(this.default_sample_description_index=t.readUint32(),e+=4):this.default_sample_description_index=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_DUR?(this.default_sample_duration=t.readUint32(),e+=4):this.default_sample_duration=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_SIZE?(this.default_sample_size=t.readUint32(),e+=4):this.default_sample_size=0,this.size-this.hdr_size>e&&this.flags&l.TFHD_FLAG_SAMPLE_FLAGS?(this.default_sample_flags=t.readUint32(),e+=4):this.default_sample_flags=0})),l.createFullBoxCtor("tfra",(function(t){this.track_ID=t.readUint32(),t.readUint24();var e=t.readUint8();this.length_size_of_traf_num=e>>4&3,this.length_size_of_trun_num=e>>2&3,this.length_size_of_sample_num=3&e,this.entries=[];for(var i=t.readUint32(),r=0;r<i;r++)1===this.version?(this.time=t.readUint64(),this.moof_offset=t.readUint64()):(this.time=t.readUint32(),this.moof_offset=t.readUint32()),this.traf_number=t["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=t["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=t["readUint"+8*(this.length_size_of_sample_num+1)]()})),l.createFullBoxCtor("tkhd",(function(t){1==this.version?(this.creation_time=t.readUint64(),this.modification_time=t.readUint64(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint64()):(this.creation_time=t.readUint32(),this.modification_time=t.readUint32(),this.track_id=t.readUint32(),t.readUint32(),this.duration=t.readUint32()),t.readUint32Array(2),this.layer=t.readInt16(),this.alternate_group=t.readInt16(),this.volume=t.readInt16()>>8,t.readUint16(),this.matrix=t.readInt32Array(9),this.width=t.readUint32(),this.height=t.readUint32()})),l.createBoxCtor("tmax",(function(t){this.time=t.readUint32()})),l.createBoxCtor("tmin",(function(t){this.time=t.readUint32()})),l.createBoxCtor("totl",(function(t){this.bytessent=t.readUint32()})),l.createBoxCtor("tpay",(function(t){this.bytessent=t.readUint32()})),l.createBoxCtor("tpyl",(function(t){this.bytessent=t.readUint64()})),l.TrackGroupTypeBox.prototype.parse=function(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()},l.createTrackGroupCtor("msrc"),l.TrackReferenceTypeBox=function(t,e,i,r){l.Box.call(this,t,e),this.hdr_size=i,this.start=r},l.TrackReferenceTypeBox.prototype=new l.Box,l.TrackReferenceTypeBox.prototype.parse=function(t){this.track_ids=t.readUint32Array((this.size-this.hdr_size)/4)},l.trefBox.prototype.parse=function(t){for(var e,r;t.getPosition()<this.start+this.size;){if((e=l.parseOneBox(t,!0,this.size-(t.getPosition()-this.start))).code!==l.OK)return;(r=new l.TrackReferenceTypeBox(e.type,e.size,e.hdr_size,e.start)).write===l.Box.prototype.write&&"mdat"!==r.type&&(i.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(t)),r.parse(t),this.boxes.push(r)}},l.createFullBoxCtor("trep",(function(t){for(this.track_ID=t.readUint32(),this.boxes=[];t.getPosition()<this.start+this.size;){if(ret=l.parseOneBox(t,!1,this.size-(t.getPosition()-this.start)),ret.code!==l.OK)return;box=ret.box,this.boxes.push(box)}})),l.createFullBoxCtor("trex",(function(t){this.track_id=t.readUint32(),this.default_sample_description_index=t.readUint32(),this.default_sample_duration=t.readUint32(),this.default_sample_size=t.readUint32(),this.default_sample_flags=t.readUint32()})),l.createBoxCtor("trpy",(function(t){this.bytessent=t.readUint64()})),l.createFullBoxCtor("trun",(function(t){var e=0;if(this.sample_count=t.readUint32(),e+=4,this.size-this.hdr_size>e&&this.flags&l.TRUN_FLAGS_DATA_OFFSET?(this.data_offset=t.readInt32(),e+=4):this.data_offset=0,this.size-this.hdr_size>e&&this.flags&l.TRUN_FLAGS_FIRST_FLAG?(this.first_sample_flags=t.readUint32(),e+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>e)for(var i=0;i<this.sample_count;i++)this.flags&l.TRUN_FLAGS_DURATION&&(this.sample_duration[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_SIZE&&(this.sample_size[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_FLAGS&&(this.sample_flags[i]=t.readUint32()),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?this.sample_composition_time_offset[i]=t.readUint32():this.sample_composition_time_offset[i]=t.readInt32())})),l.createFullBoxCtor("tsel",(function(t){this.switch_group=t.readUint32();var e=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(var i=0;i<e;i++)this.attribute_list[i]=t.readUint32()})),l.createFullBoxCtor("txtC",(function(t){this.config=t.readCString()})),l.createFullBoxCtor("url ",(function(t){1!==this.flags&&(this.location=t.readCString())})),l.createFullBoxCtor("urn ",(function(t){this.name=t.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=t.readCString())})),l.createUUIDBox("a5d40b30e81411ddba2f0800200c9a66",!0,!1,(function(t){this.LiveServerManifest=t.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")})),l.createUUIDBox("d08a4f1810f34a82b6c832d8aba183d3",!0,!1,(function(t){this.system_id=l.parseHex16(t);var e=t.readUint32();e>0&&(this.data=t.readUint8Array(e))})),l.createUUIDBox("a2394f525a9b4f14a2446c427c648df4",!0,!1),l.createUUIDBox("8974dbce7be74c5184f97148f9882554",!0,!1,(function(t){this.default_AlgorithmID=t.readUint24(),this.default_IV_size=t.readUint8(),this.default_KID=l.parseHex16(t)})),l.createUUIDBox("d4807ef2ca3946958e5426cb9e46a79f",!0,!1,(function(t){this.fragment_count=t.readUint8(),this.entries=[];for(var e=0;e<this.fragment_count;e++){var i={},r=0,s=0;1===this.version?(r=t.readUint64(),s=t.readUint64()):(r=t.readUint32(),s=t.readUint32()),i.absolute_time=r,i.absolute_duration=s,this.entries.push(i)}})),l.createUUIDBox("6d1d9b0542d544e680e2141daff757b2",!0,!1,(function(t){1===this.version?(this.absolute_time=t.readUint64(),this.duration=t.readUint64()):(this.absolute_time=t.readUint32(),this.duration=t.readUint32())})),l.createFullBoxCtor("vmhd",(function(t){this.graphicsmode=t.readUint16(),this.opcolor=t.readUint16Array(3)})),l.createFullBoxCtor("vpcC",(function(t){var e;1===this.version?(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4,this.chromaSubsampling=e>>1&7,this.videoFullRangeFlag=1&e,this.colourPrimaries=t.readUint8(),this.transferCharacteristics=t.readUint8(),this.matrixCoefficients=t.readUint8(),this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize)):(this.profile=t.readUint8(),this.level=t.readUint8(),e=t.readUint8(),this.bitDepth=e>>4&15,this.colorSpace=15&e,e=t.readUint8(),this.chromaSubsampling=e>>4&15,this.transferFunction=e>>1&7,this.videoFullRangeFlag=1&e,this.codecIntializationDataSize=t.readUint16(),this.codecIntializationData=t.readUint8Array(this.codecIntializationDataSize))})),l.createBoxCtor("vttC",(function(t){this.text=t.readString(this.size-this.hdr_size)})),l.createFullBoxCtor("vvcC",(function(t){var e,i,r={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(t){this.held_bits=t.readUint8(),this.num_held_bits=8},stream_read_2_bytes:function(t){this.held_bits=t.readUint16(),this.num_held_bits=16},extract_bits:function(t){var e=this.held_bits>>this.num_held_bits-t&(1<<t)-1;return this.num_held_bits-=t,e}};if(r.stream_read_1_bytes(t),r.extract_bits(5),this.lengthSizeMinusOne=r.extract_bits(2),this.ptl_present_flag=r.extract_bits(1),this.ptl_present_flag){if(r.stream_read_2_bytes(t),this.ols_idx=r.extract_bits(9),this.num_sublayers=r.extract_bits(3),this.constant_frame_rate=r.extract_bits(2),this.chroma_format_idc=r.extract_bits(2),r.stream_read_1_bytes(t),this.bit_depth_minus8=r.extract_bits(3),r.extract_bits(5),r.stream_read_2_bytes(t),r.extract_bits(2),this.num_bytes_constraint_info=r.extract_bits(6),this.general_profile_idc=r.extract_bits(7),this.general_tier_flag=r.extract_bits(1),this.general_level_idc=t.readUint8(),r.stream_read_1_bytes(t),this.ptl_frame_only_constraint_flag=r.extract_bits(1),this.ptl_multilayer_enabled_flag=r.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(e=0;e<this.num_bytes_constraint_info-1;e++){var s=r.extract_bits(6);r.stream_read_1_bytes(t);var n=r.extract_bits(2);this.general_constraint_info[e]=s<<2|n}this.general_constraint_info[this.num_bytes_constraint_info-1]=r.extract_bits(6)}else r.extract_bits(6);for(r.stream_read_1_bytes(t),this.ptl_sublayer_present_mask=0,i=this.num_sublayers-2;i>=0;--i){var a=r.extract_bits(1);this.ptl_sublayer_present_mask|=a<<i}for(i=this.num_sublayers;i<=8&&this.num_sublayers>1;++i)r.extract_bits(1);for(i=this.num_sublayers-2;i>=0;--i)this.ptl_sublayer_present_mask&1<<i&&(this.sublayer_level_idc[i]=t.readUint8());if(this.ptl_num_sub_profiles=t.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(e=0;e<this.ptl_num_sub_profiles;e++)this.general_sub_profile_idc.push(t.readUint32());this.max_picture_width=t.readUint16(),this.max_picture_height=t.readUint16(),this.avg_frame_rate=t.readUint16()}this.nalu_arrays=[];var o=t.readUint8();for(e=0;e<o;e++){var l=[];this.nalu_arrays.push(l),r.stream_read_1_bytes(t),l.completeness=r.extract_bits(1),r.extract_bits(2),l.nalu_type=r.extract_bits(5);var h=1;for(13!=l.nalu_type&&12!=l.nalu_type&&(h=t.readUint16()),i=0;i<h;i++){var d=t.readUint16();l.push({data:t.readUint8Array(d),length:d})}}})),l.createFullBoxCtor("vvnC",(function(t){var e=strm.readUint8();this.lengthSizeMinusOne=3&e})),l.SampleEntry.prototype.isVideo=function(){return!1},l.SampleEntry.prototype.isAudio=function(){return!1},l.SampleEntry.prototype.isSubtitle=function(){return!1},l.SampleEntry.prototype.isMetadata=function(){return!1},l.SampleEntry.prototype.isHint=function(){return!1},l.SampleEntry.prototype.getCodec=function(){return this.type.replace(".","")},l.SampleEntry.prototype.getWidth=function(){return""},l.SampleEntry.prototype.getHeight=function(){return""},l.SampleEntry.prototype.getChannelCount=function(){return""},l.SampleEntry.prototype.getSampleRate=function(){return""},l.SampleEntry.prototype.getSampleSize=function(){return""},l.VisualSampleEntry.prototype.isVideo=function(){return!0},l.VisualSampleEntry.prototype.getWidth=function(){return this.width},l.VisualSampleEntry.prototype.getHeight=function(){return this.height},l.AudioSampleEntry.prototype.isAudio=function(){return!0},l.AudioSampleEntry.prototype.getChannelCount=function(){return this.channel_count},l.AudioSampleEntry.prototype.getSampleRate=function(){return this.samplerate},l.AudioSampleEntry.prototype.getSampleSize=function(){return this.samplesize},l.SubtitleSampleEntry.prototype.isSubtitle=function(){return!0},l.MetadataSampleEntry.prototype.isMetadata=function(){return!0},l.decimalToHex=function(t,e){var i=Number(t).toString(16);for(e=null==e?e=2:e;i.length<e;)i="0"+i;return i},l.avc1SampleEntry.prototype.getCodec=l.avc2SampleEntry.prototype.getCodec=l.avc3SampleEntry.prototype.getCodec=l.avc4SampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);return this.avcC?t+"."+l.decimalToHex(this.avcC.AVCProfileIndication)+l.decimalToHex(this.avcC.profile_compatibility)+l.decimalToHex(this.avcC.AVCLevelIndication):t},l.hev1SampleEntry.prototype.getCodec=l.hvc1SampleEntry.prototype.getCodec=function(){var t,e=l.SampleEntry.prototype.getCodec.call(this);if(this.hvcC){switch(e+=".",this.hvcC.general_profile_space){case 0:e+="";break;case 1:e+="A";break;case 2:e+="B";break;case 3:e+="C"}e+=this.hvcC.general_profile_idc,e+=".";var i=this.hvcC.general_profile_compatibility,r=0;for(t=0;t<32&&(r|=1&i,31!=t);t++)r<<=1,i>>=1;e+=l.decimalToHex(r,0),e+=".",0===this.hvcC.general_tier_flag?e+="L":e+="H",e+=this.hvcC.general_level_idc;var s=!1,n="";for(t=5;t>=0;t--)(this.hvcC.general_constraint_indicator[t]||s)&&(n="."+l.decimalToHex(this.hvcC.general_constraint_indicator[t],0)+n,s=!0);e+=n}return e},l.vvc1SampleEntry.prototype.getCodec=l.vvi1SampleEntry.prototype.getCodec=function(){var t,e=l.SampleEntry.prototype.getCodec.call(this);if(this.vvcC){e+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?e+=".H":e+=".L",e+=this.vvcC.general_level_idc;var i="";if(this.vvcC.general_constraint_info){var r,s=[],n=0;for(n|=this.vvcC.ptl_frame_only_constraint<<7,n|=this.vvcC.ptl_multilayer_enabled<<6,t=0;t<this.vvcC.general_constraint_info.length;++t)n|=this.vvcC.general_constraint_info[t]>>2&63,s.push(n),n&&(r=t),n=this.vvcC.general_constraint_info[t]>>2&3;if(void 0===r)i=".CA";else{i=".C";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",o=0,h=0;for(t=0;t<=r;++t)for(o=o<<8|s[t],h+=8;h>=5;){i+=a[o>>h-5&31],o&=(1<<(h-=5))-1}h&&(i+=a[31&(o<<=5-h)])}}e+=i}return e},l.mp4aSampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);if(this.esds&&this.esds.esd){var e=this.esds.esd.getOTI(),i=this.esds.esd.getAudioConfig();return t+"."+l.decimalToHex(e)+(i?"."+i:"")}return t},l.stxtSampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this);return this.mime_format?t+"."+this.mime_format:t},l.vp08SampleEntry.prototype.getCodec=l.vp09SampleEntry.prototype.getCodec=function(){var t=l.SampleEntry.prototype.getCodec.call(this),e=this.vpcC.level;0==e&&(e="00");var i=this.vpcC.bitDepth;return 8==i&&(i="08"),t+".0"+this.vpcC.profile+"."+e+"."+i},l.av01SampleEntry.prototype.getCodec=function(){var t,e=l.SampleEntry.prototype.getCodec.call(this),i=this.av1C.seq_level_idx_0;return i<10&&(i="0"+i),2===this.av1C.seq_profile&&1===this.av1C.high_bitdepth?t=1===this.av1C.twelve_bit?"12":"10":this.av1C.seq_profile<=2&&(t=1===this.av1C.high_bitdepth?"10":"08"),e+"."+this.av1C.seq_profile+"."+i+(this.av1C.seq_tier_0?"H":"M")+"."+t},l.Box.prototype.writeHeader=function(t,e){this.size+=8,this.size>n&&(this.size+=8),"uuid"===this.type&&(this.size+=16),i.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.size>n?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,null,4),"uuid"===this.type&&t.writeUint8Array(this.uuid),this.size>n&&t.writeUint64(this.size)},l.FullBox.prototype.writeHeader=function(t){this.size+=4,l.Box.prototype.writeHeader.call(this,t," v="+this.version+" f="+this.flags),t.writeUint8(this.version),t.writeUint24(this.flags)},l.Box.prototype.write=function(t){"mdat"===this.type?this.data&&(this.size=this.data.length,this.writeHeader(t),t.writeUint8Array(this.data)):(this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data))},l.ContainerBox.prototype.write=function(t){this.size=0,this.writeHeader(t);for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.TrackReferenceTypeBox.prototype.write=function(t){this.size=4*this.track_ids.length,this.writeHeader(t),t.writeUint32Array(this.track_ids)},l.avcCBox.prototype.write=function(t){var e;for(this.size=7,e=0;e<this.SPS.length;e++)this.size+=2+this.SPS[e].length;for(e=0;e<this.PPS.length;e++)this.size+=2+this.PPS[e].length;for(this.ext&&(this.size+=this.ext.length),this.writeHeader(t),t.writeUint8(this.configurationVersion),t.writeUint8(this.AVCProfileIndication),t.writeUint8(this.profile_compatibility),t.writeUint8(this.AVCLevelIndication),t.writeUint8(this.lengthSizeMinusOne+252),t.writeUint8(this.SPS.length+224),e=0;e<this.SPS.length;e++)t.writeUint16(this.SPS[e].length),t.writeUint8Array(this.SPS[e].nalu);for(t.writeUint8(this.PPS.length),e=0;e<this.PPS.length;e++)t.writeUint16(this.PPS[e].length),t.writeUint8Array(this.PPS[e].nalu);this.ext&&t.writeUint8Array(this.ext)},l.co64Box.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),e=0;e<this.chunk_offsets.length;e++)t.writeUint64(this.chunk_offsets[e])},l.cslgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeInt32(this.compositionToDTSShift),t.writeInt32(this.leastDecodeToDisplayDelta),t.writeInt32(this.greatestDecodeToDisplayDelta),t.writeInt32(this.compositionStartTime),t.writeInt32(this.compositionEndTime)},l.cttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),1===this.version?t.writeInt32(this.sample_offsets[e]):t.writeUint32(this.sample_offsets[e])},l.drefBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.elngBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(t),t.writeString(this.extended_language)},l.elstBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+12*this.entries.length,this.writeHeader(t),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeUint32(i.segment_duration),t.writeInt32(i.media_time),t.writeInt16(i.media_rate_integer),t.writeInt16(i.media_rate_fraction)}},l.emsgBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=16+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(t),t.writeCString(this.scheme_id_uri),t.writeCString(this.value),t.writeUint32(this.timescale),t.writeUint32(this.presentation_time_delta),t.writeUint32(this.event_duration),t.writeUint32(this.id),t.writeUint8Array(this.message_data)},l.ftypBox.prototype.write=function(t){this.size=8+4*this.compatible_brands.length,this.writeHeader(t),t.writeString(this.major_brand,null,4),t.writeUint32(this.minor_version);for(var e=0;e<this.compatible_brands.length;e++)t.writeString(this.compatible_brands[e],null,4)},l.hdlrBox.prototype.write=function(t){this.size=20+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(t),t.writeUint32(0),t.writeString(this.handler,null,4),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeCString(this.name)},l.kindBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value.length+1),this.writeHeader(t),t.writeCString(this.schemeURI),t.writeCString(this.value)},l.mdhdBox.prototype.write=function(t){this.size=20,this.flags=0,this.version=0,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint16(this.language),t.writeUint16(0)},l.mehdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.fragment_duration)},l.mfhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4,this.writeHeader(t),t.writeUint32(this.sequence_number)},l.mvhdBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=96,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.timescale),t.writeUint32(this.duration),t.writeUint32(this.rate),t.writeUint16(this.volume<<8),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32Array(this.matrix),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(this.next_track_id)},l.SampleEntry.prototype.writeHeader=function(t){this.size=8,l.Box.prototype.writeHeader.call(this,t),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint8(0),t.writeUint16(this.data_reference_index)},l.SampleEntry.prototype.writeFooter=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t),this.size+=this.boxes[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.SampleEntry.prototype.write=function(t){this.writeHeader(t),t.writeUint8Array(this.data),this.size+=this.data.length,i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.VisualSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=70,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,null,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)},l.AudioSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=20,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)},l.stppSampleEntry.prototype.write=function(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)},l.SampleGroupEntry.prototype.write=function(t){t.writeUint8Array(this.data)},l.sbgpBox.prototype.write=function(t){this.version=1,this.flags=0,this.size=12+8*this.entries.length,this.writeHeader(t),t.writeString(this.grouping_type,null,4),t.writeUint32(this.grouping_type_parameter),t.writeUint32(this.entries.length);for(var e=0;e<this.entries.length;e++){var i=this.entries[e];t.writeInt32(i.sample_count),t.writeInt32(i.group_description_index)}},l.sgpdBox.prototype.write=function(t){var e,i;for(this.flags=0,this.size=12,e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&(0===this.default_length&&(this.size+=4),this.size+=i.data.length);for(this.writeHeader(t),t.writeString(this.grouping_type,null,4),1===this.version&&t.writeUint32(this.default_length),this.version>=2&&t.writeUint32(this.default_sample_description_index),t.writeUint32(this.entries.length),e=0;e<this.entries.length;e++)i=this.entries[e],1===this.version&&0===this.default_length&&t.writeUint32(i.description_length),i.write(t)},l.sidxBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20+12*this.references.length,this.writeHeader(t),t.writeUint32(this.reference_ID),t.writeUint32(this.timescale),t.writeUint32(this.earliest_presentation_time),t.writeUint32(this.first_offset),t.writeUint16(0),t.writeUint16(this.references.length);for(var e=0;e<this.references.length;e++){var i=this.references[e];t.writeUint32(i.reference_type<<31|i.referenced_size),t.writeUint32(i.subsegment_duration),t.writeUint32(i.starts_with_SAP<<31|i.SAP_type<<28|i.SAP_delta_time)}},l.smhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=4,this.writeHeader(t),t.writeUint16(this.balance),t.writeUint16(0)},l.stcoBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(t),t.writeUint32(this.chunk_offsets.length),t.writeUint32Array(this.chunk_offsets)},l.stscBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(t),t.writeUint32(this.first_chunk.length),e=0;e<this.first_chunk.length;e++)t.writeUint32(this.first_chunk[e]),t.writeUint32(this.samples_per_chunk[e]),t.writeUint32(this.sample_description_index[e])},l.stsdBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=0,this.writeHeader(t),t.writeUint32(this.entries.length),this.size+=4,e=0;e<this.entries.length;e++)this.entries[e].write(t),this.size+=this.entries[e].size;i.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)},l.stshBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(t),t.writeUint32(this.shadowed_sample_numbers.length),e=0;e<this.shadowed_sample_numbers.length;e++)t.writeUint32(this.shadowed_sample_numbers[e]),t.writeUint32(this.sync_sample_numbers[e])},l.stssBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(t),t.writeUint32(this.sample_numbers.length),t.writeUint32Array(this.sample_numbers)},l.stszBox.prototype.write=function(t){var e,i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0)for(e=0;e+1<this.sample_sizes.length;){if(this.sample_sizes[e+1]!==this.sample_sizes[0]){i=!1;break}e++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(t),i?t.writeUint32(this.sample_sizes[0]):t.writeUint32(0),t.writeUint32(this.sample_sizes.length),i||t.writeUint32Array(this.sample_sizes)},l.sttsBox.prototype.write=function(t){var e;for(this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(t),t.writeUint32(this.sample_counts.length),e=0;e<this.sample_counts.length;e++)t.writeUint32(this.sample_counts[e]),t.writeUint32(this.sample_deltas[e])},l.tfdtBox.prototype.write=function(t){var e=Math.pow(2,32)-1;this.version=this.baseMediaDecodeTime>e?1:0,this.flags=0,this.size=4,1===this.version&&(this.size+=4),this.writeHeader(t),1===this.version?t.writeUint64(this.baseMediaDecodeTime):t.writeUint32(this.baseMediaDecodeTime)},l.tfhdBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET&&(this.size+=8),this.flags&l.TFHD_FLAG_SAMPLE_DESC&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_DUR&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_SIZE&&(this.size+=4),this.flags&l.TFHD_FLAG_SAMPLE_FLAGS&&(this.size+=4),this.writeHeader(t),t.writeUint32(this.track_id),this.flags&l.TFHD_FLAG_BASE_DATA_OFFSET&&t.writeUint64(this.base_data_offset),this.flags&l.TFHD_FLAG_SAMPLE_DESC&&t.writeUint32(this.default_sample_description_index),this.flags&l.TFHD_FLAG_SAMPLE_DUR&&t.writeUint32(this.default_sample_duration),this.flags&l.TFHD_FLAG_SAMPLE_SIZE&&t.writeUint32(this.default_sample_size),this.flags&l.TFHD_FLAG_SAMPLE_FLAGS&&t.writeUint32(this.default_sample_flags)},l.tkhdBox.prototype.write=function(t){this.version=0,this.size=80,this.writeHeader(t),t.writeUint32(this.creation_time),t.writeUint32(this.modification_time),t.writeUint32(this.track_id),t.writeUint32(0),t.writeUint32(this.duration),t.writeUint32(0),t.writeUint32(0),t.writeInt16(this.layer),t.writeInt16(this.alternate_group),t.writeInt16(this.volume<<8),t.writeUint16(0),t.writeInt32Array(this.matrix),t.writeUint32(this.width),t.writeUint32(this.height)},l.trexBox.prototype.write=function(t){this.version=0,this.flags=0,this.size=20,this.writeHeader(t),t.writeUint32(this.track_id),t.writeUint32(this.default_sample_description_index),t.writeUint32(this.default_sample_duration),t.writeUint32(this.default_sample_size),t.writeUint32(this.default_sample_flags)},l.trunBox.prototype.write=function(t){this.version=0,this.size=4,this.flags&l.TRUN_FLAGS_DATA_OFFSET&&(this.size+=4),this.flags&l.TRUN_FLAGS_FIRST_FLAG&&(this.size+=4),this.flags&l.TRUN_FLAGS_DURATION&&(this.size+=4*this.sample_duration.length),this.flags&l.TRUN_FLAGS_SIZE&&(this.size+=4*this.sample_size.length),this.flags&l.TRUN_FLAGS_FLAGS&&(this.size+=4*this.sample_flags.length),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(t),t.writeUint32(this.sample_count),this.flags&l.TRUN_FLAGS_DATA_OFFSET&&(this.data_offset_position=t.getPosition(),t.writeInt32(this.data_offset)),this.flags&l.TRUN_FLAGS_FIRST_FLAG&&t.writeUint32(this.first_sample_flags);for(var e=0;e<this.sample_count;e++)this.flags&l.TRUN_FLAGS_DURATION&&t.writeUint32(this.sample_duration[e]),this.flags&l.TRUN_FLAGS_SIZE&&t.writeUint32(this.sample_size[e]),this.flags&l.TRUN_FLAGS_FLAGS&&t.writeUint32(this.sample_flags[e]),this.flags&l.TRUN_FLAGS_CTS_OFFSET&&(0===this.version?t.writeUint32(this.sample_composition_time_offset[e]):t.writeInt32(this.sample_composition_time_offset[e]))},l["url Box"].prototype.write=function(t){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(t),this.location&&t.writeCString(this.location)},l["urn Box"].prototype.write=function(t){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(t),t.writeCString(this.name),this.location&&t.writeCString(this.location)},l.vmhdBox.prototype.write=function(t){this.version=0,this.flags=1,this.size=8,this.writeHeader(t),t.writeUint16(this.graphicsmode),t.writeUint16Array(this.opcolor)},l.cttsBox.prototype.unpack=function(t){var e,i,r;for(r=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[r].pts=t[r].dts+this.sample_offsets[e],r++},l.sttsBox.prototype.unpack=function(t){var e,i,r;for(r=0,e=0;e<this.sample_counts.length;e++)for(i=0;i<this.sample_counts[e];i++)t[r].dts=0===r?0:t[r-1].dts+this.sample_deltas[e],r++},l.stcoBox.prototype.unpack=function(t){var e;for(e=0;e<this.chunk_offsets.length;e++)t[e].offset=this.chunk_offsets[e]},l.stscBox.prototype.unpack=function(t){var e,i,r,s,n;for(s=0,n=0,e=0;e<this.first_chunk.length;e++)for(i=0;i<(e+1<this.first_chunk.length?this.first_chunk[e+1]:1/0);i++)for(n++,r=0;r<this.samples_per_chunk[e];r++){if(!t[s])return;t[s].description_index=this.sample_description_index[e],t[s].chunk_index=n,s++}},l.stszBox.prototype.unpack=function(t){var e;for(e=0;e<this.sample_sizes.length;e++)t[e].size=this.sample_sizes[e]},l.DIFF_BOXES_PROP_NAMES=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],l.DIFF_PRIMITIVE_ARRAY_PROP_NAMES=["compatible_brands","matrix","opcolor","sample_counts","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"],l.boxEqualFields=function(t,e){if(t&&!e)return!1;var i;for(i in t)if(!(l.DIFF_BOXES_PROP_NAMES.indexOf(i)>-1||t[i]instanceof l.Box||e[i]instanceof l.Box||void 0===t[i]||void 0===e[i]||"function"==typeof t[i]||"function"==typeof e[i]||t.subBoxNames&&t.subBoxNames.indexOf(i.slice(0,4))>-1||e.subBoxNames&&e.subBoxNames.indexOf(i.slice(0,4))>-1||"data"===i||"start"===i||"size"===i||"creation_time"===i||"modification_time"===i||l.DIFF_PRIMITIVE_ARRAY_PROP_NAMES.indexOf(i)>-1||t[i]===e[i]))return!1;return!0},l.boxEqual=function(t,e){if(!l.boxEqualFields(t,e))return!1;for(var i=0;i<l.DIFF_BOXES_PROP_NAMES.length;i++){var r=l.DIFF_BOXES_PROP_NAMES[i];if(t[r]&&e[r]&&!l.boxEqual(t[r],e[r]))return!1}return!0};var h=function(){};h.prototype.parseSample=function(t){var e,i,s=new r(t.buffer);for(e=[];!s.isEos();)(i=l.parseOneBox(s,!1)).code===l.OK&&"vttc"===i.box.type&&e.push(i.box);return e},h.prototype.getText=function(t,e,i){function r(t,e,i){return i=i||"0",(t+="").length>=e?t:new Array(e-t.length+1).join(i)+t}function s(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),s=Math.floor(t-3600*e-60*i),n=Math.floor(1e3*(t-3600*e-60*i-s));return r(e,2)+":"+r(i,2)+":"+r(s,2)+"."+r(n,3)}for(var n=this.parseSample(i),a="",o=0;o<n.length;o++){var l=n[o];a+=s(t)+" --\x3e "+s(e)+"\r\n",a+=l.payl.text}return a};var d=function(){};d.prototype.parseSample=function(t){var e,i={};i.resources=[];var s=new r(t.data.buffer);if(t.subsamples&&0!==t.subsamples.length){if(i.documentString=s.readString(t.subsamples[0].size),t.subsamples.length>1)for(e=1;e<t.subsamples.length;e++)i.resources[e]=s.readUint8Array(t.subsamples[e].size)}else i.documentString=s.readString(t.data.length);return"undefined"!=typeof DOMParser&&(i.document=(new DOMParser).parseFromString(i.documentString,"application/xml")),i};var c=function(){};c.prototype.parseSample=function(t){return new r(t.data.buffer).readString(t.data.length)},c.prototype.parseConfig=function(t){var e=new r(t.buffer);return e.readUint32(),e.readCString()},e.XMLSubtitlein4Parser=d,e.Textin4Parser=c;var u=function(t){this.stream=t||new a,this.boxes=[],this.mdats=[],this.moofs=[],this.isProgressive=!1,this.moovStartFound=!1,this.onMoovStart=null,this.moovStartSent=!1,this.onReady=null,this.readySent=!1,this.onSegment=null,this.onSamples=null,this.onError=null,this.sampleListBuilt=!1,this.fragmentedTracks=[],this.extractedTracks=[],this.isFragmentationInitialized=!1,this.sampleProcessingStarted=!1,this.nextMoofNumber=0,this.itemListBuilt=!1,this.onSidx=null,this.sidxSent=!1};u.prototype.setSegmentOptions=function(t,e,i){var r=this.getTrackById(t);if(r){var s={};this.fragmentedTracks.push(s),s.id=t,s.user=e,s.trak=r,r.nextSample=0,s.segmentStream=null,s.nb_samples=1e3,s.rapAlignement=!0,i&&(i.nbSamples&&(s.nb_samples=i.nbSamples),i.rapAlignement&&(s.rapAlignement=i.rapAlignement))}},u.prototype.unsetSegmentOptions=function(t){for(var e=-1,i=0;i<this.fragmentedTracks.length;i++){this.fragmentedTracks[i].id==t&&(e=i)}e>-1&&this.fragmentedTracks.splice(e,1)},u.prototype.setExtractionOptions=function(t,e,i){var r=this.getTrackById(t);if(r){var s={};this.extractedTracks.push(s),s.id=t,s.user=e,s.trak=r,r.nextSample=0,s.nb_samples=1e3,s.samples=[],i&&i.nbSamples&&(s.nb_samples=i.nbSamples)}},u.prototype.unsetExtractionOptions=function(t){for(var e=-1,i=0;i<this.extractedTracks.length;i++){this.extractedTracks[i].id==t&&(e=i)}e>-1&&this.extractedTracks.splice(e,1)},u.prototype.parse=function(){var t,e;if(!this.restoreParsePosition||this.restoreParsePosition())for(;;){if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}if(this.saveParsePosition&&this.saveParsePosition(),(t=l.parseOneBox(this.stream,false)).code===l.ERR_NOT_ENOUGH_DATA){if(this.processIncompleteBox){if(this.processIncompleteBox(t))continue;return}return}var r;switch(r="uuid"!==(e=t.box).type?e.type:e.uuid,this.boxes.push(e),r){case"mdat":this.mdats.push(e);break;case"moof":this.moofs.push(e);break;case"moov":this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0);default:void 0!==this[r]&&i.warn("ISOFile","Duplicate Box of type: "+r+", overriding previous occurrence"),this[r]=e}this.updateUsedBytes&&this.updateUsedBytes(e,t)}},u.prototype.checkBuffer=function(t){if(null==t)throw"Buffer must be defined and non empty";if(void 0===t.fileStart)throw"Buffer must have a fileStart property";return 0===t.byteLength?(i.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(i.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),!!this.stream.initialized()||(i.warn("ISOFile","Not ready to start parsing"),!1))},u.prototype.appendBuffer=function(t,e){var r;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(r=this.nextSeekPosition,this.nextSeekPosition=void 0):r=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(r=this.stream.getEndFilePositionAfter(r))):r=this.nextParsePosition?this.nextParsePosition:0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(i.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+r),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),i.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),r},u.prototype.getInfo=function(){var t,e,i,r,s,n,a={},o=new Date("1904-01-01T00:00:00Z").getTime();if(this.moov)for(a.hasMoov=!0,a.duration=this.moov.mvhd.duration,a.timescale=this.moov.mvhd.timescale,a.isFragmented=null!=this.moov.mvex,a.isFragmented&&this.moov.mvex.mehd&&(a.fragment_duration=this.moov.mvex.mehd.fragment_duration),a.isProgressive=this.isProgressive,a.hasIOD=null!=this.moov.iods,a.brands=[],a.brands.push(this.ftyp.major_brand),a.brands=a.brands.concat(this.ftyp.compatible_brands),a.created=new Date(o+1e3*this.moov.mvhd.creation_time),a.modified=new Date(o+1e3*this.moov.mvhd.modification_time),a.tracks=[],a.audioTracks=[],a.videoTracks=[],a.subtitleTracks=[],a.metadataTracks=[],a.hintTracks=[],a.otherTracks=[],t=0;t<this.moov.traks.length;t++){if(n=(i=this.moov.traks[t]).mdia.minf.stbl.stsd.entries[0],r={},a.tracks.push(r),r.id=i.tkhd.track_id,r.name=i.mdia.hdlr.name,r.references=[],i.tref)for(e=0;e<i.tref.boxes.length;e++)s={},r.references.push(s),s.type=i.tref.boxes[e].type,s.track_ids=i.tref.boxes[e].track_ids;i.edts&&(r.edits=i.edts.elst.entries),r.created=new Date(o+1e3*i.tkhd.creation_time),r.modified=new Date(o+1e3*i.tkhd.modification_time),r.movie_duration=i.tkhd.duration,r.movie_timescale=a.timescale,r.layer=i.tkhd.layer,r.alternate_group=i.tkhd.alternate_group,r.volume=i.tkhd.volume,r.matrix=i.tkhd.matrix,r.track_width=i.tkhd.width/65536,r.track_height=i.tkhd.height/65536,r.timescale=i.mdia.mdhd.timescale,r.cts_shift=i.mdia.minf.stbl.cslg,r.duration=i.mdia.mdhd.duration,r.samples_duration=i.samples_duration,r.codec=n.getCodec(),r.kind=i.udta&&i.udta.kinds.length?i.udta.kinds[0]:{schemeURI:"",value:""},r.language=i.mdia.elng?i.mdia.elng.extended_language:i.mdia.mdhd.languageString,r.nb_samples=i.samples.length,r.size=i.samples_size,r.bitrate=8*r.size*r.timescale/r.samples_duration,n.isAudio()?(r.type="audio",a.audioTracks.push(r),r.audio={},r.audio.sample_rate=n.getSampleRate(),r.audio.channel_count=n.getChannelCount(),r.audio.sample_size=n.getSampleSize()):n.isVideo()?(r.type="video",a.videoTracks.push(r),r.video={},r.video.width=n.getWidth(),r.video.height=n.getHeight()):n.isSubtitle()?(r.type="subtitles",a.subtitleTracks.push(r)):n.isHint()?(r.type="metadata",a.hintTracks.push(r)):n.isMetadata()?(r.type="metadata",a.metadataTracks.push(r)):(r.type="metadata",a.otherTracks.push(r))}else a.hasMoov=!1;if(a.mime="",a.hasMoov&&a.tracks){for(a.videoTracks&&a.videoTracks.length>0?a.mime+='video/mp4; codecs="':a.audioTracks&&a.audioTracks.length>0?a.mime+='audio/mp4; codecs="':a.mime+='application/mp4; codecs="',t=0;t<a.tracks.length;t++)0!==t&&(a.mime+=","),a.mime+=a.tracks[t].codec;a.mime+='"; profiles="',a.mime+=this.ftyp.compatible_brands.join(),a.mime+='"'}return a},u.prototype.processSamples=function(t){var e,r;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&null!==this.onSegment)for(e=0;e<this.fragmentedTracks.length;e++){var s=this.fragmentedTracks[e];for(r=s.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){i.debug("ISOFile","Creating media fragment on track #"+s.id+" for sample "+r.nextSample);var n=this.createFragment(s.id,r.nextSample,s.segmentStream);if(!n)break;if(s.segmentStream=n,r.nextSample++,(r.nextSample%s.nb_samples==0||t||r.nextSample>=r.samples.length)&&(i.info("ISOFile","Sending fragmented data on track #"+s.id+" for samples ["+Math.max(0,r.nextSample-s.nb_samples)+","+(r.nextSample-1)+"]"),i.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(s.id,s.user,s.segmentStream.buffer,r.nextSample,t||r.nextSample>=r.samples.length),s.segmentStream=null,s!==this.fragmentedTracks[e]))break}}if(null!==this.onSamples)for(e=0;e<this.extractedTracks.length;e++){var a=this.extractedTracks[e];for(r=a.trak;r.nextSample<r.samples.length&&this.sampleProcessingStarted;){i.debug("ISOFile","Exporting on track #"+a.id+" sample #"+r.nextSample);var o=this.getSample(r,r.nextSample);if(!o)break;if(r.nextSample++,a.samples.push(o),(r.nextSample%a.nb_samples==0||r.nextSample>=r.samples.length)&&(i.debug("ISOFile","Sending samples on track #"+a.id+" for sample "+r.nextSample),this.onSamples&&this.onSamples(a.id,a.user,a.samples),a.samples=[],a!==this.extractedTracks[e]))break}}}},u.prototype.getBox=function(t){var e=this.getBoxes(t,!0);return e.length?e[0]:null},u.prototype.getBoxes=function(t,e){var i=[];return u._sweep.call(this,t,i,e),i},u._sweep=function(t,e,i){for(var r in this.type&&this.type==t&&e.push(this),this.boxes){if(e.length&&i)return;u._sweep.call(this.boxes[r],t,e,i)}},u.prototype.getTrackSamplesInfo=function(t){var e=this.getTrackById(t);return e?e.samples:void 0},u.prototype.getTrackSample=function(t,e){var i=this.getTrackById(t);return this.getSample(i,e)},u.prototype.releaseUsedSamples=function(t,e){var r=0,s=this.getTrackById(t);s.lastValidSample||(s.lastValidSample=0);for(var n=s.lastValidSample;n<e;n++)r+=this.releaseSample(s,n);i.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+r+", remaining: "+this.samplesDataSize+")"),s.lastValidSample=e},u.prototype.start=function(){this.sampleProcessingStarted=!0,this.processSamples(!1)},u.prototype.stop=function(){this.sampleProcessingStarted=!1},u.prototype.flush=function(){i.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)},u.prototype.seekTrack=function(t,e,r){var s,n,a,o,l=0,h=0;if(0===r.samples.length)return i.info("ISOFile","No sample in track, cannot seek! Using time "+i.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(s=0;s<r.samples.length;s++){if(n=r.samples[s],0===s)h=0,o=n.timescale;else if(n.cts>t*n.timescale){h=s-1;break}e&&n.is_sync&&(l=s)}for(e&&(h=l),t=r.samples[h].cts,r.nextSample=h;r.samples[h].alreadyRead===r.samples[h].size&&r.samples[h+1];)h++;return a=r.samples[h].offset+r.samples[h].alreadyRead,i.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+r.nextSample+" on track "+r.tkhd.track_id+", time "+i.getDurationString(t,o)+" and offset: "+a),{offset:a,time:t/o}},u.prototype.seek=function(t,e){var r,s,n,a=this.moov,o={offset:1/0,time:1/0};if(this.moov){for(n=0;n<a.traks.length;n++)r=a.traks[n],(s=this.seekTrack(t,e,r)).offset<o.offset&&(o.offset=s.offset),s.time<o.time&&(o.time=s.time);return i.info("ISOFile","Seeking at time "+i.getDurationString(o.time,1)+" needs a buffer with a fileStart position of "+o.offset),o.offset===1/0?o={offset:this.nextParsePosition,time:0}:o.offset=this.stream.getEndFilePositionAfter(o.offset),i.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+o.offset),o}throw"Cannot seek: moov not received!"},u.prototype.equal=function(t){for(var e=0;e<this.boxes.length&&e<t.boxes.length;){var i=this.boxes[e],r=t.boxes[e];if(!l.boxEqual(i,r))return!1;e++}return!0},e.ISOFile=u,u.prototype.lastBoxStartPosition=0,u.prototype.parsingMdat=null,u.prototype.nextParsePosition=0,u.prototype.discardMdatData=!1,u.prototype.processIncompleteBox=function(t){var e;return"mdat"===t.type?(e=new l[t.type+"Box"](t.size),this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.parsingMdat=null,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)):("moov"===t.type&&(this.moovStartFound=!0,0===this.mdats.length&&(this.isProgressive=!0)),!!this.stream.mergeNextBuffer&&this.stream.mergeNextBuffer()?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1))},u.prototype.hasIncompleteMdat=function(){return null!==this.parsingMdat},u.prototype.processIncompleteMdat=function(){var t;return t=this.parsingMdat,this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(i.debug("ISOFile","Found 'mdat' end in buffered data"),this.parsingMdat=null,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)},u.prototype.restoreParsePosition=function(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)},u.prototype.saveParsePosition=function(){this.lastBoxStartPosition=this.stream.getPosition()},u.prototype.updateUsedBytes=function(t,e){this.stream.addUsedBytes&&("mdat"===t.type?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))},u.prototype.add=l.Box.prototype.add,u.prototype.addBox=l.Box.prototype.addBox,u.prototype.init=function(t){var e=t||{},i=(this.add("ftyp").set("major_brand",e.brands&&e.brands[0]||"iso4").set("minor_version",0).set("compatible_brands",e.brands||["iso4"]),this.add("moov"));return i.add("mvhd").set("timescale",e.timescale||600).set("rate",e.rate||65536).set("creation_time",0).set("modification_time",0).set("duration",e.duration||0).set("volume",e.width?0:256).set("matrix",[65536,0,0,0,65536,0,0,0,1073741824]).set("next_track_id",1),i.add("mvex"),this},u.prototype.addTrack=function(t){this.moov||this.init(t);var e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";var i=this.moov.add("trak");this.moov.mvhd.next_track_id=e.id+1,i.add("tkhd").set("flags",l.TKHD_FLAG_ENABLED|l.TKHD_FLAG_IN_MOVIE|l.TKHD_FLAG_IN_PREVIEW).set("creation_time",0).set("modification_time",0).set("track_id",e.id).set("duration",e.duration||0).set("layer",e.layer||0).set("alternate_group",0).set("volume",1).set("matrix",[0,0,0,0,0,0,0,0,0]).set("width",e.width<<16).set("height",e.height<<16);var s=i.add("mdia");s.add("mdhd").set("creation_time",0).set("modification_time",0).set("timescale",e.timescale||1).set("duration",e.media_duration||0).set("language",e.language||"und"),s.add("hdlr").set("handler",e.hdlr||"vide").set("name",e.name||"Track created with MP4Box.js"),s.add("elng").set("extended_language",e.language||"fr-FR");var n=s.add("minf");if(void 0!==l[e.type+"SampleEntry"]){var a=new l[e.type+"SampleEntry"];a.data_reference_index=1;var o="";for(var h in l.sampleEntryCodes)for(var d=l.sampleEntryCodes[h],c=0;c<d.length;c++)if(d.indexOf(e.type)>-1){o=h;break}switch(o){case"Visual":if(n.add("vmhd").set("graphicsmode",0).set("opcolor",[0,0,0]),a.set("width",e.width).set("height",e.height).set("horizresolution",72<<16).set("vertresolution",72<<16).set("frame_count",1).set("compressorname",e.type+" Compressor").set("depth",24),e.avcDecoderConfigRecord){var u=new l.avcCBox,f=new r(e.avcDecoderConfigRecord);u.parse(f),a.addBox(u)}break;case"Audio":n.add("smhd").set("balance",e.balance||0),a.set("channel_count",e.channel_count||2).set("samplesize",e.samplesize||16).set("samplerate",e.samplerate||65536);break;case"Hint":n.add("hmhd");break;case"Subtitle":if(n.add("sthd"),"stpp"===e.type)a.set("namespace",e.namespace||"nonamespace").set("schema_location",e.schema_location||"").set("auxiliary_mime_types",e.auxiliary_mime_types||"");break;default:n.add("nmhd")}e.description&&a.addBox(e.description),e.description_boxes&&e.description_boxes.forEach((function(t){a.addBox(t)})),n.add("dinf").add("dref").addEntry((new l["url Box"]).set("flags",1));var p=n.add("stbl");return p.add("stsd").addEntry(a),p.add("stts").set("sample_counts",[]).set("sample_deltas",[]),p.add("stsc").set("first_chunk",[]).set("samples_per_chunk",[]).set("sample_description_index",[]),p.add("stco").set("chunk_offsets",[]),p.add("stsz").set("sample_sizes",[]),this.moov.mvex.add("trex").set("track_id",e.id).set("default_sample_description_index",e.default_sample_description_index||1).set("default_sample_duration",e.default_sample_duration||0).set("default_sample_size",e.default_sample_size||0).set("default_sample_flags",e.default_sample_flags||0),this.buildTrakSampleLists(i),e.id}},l.Box.prototype.computeSize=function(t){var e=t||new s;e.endianness=s.BIG_ENDIAN,this.write(e)},u.prototype.addSample=function(t,e,i){var r=i||{},s={},n=this.getTrackById(t);if(null!==n){s.number=n.samples.length,s.track_id=n.tkhd.track_id,s.timescale=n.mdia.mdhd.timescale,s.description_index=r.sample_description_index?r.sample_description_index-1:0,s.description=n.mdia.minf.stbl.stsd.entries[s.description_index],s.data=e,s.size=e.byteLength,s.alreadyRead=s.size,s.duration=r.duration||1,s.cts=r.cts||0,s.dts=r.dts||0,s.is_sync=r.is_sync||!1,s.is_leading=r.is_leading||0,s.depends_on=r.depends_on||0,s.is_depended_on=r.is_depended_on||0,s.has_redundancy=r.has_redundancy||0,s.degradation_priority=r.degradation_priority||0,s.offset=0,s.subsamples=r.subsamples,n.samples.push(s),n.samples_size+=s.size,n.samples_duration+=s.duration,n.first_dts||(n.first_dts=r.dts),this.processSamples();var a=this.createSingleSampleMoof(s);return this.addBox(a),a.computeSize(),a.trafs[0].truns[0].data_offset=a.size+8,this.add("mdat").data=new Uint8Array(e),s}},u.prototype.createSingleSampleMoof=function(t){var e=0;e=t.is_sync?1<<25:65536;var i=new l.moofBox;i.add("mfhd").set("sequence_number",this.nextMoofNumber),this.nextMoofNumber++;var r=i.add("traf"),s=this.getTrackById(t.track_id);return r.add("tfhd").set("track_id",t.track_id).set("flags",l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),r.add("tfdt").set("baseMediaDecodeTime",t.dts-(s.first_dts||0)),r.add("trun").set("flags",l.TRUN_FLAGS_DATA_OFFSET|l.TRUN_FLAGS_DURATION|l.TRUN_FLAGS_SIZE|l.TRUN_FLAGS_FLAGS|l.TRUN_FLAGS_CTS_OFFSET).set("data_offset",0).set("first_sample_flags",0).set("sample_count",1).set("sample_duration",[t.duration]).set("sample_size",[t.size]).set("sample_flags",[e]).set("sample_composition_time_offset",[t.cts-t.dts]),i},u.prototype.lastMoofIndex=0,u.prototype.samplesDataSize=0,u.prototype.resetTables=function(){var t,e,i,r,s,n;for(this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0,t=0;t<this.moov.traks.length;t++){(e=this.moov.traks[t]).tkhd.duration=0,e.mdia.mdhd.duration=0,(e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64).chunk_offsets=[],(i=e.mdia.minf.stbl.stsc).first_chunk=[],i.samples_per_chunk=[],i.sample_description_index=[],(e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2).sample_sizes=[],(r=e.mdia.minf.stbl.stts).sample_counts=[],r.sample_deltas=[],(s=e.mdia.minf.stbl.ctts)&&(s.sample_counts=[],s.sample_offsets=[]),n=e.mdia.minf.stbl.stss;var a=e.mdia.minf.stbl.boxes.indexOf(n);-1!=a&&(e.mdia.minf.stbl.boxes[a]=null)}},u.initSampleGroups=function(t,e,i,r,s){var n,a,o,l;function h(t,e,i){this.grouping_type=t,this.grouping_type_parameter=e,this.sbgp=i,this.last_sample_in_run=-1,this.entry_index=-1}for(e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]),a=0;a<i.length;a++){for(l=i[a].grouping_type+"/"+i[a].grouping_type_parameter,o=new h(i[a].grouping_type,i[a].grouping_type_parameter,i[a]),e&&(e.sample_groups_info[l]=o),t.sample_groups_info[l]||(t.sample_groups_info[l]=o),n=0;n<r.length;n++)r[n].grouping_type===i[a].grouping_type&&(o.description=r[n],o.description.used=!0);if(s)for(n=0;n<s.length;n++)s[n].grouping_type===i[a].grouping_type&&(o.fragment_description=s[n],o.fragment_description.used=!0,o.is_fragment=!0)}if(e){if(s)for(a=0;a<s.length;a++)!s[a].used&&s[a].version>=2&&(l=s[a].grouping_type+"/0",(o=new h(s[a].grouping_type,0)).is_fragment=!0,e.sample_groups_info[l]||(e.sample_groups_info[l]=o))}else for(a=0;a<r.length;a++)!r[a].used&&r[a].version>=2&&(l=r[a].grouping_type+"/0",o=new h(r[a].grouping_type,0),t.sample_groups_info[l]||(t.sample_groups_info[l]=o))},u.setSampleGroupProperties=function(t,e,i,r){var s,n;for(s in e.sample_groups=[],r){var a;if(e.sample_groups[s]={},e.sample_groups[s].grouping_type=r[s].grouping_type,e.sample_groups[s].grouping_type_parameter=r[s].grouping_type_parameter,i>=r[s].last_sample_in_run&&(r[s].last_sample_in_run<0&&(r[s].last_sample_in_run=0),r[s].entry_index++,r[s].entry_index<=r[s].sbgp.entries.length-1&&(r[s].last_sample_in_run+=r[s].sbgp.entries[r[s].entry_index].sample_count)),r[s].entry_index<=r[s].sbgp.entries.length-1?e.sample_groups[s].group_description_index=r[s].sbgp.entries[r[s].entry_index].group_description_index:e.sample_groups[s].group_description_index=-1,0!==e.sample_groups[s].group_description_index)a=r[s].fragment_description?r[s].fragment_description:r[s].description,e.sample_groups[s].group_description_index>0?(n=e.sample_groups[s].group_description_index>65535?(e.sample_groups[s].group_description_index>>16)-1:e.sample_groups[s].group_description_index-1,a&&n>=0&&(e.sample_groups[s].description=a.entries[n])):a&&a.version>=2&&a.default_group_description_index>0&&(e.sample_groups[s].description=a.entries[a.default_group_description_index-1])}},u.process_sdtp=function(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))},u.prototype.buildSampleLists=function(){var t,e;for(t=0;t<this.moov.traks.length;t++)e=this.moov.traks[t],this.buildTrakSampleLists(e)},u.prototype.buildTrakSampleLists=function(t){var e,i,r,s,n,a,o,l,h,d,c,f,p,m,g,y,v,_,S,T,E,b,w,L;if(t.samples=[],t.samples_duration=0,t.samples_size=0,i=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,r=t.mdia.minf.stbl.stsc,s=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,n=t.mdia.minf.stbl.stts,a=t.mdia.minf.stbl.ctts,o=t.mdia.minf.stbl.stss,l=t.mdia.minf.stbl.stsd,h=t.mdia.minf.stbl.subs,f=t.mdia.minf.stbl.stdp,d=t.mdia.minf.stbl.sbgps,c=t.mdia.minf.stbl.sgpds,_=-1,S=-1,T=-1,E=-1,b=0,w=0,L=0,u.initSampleGroups(t,null,d,c),void 0!==s){for(e=0;e<s.sample_sizes.length;e++){var A={};A.number=e,A.track_id=t.tkhd.track_id,A.timescale=t.mdia.mdhd.timescale,A.alreadyRead=0,t.samples[e]=A,A.size=s.sample_sizes[e],t.samples_size+=A.size,0===e?(m=1,p=0,A.chunk_index=m,A.chunk_run_index=p,v=r.samples_per_chunk[p],y=0,g=p+1<r.first_chunk.length?r.first_chunk[p+1]-1:1/0):e<v?(A.chunk_index=m,A.chunk_run_index=p):(m++,A.chunk_index=m,y=0,m<=g||(g=++p+1<r.first_chunk.length?r.first_chunk[p+1]-1:1/0),A.chunk_run_index=p,v+=r.samples_per_chunk[p]),A.description_index=r.sample_description_index[A.chunk_run_index]-1,A.description=l.entries[A.description_index],A.offset=i.chunk_offsets[A.chunk_index-1]+y,y+=A.size,e>_&&(S++,_<0&&(_=0),_+=n.sample_counts[S]),e>0?(t.samples[e-1].duration=n.sample_deltas[S],t.samples_duration+=t.samples[e-1].duration,A.dts=t.samples[e-1].dts+t.samples[e-1].duration):A.dts=0,a?(e>=T&&(E++,T<0&&(T=0),T+=a.sample_counts[E]),A.cts=t.samples[e].dts+a.sample_offsets[E]):A.cts=A.dts,o?(e==o.sample_numbers[b]-1?(A.is_sync=!0,b++):(A.is_sync=!1,A.degradation_priority=0),h&&h.entries[w].sample_delta+L==e+1&&(A.subsamples=h.entries[w].subsamples,L+=h.entries[w].sample_delta,w++)):A.is_sync=!0,u.process_sdtp(t.mdia.minf.stbl.sdtp,A,A.number),A.degradation_priority=f?f.priority[e]:0,h&&h.entries[w].sample_delta+L==e&&(A.subsamples=h.entries[w].subsamples,L+=h.entries[w].sample_delta),(d.length>0||c.length>0)&&u.setSampleGroupProperties(t,A,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}},u.prototype.updateSampleLists=function(){var t,e,i,r,s,n,a,o,h,d,c,f,p,m,g;if(void 0!==this.moov)for(;this.lastMoofIndex<this.moofs.length;)if(h=this.moofs[this.lastMoofIndex],this.lastMoofIndex++,"moof"==h.type)for(d=h,t=0;t<d.trafs.length;t++){for(c=d.trafs[t],f=this.getTrackById(c.tfhd.track_id),p=this.getTrexById(c.tfhd.track_id),r=c.tfhd.flags&l.TFHD_FLAG_SAMPLE_DESC?c.tfhd.default_sample_description_index:p?p.default_sample_description_index:1,s=c.tfhd.flags&l.TFHD_FLAG_SAMPLE_DUR?c.tfhd.default_sample_duration:p?p.default_sample_duration:0,n=c.tfhd.flags&l.TFHD_FLAG_SAMPLE_SIZE?c.tfhd.default_sample_size:p?p.default_sample_size:0,a=c.tfhd.flags&l.TFHD_FLAG_SAMPLE_FLAGS?c.tfhd.default_sample_flags:p?p.default_sample_flags:0,c.sample_number=0,c.sbgps.length>0&&u.initSampleGroups(f,c,c.sbgps,f.mdia.minf.stbl.sgpds,c.sgpds),e=0;e<c.truns.length;e++){var y=c.truns[e];for(i=0;i<y.sample_count;i++){(m={}).moof_number=this.lastMoofIndex,m.number_in_traf=c.sample_number,c.sample_number++,m.number=f.samples.length,c.first_sample_index=f.samples.length,f.samples.push(m),m.track_id=f.tkhd.track_id,m.timescale=f.mdia.mdhd.timescale,m.description_index=r-1,m.description=f.mdia.minf.stbl.stsd.entries[m.description_index],m.size=n,y.flags&l.TRUN_FLAGS_SIZE&&(m.size=y.sample_size[i]),f.samples_size+=m.size,m.duration=s,y.flags&l.TRUN_FLAGS_DURATION&&(m.duration=y.sample_duration[i]),f.samples_duration+=m.duration,f.first_traf_merged||i>0?m.dts=f.samples[f.samples.length-2].dts+f.samples[f.samples.length-2].duration:(c.tfdt?m.dts=c.tfdt.baseMediaDecodeTime:m.dts=0,f.first_traf_merged=!0),m.cts=m.dts,y.flags&l.TRUN_FLAGS_CTS_OFFSET&&(m.cts=m.dts+y.sample_composition_time_offset[i]),g=a,y.flags&l.TRUN_FLAGS_FLAGS?g=y.sample_flags[i]:0===i&&y.flags&l.TRUN_FLAGS_FIRST_FLAG&&(g=y.first_sample_flags),m.is_sync=!(g>>16&1),m.is_leading=g>>26&3,m.depends_on=g>>24&3,m.is_depended_on=g>>22&3,m.has_redundancy=g>>20&3,m.degradation_priority=65535&g;var v=!!(c.tfhd.flags&l.TFHD_FLAG_BASE_DATA_OFFSET),_=!!(c.tfhd.flags&l.TFHD_FLAG_DEFAULT_BASE_IS_MOOF),S=!!(y.flags&l.TRUN_FLAGS_DATA_OFFSET),T=0;T=v?c.tfhd.base_data_offset:_||0===e?d.start:o,m.offset=0===e&&0===i?S?T+y.data_offset:T:o,o=m.offset+m.size,(c.sbgps.length>0||c.sgpds.length>0||f.mdia.minf.stbl.sbgps.length>0||f.mdia.minf.stbl.sgpds.length>0)&&u.setSampleGroupProperties(f,m,m.number_in_traf,c.sample_groups_info)}}if(c.subs){f.has_fragment_subsamples=!0;var E=c.first_sample_index;for(e=0;e<c.subs.entries.length;e++)E+=c.subs.entries[e].sample_delta,(m=f.samples[E-1]).subsamples=c.subs.entries[e].subsamples}}},u.prototype.getSample=function(t,e){var r,n=t.samples[e];if(!this.moov)return null;if(n.data){if(n.alreadyRead==n.size)return n}else n.data=new Uint8Array(n.size),n.alreadyRead=0,this.samplesDataSize+=n.size,i.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+n.size+" (total: "+this.samplesDataSize+")");for(;;){var a=this.stream.findPosition(!0,n.offset+n.alreadyRead,!1);if(!(a>-1))return null;var o=(r=this.stream.buffers[a]).byteLength-(n.offset+n.alreadyRead-r.fileStart);if(n.size-n.alreadyRead<=o)return i.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-r.fileStart)+" read size: "+(n.size-n.alreadyRead)+" full size: "+n.size+")"),s.memcpy(n.data.buffer,n.alreadyRead,r,n.offset+n.alreadyRead-r.fileStart,n.size-n.alreadyRead),r.usedBytes+=n.size-n.alreadyRead,this.stream.logBufferLevel(),n.alreadyRead=n.size,n;if(0===o)return null;i.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+n.alreadyRead+" offset: "+(n.offset+n.alreadyRead-r.fileStart)+" read size: "+o+" full size: "+n.size+")"),s.memcpy(n.data.buffer,n.alreadyRead,r,n.offset+n.alreadyRead-r.fileStart,o),n.alreadyRead+=o,r.usedBytes+=o,this.stream.logBufferLevel()}},u.prototype.releaseSample=function(t,e){var i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=null,i.alreadyRead=0,i.size):0},u.prototype.getAllocatedSampleDataSize=function(){return this.samplesDataSize},u.prototype.getCodecs=function(){var t,e="";for(t=0;t<this.moov.traks.length;t++){t>0&&(e+=","),e+=this.moov.traks[t].mdia.minf.stbl.stsd.entries[0].getCodec()}return e},u.prototype.getTrexById=function(t){var e;if(!this.moov||!this.moov.mvex)return null;for(e=0;e<this.moov.mvex.trexs.length;e++){var i=this.moov.mvex.trexs[e];if(i.track_id==t)return i}return null},u.prototype.getTrackById=function(t){if(void 0===this.moov)return null;for(var e=0;e<this.moov.traks.length;e++){var i=this.moov.traks[e];if(i.tkhd.track_id==t)return i}return null},u.prototype.items=[],u.prototype.itemsDataSize=0,u.prototype.flattenItemInfo=function(){var t,e,r,s=this.items,n=this.meta;if(null!=n&&void 0!==n.hdlr&&void 0!==n.iinf){for(t=0;t<n.iinf.item_infos.length;t++)(r={}).id=n.iinf.item_infos[t].item_ID,s[r.id]=r,r.ref_to=[],r.name=n.iinf.item_infos[t].item_name,n.iinf.item_infos[t].protection_index>0&&(r.protection=n.ipro.protections[n.iinf.item_infos[t].protection_index-1]),n.iinf.item_infos[t].item_type?r.type=n.iinf.item_infos[t].item_type:r.type="mime",r.content_type=n.iinf.item_infos[t].content_type,r.content_encoding=n.iinf.item_infos[t].content_encoding;if(n.iloc)for(t=0;t<n.iloc.items.length;t++){var a=n.iloc.items[t];switch(r=s[a.item_ID],0!==a.data_reference_index&&(i.warn("Item storage with reference to other files: not supported"),r.source=n.dinf.boxes[a.data_reference_index-1]),a.construction_method){case 0:break;case 1:case 2:i.warn("Item storage with construction_method : not supported")}for(r.extents=[],r.size=0,e=0;e<a.extents.length;e++)r.extents[e]={},r.extents[e].offset=a.extents[e].extent_offset+a.base_offset,r.extents[e].length=a.extents[e].extent_length,r.extents[e].alreadyRead=0,r.size+=r.extents[e].length}if(n.pitm&&(s[n.pitm.item_id].primary=!0),n.iref)for(t=0;t<n.iref.references.length;t++){var o=n.iref.references[t];for(e=0;e<o.references.length;e++)s[o.from_item_ID].ref_to.push({type:o.type,id:o.references[e]})}if(n.iprp)for(var l=0;l<n.iprp.ipmas.length;l++){var h=n.iprp.ipmas[l];for(t=0;t<h.associations.length;t++){var d=h.associations[t];for(void 0===(r=s[d.id]).properties&&(r.properties={},r.properties.boxes=[]),e=0;e<d.props.length;e++){var c=d.props[e];if(c.property_index>0&&c.property_index-1<n.iprp.ipco.boxes.length){var u=n.iprp.ipco.boxes[c.property_index-1];r.properties[u.type]=u,r.properties.boxes.push(u)}}}}}},u.prototype.getItem=function(t){var e,r;if(!this.meta)return null;if(!(r=this.items[t]).data&&r.size)r.data=new Uint8Array(r.size),r.alreadyRead=0,this.itemsDataSize+=r.size,i.debug("ISOFile","Allocating item #"+t+" of size "+r.size+" (total: "+this.itemsDataSize+")");else if(r.alreadyRead===r.size)return r;for(var n=0;n<r.extents.length;n++){var a=r.extents[n];if(a.alreadyRead!==a.length){var o=this.stream.findPosition(!0,a.offset+a.alreadyRead,!1);if(!(o>-1))return null;var l=(e=this.stream.buffers[o]).byteLength-(a.offset+a.alreadyRead-e.fileStart);if(!(a.length-a.alreadyRead<=l))return i.debug("ISOFile","Getting item #"+t+" extent #"+n+" partial data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+l+" full extent size: "+a.length+" full item size: "+r.size+")"),s.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,l),a.alreadyRead+=l,r.alreadyRead+=l,e.usedBytes+=l,this.stream.logBufferLevel(),null;i.debug("ISOFile","Getting item #"+t+" extent #"+n+" data (alreadyRead: "+a.alreadyRead+" offset: "+(a.offset+a.alreadyRead-e.fileStart)+" read size: "+(a.length-a.alreadyRead)+" full extent size: "+a.length+" full item size: "+r.size+")"),s.memcpy(r.data.buffer,r.alreadyRead,e,a.offset+a.alreadyRead-e.fileStart,a.length-a.alreadyRead),e.usedBytes+=a.length-a.alreadyRead,this.stream.logBufferLevel(),r.alreadyRead+=a.length-a.alreadyRead,a.alreadyRead=a.length}}return r.alreadyRead===r.size?r:null},u.prototype.releaseItem=function(t){var e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=null,e.alreadyRead=0;for(var i=0;i<e.extents.length;i++){e.extents[i].alreadyRead=0}return e.size}return 0},u.prototype.processItems=function(t){for(var e in this.items){var i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=null)}},u.prototype.hasItem=function(t){for(var e in this.items){var i=this.items[e];if(i.name===t)return i.id}return-1},u.prototype.getMetaHandler=function(){return this.meta?this.meta.hdlr.handler:null},u.prototype.getPrimaryItem=function(){return this.meta&&this.meta.pitm?this.getItem(this.meta.pitm.item_id):null},u.prototype.itemToFragmentedTrackFile=function(t){var e=t||{},i=null;if(null==(i=e.itemId?this.getItem(e.itemId):this.getPrimaryItem()))return null;var r=new u;r.discardMdatData=!1;var s={type:i.type,description_boxes:i.properties.boxes};i.properties.ispe&&(s.width=i.properties.ispe.image_width,s.height=i.properties.ispe.image_height);var n=r.addTrack(s);return n?(r.addSample(n,i.data),r):null},u.prototype.write=function(t){for(var e=0;e<this.boxes.length;e++)this.boxes[e].write(t)},u.prototype.createFragment=function(t,e,r){var n=this.getTrackById(t),a=this.getSample(n,e);if(null==a)return a=n.samples[e],this.nextSeekPosition?this.nextSeekPosition=Math.min(a.offset+a.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=n.samples[e].offset+a.alreadyRead,null;var o=r||new s;o.endianness=s.BIG_ENDIAN;var h=this.createSingleSampleMoof(a);h.write(o),h.trafs[0].truns[0].data_offset=h.size+8,i.debug("MP4Box","Adjusting data_offset with new value "+h.trafs[0].truns[0].data_offset),o.adjustUint32(h.trafs[0].truns[0].data_offset_position,h.trafs[0].truns[0].data_offset);var d=new l.mdatBox;return d.data=a.data,d.write(o),o},u.writeInitializationSegment=function(t,e,r,n){var a;i.debug("ISOFile","Generating initialization segment");var o=new s;o.endianness=s.BIG_ENDIAN,t.write(o);var l=e.add("mvex");for(r&&l.add("mehd").set("fragment_duration",r),a=0;a<e.traks.length;a++)l.add("trex").set("track_id",e.traks[a].tkhd.track_id).set("default_sample_description_index",1).set("default_sample_duration",n).set("default_sample_size",0).set("default_sample_flags",65536);return e.write(o),o.buffer},u.prototype.save=function(t){var e=new s;e.endianness=s.BIG_ENDIAN,this.write(e),e.save(t)},u.prototype.getBuffer=function(){var t=new s;return t.endianness=s.BIG_ENDIAN,this.write(t),t.buffer},u.prototype.initializeSegmentation=function(){var t,e,r,s;for(null===this.onSegment&&i.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.nextMoofNumber=0,this.resetTables()),e=[],t=0;t<this.fragmentedTracks.length;t++){var n=new l.moovBox;n.mvhd=this.moov.mvhd,n.boxes.push(n.mvhd),r=this.getTrackById(this.fragmentedTracks[t].id),n.boxes.push(r),n.traks.push(r),(s={}).id=r.tkhd.track_id,s.user=this.fragmentedTracks[t].user,s.buffer=u.writeInitializationSegment(this.ftyp,n,this.moov.mvex&&this.moov.mvex.mehd?this.moov.mvex.mehd.fragment_duration:void 0,this.moov.traks[t].samples.length>0?this.moov.traks[t].samples[0].duration:0),e.push(s)}return e},l.Box.prototype.printHeader=function(t){this.size+=8,this.size>n&&(this.size+=8),"uuid"===this.type&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)},l.FullBox.prototype.printHeader=function(t){this.size+=4,l.Box.prototype.printHeader.call(this,t),t.log(t.indent+"version:"+this.version),t.log(t.indent+"flags:"+this.flags)},l.Box.prototype.print=function(t){this.printHeader(t)},l.ContainerBox.prototype.print=function(t){this.printHeader(t);for(var e=0;e<this.boxes.length;e++)if(this.boxes[e]){var i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}},u.prototype.print=function(t){t.indent="";for(var e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)},l.mvhdBox.prototype.print=function(t){l.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"timescale: "+this.timescale),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"rate: "+this.rate),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"next_track_id: "+this.next_track_id)},l.tkhdBox.prototype.print=function(t){l.FullBox.prototype.printHeader.call(this,t),t.log(t.indent+"creation_time: "+this.creation_time),t.log(t.indent+"modification_time: "+this.modification_time),t.log(t.indent+"track_id: "+this.track_id),t.log(t.indent+"duration: "+this.duration),t.log(t.indent+"volume: "+(this.volume>>8)),t.log(t.indent+"matrix: "+this.matrix.join(", ")),t.log(t.indent+"layer: "+this.layer),t.log(t.indent+"alternate_group: "+this.alternate_group),t.log(t.indent+"width: "+this.width),t.log(t.indent+"height: "+this.height)};var f={createFile:function(t,e){var i=void 0===t||t,r=new u(e);return r.discardMdatData=!i,r}};e.createFile=f.createFile},6:function(t){var e;e=()=>{"use strict";const t="object"==typeof window?window:this;t.HTMLElement;let e=null,i=!1;const r=t.WebStreamsPolyfill||{},s=t.isSecureContext;let n=/constructor/i.test(t.HTMLElement)||!!t.safari||!!t.WebKitPoint;const a=s||"MozAppearance"in document.documentElement.style?"iframe":"navigate",o={createWriteStream:function(r,h,d){let c={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},u=0,f=null,p=null,m=null;if(Number.isFinite(h)?([d,h]=[h,d],c.size=d,c.writableStrategy=h):h&&h.highWaterMark?(c.size=d,c.writableStrategy=h):c=h||{},!n){e||(e=s?l(o.mitm):function(e){const i="width=200,height=100",r=document.createDocumentFragment(),s={frame:t.open(e,"popup",i),loaded:!1,isIframe:!1,isPopup:!0,remove(){s.frame.close()},addEventListener(...t){r.addEventListener(...t)},dispatchEvent(...t){r.dispatchEvent(...t)},removeEventListener(...t){r.removeEventListener(...t)},postMessage(...t){s.frame.postMessage(...t)}},n=e=>{e.source===s.frame&&(s.loaded=!0,t.removeEventListener("message",n),s.dispatchEvent(new Event("load")))};return t.addEventListener("message",n),s}(o.mitm)),p=new MessageChannel,r=encodeURIComponent(r.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const n={transferringReadable:i,pathname:c.pathname||Math.random().toString().slice(-6)+"/"+r,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+r}};c.size&&(n.headers["Content-Length"]=c.size);const h=[n,"*",[p.port2]];if(i){const t="iframe"===a?void 0:{transform(t,e){if(!(t instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");u+=t.length,e.enqueue(t),f&&(location.href=f,f=null)},flush(){f&&(location.href=f)}};m=new o.TransformStream(t,c.writableStrategy,c.readableStrategy);const e=m.readable;p.port1.postMessage({readableStream:e},[e])}p.port1.onmessage=t=>{t.data.download?"navigate"===a?(e.remove(),e=null,u?location.href=t.data.download:f=t.data.download):(e.isPopup&&(e.remove(),e=null,"iframe"===a&&l(o.mitm)),l(t.data.download)):t.data.abort&&(g=[],p.port1.postMessage("abort"),p.port1.onmessage=null,p.port1.close(),p.port2.close(),p=null)},e.loaded?e.postMessage(...h):e.addEventListener("load",(()=>{e.postMessage(...h)}),{once:!0})}let g=[];return!n&&m&&m.writable||new o.WritableStream({write(t){if(!(t instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");n?g.push(t):(p.port1.postMessage(t),u+=t.length,f&&(location.href=f,f=null))},close(){if(n){const t=new Blob(g,{type:"application/octet-stream; charset=utf-8"}),e=document.createElement("a");e.href=URL.createObjectURL(t),e.download=r,e.click()}else p.port1.postMessage("end")},abort(){g=[],p.port1.postMessage("abort"),p.port1.onmessage=null,p.port1.close(),p.port2.close(),p=null}},c.writableStrategy)},WritableStream:t.WritableStream||r.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};function l(t){if(!t)throw new Error("meh");const e=document.createElement("iframe");return e.hidden=!0,e.src=t,e.loaded=!1,e.name="iframe",e.isIframe=!0,e.postMessage=(...t)=>e.contentWindow.postMessage(...t),e.addEventListener("load",(()=>{e.loaded=!0}),{once:!0}),document.body.appendChild(e),e}try{new Response(new ReadableStream),s&&!("serviceWorker"in navigator)&&(n=!0)}catch(t){n=!0}return(t=>{try{t()}catch(t){}})((()=>{const{readable:t}=new TransformStream,e=new MessageChannel;e.port1.postMessage(t,[t]),e.port1.close(),e.port2.close(),i=!0,Object.defineProperty(o,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})})),o},t.exports=e()},337:(t,e,i)=>{var r=i(501).default;function s(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */t.exports=s=function(){return e},t.exports.__esModule=!0,t.exports.default=t.exports;var e={},i=Object.prototype,n=i.hasOwnProperty,a=Object.defineProperty||function(t,e,i){t[e]=i.value},o="function"==typeof Symbol?Symbol:{},l=o.iterator||"@@iterator",h=o.asyncIterator||"@@asyncIterator",d=o.toStringTag||"@@toStringTag";function c(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(t){c=function(t,e,i){return t[e]=i}}function u(t,e,i,r){var s=e&&e.prototype instanceof m?e:m,n=Object.create(s.prototype),o=new k(r||[]);return a(n,"_invoke",{value:w(t,i,o)}),n}function f(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(t){return{type:"throw",arg:t}}}e.wrap=u;var p={};function m(){}function g(){}function y(){}var v={};c(v,l,(function(){return this}));var _=Object.getPrototypeOf,S=_&&_(_(R([])));S&&S!==i&&n.call(S,l)&&(v=S);var T=y.prototype=m.prototype=Object.create(v);function E(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function b(t,e){function i(s,a,o,l){var h=f(t[s],t,a);if("throw"!==h.type){var d=h.arg,c=d.value;return c&&"object"==r(c)&&n.call(c,"__await")?e.resolve(c.__await).then((function(t){i("next",t,o,l)}),(function(t){i("throw",t,o,l)})):e.resolve(c).then((function(t){d.value=t,o(d)}),(function(t){return i("throw",t,o,l)}))}l(h.arg)}var s;a(this,"_invoke",{value:function(t,r){function n(){return new e((function(e,s){i(t,r,e,s)}))}return s=s?s.then(n,n):n()}})}function w(t,e,i){var r="suspendedStart";return function(s,n){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===s)throw n;return D()}for(i.method=s,i.arg=n;;){var a=i.delegate;if(a){var o=L(a,i);if(o){if(o===p)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===r)throw r="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r="executing";var l=f(t,e,i);if("normal"===l.type){if(r=i.done?"completed":"suspendedYield",l.arg===p)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r="completed",i.method="throw",i.arg=l.arg)}}}function L(t,e){var i=e.method,r=t.iterator[i];if(void 0===r)return e.delegate=null,"throw"===i&&t.iterator.return&&(e.method="return",e.arg=void 0,L(t,e),"throw"===e.method)||"return"!==i&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+i+"' method")),p;var s=f(r,t.iterator,e.arg);if("throw"===s.type)return e.method="throw",e.arg=s.arg,e.delegate=null,p;var n=s.arg;return n?n.done?(e[t.resultName]=n.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,p):n:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,p)}function A(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function x(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function k(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(A,this),this.reset(!0)}function R(t){if(t){var e=t[l];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,r=function e(){for(;++i<t.length;)if(n.call(t,i))return e.value=t[i],e.done=!1,e;return e.value=void 0,e.done=!0,e};return r.next=r}}return{next:D}}function D(){return{value:void 0,done:!0}}return g.prototype=y,a(T,"constructor",{value:y,configurable:!0}),a(y,"constructor",{value:g,configurable:!0}),g.displayName=c(y,d,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,y):(t.__proto__=y,c(t,d,"GeneratorFunction")),t.prototype=Object.create(T),t},e.awrap=function(t){return{__await:t}},E(b.prototype),c(b.prototype,h,(function(){return this})),e.AsyncIterator=b,e.async=function(t,i,r,s,n){void 0===n&&(n=Promise);var a=new b(u(t,i,r,s),n);return e.isGeneratorFunction(i)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},E(T),c(T,d,"Generator"),c(T,l,(function(){return this})),c(T,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),i=[];for(var r in e)i.push(r);return i.reverse(),function t(){for(;i.length;){var r=i.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=R,k.prototype={constructor:k,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(x),!t)for(var e in this)"t"===e.charAt(0)&&n.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function i(i,r){return a.type="throw",a.arg=t,e.next=i,r&&(e.method="next",e.arg=void 0),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var s=this.tryEntries[r],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var o=n.call(s,"catchLoc"),l=n.call(s,"finallyLoc");if(o&&l){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(o){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var r=this.tryEntries[i];if(r.tryLoc<=this.prev&&n.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===t||"continue"===t)&&s.tryLoc<=e&&e<=s.finallyLoc&&(s=null);var a=s?s.completion:{};return a.type=t,a.arg=e,s?(this.method="next",this.next=s.finallyLoc,p):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),p},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),x(i),p}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var r=i.completion;if("throw"===r.type){var s=r.arg;x(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,i){return this.delegate={iterator:R(t),resultName:e,nextLoc:i},"next"===this.method&&(this.arg=void 0),p}},e}t.exports=s,t.exports.__esModule=!0,t.exports.default=t.exports},501:t=>{function e(i){return t.exports=e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,e(i)}t.exports=e,t.exports.__esModule=!0,t.exports.default=t.exports},824:(t,e,i)=>{var r=i(337)();t.exports=r;try{regeneratorRuntime=r}catch(t){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}},793:(t,e,i)=>{"use strict";function r(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}i.d(e,{Z:()=>r})},649:(t,e,i)=>{"use strict";i.d(e,{Z:()=>s});var r=i(217);function s(t,e,i){return(e=(0,r.Z)(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}},809:(t,e,i)=>{"use strict";i.d(e,{Z:()=>s});var r=i(13);function s(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var r,s,n,a,o=[],l=!0,h=!1;try{if(n=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=n.call(i)).done)&&(o.push(r.value),o.length!==e);l=!0);}catch(t){h=!0,s=t}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(h)throw s}}return o}}(t,e)||(0,r.Z)(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}},217:(t,e,i)=>{"use strict";i.d(e,{Z:()=>s});var r=i(940);function s(t){var e=function(t,e){if("object"!==(0,r.Z)(t)||null===t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var s=i.call(t,e||"default");if("object"!==(0,r.Z)(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"===(0,r.Z)(e)?e:String(e)}},940:(t,e,i)=>{"use strict";function r(t){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r(t)}i.d(e,{Z:()=>r})},13:(t,e,i)=>{"use strict";i.d(e,{Z:()=>s});var r=i(793);function s(t,e){if(t){if("string"==typeof t)return(0,r.Z)(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?(0,r.Z)(t,e):void 0}}}},e={};function i(r){var s=e[r];if(void 0!==s)return s.exports;var n=e[r]={exports:{}};return t[r].call(n.exports,n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t=i(824),e=i.n(t);function r(t,e,i,r,s,n,a){try{var o=t[n](a),l=o.value}catch(t){return void i(t)}o.done?e(l):Promise.resolve(l).then(r,s)}function s(t){return function(){var e=this,i=arguments;return new Promise((function(s,n){var a=t.apply(e,i);function o(t){r(a,s,n,o,l,"next",t)}function l(t){r(a,s,n,o,l,"throw",t)}o(void 0)}))}}var n=navigator.userAgent.includes("Chrome")?chrome:browser,a="FETCH_DOM",o="ADD_HEADER",l="UNSET_HEADER",h="KEEP_SET_HEADER",d="SET_SPEEDUP_REC",c="SET_USER_INFO",u="MESSAGEPIPE",f="ONE2ONEMESSAGE",p="GET_BG_OPTIONS",m="SET_BG_OPTIONS",g="M3U8DL_AJAX",y={GET_parentVideoPageTabId:"GET_parentVideoPageTabId",ASK_VPAGE_START_CAPTURE:"ASK_VPAGE_START_CAPTURE",CAPTURE_STARTED:"CAPTURE_STARTED",VPAGE_CAPTURED_ONE_BUFFER:"VPAGE_CAPTURED_ONE_BUFFER",CAPTURE_ABORT:"CAPTURE_ABORT",CAPTURE_DONE:"CAPTURE_DONE",SEND_ONE_BUFFER_TO_DLPAGE:"SEND_ONE_BUFFER_TO_DLPAGE",SET_HLSDL_HEADERS:"SET_HLSDL_HEADERS",GET_MPD_M3U8_TEXT:"GET_MPD_M3U8_TEXT"};function v(t,e){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n.runtime.onMessage.addListener((function(r,s,n){var a=r.eventName,o=r.data;return a===t&&(e(o,n,s),!!i||void 0)}))}var _,S,T,E,b,w,L,A,x,k,R=(_=s(e().mark((function t(i,r){var s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.runtime.sendMessage({eventName:i,data:r});case 2:return s=t.sent,t.abrupt("return",s);case 4:case"end":return t.stop()}}),t)}))),function(t,e){return _.apply(this,arguments)}),D=(S=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(a,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),T=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(o,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),E=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(l,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),b=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(h,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),w=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(c,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),L=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:R(u,i);case 1:case"end":return t.stop()}}),t)}))),A=s(e().mark((function t(){var i;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(p);case 2:return i=t.sent,t.abrupt("return",i);case 4:case"end":return t.stop()}}),t)}))),x=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:R(m,i);case 1:case"end":return t.stop()}}),t)}))),k=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(g,i);case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),function(t){return k.apply(this,arguments)}),I=i(809);function C(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var U=i(217);function P(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,(0,U.Z)(r.key),r)}}function M(t,e,i){return e&&P(t.prototype,e),i&&P(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}var F=i(793);var O=i(13);function B(t){return function(t){if(Array.isArray(t))return(0,F.Z)(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||(0,O.Z)(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}const N=navigator.userAgent.includes("Chrome")?chrome:browser,G=t=>new Promise(((e,i)=>N.storage.sync.get(t,(r=>N.runtime.lastError?i(Error(N.runtime.lastError.message)):e(r?r[t]:void 0)))));function $(t,e){const i={};return i[t]=e,N.storage.sync.set(i)}function z(t,e,i){!function(t,e){const i={};i[t]=e,N.storage.local.set(i)}(t,{value:e,expiry:(new Date).getTime()+i})}async function H(t){const e=await(t=>new Promise(((e,i)=>N.storage.local.get(t,(r=>N.runtime.lastError?i(Error(N.runtime.lastError.message)):e(r?r[t]:void 0))))))(t);if(!e)return null;return(new Date).getTime()>e.expiry?(function(t){N.storage.local.remove(t)}(t),null):e.value}var V=function(t){var e=function(e){return(i=t,i.split("").map((function(t){return t.charCodeAt(0)}))).reduce((function(t,e){return t^e}),e);var i};return function(t){return t.match(/.{1,2}/g).map((function(t){return parseInt(t,16)})).map(e).map((function(t){return String.fromCharCode(t)})).join("")}};function K(){return 1440-60*(new Date).getHours()-(new Date).getMinutes()}!function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,H("dailyDlCount");case 2:i=(i=t.sent)?parseInt(i)+1:1,r=60*K()*1e3,z("dailyDlCount",i,r);case 6:case"end":return t.stop()}}),t)})))}();var Y=function(){var t=s(e().mark((function t(i){var r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,fetch(i);case 3:if((r=t.sent).ok){t.next=6;break}throw new Error("Error fetching data. Status: ".concat(r.status));case 6:return t.next=8,r.arrayBuffer();case 8:return s=t.sent,t.abrupt("return",s);case 12:t.prev=12,t.t0=t.catch(0);case 15:case"end":return t.stop()}}),t,null,[[0,12]])})));return function(e){return t.apply(this,arguments)}}(),j=function(){function t(){C(this,t),this.items=[]}return M(t,[{key:"push",value:function(t,e){var i={data:t,dataIndex:e},r=this.items.findIndex((function(t){return t.dataIndex>e}));-1===r&&(r=this.items.length),this.items.splice(r,0,i)}},{key:"toArray",value:function(){return this.items.map((function(t){return t.data}))}}]),t}();var W,q=function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Z.runtime.setUninstallURL){t.next=12;break}return i=lt(),t.next=4,rt();case 4:t.t0=t.sent,t.t1=t.t0+"/",t.t2=ot.includes(i)?i+"/":"",t.t3=t.t1+t.t2,r=t.t3+"uninstalled.html",Z.runtime.setUninstallURL(r),t.next=12;break;case 12:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),X=(W=s(e().mark((function t(){var i,r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,tt();case 2:return(i=t.sent).dailycount||(i.dailycount=20),t.next=6,H("dailyDlCount");case 6:return(r=t.sent)&&r>i.dailycount&&Q&&(s="exceeded.html"),t.abrupt("return",s);case 9:case"end":return t.stop()}}),t)}))),function(){return W.apply(this,arguments)}),Z=navigator.userAgent.includes("Chrome")?chrome:browser,Q=!0;navigator.userAgent.includes("Firefox");Z.i18n.getMessage;var J="speed",tt=function(){var t=s(e().mark((function t(){var i,r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,G("option");case 2:i=t.sent,r={counter:0,priority:J,domain:{},rcounterr:0,recltime:30,reclsize:100};try{i&&Object.assign(r,i),r.counter=Math.max(0,Math.floor(Number(r.counter)||0)),r.rcounterr=Math.max(0,Math.floor(Number(r.rcounterr)||0)),et(r)}catch(t){(s=console).log.apply(s,B(logRED(t.stack)))}return t.abrupt("return",r);case 6:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),et=function(t){$("option",t)},it=function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i="cococut.net",t.next=3,tt();case 3:return(r=t.sent).homedomain&&(i=r.homedomain),Q||(i="127.0.0.1"),t.abrupt("return",i);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),rt=function(){var t=s(e().mark((function t(){var i,r,s,n=arguments;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=n.length>0&&void 0!==n[0]&&n[0],r="https://cococut.net",t.next=4,tt();case 4:return(s=t.sent).homedomain&&(r="https://".concat(s.homedomain)),Q||i||(r="http://127.0.0.1"),t.abrupt("return",r);case 8:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),st=(function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i="https://findit.cococut.net/",t.next=3,tt();case 3:return(r=t.sent).homedomain&&(i="https://findit.".concat(r.homedomain)),t.abrupt("return",i);case 6:case"end":return t.stop()}}),t)})))}(),function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i="https://merge-video-audio.cococut.net/",t.next=3,tt();case 3:return(r=t.sent).homedomain&&(i="https://merge-video-audio.".concat(r.homedomain,"/")),t.abrupt("return",i);case 6:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}()),nt=function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i="pro.cococut.net",t.next=3,tt();case 3:return(r=t.sent).prodomain&&(i=r.prodomain),Q||(i="127.0.0.1"),t.abrupt("return",i);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),at=function(){var t=s(e().mark((function t(){var i,r,s,n=arguments;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=n.length>0&&void 0!==n[0]&&n[0],r="https://pro.cococut.net",t.next=4,tt();case 4:return(s=t.sent).prodomain&&(r="https://".concat(s.prodomain)),Q||i||(r="http://127.0.0.1"),t.abrupt("return",r);case 8:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();!function(){var t=s(e().mark((function t(){var i;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0="https://config.",t.next=3,it();case 3:return t.t1=t.sent,t.t2=t.t0.concat.call(t.t0,t.t1,"/config.json"),i=[t.t2,"https://config.cococut.net/config.json","https://parser-config.cocoshot.com/config.json"],Q||(i=["http://127.0.0.1/pub/config/config.json"]),t.abrupt("return",i);case 8:case"end":return t.stop()}}),t)})))}();var ot=["zh_tw","zh_cn"];function lt(){var t=Z.i18n.getUILanguage();return t.match(/zh-CN/)?"zh_cn":t.match(/zh-TW/)?"zh_tw":t.startsWith("zh")?"zh_cn":t.startsWith("en")?t.substr(0,2):"other"}Z.runtime.onInstalled&&Z.runtime.onInstalled.addListener(function(){var t=s(e().mark((function t(i){var r,s,n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=Z.runtime.getManifest(),s=lt(),t.next=4,rt();case 4:return t.t0=t.sent,t.t1=t.t0+"/",t.t2=ot.includes(s)?s+"/":"",t.t3=t.t1+t.t2,t.t4=t.t3+"installed.html?v=",t.t5=r.version,n=t.t4+t.t5,t.next=13,G("installed");case 13:if(t.sent){t.next=15;break}Z.tabs.create({url:n},(function(t){$("installed","t")}));case 15:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),q();var ht,dt,ct,ut=(ht=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,G("pui");case 2:if(!(i=t.sent)){t.next=9;break}if(r=V("CocoCut pro user"),"active"!=r(i).split("||")[3]){t.next=9;break}return t.abrupt("return",!0);case 9:return t.abrupt("return",!1);case 10:case"end":return t.stop()}}),t)}))),function(){return ht.apply(this,arguments)}),ft=(dt=s(e().mark((function t(){var i,r,s,n,a;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=lt(),t.t0="://",t.next=4,it();case 4:return t.t1=t.sent,r=t.t0.concat.call(t.t0,t.t1,"/"),s="other"!==i?"ahls.html":"oahls.html",t.next=9,X();case 9:return(n=t.sent)&&(s=n),t.next=13,ut();case 13:if(!t.sent){t.next=21;break}return t.t2="://",t.next=17,nt();case 17:t.t3=t.sent,r=t.t2.concat.call(t.t2,t.t3,"/"),s="ahls.vhtml","other"==i&&(s="oahls.vhtml");case 21:return a=Q?r+(ot.includes(i)?i+"/":"")+s:"://127.0.0.1/"+s,t.abrupt("return",a);case 23:case"end":return t.stop()}}),t)}))),ct=s(e().mark((function t(){var i,r,s,n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=lt(),t.t0="://",t.next=4,it();case 4:return t.t1=t.sent,r=t.t0.concat.call(t.t0,t.t1,"/"),s="other"!=i?"dlm.html":"odlm.html",t.next=9,ut();case 9:if(!t.sent){t.next=17;break}return t.t2="://",t.next=13,nt();case 13:t.t3=t.sent,r=t.t2.concat.call(t.t2,t.t3,"/"),s="dlm.vhtml","other"==i&&(s="odlm.vhtml");case 17:return n=Q?r+"dlm/"+(ot.includes(i)?i+"/":"")+s:"://127.0.0.1/dlm/"+s,t.abrupt("return",n);case 19:case"end":return t.stop()}}),t)}))),function(){function t(e,i){C(this,t),this.id=e,this.url=i.url,this.videoPageTitle=i.videoPageTitle,this.parentVideoPageTabId=i.parentVideoPageTabId,this.isM3U8dlPage=i.isM3U8dlPage,this.m3u8dlPageTabs=i.m3u8dlPageTabs}var i,r,n,a,o;return M(t,null,[{key:"create",value:function(e,i,r){var s=new t(e,i);return r[e]=s,t.saveTabs(r),s}},{key:"recover",value:function(e,i){var r=new t(e,i);return Object.assign(r,i),r}},{key:"saveTabs",value:(o=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:z("workingTabs",i,864e5);case 2:case"end":return t.stop()}}),t)}))),function(t){return o.apply(this,arguments)})},{key:"getTabById",value:(a=s(e().mark((function i(r){var s;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H("workingTabs");case 2:if(!(s=e.sent)){e.next=5;break}return e.abrupt("return",t.recover(r,s[r]));case 5:case"end":return e.stop()}}),i)}))),function(t){return a.apply(this,arguments)})},{key:"getTabByM3u8dlPageTabId",value:(n=s(e().mark((function i(r){var s,n,a,o,l,h;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H("workingTabs");case 2:if(!(s=e.sent)){e.next=17;break}n=0,a=Object.entries(s);case 5:if(!(n<a.length)){e.next=17;break}if(o=(0,I.Z)(a[n],2),l=o[0],!(h=o[1]).isM3U8dlPage){e.next=9;break}return e.abrupt("continue",14);case 9:if(!h.m3u8dlPageTabs||!h.m3u8dlPageTabs.hasOwnProperty(r)){e.next=14;break}return s[l].m3u8dlPageTabs[r].isWorking=!0,e.next=13,t.saveTabs(s);case 13:return e.abrupt("return",t.recover(l,h));case 14:n++,e.next=5;break;case 17:case"end":return e.stop()}}),i)}))),function(t){return n.apply(this,arguments)})},{key:"removeTabById",value:(r=s(e().mark((function i(r){var s,n;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H("workingTabs");case 2:if(!(s=e.sent)){e.next=9;break}return null!=(n=s[r])&&n.isM3U8dlPage&&delete s[n.parentVideoPageTabId].m3u8dlPageTabs[r],delete s[r],e.next=9,t.saveTabs(s);case 9:return e.abrupt("return",s);case 10:case"end":return e.stop()}}),i)}))),function(t){return r.apply(this,arguments)})},{key:"m3u8dlPageNotFoundHandler",value:(i=s(e().mark((function i(r,s){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return delete s[r],e.next=3,t.removeTabById(r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),i)}))),function(t,e){return i.apply(this,arguments)})}]),t}());var pt=function(){function t(){C(this,t),this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.initTable()}return M(t,[{key:"removePadding",value:function(t){var e=t.byteLength,i=e&&new DataView(t).getUint8(e-1);return i?t.slice(0,e-i):t}},{key:"uint8ArrayToUint32Array_",value:function(t){for(var e=new DataView(t),i=new Uint32Array(4),r=0;r<4;r++)i[r]=e.getUint32(4*r);return i}},{key:"initTable",value:function(){var t=this.sBox,e=this.invSBox,i=this.subMix,r=i[0],s=i[1],n=i[2],a=i[3],o=this.invSubMix,l=o[0],h=o[1],d=o[2],c=o[3],u=new Uint32Array(256),f=0,p=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){var g=p^p<<1^p<<2^p<<3^p<<4;g=g>>>8^255&g^99,t[f]=g,e[g]=f;var y=u[f],v=u[y],_=u[v],S=257*u[g]^16843008*g;r[f]=S<<24|S>>>8,s[f]=S<<16|S>>>16,n[f]=S<<8|S>>>24,a[f]=S,S=16843009*_^65537*v^257*y^16843008*f,l[g]=S<<24|S>>>8,h[g]=S<<16|S>>>16,d[g]=S<<8|S>>>24,c[g]=S,f?(f=y^u[u[u[_^y]]],p^=u[u[p]]):f=p=1}}},{key:"expandKey",value:function(t){for(var e=this.uint8ArrayToUint32Array_(t),i=!0,r=0;r<e.length&&i;)i=e[r]===this.key[r],r++;if(!i){this.key=e;var s=this.keySize=e.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);var n,a,o,l,h=this.ksRows=4*(s+6+1),d=this.keySchedule=new Uint32Array(h),c=this.invKeySchedule=new Uint32Array(h),u=this.sBox,f=this.rcon,p=this.invSubMix,m=p[0],g=p[1],y=p[2],v=p[3];for(n=0;n<h;n++)n<s?o=d[n]=e[n]:(l=o,n%s==0?(l=u[(l=l<<8|l>>>24)>>>24]<<24|u[l>>>16&255]<<16|u[l>>>8&255]<<8|u[255&l],l^=f[n/s|0]<<24):s>6&&n%s==4&&(l=u[l>>>24]<<24|u[l>>>16&255]<<16|u[l>>>8&255]<<8|u[255&l]),d[n]=o=(d[n-s]^l)>>>0);for(a=0;a<h;a++)n=h-a,l=3&a?d[n]:d[n-4],c[a]=a<4||n<=4?l:m[u[l>>>24]]^g[u[l>>>16&255]]^y[u[l>>>8&255]]^v[u[255&l]],c[a]=c[a]>>>0}}},{key:"networkToHostOrderSwap",value:function(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24}},{key:"decrypt",value:function(t,e,i,r){for(var s,n,a,o,l,h,d,c,u,f,p,m,g,y,v=this.keySize+6,_=this.invKeySchedule,S=this.invSBox,T=this.invSubMix,E=T[0],b=T[1],w=T[2],L=T[3],A=this.uint8ArrayToUint32Array_(i),x=A[0],k=A[1],R=A[2],D=A[3],I=new Int32Array(t),C=new Int32Array(I.length),U=this.networkToHostOrderSwap;e<I.length;){for(u=U(I[e]),f=U(I[e+1]),p=U(I[e+2]),m=U(I[e+3]),l=u^_[0],h=m^_[1],d=p^_[2],c=f^_[3],g=4,y=1;y<v;y++)s=E[l>>>24]^b[h>>16&255]^w[d>>8&255]^L[255&c]^_[g],n=E[h>>>24]^b[d>>16&255]^w[c>>8&255]^L[255&l]^_[g+1],a=E[d>>>24]^b[c>>16&255]^w[l>>8&255]^L[255&h]^_[g+2],o=E[c>>>24]^b[l>>16&255]^w[h>>8&255]^L[255&d]^_[g+3],l=s,h=n,d=a,c=o,g+=4;s=S[l>>>24]<<24^S[h>>16&255]<<16^S[d>>8&255]<<8^S[255&c]^_[g],n=S[h>>>24]<<24^S[d>>16&255]<<16^S[c>>8&255]<<8^S[255&l]^_[g+1],a=S[d>>>24]<<24^S[c>>16&255]<<16^S[l>>8&255]<<8^S[255&h]^_[g+2],o=S[c>>>24]<<24^S[l>>16&255]<<16^S[h>>8&255]<<8^S[255&d]^_[g+3],C[e]=U(s^x),C[e+1]=U(o^k),C[e+2]=U(a^R),C[e+3]=U(n^D),x=u,k=f,R=p,D=m,e+=4}return r?this.removePadding(C.buffer):C.buffer}},{key:"destroy",value:function(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}]),t}();function mt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var gt,yt,vt,_t,St,Tt={exports:{}};gt=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,yt=/^(?=([^\/?#]*))\1([^]*)$/,vt=/(?:\/|^)\.(?=\/)/g,_t=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,Tt.exports=St={buildAbsoluteURL:function(t,e,i){if(i=i||{},t=t.trim(),!(e=e.trim())){if(!i.alwaysNormalize)return t;var r=St.parseURL(t);if(!r)throw new Error("Error trying to parse base URL.");return r.path=St.normalizePath(r.path),St.buildURLFromParts(r)}var s=St.parseURL(e);if(!s)throw new Error("Error trying to parse relative URL.");if(s.scheme)return i.alwaysNormalize?(s.path=St.normalizePath(s.path),St.buildURLFromParts(s)):e;var n=St.parseURL(t);if(!n)throw new Error("Error trying to parse base URL.");if(!n.netLoc&&n.path&&"/"!==n.path[0]){var a=yt.exec(n.path);n.netLoc=a[1],n.path=a[2]}n.netLoc&&!n.path&&(n.path="/");var o={scheme:n.scheme,netLoc:s.netLoc,path:null,params:s.params,query:s.query,fragment:s.fragment};if(!s.netLoc&&(o.netLoc=n.netLoc,"/"!==s.path[0]))if(s.path){var l=n.path,h=l.substring(0,l.lastIndexOf("/")+1)+s.path;o.path=St.normalizePath(h)}else o.path=n.path,s.params||(o.params=n.params,s.query||(o.query=n.query));return null===o.path&&(o.path=i.alwaysNormalize?St.normalizePath(s.path):s.path),St.buildURLFromParts(o)},parseURL:function(t){var e=gt.exec(t);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(vt,"");t.length!==(t=t.replace(_t,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}};var Et=Tt.exports;function bt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function wt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?bt(Object(i),!0).forEach((function(e){At(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):bt(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function Lt(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}function At(t,e,i){return(e=Lt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function xt(){return xt=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t},xt.apply(this,arguments)}const kt=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},Rt=Number.isSafeInteger||function(t){return"number"==typeof t&&Math.abs(t)<=Dt},Dt=Number.MAX_SAFE_INTEGER||9007199254740991;let It=function(t){return t.MEDIA_ATTACHING="hlsMediaAttaching",t.MEDIA_ATTACHED="hlsMediaAttached",t.MEDIA_DETACHING="hlsMediaDetaching",t.MEDIA_DETACHED="hlsMediaDetached",t.BUFFER_RESET="hlsBufferReset",t.BUFFER_CODECS="hlsBufferCodecs",t.BUFFER_CREATED="hlsBufferCreated",t.BUFFER_APPENDING="hlsBufferAppending",t.BUFFER_APPENDED="hlsBufferAppended",t.BUFFER_EOS="hlsBufferEos",t.BUFFER_FLUSHING="hlsBufferFlushing",t.BUFFER_FLUSHED="hlsBufferFlushed",t.MANIFEST_LOADING="hlsManifestLoading",t.MANIFEST_LOADED="hlsManifestLoaded",t.MANIFEST_PARSED="hlsManifestParsed",t.LEVEL_SWITCHING="hlsLevelSwitching",t.LEVEL_SWITCHED="hlsLevelSwitched",t.LEVEL_LOADING="hlsLevelLoading",t.LEVEL_LOADED="hlsLevelLoaded",t.LEVEL_UPDATED="hlsLevelUpdated",t.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",t.LEVELS_UPDATED="hlsLevelsUpdated",t.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",t.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",t.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",t.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",t.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",t.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",t.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",t.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",t.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",t.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",t.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",t.CUES_PARSED="hlsCuesParsed",t.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",t.INIT_PTS_FOUND="hlsInitPtsFound",t.FRAG_LOADING="hlsFragLoading",t.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",t.FRAG_LOADED="hlsFragLoaded",t.FRAG_DECRYPTED="hlsFragDecrypted",t.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",t.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",t.FRAG_PARSING_METADATA="hlsFragParsingMetadata",t.FRAG_PARSED="hlsFragParsed",t.FRAG_BUFFERED="hlsFragBuffered",t.FRAG_CHANGED="hlsFragChanged",t.FPS_DROP="hlsFpsDrop",t.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",t.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",t.ERROR="hlsError",t.DESTROYING="hlsDestroying",t.KEY_LOADING="hlsKeyLoading",t.KEY_LOADED="hlsKeyLoaded",t.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",t.BACK_BUFFER_REACHED="hlsBackBufferReached",t.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",t}({}),Ct=function(t){return t.NETWORK_ERROR="networkError",t.MEDIA_ERROR="mediaError",t.KEY_SYSTEM_ERROR="keySystemError",t.MUX_ERROR="muxError",t.OTHER_ERROR="otherError",t}({}),Ut=function(t){return t.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",t.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",t.KEY_SYSTEM_NO_SESSION="keySystemNoSession",t.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",t.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",t.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",t.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",t.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",t.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",t.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",t.MANIFEST_LOAD_ERROR="manifestLoadError",t.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",t.MANIFEST_PARSING_ERROR="manifestParsingError",t.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",t.LEVEL_EMPTY_ERROR="levelEmptyError",t.LEVEL_LOAD_ERROR="levelLoadError",t.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",t.LEVEL_PARSING_ERROR="levelParsingError",t.LEVEL_SWITCH_ERROR="levelSwitchError",t.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",t.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",t.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",t.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",t.FRAG_LOAD_ERROR="fragLoadError",t.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",t.FRAG_DECRYPT_ERROR="fragDecryptError",t.FRAG_PARSING_ERROR="fragParsingError",t.FRAG_GAP="fragGap",t.REMUX_ALLOC_ERROR="remuxAllocError",t.KEY_LOAD_ERROR="keyLoadError",t.KEY_LOAD_TIMEOUT="keyLoadTimeOut",t.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",t.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",t.BUFFER_APPEND_ERROR="bufferAppendError",t.BUFFER_APPENDING_ERROR="bufferAppendingError",t.BUFFER_STALLED_ERROR="bufferStalledError",t.BUFFER_FULL_ERROR="bufferFullError",t.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",t.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",t.INTERNAL_EXCEPTION="internalException",t.INTERNAL_ABORTED="aborted",t.UNKNOWN="unknown",t}({});const Pt=function(){},Mt={trace:Pt,debug:Pt,log:Pt,warn:Pt,info:Pt,error:Pt};let Ft=Mt;function Ot(t,...e){e.forEach((function(e){Ft[e]=t[e]?t[e].bind(t):function(t){const e=self.console[t];return e?e.bind(self.console,`[${t}] >`):Pt}(e)}))}const Bt=Ft,Nt=/^(\d+)x(\d+)$/,Gt=/(.+?)=(".*?"|.*?)(?:,|$)/g;class $t{constructor(t){"string"==typeof t&&(t=$t.parseAttrList(t)),xt(this,t)}get clientAttrs(){return Object.keys(this).filter((t=>"X-"===t.substring(0,2)))}decimalInteger(t){const e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(this[t]){let e=(this[t]||"0x").slice(2);e=(1&e.length?"0":"")+e;const i=new Uint8Array(e.length/2);for(let t=0;t<e.length/2;t++)i[t]=parseInt(e.slice(2*t,2*t+2),16);return i}return null}hexadecimalIntegerAsNumber(t){const e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){const i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}bool(t){return"YES"===this[t]}decimalResolution(t){const e=Nt.exec(this[t]);if(null!==e)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;const i={};for(Gt.lastIndex=0;null!==(e=Gt.exec(t));){let t=e[2];0===t.indexOf('"')&&t.lastIndexOf('"')===t.length-1&&(t=t.slice(1,-1));i[e[1].trim()]=t}return i}}function zt(t){return"SCTE35-OUT"===t||"SCTE35-IN"===t}class Ht{constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){const i=e.attr;for(const e in i)if(Object.prototype.hasOwnProperty.call(t,e)&&t[e]!==i[e]){Bt.warn(`DATERANGE tag attribute: "${e}" does not match for tags with ID: "${t.ID}"`),this._badValueForSameId=e;break}t=xt(new $t({}),i,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){const t=new Date(this.attr["END-DATE"]);kt(t.getTime())&&(this._endDate=t)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const t=this.duration;return null!==t?new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){const t=this.attr.decimalFloatingPoint("DURATION");if(kt(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&kt(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Vt{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var Kt="audio",Yt="video",jt="audiovideo";class Wt{constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[Kt]:null,[Yt]:null,[jt]:null},this.baseurl=t}setByteRange(t,e){const i=t.split("@",2);let r;r=1===i.length?(null==e?void 0:e.byteRangeEndOffset)||0:parseInt(i[1]),this._byteRange=[r,parseInt(i[0])+r]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Et.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}}class qt extends Wt{constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Vt,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}get decryptdata(){const{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const t=Object.keys(this.levelkeys);if(1===t.length)return this._decryptdata=this.levelkeys[t[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!kt(this.programDateTime))return null;const t=kt(this.duration)?this.duration:0;return this.programDateTime+1e3*t}get encrypted(){var t;if(null!=(t=this._decryptdata)&&t.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),e=t.length;if(e>1||1===e&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){const e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;null==(t=this.loader)||t.abort(),null==(e=this.keyLoader)||e.abort()}setElementaryStreamInfo(t,e,i,r,s,n=!1){const{elementaryStreams:a}=this,o=a[t];o?(o.startPTS=Math.min(o.startPTS,e),o.endPTS=Math.max(o.endPTS,i),o.startDTS=Math.min(o.startDTS,r),o.endDTS=Math.max(o.endDTS,s)):a[t]={startPTS:e,endPTS:i,startDTS:r,endDTS:s,partial:n}}clearElementaryStreamInfo(){const{elementaryStreams:t}=this;t[Kt]=null,t[Yt]=null,t[jt]=null}}class Xt extends Wt{constructor(t,e,i,r,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Vt,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=r;const n=t.enumeratedString("BYTERANGE");n&&this.setByteRange(n,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}}class Zt{constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}reloaded(t){if(!t)return this.advanced=!0,void(this.updated=!0);const e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||0===e&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*t.misses):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&kt(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const t=this.driftEndTime-this.driftStartTime;if(t>0){return 1e3*(this.driftEnd-this.driftStart)/t}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function Qt(t){return Uint8Array.from(atob(t),(t=>t.charCodeAt(0)))}function Jt(t){const e=t.split(":");let i=null;if("data"===e[0]&&2===e.length){const t=e[1].split(";"),r=t[t.length-1].split(",");if(2===r.length){const e="base64"===r[0],s=r[1];e?(t.splice(-1,1),i=Qt(s)):i=function(t){const e=te(t).subarray(0,16),i=new Uint8Array(16);return i.set(e,16-e.length),i}(s)}}return i}function te(t){return Uint8Array.from(unescape(encodeURIComponent(t)),(t=>t.charCodeAt(0)))}const ee="undefined"!=typeof self?self:void 0;var ie={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},re="org.w3.clearkey",se="com.apple.streamingkeydelivery",ne="com.microsoft.playready",ae="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed";function oe(t){switch(t){case se:return ie.FAIRPLAY;case ne:return ie.PLAYREADY;case ae:return ie.WIDEVINE;case re:return ie.CLEARKEY}}var le="1077efecc0b24d02ace33c1e52e2fb4b",he="e2719d58a985b3c9781ab030af78d30e",de="9a04f07998404286ab92e65be0885f95",ce="edef8ba979d64acea3c827dcd51d21ed";function ue(t){return t===ce?ie.WIDEVINE:t===de?ie.PLAYREADY:t===le||t===he?ie.CLEARKEY:void 0}function fe(t){switch(t){case ie.FAIRPLAY:return se;case ie.PLAYREADY:return ne;case ie.WIDEVINE:return ae;case ie.CLEARKEY:return re}}function pe(t){const{drmSystems:e,widevineLicenseUrl:i}=t,r=e?[ie.FAIRPLAY,ie.WIDEVINE,ie.PLAYREADY,ie.CLEARKEY].filter((t=>!!e[t])):[];return!r[ie.WIDEVINE]&&i&&r.push(ie.WIDEVINE),r}const me=null!=ee&&null!=(ge=ee.navigator)&&ge.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var ge;function ye(t,e,i){return Uint8Array.prototype.slice?t.slice(e,i):new Uint8Array(Array.prototype.slice.call(t,e,i))}const ve=(t,e)=>e+10<=t.length&&73===t[e]&&68===t[e+1]&&51===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,_e=(t,e)=>e+10<=t.length&&51===t[e]&&68===t[e+1]&&73===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,Se=(t,e)=>{const i=e;let r=0;for(;ve(t,e);){r+=10;r+=Te(t,e+6),_e(t,e+10)&&(r+=10),e+=r}if(r>0)return t.subarray(i,i+r)},Te=(t,e)=>{let i=0;return i=(127&t[e])<<21,i|=(127&t[e+1])<<14,i|=(127&t[e+2])<<7,i|=127&t[e+3],i},Ee=(t,e)=>ve(t,e)&&Te(t,e+6)+10<=t.length-e,be=t=>{const e=Ae(t);for(let t=0;t<e.length;t++){const i=e[t];if(we(i))return Ie(i)}},we=t=>t&&"PRIV"===t.key&&"com.apple.streaming.transportStreamTimestamp"===t.info,Le=t=>{const e=String.fromCharCode(t[0],t[1],t[2],t[3]),i=Te(t,4);return{type:e,size:i,data:t.subarray(10,10+i)}},Ae=t=>{let e=0;const i=[];for(;ve(t,e);){const r=Te(t,e+6);e+=10;const s=e+r;for(;e+8<s;){const r=Le(t.subarray(e)),s=xe(r);s&&i.push(s),e+=r.size+10}_e(t,e)&&(e+=10)}return i},xe=t=>"PRIV"===t.type?ke(t):"W"===t.type[0]?De(t):Re(t),ke=t=>{if(t.size<2)return;const e=Ce(t.data,!0),i=new Uint8Array(t.data.subarray(e.length+1));return{key:t.type,info:e,data:i.buffer}},Re=t=>{if(t.size<2)return;if("TXXX"===t.type){let e=1;const i=Ce(t.data.subarray(e),!0);e+=i.length+1;const r=Ce(t.data.subarray(e));return{key:t.type,info:i,data:r}}const e=Ce(t.data.subarray(1));return{key:t.type,data:e}},De=t=>{if("WXXX"===t.type){if(t.size<2)return;let e=1;const i=Ce(t.data.subarray(e),!0);e+=i.length+1;const r=Ce(t.data.subarray(e));return{key:t.type,info:i,data:r}}const e=Ce(t.data);return{key:t.type,data:e}},Ie=t=>{if(8===t.data.byteLength){const e=new Uint8Array(t.data),i=1&e[3];let r=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return r/=45,i&&(r+=47721858.84),Math.round(r)}},Ce=(t,e=!1)=>{const i=Pe();if(i){const r=i.decode(t);if(e){const t=r.indexOf("\0");return-1!==t?r.substring(0,t):r}return r.replace(/\0/g,"")}const r=t.length;let s,n,a,o="",l=0;for(;l<r;){if(s=t[l++],0===s&&e)return o;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:n=t[l++],o+=String.fromCharCode((31&s)<<6|63&n);break;case 14:n=t[l++],a=t[l++],o+=String.fromCharCode((15&s)<<12|(63&n)<<6|(63&a)<<0)}}return o};let Ue;function Pe(){if(!navigator.userAgent.includes("PlayStation 4"))return Ue||void 0===self.TextDecoder||(Ue=new self.TextDecoder("utf-8")),Ue}const Me={hexDump:function(t){let e="";for(let i=0;i<t.length;i++){let r=t[i].toString(16);r.length<2&&(r="0"+r),e+=r}return e}},Fe=Math.pow(2,32)-1,Oe=[].push,Be={video:1,audio:2,id3:3,text:4};function Ne(t){return String.fromCharCode.apply(null,t)}function Ge(t,e){const i=t[e]<<8|t[e+1];return i<0?65536+i:i}function $e(t,e){const i=He(t,e);return i<0?4294967296+i:i}function ze(t,e){let i=$e(t,e);return i*=Math.pow(2,32),i+=$e(t,e+4),i}function He(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function Ve(t,e,i){t[e]=i>>24,t[e+1]=i>>16&255,t[e+2]=i>>8&255,t[e+3]=255&i}function Ke(t,e){const i=[];if(!e.length)return i;const r=t.byteLength;for(let s=0;s<r;){const n=$e(t,s),a=n>1?s+n:r;if(Ne(t.subarray(s+4,s+8))===e[0])if(1===e.length)i.push(t.subarray(s+8,a));else{const r=Ke(t.subarray(s+8,a),e.slice(1));r.length&&Oe.apply(i,r)}s=a}return i}function Ye(t){const e=[],i=t[0];let r=8;const s=$e(t,r);r+=4;let n=0,a=0;0===i?(n=$e(t,r),a=$e(t,r+4),r+=8):(n=ze(t,r),a=ze(t,r+8),r+=16),r+=2;let o=t.length+a;const l=Ge(t,r);r+=2;for(let i=0;i<l;i++){let i=r;const n=$e(t,i);i+=4;const a=2147483647&n;if(1===(2147483648&n)>>>31)return Bt.warn("SIDX has hierarchical references (not supported)"),null;const l=$e(t,i);i+=4,e.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/s,start:o,end:o+a-1}}),o+=a,i+=4,r=i}return{earliestPresentationTime:n,timescale:s,version:i,referencesCount:l,references:e}}function je(t){const e=[],i=Ke(t,["moov","trak"]);for(let t=0;t<i.length;t++){const r=i[t],s=Ke(r,["tkhd"])[0];if(s){let t=s[0];const i=$e(s,0===t?12:20),n=Ke(r,["mdia","mdhd"])[0];if(n){t=n[0];const s=$e(n,0===t?12:20),a=Ke(r,["mdia","hdlr"])[0];if(a){const t=Ne(a.subarray(8,12)),n={soun:Kt,vide:Yt}[t];if(n){const t=We(Ke(r,["mdia","minf","stbl","stsd"])[0]);e[i]={timescale:s,type:n},e[n]=wt({timescale:s,id:i},t)}}}}}return Ke(t,["moov","mvex","trex"]).forEach((t=>{const i=$e(t,4),r=e[i];r&&(r.default={duration:$e(t,12),flags:$e(t,20)})})),e}function We(t){const e=t.subarray(8),i=e.subarray(86),r=Ne(e.subarray(4,8));let s=r;const n="enca"===r||"encv"===r;if(n){const t=Ke(e,[r])[0];Ke(t.subarray("enca"===r?28:78),["sinf"]).forEach((t=>{const e=Ke(t,["schm"])[0];if(e){const i=Ne(e.subarray(4,8));if("cbcs"===i||"cenc"===i){const e=Ke(t,["frma"])[0];e&&(s=Ne(e))}}}))}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const t=Ke(i,["avcC"])[0];s+="."+Xe(t[1])+Xe(t[2])+Xe(t[3]);break}case"mp4a":{const t=Ke(e,[r])[0],i=Ke(t.subarray(28),["esds"])[0];if(i&&i.length>12){let t=4;if(3!==i[t++])break;t=qe(i,t),t+=2;const e=i[t++];if(128&e&&(t+=2),64&e&&(t+=i[t++]),4!==i[t++])break;t=qe(i,t);const r=i[t++];if(64!==r)break;if(s+="."+Xe(r),t+=12,5!==i[t++])break;t=qe(i,t);const n=i[t++];let a=(248&n)>>3;31===a&&(a+=1+((7&n)<<3)+((224&i[t])>>5)),s+="."+a}break}case"hvc1":case"hev1":{const t=Ke(i,["hvcC"])[0],e=t[1],r=["","A","B","C"][e>>6],n=31&e,a=$e(t,2),o=(32&e)>>5?"H":"L",l=t[12],h=t.subarray(6,12);s+="."+r+n,s+="."+a.toString(16).toUpperCase(),s+="."+o+l;let d="";for(let t=h.length;t--;){const e=h[t];if(e||d){d="."+e.toString(16).toUpperCase()+d}}s+=d;break}case"dvh1":case"dvhe":{const t=Ke(i,["dvcC"])[0],e=t[2]>>1&127,r=t[2]<<5&32|t[3]>>3&31;s+="."+Ze(e)+"."+Ze(r);break}case"vp09":{const t=Ke(i,["vpcC"])[0],e=t[4],r=t[5],n=t[6]>>4&15;s+="."+Ze(e)+"."+Ze(r)+"."+Ze(n);break}case"av01":{const t=Ke(i,["av1C"])[0],e=t[1]>>>5,r=31&t[1],n=t[2]>>>7?"H":"M",a=(64&t[2])>>6,o=(32&t[2])>>5,l=2===e&&a?o?12:10:a?10:8,h=(16&t[2])>>4,d=(8&t[2])>>3,c=(4&t[2])>>2,u=3&t[2],f=1,p=1,m=1,g=0;s+="."+e+"."+Ze(r)+n+"."+Ze(l)+"."+h+"."+d+c+u+"."+Ze(f)+"."+Ze(p)+"."+Ze(m)+"."+g;break}}return{codec:s,encrypted:n}}function qe(t,e){const i=e+5;for(;128&t[e++]&&e<i;);return e}function Xe(t){return("0"+t.toString(16).toUpperCase()).slice(-2)}function Ze(t){return(t<10?"0":"")+t}function Qe(t){const e=Ke(t,["schm"])[0];if(e){const i=Ne(e.subarray(4,8));if("cbcs"===i||"cenc"===i)return Ke(t,["schi","tenc"])[0]}return null}function Je(t){const e=$e(t,0);let i=8;1&e&&(i+=4),4&e&&(i+=4);let r=0;const s=$e(t,4);for(let n=0;n<s;n++){if(256&e){r+=$e(t,i),i+=4}512&e&&(i+=4),1024&e&&(i+=4),2048&e&&(i+=4)}return r}function ti(t,e){const i=new Uint8Array(t.length+e.length);return i.set(t),i.set(e,t.length),i}function ei(t,e){const i=[],r=e.samples,s=e.timescale,n=e.id;let a=!1;return Ke(r,["moof"]).map((o=>{const l=o.byteOffset-8;Ke(o,["traf"]).map((o=>{const h=Ke(o,["tfdt"]).map((t=>{const e=t[0];let i=$e(t,4);return 1===e&&(i*=Math.pow(2,32),i+=$e(t,8)),i/s}))[0];return void 0!==h&&(t=h),Ke(o,["tfhd"]).map((h=>{const d=$e(h,4),c=16777215&$e(h,0);let u=0;const f=0!=(16&c);let p=0;const m=0!=(32&c);let g=8;d===n&&(0!=(1&c)&&(g+=8),0!=(2&c)&&(g+=4),0!=(8&c)&&(u=$e(h,g),g+=4),f&&(p=$e(h,g),g+=4),m&&(g+=4),"video"===e.type&&(a=function(t){if(!t)return!1;const e=t.indexOf("."),i=e<0?t:t.substring(0,e);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}(e.codec)),Ke(o,["trun"]).map((n=>{const o=n[0],h=16777215&$e(n,0),d=0!=(1&h);let c=0;const f=0!=(4&h),m=0!=(256&h);let g=0;const y=0!=(512&h);let v=0;const _=0!=(1024&h),S=0!=(2048&h);let T=0;const E=$e(n,4);let b=8;d&&(c=$e(n,b),b+=4),f&&(b+=4);let w=c+l;for(let l=0;l<E;l++){if(m?(g=$e(n,b),b+=4):g=u,y?(v=$e(n,b),b+=4):v=p,_&&(b+=4),S&&(T=0===o?$e(n,b):He(n,b),b+=4),e.type===Yt){let e=0;for(;e<v;){const n=$e(r,w);if(w+=4,ii(a,r[w])){ri(r.subarray(w,w+n),a?2:1,t+T/s,i)}w+=n,e+=n+4}}t+=g/s}})))}))}))})),i}function ii(t,e){if(t){const t=e>>1&63;return 39===t||40===t}return 6===(31&e)}function ri(t,e,i,r){const s=si(t);let n=0;n+=e;let a=0,o=0,l=0;for(;n<s.length;){a=0;do{if(n>=s.length)break;l=s[n++],a+=l}while(255===l);o=0;do{if(n>=s.length)break;l=s[n++],o+=l}while(255===l);const t=s.length-n;let e=n;if(o<t)n+=o;else if(o>t){Bt.error(`Malformed SEI payload. ${o} is too small, only ${t} bytes left to parse.`);break}if(4===a){if(181===s[e++]){const t=Ge(s,e);if(e+=2,49===t){const t=$e(s,e);if(e+=4,1195456820===t){const t=s[e++];if(3===t){const n=s[e++],o=64&n,l=o?2+3*(31&n):0,h=new Uint8Array(l);if(o){h[0]=n;for(let t=1;t<l;t++)h[t]=s[e++]}r.push({type:t,payloadType:a,pts:i,bytes:h})}}}}}else if(5===a&&o>16){const t=[];for(let i=0;i<16;i++){const r=s[e++].toString(16);t.push(1==r.length?"0"+r:r),3!==i&&5!==i&&7!==i&&9!==i||t.push("-")}const n=o-16,l=new Uint8Array(n);for(let t=0;t<n;t++)l[t]=s[e++];r.push({payloadType:a,pts:i,uuid:t.join(""),userData:Ce(l),userDataBytes:l})}}}function si(t){const e=t.byteLength,i=[];let r=1;for(;r<e-2;)0===t[r]&&0===t[r+1]&&3===t[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return t;const s=e-i.length,n=new Uint8Array(s);let a=0;for(r=0;r<s;a++,r++)a===i[0]&&(a++,i.shift()),n[r]=t[a];return n}function ni(t,e,i){if(16!==t.byteLength)throw new RangeError("Invalid system id");let r,s,n;if(e){r=1,s=new Uint8Array(16*e.length);for(let t=0;t<e.length;t++){const i=e[t];if(16!==i.byteLength)throw new RangeError("Invalid key");s.set(i,16*t)}}else r=0,s=new Uint8Array;r>0?(n=new Uint8Array(4),e.length>0&&new DataView(n.buffer).setUint32(0,e.length,!1)):n=new Uint8Array;const a=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(a.buffer).setUint32(0,i.byteLength,!1),function(t,...e){const i=e.length;let r=8,s=i;for(;s--;)r+=e[s].byteLength;const n=new Uint8Array(r);for(n[0]=r>>24&255,n[1]=r>>16&255,n[2]=r>>8&255,n[3]=255&r,n.set(t,4),s=0,r=8;s<i;s++)n.set(e[s],r),r+=e[s].byteLength;return n}([112,115,115,104],new Uint8Array([r,0,0,0]),t,n,s,a,i||new Uint8Array)}function ai(t){const e=t.getUint32(0),i=t.byteOffset,r=t.byteLength;if(r<e)return{offset:i,size:r};if(1886614376!==t.getUint32(4))return{offset:i,size:e};const s=t.getUint32(8)>>>24;if(0!==s&&1!==s)return{offset:i,size:e};const n=t.buffer,a=Me.hexDump(new Uint8Array(n,i+12,16)),o=t.getUint32(28);let l=null,h=null;if(0===s){if(e-32<o||o<22)return{offset:i,size:e};h=new Uint8Array(n,i+32,o)}else if(1===s){if(!o||r<i+32+16*o+16)return{offset:i,size:e};l=[];for(let t=0;t<o;t++)l.push(new Uint8Array(n,i+32+16*t,16))}return{version:s,systemId:a,kids:l,data:h,offset:i,size:e}}let oi={};class li{static clearKeyUriToKeyIdMap(){oi={}}constructor(t,e,i,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=r,this.iv=s,this.encrypted=!!t&&"NONE"!==t,this.isCommonEncryption=this.encrypted&&"AES-128"!==t}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case se:case ae:case ne:case re:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof t&&("AES-128"!==this.method||this.iv||Bt.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),t=0);const e=function(t){const e=new Uint8Array(16);for(let i=12;i<16;i++)e[i]=t>>8*(15-i)&255;return e}(t);return new li(this.method,this.uri,"identity",this.keyFormatVersions,e)}const e=Jt(this.uri);if(e)switch(this.keyFormat){case ae:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case ne:{const t=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=ni(t,null,e);const i=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),r=String.fromCharCode.apply(null,Array.from(i)),s=r.substring(r.indexOf("<"),r.length),n=(new DOMParser).parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(n){const t=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");if(t){const e=Qt(t).subarray(0,16);!function(t){const e=function(t,e,i){const r=t[e];t[e]=t[i],t[i]=r};e(t,0,3),e(t,1,2),e(t,4,5),e(t,6,7)}(e),this.keyId=e}}break}default:{let t=e.subarray(0,16);if(16!==t.length){const e=new Uint8Array(16);e.set(t,16-t.length),t=e}this.keyId=t;break}}if(!this.keyId||16!==this.keyId.byteLength){let t=oi[this.uri];if(!t){const e=Object.keys(oi).length%Number.MAX_SAFE_INTEGER;t=new Uint8Array(16);new DataView(t.buffer,12,4).setUint32(0,e),oi[this.uri]=t}this.keyId=t}return this}}const hi=/\{\$([a-zA-Z0-9-_]+)\}/g;function di(t){return hi.test(t)}function ci(t,e,i){if(null!==t.variableList||t.hasVariableRefs)for(let r=i.length;r--;){const s=i[r],n=e[s];n&&(e[s]=ui(t,n))}}function ui(t,e){if(null!==t.variableList||t.hasVariableRefs){const i=t.variableList;return e.replace(hi,(e=>{const r=e.substring(2,e.length-1),s=null==i?void 0:i[r];return void 0===s?(t.playlistParsingError||(t.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${r}"`)),e):s}))}return e}function fi(t,e,i){let r,s,n=t.variableList;if(n||(t.variableList=n={}),"QUERYPARAM"in e){r=e.QUERYPARAM;try{const t=new self.URL(i).searchParams;if(!t.has(r))throw new Error(`"${r}" does not match any query parameter in URI: "${i}"`);s=t.get(r)}catch(e){t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${e.message}`))}}else r=e.NAME,s=e.VALUE;r in n?t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${r}"`)):n[r]=s||""}function pi(t,e,i){const r=e.IMPORT;if(i&&r in i){let e=t.variableList;e||(t.variableList=e={}),e[r]=i[r]}else t.playlistParsingError||(t.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${r}"`))}function mi(t=!0){if("undefined"==typeof self)return;return(t||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const gi={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function yi(t,e,i=!0){return!t.split(",").some((t=>!vi(t,e,i)))}function vi(t,e,i=!0){var r;const s=mi(i);return null!=(r=null==s?void 0:s.isTypeSupported(_i(t,e)))&&r}function _i(t,e){return`${e}/mp4;codecs="${t}"`}function Si(t){if(t){const e=t.substring(0,4);return gi.video[e]}return 2}function Ti(t){return t.split(",").reduce(((t,e)=>{const i=gi.video[e];return i?(2*i+t)/(t?3:2):(gi.audio[e]+t)/(t?2:1)}),0)}const Ei={};const bi=/flac|opus/i;function wi(t,e=!0){return t.replace(bi,(t=>function(t,e=!0){if(Ei[t])return Ei[t];const i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[t];for(let r=0;r<i.length;r++)if(vi(i[r],"audio",e))return Ei[t]=i[r],i[r];return t}(t.toLowerCase(),e)))}function Li(t,e){return t&&"mp4a"!==t?t:e?e.split(",")[0]:e}const Ai=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,xi=/#EXT-X-MEDIA:(.*)/g,ki=/^#EXT(?:INF|-X-TARGETDURATION):/m,Ri=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),Di=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Ii{static findGroup(t,e){for(let i=0;i<t.length;i++){const r=t[i];if(r.id===e)return r}}static resolve(t,e){return Et.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return ki.test(t)}static parseMasterPlaylist(t,e){const i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:di(t)},r=[];let s;for(Ai.lastIndex=0;null!=(s=Ai.exec(t));)if(s[1]){var n;const t=new $t(s[1]);ci(i,t,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const a=ui(i,s[2]),o={attrs:t,bitrate:t.decimalInteger("BANDWIDTH")||t.decimalInteger("AVERAGE-BANDWIDTH"),name:t.NAME,url:Ii.resolve(a,e)},l=t.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),Pi(t.CODECS,o),null!=(n=o.unknownCodecs)&&n.length||r.push(o),i.levels.push(o)}else if(s[3]){const t=s[3],r=s[4];switch(t){case"SESSION-DATA":{const t=new $t(r);ci(i,t,["DATA-ID","LANGUAGE","VALUE","URI"]);const e=t["DATA-ID"];e&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[e]=t);break}case"SESSION-KEY":{const t=Ci(r,e,i);t.encrypted&&t.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(t)):Bt.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${r}"`);break}case"DEFINE":{const t=new $t(r);ci(i,t,["NAME","VALUE","QUERYPARAM"]),fi(i,t,e)}break;case"CONTENT-STEERING":{const t=new $t(r);ci(i,t,["SERVER-URI","PATHWAY-ID"]),i.contentSteering={uri:Ii.resolve(t["SERVER-URI"],e),pathwayId:t["PATHWAY-ID"]||"."};break}case"START":i.startTimeOffset=Ui(r)}}const a=r.length>0&&r.length<i.levels.length;return i.levels=a?r:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(t,e,i){let r;const s={},n=i.levels,a={AUDIO:n.map((t=>({id:t.attrs.AUDIO,audioCodec:t.audioCodec}))),SUBTITLES:n.map((t=>({id:t.attrs.SUBTITLES,textCodec:t.textCodec}))),"CLOSED-CAPTIONS":[]};let o=0;for(xi.lastIndex=0;null!==(r=xi.exec(t));){const t=new $t(r[1]),n=t.TYPE;if(n){const r=a[n],l=s[n]||[];s[n]=l,ci(i,t,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const h=t.LANGUAGE,d=t["ASSOC-LANGUAGE"],c=t.CHANNELS,u=t.CHARACTERISTICS,f=t["INSTREAM-ID"],p={attrs:t,bitrate:0,id:o++,groupId:t["GROUP-ID"]||"",name:t.NAME||h||"",type:n,default:t.bool("DEFAULT"),autoselect:t.bool("AUTOSELECT"),forced:t.bool("FORCED"),lang:h,url:t.URI?Ii.resolve(t.URI,e):""};if(d&&(p.assocLang=d),c&&(p.channels=c),u&&(p.characteristics=u),f&&(p.instreamId=f),null!=r&&r.length){const t=Ii.findGroup(r,p.groupId)||r[0];Mi(p,t,"audioCodec"),Mi(p,t,"textCodec")}l.push(p)}}return s}static parseLevelPlaylist(t,e,i,r,s,n){const a=new Zt(e),o=a.fragments;let l,h,d,c=null,u=0,f=0,p=0,m=0,g=null,y=new qt(r,e),v=-1,_=!1,S=null;for(Ri.lastIndex=0,a.m3u8=t,a.hasVariableRefs=di(t);null!==(l=Ri.exec(t));){_&&(_=!1,y=new qt(r,e),y.start=p,y.sn=u,y.cc=m,y.level=i,c&&(y.initSegment=c,y.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null,S&&(y.setByteRange(S),S=null)));const t=l[1];if(t){y.duration=parseFloat(t);const e=(" "+l[2]).slice(1);y.title=e||null,y.tagList.push(e?["INF",t,e]:["INF",t])}else if(l[3]){if(kt(y.duration)){y.start=p,d&&Bi(y,d,a),y.sn=u,y.level=i,y.cc=m,o.push(y);const t=(" "+l[3]).slice(1);y.relurl=ui(a,t),Fi(y,g),g=y,p+=y.duration,u++,f=0,_=!0}}else if(l[4]){const t=(" "+l[4]).slice(1);g?y.setByteRange(t,g):y.setByteRange(t)}else if(l[5])y.rawProgramDateTime=(" "+l[5]).slice(1),y.tagList.push(["PROGRAM-DATE-TIME",y.rawProgramDateTime]),-1===v&&(v=o.length);else{if(l=l[0].match(Di),!l){Bt.warn("No matches on slow regex match for level playlist!");continue}for(h=1;h<l.length&&void 0===l[h];h++);const t=(" "+l[h]).slice(1),s=(" "+l[h+1]).slice(1),p=l[h+2]?(" "+l[h+2]).slice(1):"";switch(t){case"PLAYLIST-TYPE":a.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":u=a.startSN=parseInt(s);break;case"SKIP":{const t=new $t(s);ci(a,t,["RECENTLY-REMOVED-DATERANGES"]);const e=t.decimalInteger("SKIPPED-SEGMENTS");if(kt(e)){a.skippedSegments=e;for(let t=e;t--;)o.unshift(null);u+=e}const i=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(a.recentlyRemovedDateranges=i.split("\t"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(s),1);break;case"VERSION":a.version=parseInt(s);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(s||p)&&y.tagList.push(p?[s,p]:[s]);break;case"DISCONTINUITY":m++,y.tagList.push(["DIS"]);break;case"GAP":y.gap=!0,y.tagList.push([t]);break;case"BITRATE":y.tagList.push([t,s]);break;case"DATERANGE":{const t=new $t(s);ci(a,t,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),ci(a,t,t.clientAttrs);const e=new Ht(t,a.dateRanges[t.ID]);e.isValid||a.skippedSegments?a.dateRanges[e.id]=e:Bt.warn(`Ignoring invalid DATERANGE tag: "${s}"`),y.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{const t=new $t(s);ci(a,t,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in t?pi(a,t,n):fi(a,t,e)}break;case"DISCONTINUITY-SEQUENCE":m=parseInt(s);break;case"KEY":{const t=Ci(s,e,a);if(t.isSupported()){if("NONE"===t.method){d=void 0;break}d||(d={}),d[t.keyFormat]&&(d=xt({},d)),d[t.keyFormat]=t}else Bt.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${s}"`);break}case"START":a.startTimeOffset=Ui(s);break;case"MAP":{const t=new $t(s);if(ci(a,t,["BYTERANGE","URI"]),y.duration){const s=new qt(r,e);Oi(s,t,i,d),c=s,y.initSegment=c,c.rawProgramDateTime&&!y.rawProgramDateTime&&(y.rawProgramDateTime=c.rawProgramDateTime)}else{const e=y.byteRangeEndOffset;if(e){const t=y.byteRangeStartOffset;S=`${e-t}@${t}`}else S=null;Oi(y,t,i,d),c=y,_=!0}break}case"SERVER-CONTROL":{const t=new $t(s);a.canBlockReload=t.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=t.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&t.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=t.optionalFloat("PART-HOLD-BACK",0),a.holdBack=t.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const t=new $t(s);a.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let t=a.partList;t||(t=a.partList=[]);const i=f>0?t[t.length-1]:void 0,r=f++,n=new $t(s);ci(a,n,["BYTERANGE","URI"]);const o=new Xt(n,y,e,r,i);t.push(o),y.duration+=o.duration;break}case"PRELOAD-HINT":{const t=new $t(s);ci(a,t,["URI"]),a.preloadHint=t;break}case"RENDITION-REPORT":{const t=new $t(s);ci(a,t,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(t);break}default:Bt.warn(`line parsed but not handled: ${l}`)}}}g&&!g.relurl?(o.pop(),p-=g.duration,a.partList&&(a.fragmentHint=g)):a.partList&&(Fi(y,g),y.cc=m,a.fragmentHint=y,d&&Bi(y,d,a));const T=o.length,E=o[0],b=o[T-1];if(p+=a.skippedSegments*a.targetduration,p>0&&T&&b){a.averagetargetduration=p/T;const t=b.sn;a.endSN="initSegment"!==t?t:0,a.live||(b.endList=!0),E&&(a.startCC=E.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(p+=a.fragmentHint.duration),a.totalduration=p,a.endCC=m,v>0&&function(t,e){let i=t[e];for(let r=e;r--;){const e=t[r];if(!e)return;e.programDateTime=i.programDateTime-1e3*e.duration,i=e}}(o,v),a}}function Ci(t,e,i){var r,s;const n=new $t(t);ci(i,n,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const a=null!=(r=n.METHOD)?r:"",o=n.URI,l=n.hexadecimalInteger("IV"),h=n.KEYFORMATVERSIONS,d=null!=(s=n.KEYFORMAT)?s:"identity";o&&n.IV&&!l&&Bt.error(`Invalid IV: ${n.IV}`);const c=o?Ii.resolve(o,e):"",u=(h||"1").split("/").map(Number).filter(Number.isFinite);return new li(a,c,d,u,l)}function Ui(t){const e=new $t(t).decimalFloatingPoint("TIME-OFFSET");return kt(e)?e:null}function Pi(t,e){let i=(t||"").split(/[ ,]+/).filter((t=>t));["video","audio","text"].forEach((t=>{const r=i.filter((e=>function(t,e){const i=gi[e];return!!i&&!!i[t.slice(0,4)]}(e,t)));r.length&&(e[`${t}Codec`]=r.join(","),i=i.filter((t=>-1===r.indexOf(t))))})),e.unknownCodecs=i}function Mi(t,e,i){const r=e[i];r&&(t[i]=r)}function Fi(t,e){t.rawProgramDateTime?t.programDateTime=Date.parse(t.rawProgramDateTime):null!=e&&e.programDateTime&&(t.programDateTime=e.endProgramDateTime),kt(t.programDateTime)||(t.programDateTime=null,t.rawProgramDateTime=null)}function Oi(t,e,i,r){t.relurl=e.URI,e.BYTERANGE&&t.setByteRange(e.BYTERANGE),t.level=i,t.sn="initSegment",r&&(t.levelkeys=r),t.initSegment=null}function Bi(t,e,i){t.levelkeys=e;const{encryptedFragments:r}=i;r.length&&r[r.length-1].levelkeys===e||!Object.keys(e).some((t=>e[t].isCommonEncryption))||r.push(t)}var Ni="manifest",Gi="level",$i="audioTrack",zi="subtitleTrack",Hi="main",Vi="audio",Ki="subtitle";function Yi(t){const{type:e}=t;switch(e){case $i:return Vi;case zi:return Ki;default:return Hi}}function ji(t,e){let i=t.url;return void 0!==i&&0!==i.indexOf("data:")||(i=e.url),i}class Wi{constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:t}=this;t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.LEVEL_LOADING,this.onLevelLoading,this),t.on(It.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(It.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:t}=this;t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.LEVEL_LOADING,this.onLevelLoading,this),t.off(It.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(It.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){const e=this.hls.config,i=e.pLoader,r=e.loader,s=new(i||r)(e);return this.loaders[t.type]=s,s}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(const t in this.loaders){const e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){const{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Ni,url:i,deliveryDirectives:null})}onLevelLoading(t,e){const{id:i,level:r,pathwayId:s,url:n,deliveryDirectives:a}=e;this.load({id:i,level:r,pathwayId:s,responseType:"text",type:Gi,url:n,deliveryDirectives:a})}onAudioTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:n}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:$i,url:s,deliveryDirectives:n})}onSubtitleTrackLoading(t,e){const{id:i,groupId:r,url:s,deliveryDirectives:n}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:zi,url:s,deliveryDirectives:n})}load(t){var e;const i=this.hls.config;let r,s=this.getInternalLoader(t);if(s){const e=s.context;if(e&&e.url===t.url&&e.level===t.level)return void Bt.trace("[playlist-loader]: playlist request ongoing");Bt.log(`[playlist-loader]: aborting previous loader for type: ${t.type}`),s.abort()}if(r=t.type===Ni?i.manifestLoadPolicy.default:xt({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(t),kt(null==(e=t.deliveryDirectives)?void 0:e.part)){let e;if(t.type===Gi&&null!==t.level?e=this.hls.levels[t.level].details:t.type===$i&&null!==t.id?e=this.hls.audioTracks[t.id].details:t.type===zi&&null!==t.id&&(e=this.hls.subtitleTracks[t.id].details),e){const t=e.partTarget,i=e.targetduration;if(t&&i){const e=1e3*Math.max(3*t,.8*i);r=xt({},r,{maxTimeToFirstByteMs:Math.min(e,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(e,r.maxTimeToFirstByteMs)})}}}const n=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0},o={onSuccess:(t,e,i,r)=>{const s=this.getInternalLoader(i);this.resetInternalLoader(i.type);const n=t.data;0===n.indexOf("#EXTM3U")?(e.parsing.start=performance.now(),Ii.isMediaPlaylist(n)?this.handleTrackOrLevelPlaylist(t,e,i,r||null,s):this.handleMasterPlaylist(t,e,i,r)):this.handleManifestParsingError(t,i,new Error("no EXTM3U delimiter"),r||null,e)},onError:(t,e,i,r)=>{this.handleNetworkError(e,i,!1,t,r)},onTimeout:(t,e,i)=>{this.handleNetworkError(e,i,!0,void 0,t)}};s.load(t,a,o)}handleMasterPlaylist(t,e,i,r){const s=this.hls,n=t.data,a=ji(t,i),o=Ii.parseMasterPlaylist(n,a);if(o.playlistParsingError)return void this.handleManifestParsingError(t,i,o.playlistParsingError,r,e);const{contentSteering:l,levels:h,sessionData:d,sessionKeys:c,startTimeOffset:u,variableList:f}=o;this.variableList=f;const{AUDIO:p=[],SUBTITLES:m,"CLOSED-CAPTIONS":g}=Ii.parseMasterPlaylistMedia(n,a,o);if(p.length){p.some((t=>!t.url))||!h[0].audioCodec||h[0].attrs.AUDIO||(Bt.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),p.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new $t({}),bitrate:0,url:""}))}s.trigger(It.MANIFEST_LOADED,{levels:h,audioTracks:p,subtitles:m,captions:g,contentSteering:l,url:a,stats:e,networkDetails:r,sessionData:d,sessionKeys:c,startTimeOffset:u,variableList:f})}handleTrackOrLevelPlaylist(t,e,i,r,s){const n=this.hls,{id:a,level:o,type:l}=i,h=ji(t,i),d=kt(o)?o:kt(a)?a:0,c=Yi(i),u=Ii.parseLevelPlaylist(t.data,h,d,c,0,this.variableList);if(l===Ni){const t={attrs:new $t({}),bitrate:0,details:u,name:"",url:h};n.trigger(It.MANIFEST_LOADED,{levels:[t],audioTracks:[],url:h,stats:e,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=u,this.handlePlaylistLoaded(u,t,e,i,r,s)}handleManifestParsingError(t,e,i,r,s){this.hls.trigger(It.ERROR,{type:Ct.NETWORK_ERROR,details:Ut.MANIFEST_PARSING_ERROR,fatal:e.type===Ni,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:r,stats:s})}handleNetworkError(t,e,i=!1,r,s){let n=`A network ${i?"timeout":"error"+(r?" (status "+r.code+")":"")} occurred while loading ${t.type}`;t.type===Gi?n+=`: ${t.level} id: ${t.id}`:t.type!==$i&&t.type!==zi||(n+=` id: ${t.id} group-id: "${t.groupId}"`);const a=new Error(n);Bt.warn(`[playlist-loader]: ${n}`);let o=Ut.UNKNOWN,l=!1;const h=this.getInternalLoader(t);switch(t.type){case Ni:o=i?Ut.MANIFEST_LOAD_TIMEOUT:Ut.MANIFEST_LOAD_ERROR,l=!0;break;case Gi:o=i?Ut.LEVEL_LOAD_TIMEOUT:Ut.LEVEL_LOAD_ERROR,l=!1;break;case $i:o=i?Ut.AUDIO_TRACK_LOAD_TIMEOUT:Ut.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case zi:o=i?Ut.SUBTITLE_TRACK_LOAD_TIMEOUT:Ut.SUBTITLE_LOAD_ERROR,l=!1}h&&this.resetInternalLoader(t.type);const d={type:Ct.NETWORK_ERROR,details:o,fatal:l,url:t.url,loader:h,context:t,error:a,networkDetails:e,stats:s};if(r){const i=(null==e?void 0:e.url)||t.url;d.response=wt({url:i,data:void 0},r)}this.hls.trigger(It.ERROR,d)}handlePlaylistLoaded(t,e,i,r,s,n){const a=this.hls,{type:o,level:l,id:h,groupId:d,deliveryDirectives:c}=r,u=ji(e,r),f=Yi(r),p="number"==typeof r.level&&f===Hi?l:void 0;if(!t.fragments.length){const t=new Error("No Segments found in Playlist");return void a.trigger(It.ERROR,{type:Ct.NETWORK_ERROR,details:Ut.LEVEL_EMPTY_ERROR,fatal:!1,url:u,error:t,reason:t.message,response:e,context:r,level:p,parent:f,networkDetails:s,stats:i})}t.targetduration||(t.playlistParsingError=new Error("Missing Target Duration"));const m=t.playlistParsingError;if(m)a.trigger(It.ERROR,{type:Ct.NETWORK_ERROR,details:Ut.LEVEL_PARSING_ERROR,fatal:!1,url:u,error:m,reason:m.message,response:e,context:r,level:p,parent:f,networkDetails:s,stats:i});else switch(t.live&&n&&(n.getCacheAge&&(t.ageHeader=n.getCacheAge()||0),n.getCacheAge&&!isNaN(t.ageHeader)||(t.ageHeader=0)),o){case Ni:case Gi:a.trigger(It.LEVEL_LOADED,{details:t,level:p||0,id:h||0,stats:i,networkDetails:s,deliveryDirectives:c});break;case $i:a.trigger(It.AUDIO_TRACK_LOADED,{details:t,id:h||0,groupId:d||"",stats:i,networkDetails:s,deliveryDirectives:c});break;case zi:a.trigger(It.SUBTITLE_TRACK_LOADED,{details:t,id:h||0,groupId:d||"",stats:i,networkDetails:s,deliveryDirectives:c})}}}function qi(t,e){let i;try{i=new Event("addtrack")}catch(t){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=t,e.dispatchEvent(i)}function Xi(t,e){const i=t.mode;if("disabled"===i&&(t.mode="hidden"),t.cues&&!t.cues.getCueById(e.id))try{if(t.addCue(e),!t.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Bt.debug(`[texttrack-utils]: ${i}`);try{const i=new self.TextTrackCue(e.startTime,e.endTime,e.text);i.id=e.id,t.addCue(i)}catch(t){Bt.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${t}`)}}"disabled"===i&&(t.mode=i)}function Zi(t){const e=t.mode;if("disabled"===e&&(t.mode="hidden"),t.cues)for(let e=t.cues.length;e--;)t.removeCue(t.cues[e]);"disabled"===e&&(t.mode=e)}function Qi(t,e,i,r){const s=t.mode;if("disabled"===s&&(t.mode="hidden"),t.cues&&t.cues.length>0){const s=function(t,e,i){const r=[],s=function(t,e){if(e<t[0].startTime)return 0;const i=t.length-1;if(e>t[i].endTime)return-1;let r=0,s=i;for(;r<=s;){const n=Math.floor((s+r)/2);if(e<t[n].startTime)s=n-1;else{if(!(e>t[n].startTime&&r<i))return n;r=n+1}}return t[r].startTime-e<e-t[s].startTime?r:s}(t,e);if(s>-1)for(let n=s,a=t.length;n<a;n++){const s=t[n];if(s.startTime>=e&&s.endTime<=i)r.push(s);else if(s.startTime>i)return r}return r}(t.cues,e,i);for(let e=0;e<s.length;e++)r&&!r(s[e])||t.removeCue(s[e])}"disabled"===s&&(t.mode=s)}function Ji(t){const e=[];for(let i=0;i<t.length;i++){const r=t[i];"subtitles"!==r.kind&&"captions"!==r.kind||!r.label||e.push(t[i])}return e}var tr="org.id3",er="com.apple.quicktime.HLS",ir="https://aomedia.org/emsg/ID3";function rr(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function sr(t,e,i,r,s){let n=new t(e,i,"");try{n.value=r,s&&(n.type=s)}catch(a){n=new t(e,i,JSON.stringify(s?wt({type:s},r):r))}return n}const nr=(()=>{const t=rr();try{t&&new t(0,Number.POSITIVE_INFINITY,"")}catch(t){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function ar(t,e){return t.getTime()/1e3-e}class or{constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(It.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(It.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(Zi(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){const e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){const i=t[e];if("metadata"===i.kind&&"id3"===i.label)return qi(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;const{samples:s}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));const n=rr();if(n)for(let t=0;t<s.length;t++){const e=s[t].type;if(e===ir&&!i||!r)continue;const a=Ae(s[t].data);if(a){const i=s[t].pts;let r=i+s[t].duration;r>nr&&(r=nr);r-i<=0&&(r=i+.25);for(let t=0;t<a.length;t++){const s=a[t];if(!we(s)){this.updateId3CueEnds(i,e);const t=sr(n,i,r,s,e);t&&this.id3Track.addCue(t)}}}}}updateId3CueEnds(t,e){var i;const r=null==(i=this.id3Track)?void 0:i.cues;if(r)for(let i=r.length;i--;){const s=r[i];s.type===e&&s.startTime<t&&s.endTime===nr&&(s.endTime=t)}}onBufferFlushing(t,{startOffset:e,endOffset:i,type:r}){const{id3Track:s,hls:n}=this;if(!n)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=n;if(s&&(a||o)){let t;t="audio"===r?t=>t.type===tr&&o:"video"===r?t=>t.type===ir&&a:t=>t.type===tr&&o||t.type===ir&&a,Qi(s,e,i,t)}}onLevelUpdated(t,{details:e}){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:r}=this,{dateRanges:s}=e,n=Object.keys(s);if(r){const t=Object.keys(i).filter((t=>!n.includes(t)));for(let e=t.length;e--;){const s=t[e];Object.keys(i[s].cues).forEach((t=>{r.removeCue(i[s].cues[t])})),delete i[s]}}const a=e.fragments[e.fragments.length-1];if(0===n.length||!kt(null==a?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=a.programDateTime/1e3-a.start,l=rr();for(let t=0;t<n.length;t++){const e=n[t],r=s[e],a=ar(r.startDate,o),c=i[e],u=(null==c?void 0:c.cues)||{};let f=(null==c?void 0:c.durationKnown)||!1,p=nr;const m=r.endDate;if(m)p=ar(m,o),f=!0;else if(r.endOnNext&&!f){const t=n.reduce(((t,e)=>{if(e!==r.id){const i=s[e];if(i.class===r.class&&i.startDate>r.startDate&&(!t||r.startDate<t.startDate))return i}return t}),null);t&&(p=ar(t.startDate,o),f=!0)}const g=Object.keys(r.attr);for(let t=0;t<g.length;t++){const i=g[t];if("ID"===(d=i)||"CLASS"===d||"START-DATE"===d||"DURATION"===d||"END-DATE"===d||"END-ON-NEXT"===d)continue;const s=u[i];if(s)f&&!c.durationKnown&&(s.endTime=p);else if(l){let t=r.attr[i];zt(i)&&(h=t,t=Uint8Array.from(h.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);const s=sr(l,a,p,{key:i,data:t},er);s&&(s.id=e,this.id3Track.addCue(s),u[i]=s)}}i[e]={cues:u,dateRange:r,durationKnown:f}}var h,d}}class lr{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:t,levelDetails:e}=this;return void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){const{levelDetails:t}=this;if(null===t)return null;const{holdBack:e,partHoldBack:i,targetduration:r}=t,{liveSyncDuration:s,liveSyncDurationCount:n,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&i||e;(o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==s?s:n*r);const h=r;return l+Math.min(1*this.stallCount,h)}get liveSyncPosition(){const t=this.estimateLiveEdge(),e=this.targetLatency,i=this.levelDetails;if(null===t||null===e||null===i)return null;const r=i.edge,s=t-e-this.edgeStalled,n=r-i.totalduration,a=r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(n,s),a)}get drift(){const{levelDetails:t}=this;return null===t?1:t.drift}get edgeStalled(){const{levelDetails:t}=this;if(null===t)return 0;const e=3*(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return Math.max(t.age-e,0)}get forwardBufferLength(){const{media:t,levelDetails:e}=this;if(!t||!e)return 0;const i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(It.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(It.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(It.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(It.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(It.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(It.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,{details:e}){this.levelDetails=e,e.advanced&&this.timeupdate(),!e.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var i;e.details===Ut.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(i=this.levelDetails)&&i.live&&Bt.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||1===s||!e.live)return;const n=this.targetLatency;if(null===n)return;const a=i-n;if(a<Math.min(this.maxLatency,n+e.targetduration)&&a>.05&&this.forwardBufferLength>1){const e=Math.min(2,Math.max(1,s)),i=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;t.playbackRate=Math.min(e,Math.max(1,i))}else 1!==t.playbackRate&&0!==t.playbackRate&&(t.playbackRate=1)}estimateLiveEdge(){const{levelDetails:t}=this;return null===t?null:t.edge+t.age}computeLatency(){const t=this.estimateLiveEdge();return null===t?null:t-this.currentTime}}const hr=["NONE","TYPE-0","TYPE-1",null];const dr=["SDR","PQ","HLG"];var cr="",ur="YES",fr="v2";function pr(t){const{canSkipUntil:e,canSkipDateRanges:i,age:r}=t;return e&&r<e/2?i?fr:ur:cr}class mr{constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}addDirectives(t){const e=new self.URL(t);return void 0!==this.msn&&e.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}}class gr{constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter((t=>!!t)).map((t=>t.substring(0,4))).join(","),this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return yr(this._audioGroups,t)}hasSubtitleGroup(t){return yr(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e)if("audio"===t){let t=this._audioGroups;t||(t=this._audioGroups=[]),-1===t.indexOf(e)&&t.push(e)}else if("text"===t){let t=this._subtitleGroups;t||(t=this._subtitleGroups=[]),-1===t.indexOf(e)&&t.push(e)}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return null==(t=this.audioGroups)?void 0:t[0]}get textGroupId(){var t;return null==(t=this.subtitleGroups)?void 0:t[0]}addFallback(){}}function yr(t,e){return!(!e||!t)&&-1!==t.indexOf(e)}function vr(t,e){const i=e.startPTS;if(kt(i)){let r,s=0;e.sn>t.sn?(s=i-t.start,r=t):(s=t.start-i,r=e),r.duration!==s&&(r.duration=s)}else if(e.sn>t.sn){t.cc===e.cc&&t.minEndPTS?e.start=t.start+(t.minEndPTS-t.start):e.start=t.start+t.duration}else e.start=Math.max(t.start-e.duration,0)}function _r(t,e,i,r,s,n){r-i<=0&&(Bt.warn("Fragment should have a positive duration",e),r=i+e.duration,n=s+e.duration);let a=i,o=r;const l=e.startPTS,h=e.endPTS;if(kt(l)){const t=Math.abs(l-i);kt(e.deltaPTS)?e.deltaPTS=Math.max(t,e.deltaPTS):e.deltaPTS=t,a=Math.max(i,l),i=Math.min(i,l),s=Math.min(s,e.startDTS),o=Math.min(r,h),r=Math.max(r,h),n=Math.max(n,e.endDTS)}const d=i-e.start;0!==e.start&&(e.start=i),e.duration=r-e.start,e.startPTS=i,e.maxStartPTS=a,e.startDTS=s,e.endPTS=r,e.minEndPTS=o,e.endDTS=n;const c=e.sn;if(!t||c<t.startSN||c>t.endSN)return 0;let u;const f=c-t.startSN,p=t.fragments;for(p[f]=e,u=f;u>0;u--)vr(p[u],p[u-1]);for(u=f;u<p.length-1;u++)vr(p[u],p[u+1]);return t.fragmentHint&&vr(p[p.length-1],t.fragmentHint),t.PTSKnown=t.alignedSliding=!0,d}function Sr(t,e){let i=null;const r=t.fragments;for(let t=r.length-1;t>=0;t--){const e=r[t].initSegment;if(e){i=e;break}}t.fragmentHint&&delete t.fragmentHint.endPTS;let s,n=0;if(function(t,e,i){const r=e.skippedSegments,s=Math.max(t.startSN,e.startSN)-e.startSN,n=(t.fragmentHint?1:0)+(r?e.endSN:Math.min(t.endSN,e.endSN))-e.startSN,a=e.startSN-t.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments;for(let t=s;t<=n;t++){const s=l[a+t];let n=o[t];r&&!n&&t<r&&(n=e.fragments[t]=s),s&&n&&i(s,n)}}(t,e,((t,r)=>{t.relurl&&(n=t.cc-r.cc),kt(t.startPTS)&&kt(t.endPTS)&&(r.start=r.startPTS=t.startPTS,r.startDTS=t.startDTS,r.maxStartPTS=t.maxStartPTS,r.endPTS=t.endPTS,r.endDTS=t.endDTS,r.minEndPTS=t.minEndPTS,r.duration=t.endPTS-t.startPTS,r.duration&&(s=r),e.PTSKnown=e.alignedSliding=!0),r.elementaryStreams=t.elementaryStreams,r.loader=t.loader,r.stats=t.stats,t.initSegment&&(r.initSegment=t.initSegment,i=t.initSegment)})),i){(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach((t=>{var e;!t||t.initSegment&&t.initSegment.relurl!==(null==(e=i)?void 0:e.relurl)||(t.initSegment=i)}))}if(e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some((t=>!t)),e.deltaUpdateFailed){Bt.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let t=e.skippedSegments;t--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=function(t,e,i){const r=xt({},t);i&&i.forEach((t=>{delete r[t]}));return Object.keys(e).forEach((t=>{const i=new Ht(e[t].attr,r[t]);i.isValid?r[t]=i:Bt.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[t].attr)}"`)})),r}(t.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const a=e.fragments;if(n){Bt.warn("discontinuity sliding from playlist, take drift into account");for(let t=0;t<a.length;t++)a[t].cc+=n}e.skippedSegments&&(e.startCC=e.fragments[0].cc),function(t,e,i){if(t&&e){let r=0;for(let s=0,n=t.length;s<=n;s++){const n=t[s],a=e[s+r];n&&a&&n.index===a.index&&n.fragment.sn===a.fragment.sn?i(n,a):r--}}}(t.partList,e.partList,((t,e)=>{e.elementaryStreams=t.elementaryStreams,e.stats=t.stats})),s?_r(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):Tr(t,e),a.length&&(e.totalduration=e.edge-a[0].start),e.driftStartTime=t.driftStartTime,e.driftStart=t.driftStart;const o=e.advancedDateTime;if(e.advanced&&o){const t=e.edge;e.driftStart||(e.driftStartTime=o,e.driftStart=t),e.driftEndTime=o,e.driftEnd=t}else e.driftEndTime=t.driftEndTime,e.driftEnd=t.driftEnd,e.advancedDateTime=t.advancedDateTime}function Tr(t,e){const i=e.startSN+e.skippedSegments-t.startSN,r=t.fragments;i<0||i>=r.length||Er(e,r[i].start)}function Er(t,e){if(e){const i=t.fragments;for(let r=t.skippedSegments;r<i.length;r++)i[r].start+=e;t.fragmentHint&&(t.fragmentHint.start+=e)}}function br(t,e,i){var r;return null!=t&&t.details?wr(null==(r=t.details)?void 0:r.partList,e,i):null}function wr(t,e,i){if(t)for(let r=t.length;r--;){const s=t[r];if(s.index===i&&s.fragment.sn===e)return s}return null}function Lr(t){t.forEach(((t,e)=>{const{details:i}=t;null!=i&&i.fragments&&i.fragments.forEach((t=>{t.level=e}))}))}function Ar(t){switch(t.details){case Ut.FRAG_LOAD_TIMEOUT:case Ut.KEY_LOAD_TIMEOUT:case Ut.LEVEL_LOAD_TIMEOUT:case Ut.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function xr(t,e){const i=Ar(e);return t.default[(i?"timeout":"error")+"Retry"]}function kr(t,e){const i="linear"===t.backoff?1:Math.pow(2,e);return Math.min(i*t.retryDelayMs,t.maxRetryDelayMs)}function Rr(t){return wt(wt({},t),{errorRetry:null,timeoutRetry:null})}function Dr(t,e,i,r){if(!t)return!1;const s=null==r?void 0:r.code,n=e<t.maxNumRetry&&(function(t){return 0===t&&!1===navigator.onLine||!!t&&(t<400||t>499)}(s)||!!i);return t.shouldRetry?t.shouldRetry(t,e,i,r,n):n}const Ir=function(t,e){let i=0,r=t.length-1,s=null,n=null;for(;i<=r;){s=(i+r)/2|0,n=t[s];const a=e(n);if(a>0)i=s+1;else{if(!(a<0))return n;r=s-1}}return null};function Cr(t,e,i=0,r=0,s=.005){let n=null;if(t){n=e[t.sn-e[0].sn+1]||null;const r=t.endDTS-i;r>0&&r<15e-7&&(i+=15e-7)}else 0===i&&0===e[0].start&&(n=e[0]);if(n&&((!t||t.level===n.level)&&0===Ur(i,r,n)||function(t,e,i){if(e&&0===e.start&&e.level<t.level&&(e.endPTS||0)>0){const r=e.tagList.reduce(((t,e)=>("INF"===e[0]&&(t+=parseFloat(e[1])),t)),i);return t.start<=r}return!1}(n,t,Math.min(s,r))))return n;const a=Ir(e,Ur.bind(null,i,r));return!a||a===t&&n?n:a}function Ur(t=0,e=0,i){if(i.start<=t&&i.start+i.duration>t)return 0;const r=Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=t?1:i.start-r>t&&i.start?-1:0}function Pr(t,e,i){const r=1e3*Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-r>t}var Mr=0,Fr=2,Or=3,Br=5,Nr=0,Gr=1,$r=2;class zr{constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=Bt.log.bind(Bt,`${e}:`),this.warn=Bt.warn.bind(Bt,`${e}:`),this.hls=t}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e,i){const r=null==e?void 0:e.renditionReports;if(r){let s=-1;for(let i=0;i<r.length;i++){const n=r[i];let a;try{a=new self.URL(n.URI,e.url).href}catch(t){Bt.warn(`Could not construct new URL for Rendition Report: ${t}`),a=n.URI||""}if(a===t){s=i;break}a===t.substring(0,a.length)&&(s=i)}if(-1!==s){const t=r[s],n=parseInt(t["LAST-MSN"])||(null==e?void 0:e.lastPartSn);let a=parseInt(t["LAST-PART"])||(null==e?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){const t=Math.min(e.age-e.partTarget,e.targetduration);a>=0&&t>e.partTarget&&(a+=1)}const o=i&&pr(i);return new mr(n,a>=0?a:void 0,o)}}}loadPlaylist(t){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,i){const{details:r,stats:s}=e,n=self.performance.now(),a=s.loading.first?Math.max(0,n-s.loading.first):0;if(r.advancedDateTime=Date.now()-a,r.live||null!=i&&i.live){if(r.reloaded(i),i&&this.log(`live playlist ${t} ${r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED"}`),i&&r.fragments.length>0&&Sr(i,r),!this.canLoad||!r.live)return;let a,o,l;if(r.canBlockReload&&r.endSN&&r.advanced){const t=this.hls.config.lowLatencyMode,s=r.lastPartSn,n=r.endSN,h=r.lastPartIndex,d=s===n;-1!==h?(o=d?n+1:s,l=d?t?0:h:h+1):o=n+1;const c=r.age,u=c+r.ageHeader;let f=Math.min(u-r.partTarget,1.5*r.targetduration);if(f>0){if(i&&f>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${f} with playlist age: ${r.age}`),f=0;else{const t=Math.floor(f/r.targetduration);if(o+=t,void 0!==l){l+=Math.round(f%r.targetduration/r.partTarget)}this.log(`CDN Tune-in age: ${r.ageHeader}s last advanced ${c.toFixed(2)}s goal: ${f} skip sn ${t} to part ${l}`)}r.tuneInGoal=f}if(a=this.getDeliveryDirectives(r,e.deliveryDirectives,o,l),t||!d)return void this.loadPlaylist(a)}else(r.canBlockReload||r.canSkipUntil)&&(a=this.getDeliveryDirectives(r,e.deliveryDirectives,o,l));const h=this.hls.mainForwardBufferInfo,d=h?h.end-h.len:0,c=function(t,e=1/0){let i=1e3*t.targetduration;if(t.updated){const r=t.fragments,s=4;if(r.length&&i*s>e){const t=1e3*r[r.length-1].duration;t<i&&(i=t)}}else i/=2;return Math.round(i)}(r,1e3*(r.edge-d));r.updated&&n>this.requestScheduled+c&&(this.requestScheduled=s.loading.start),void 0!==o&&r.canBlockReload?this.requestScheduled=s.loading.first+c-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+c<n?this.requestScheduled=n:this.requestScheduled-n<=0&&(this.requestScheduled+=c);let u=this.requestScheduled-n;u=Math.max(0,u),this.log(`reload live playlist ${t} in ${Math.round(u)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(a)),u)}else this.clearTimer()}getDeliveryDirectives(t,e,i,r){let s=pr(t);return null!=e&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,r=e.part,s=cr),new mr(i,r,s)}checkRetry(t){const e=t.details,i=Ar(t),r=t.errorAction,{action:s,retryCount:n=0,retryConfig:a}=r||{},o=!!r&&!!a&&(s===Br||!r.resolved&&s===Fr);if(o){var l;if(this.requestScheduled=-1,n>=a.maxNumRetry)return!1;if(i&&null!=(l=t.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${n+1}/${a.maxNumRetry} after "${e}" without delivery-directives`),this.loadPlaylist();else{const t=kr(a,n);this.timer=self.setTimeout((()=>this.loadPlaylist()),t),this.warn(`Retrying playlist loading ${n+1}/${a.maxNumRetry} after "${e}" in ${t}ms`)}t.levelRetry=!0,r.resolved=!0}return o}}class Hr{constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}sample(t,e){const i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}}class Vr{constructor(t,e,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Hr(t),this.fast_=new Hr(e),this.defaultTTFB_=r,this.ttfb_=new Hr(t)}update(t,e){const{slow_:i,fast_:r,ttfb_:s}=this;i.halfLife!==t&&(this.slow_=new Hr(t,i.getEstimate(),i.getTotalWeight())),r.halfLife!==e&&(this.fast_=new Hr(e,r.getEstimate(),r.getTotalWeight())),s.halfLife!==t&&(this.ttfb_=new Hr(t,s.getEstimate(),s.getTotalWeight()))}sample(t,e){const i=(t=Math.max(t,this.minDelayMs_))/1e3,r=8*e/i;this.fast_.sample(i,r),this.slow_.sample(i,r)}sampleTTFB(t){const e=t/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(i,Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const Kr={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},Yr={};function jr(t,e,i,r,s,n){const a=t.audioCodec?t.audioGroups:null,o=null==n?void 0:n.audioCodec,l=null==n?void 0:n.channels,h=l?parseInt(l):o?1/0:2;let d=null;if(null!=a&&a.length)try{d=1===a.length&&a[0]?e.groups[a[0]].channels:a.reduce(((t,i)=>{if(i){const r=e.groups[i];if(!r)throw new Error(`Audio track group ${i} not found`);Object.keys(r.channels).forEach((e=>{t[e]=(t[e]||0)+r.channels[e]}))}return t}),{2:0})}catch(t){return!0}return void 0!==t.videoCodec&&(t.width>1920&&t.height>1088||t.height>1920&&t.width>1088||t.frameRate>Math.max(r,30)||"SDR"!==t.videoRange&&t.videoRange!==i||t.bitrate>Math.max(s,8e6))||!!d&&kt(h)&&Object.keys(d).some((t=>parseInt(t)>h))}function Wr(t,e,i){const r=t.videoCodec,s=t.audioCodec;if(!r||!s||!i)return Promise.resolve(Kr);const n={width:t.width,height:t.height,bitrate:Math.ceil(Math.max(.9*t.bitrate,t.averageBitrate)),framerate:t.frameRate||30},a=t.videoRange;"SDR"!==a&&(n.transferFunction=a.toLowerCase());const o=r.split(",").map((t=>({type:"media-source",video:wt(wt({},n),{},{contentType:_i(t,"video")})})));return s&&t.audioGroups&&t.audioGroups.forEach((t=>{var i;t&&(null==(i=e.groups[t])||i.tracks.forEach((e=>{if(e.groupId===t){const t=e.channels||"",i=parseFloat(t);kt(i)&&i>2&&o.push.apply(o,s.split(",").map((t=>({type:"media-source",audio:{contentType:_i(t,"audio"),channels:""+i}}))))}})))})),Promise.all(o.map((t=>{const e=function(t){const{audio:e,video:i}=t,r=i||e;if(r){const t=r.contentType.split('"')[1];if(i)return`r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${t}_${Math.ceil(i.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${t}`}return""}(t);return Yr[e]||(Yr[e]=i.decodingInfo(t))}))).then((t=>({supported:!t.some((t=>!t.supported)),configurations:o,decodingInfoResults:t}))).catch((t=>({supported:!1,configurations:o,decodingInfoResults:[],error:t})))}function qr(t,e){let i=!1,r=[];return t&&(i="SDR"!==t,r=[t]),e&&(r=e.allowedVideoRanges||dr.slice(0),i=void 0!==e.preferHDR?e.preferHDR:function(){if("function"==typeof matchMedia){const t=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(t.media!==e.media)return!0===t.matches}return!1}(),r=i?r.filter((t=>"SDR"!==t)):["SDR"]),{preferHDR:i,allowedVideoRanges:r}}function Xr(t,e){Bt.log(`[abr] start candidates with "${t}" ignored because ${e}`)}function Zr(t,e,i){if("attrs"in t){const i=e.indexOf(t);if(-1!==i)return i}for(let r=0;r<e.length;r++){if(Qr(t,e[r],i))return r}return-1}function Qr(t,e,i){const{groupId:r,name:s,lang:n,assocLang:a,characteristics:o,default:l}=t,h=t.forced;return(void 0===r||e.groupId===r)&&(void 0===s||e.name===s)&&(void 0===n||e.lang===n)&&(void 0===n||e.assocLang===a)&&(void 0===l||e.default===l)&&(void 0===h||e.forced===h)&&(void 0===o||function(t,e=""){const i=t.split(","),r=e.split(",");return i.length===r.length&&!i.some((t=>-1===r.indexOf(t)))}(o,e.characteristics))&&(void 0===i||i(t,e))}function Jr(t,e){const{audioCodec:i,channels:r}=t;return!(void 0!==i&&(e.audioCodec||"").substring(0,4)!==i.substring(0,4)||void 0!==r&&r!==(e.channels||"2"))}function ts(t,e,i){for(let r=e;r>-1;r--)if(i(t[r]))return r;for(let r=e+1;r<t.length;r++)if(i(t[r]))return r;return-1}class es{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var is="NOT_LOADED",rs="APPENDING",ss="PARTIAL",ns="OK";class as{constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(It.BUFFER_APPENDED,this.onBufferAppended,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this),t.on(It.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.BUFFER_APPENDED,this.onBufferAppended,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this),t.off(It.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){const i=this.activePartLists[e];if(i)for(let e=i.length;e--;){const r=i[e];if(!r)break;const s=r.end;if(r.start<=t&&null!==s&&t<=s)return r}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){const{fragments:i}=this,r=Object.keys(i);for(let s=r.length;s--;){const n=i[r[s]];if((null==n?void 0:n.body.type)===e&&n.buffered){const e=n.body;if(e.start<=t&&t<=e.end)return e}}return null}detectEvictedFragments(t,e,i,r){this.timeRanges&&(this.timeRanges[t]=e);const s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach((r=>{const n=this.fragments[r];if(!n)return;if(s>=n.body.sn)return;if(!n.buffered&&!n.loaded)return void(n.body.type===i&&this.removeFragment(n.body));const a=n.range[t];a&&a.time.some((t=>{const i=!this.isTimeBuffered(t.startPTS,t.endPTS,e);return i&&this.removeFragment(n.body),i}))}))}detectPartialFragments(t){const e=this.timeRanges,{frag:i,part:r}=t;if(!e||"initSegment"===i.sn)return;const s=ls(i),n=this.fragments[s];if(!n||n.buffered&&i.gap)return;const a=!i.relurl;if(Object.keys(e).forEach((t=>{const s=i.elementaryStreams[t];if(!s)return;const o=e[t],l=a||!0===s.partial;n.range[t]=this.getBufferedTimes(i,r,l,o)})),n.loaded=null,Object.keys(n.range).length){n.buffered=!0;(n.body.endList=i.endList||n.body.endList)&&(this.endListFragments[n.body.type]=n),os(n)||this.removeParts(i.sn-1,i.type)}else this.removeFragment(n.body)}removeParts(t,e){const i=this.activePartLists[e];i&&(this.activePartLists[e]=i.filter((e=>e.fragment.sn>=t)))}fragBuffered(t,e){const i=ls(t);let r=this.fragments[i];!r&&e&&(r=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(t,e,i,r){const s={time:[],partial:i},n=t.start,a=t.end,o=t.minEndPTS||a,l=t.maxStartPTS||n;for(let t=0;t<r.length;t++){const e=r.start(t)-this.bufferPadding,i=r.end(t)+this.bufferPadding;if(l>=e&&o<=i){s.time.push({startPTS:Math.max(n,r.start(t)),endPTS:Math.min(a,r.end(t))});break}if(n<i&&a>e){const e=Math.max(n,r.start(t)),i=Math.min(a,r.end(t));i>e&&(s.partial=!0,s.time.push({startPTS:e,endPTS:i}))}else if(a<=e)break}return s}getPartialFragment(t){let e,i,r,s=null,n=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach((l=>{const h=o[l];h&&os(h)&&(i=h.body.start-a,r=h.body.end+a,t>=i&&t<=r&&(e=Math.min(t-i,r-t),n<=e&&(s=h.body,n=e)))})),s}isEndListAppended(t){const e=this.endListFragments[t];return void 0!==e&&(e.buffered||os(e))}getState(t){const e=ls(t),i=this.fragments[e];return i?i.buffered?os(i)?ss:ns:rs:is}isTimeBuffered(t,e,i){let r,s;for(let n=0;n<i.length;n++){if(r=i.start(n)-this.bufferPadding,s=i.end(n)+this.bufferPadding,t>=r&&e<=s)return!0;if(e<=r)return!1}return!1}onFragLoaded(t,e){const{frag:i,part:r}=e;if("initSegment"===i.sn||i.bitrateTest)return;const s=r?null:e,n=ls(i);this.fragments[n]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){const{frag:i,part:r,timeRanges:s}=e;if("initSegment"===i.sn)return;const n=i.type;if(r){let t=this.activePartLists[n];t||(this.activePartLists[n]=t=[]),t.push(r)}this.timeRanges=s,Object.keys(s).forEach((t=>{const e=s[t];this.detectEvictedFragments(t,e,n,r)}))}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){const e=ls(t);return!!this.fragments[e]}hasParts(t){var e;return!(null==(e=this.activePartLists[t])||!e.length)}removeFragmentsInRange(t,e,i,r,s){r&&!this.hasGaps||Object.keys(this.fragments).forEach((n=>{const a=this.fragments[n];if(!a)return;const o=a.body;o.type!==i||r&&!o.gap||o.start<e&&o.end>t&&(a.buffered||s)&&this.removeFragment(o)}))}removeFragment(t){const e=ls(t);t.stats.loaded=0,t.clearElementaryStreamInfo();const i=this.activePartLists[t.type];if(i){const e=t.sn;this.activePartLists[t.type]=i.filter((t=>t.fragment.sn!==e))}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function os(t){var e,i,r;return t.buffered&&(t.body.gap||(null==(e=t.range.video)?void 0:e.partial)||(null==(i=t.range.audio)?void 0:i.partial)||(null==(r=t.range.audiovideo)?void 0:r.partial))}function ls(t){return`${t.type}_${t.level}_${t.sn}`}const hs={length:0,start:()=>0,end:()=>0};class ds{static isBuffered(t,e){try{if(t){const i=ds.getBuffered(t);for(let t=0;t<i.length;t++)if(e>=i.start(t)&&e<=i.end(t))return!0}}catch(t){}return!1}static bufferInfo(t,e,i){try{if(t){const r=ds.getBuffered(t),s=[];let n;for(n=0;n<r.length;n++)s.push({start:r.start(n),end:r.end(n)});return this.bufferedInfo(s,e,i)}}catch(t){}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,i){e=Math.max(0,e),t.sort((function(t,e){const i=t.start-e.start;return i||e.end-t.end}));let r=[];if(i)for(let e=0;e<t.length;e++){const s=r.length;if(s){const n=r[s-1].end;t[e].start-n<i?t[e].end>n&&(r[s-1].end=t[e].end):r.push(t[e])}else r.push(t[e])}else r=t;let s,n=0,a=e,o=e;for(let t=0;t<r.length;t++){const l=r[t].start,h=r[t].end;if(e+i>=l&&e<h)a=l,o=h,n=o-e;else if(e+i<l){s=l;break}}return{len:n,start:a||0,end:o||0,nextStart:s}}static getBuffered(t){try{return t.buffered}catch(t){return Bt.log("failed to get media.buffered",t),hs}}}class cs{constructor(t,e,i,r=0,s=-1,n=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=t,this.sn=e,this.id=i,this.size=r,this.part=s,this.partial=n}}function us(t,e){for(let r=0,s=t.length;r<s;r++){var i;if((null==(i=t[r])?void 0:i.cc)===e)return t[r]}return null}function fs(t,e){if(t){const i=t.start+e;t.start=t.startPTS=i,t.endPTS=i+t.duration}}function ps(t,e){const i=e.fragments;for(let e=0,r=i.length;e<r;e++)fs(i[e],t);e.fragmentHint&&fs(e.fragmentHint,t),e.alignedSliding=!0}function ms(t,e,i){e&&(!function(t,e,i){if(function(t,e,i){return!(!e||!(i.endCC>i.startCC||t&&t.cc<i.startCC))}(t,i,e)){const t=function(t,e){const i=t.fragments,r=e.fragments;if(!r.length||!i.length)return void Bt.log("No fragments to align");const s=us(i,r[0].cc);if(s&&(!s||s.startPTS))return s;Bt.log("No frag in previous level to align on")}(i,e);t&&kt(t.start)&&(Bt.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),ps(t.start,e))}}(t,i,e),!i.alignedSliding&&e&&gs(i,e),i.alignedSliding||!e||i.skippedSegments||Tr(e,i))}function gs(t,e){if(!t.hasProgramDateTime||!e.hasProgramDateTime)return;const i=t.fragments,r=e.fragments;if(!i.length||!r.length)return;let s,n;const a=Math.min(e.endCC,t.endCC);e.startCC<a&&t.startCC<a&&(s=us(r,a),n=us(i,a)),s&&n||(s=r[Math.floor(r.length/2)],n=us(i,s.cc)||i[Math.floor(i.length/2)]);const o=s.programDateTime,l=n.programDateTime;if(!o||!l)return;ps((l-o)/1e3-(n.start-s.start),t)}const ys=Math.pow(2,17);class vs{constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){const i=t.url;if(!i)return Promise.reject(new Ts({type:Ct.NETWORK_ERROR,details:Ut.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();const r=this.config,s=r.fLoader,n=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),t.gap){if(t.tagList.some((t=>"GAP"===t[0])))return void o(Ss(t));t.gap=!1}const l=this.loader=t.loader=s?new s(r):new n(r),h=_s(t),d=Rr(r.fragLoadPolicy.default),c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===t.sn?1/0:ys};t.stats=l.stats,l.load(h,c,{onSuccess:(e,i,r,s)=>{this.resetLoader(t,l);let n=e.data;r.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(n.slice(0,16)),n=n.slice(16)),a({frag:t,part:null,payload:n,networkDetails:s})},onError:(e,r,s,n)=>{this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:wt({url:i,data:void 0},e),error:new Error(`HTTP Error ${e.code} ${e.text}`),networkDetails:s,stats:n}))},onAbort:(e,i,r)=>{this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.INTERNAL_ABORTED,fatal:!1,frag:t,error:new Error("Aborted"),networkDetails:r,stats:e}))},onTimeout:(e,i,r)=>{this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:new Error(`Timeout after ${c.timeout}ms`),networkDetails:r,stats:e}))},onProgress:(i,r,s,n)=>{e&&e({frag:t,part:null,payload:s,networkDetails:n})}})}))}loadPart(t,e,i){this.abort();const r=this.config,s=r.fLoader,n=r.loader;return new Promise(((a,o)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap)return void o(Ss(t,e));const l=this.loader=t.loader=s?new s(r):new n(r),h=_s(t,e),d=Rr(r.fragLoadPolicy.default),c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:ys};e.stats=l.stats,l.load(h,c,{onSuccess:(r,s,n,o)=>{this.resetLoader(t,l),this.updateStatsFromPart(t,e);const h={frag:t,part:e,payload:r.data,networkDetails:o};i(h),a(h)},onError:(i,r,s,n)=>{this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:wt({url:h.url,data:void 0},i),error:new Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:s,stats:n}))},onAbort:(i,r,s)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:new Error("Aborted"),networkDetails:s,stats:i}))},onTimeout:(i,r,s)=>{this.resetLoader(t,l),o(new Ts({type:Ct.NETWORK_ERROR,details:Ut.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:new Error(`Timeout after ${c.timeout}ms`),networkDetails:s,stats:i}))}})}))}updateStatsFromPart(t,e){const i=t.stats,r=e.stats,s=r.total;if(i.loaded+=r.loaded,s){const r=Math.round(t.duration/e.duration),n=Math.min(Math.round(i.loaded/s),r),a=(r-n)*Math.round(i.loaded/n);i.total=i.loaded+a}else i.total=Math.max(i.loaded,i.total);const n=i.loading,a=r.loading;n.start?n.first+=a.first-a.start:(n.start=a.start,n.first=a.first),n.end=a.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}}function _s(t,e=null){const i=e||t,r={frag:t,part:e,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},s=i.byteRangeStartOffset,n=i.byteRangeEndOffset;if(kt(s)&&kt(n)){var a;let e=s,i=n;if("initSegment"===t.sn&&"AES-128"===(null==(a=t.decryptdata)?void 0:a.method)){const t=n-s;t%16&&(i=n+(16-t%16)),0!==s&&(r.resetIV=!0,e=s-16)}r.rangeStart=e,r.rangeEnd=i}return r}function Ss(t,e){const i=new Error(`GAP ${t.gap?"tag":"attribute"} found`),r={type:Ct.MEDIA_ERROR,details:Ut.FRAG_GAP,fatal:!1,frag:t,error:i,networkDetails:null};return e&&(r.part=e),(e||t).stats.aborted=!0,new Ts(r)}class Ts extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class Es{constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}}class bs{constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class ws{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(t){const e=new DataView(t),i=new Uint32Array(4);for(let t=0;t<4;t++)i[t]=e.getUint32(4*t);return i}initTable(){const t=this.sBox,e=this.invSBox,i=this.subMix,r=i[0],s=i[1],n=i[2],a=i[3],o=this.invSubMix,l=o[0],h=o[1],d=o[2],c=o[3],u=new Uint32Array(256);let f=0,p=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let i=p^p<<1^p<<2^p<<3^p<<4;i=i>>>8^255&i^99,t[f]=i,e[i]=f;const o=u[f],m=u[o],g=u[m];let y=257*u[i]^16843008*i;r[f]=y<<24|y>>>8,s[f]=y<<16|y>>>16,n[f]=y<<8|y>>>24,a[f]=y,y=16843009*g^65537*m^257*o^16843008*f,l[i]=y<<24|y>>>8,h[i]=y<<16|y>>>16,d[i]=y<<8|y>>>24,c[i]=y,f?(f=o^u[u[u[g^o]]],p^=u[u[p]]):f=p=1}}expandKey(t){const e=this.uint8ArrayToUint32Array_(t);let i=!0,r=0;for(;r<e.length&&i;)i=e[r]===this.key[r],r++;if(i)return;this.key=e;const s=this.keySize=e.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const n=this.ksRows=4*(s+6+1);let a,o;const l=this.keySchedule=new Uint32Array(n),h=this.invKeySchedule=new Uint32Array(n),d=this.sBox,c=this.rcon,u=this.invSubMix,f=u[0],p=u[1],m=u[2],g=u[3];let y,v;for(a=0;a<n;a++)a<s?y=l[a]=e[a]:(v=y,a%s==0?(v=v<<8|v>>>24,v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v],v^=c[a/s|0]<<24):s>6&&a%s==4&&(v=d[v>>>24]<<24|d[v>>>16&255]<<16|d[v>>>8&255]<<8|d[255&v]),l[a]=y=(l[a-s]^v)>>>0);for(o=0;o<n;o++)a=n-o,v=3&o?l[a]:l[a-4],h[o]=o<4||a<=4?v:f[d[v>>>24]]^p[d[v>>>16&255]]^m[d[v>>>8&255]]^g[d[255&v]],h[o]=h[o]>>>0}networkToHostOrderSwap(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24}decrypt(t,e,i){const r=this.keySize+6,s=this.invKeySchedule,n=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],h=a[2],d=a[3],c=this.uint8ArrayToUint32Array_(i);let u=c[0],f=c[1],p=c[2],m=c[3];const g=new Int32Array(t),y=new Int32Array(g.length);let v,_,S,T,E,b,w,L,A,x,k,R,D,I;const C=this.networkToHostOrderSwap;for(;e<g.length;){for(A=C(g[e]),x=C(g[e+1]),k=C(g[e+2]),R=C(g[e+3]),E=A^s[0],b=R^s[1],w=k^s[2],L=x^s[3],D=4,I=1;I<r;I++)v=o[E>>>24]^l[b>>16&255]^h[w>>8&255]^d[255&L]^s[D],_=o[b>>>24]^l[w>>16&255]^h[L>>8&255]^d[255&E]^s[D+1],S=o[w>>>24]^l[L>>16&255]^h[E>>8&255]^d[255&b]^s[D+2],T=o[L>>>24]^l[E>>16&255]^h[b>>8&255]^d[255&w]^s[D+3],E=v,b=_,w=S,L=T,D+=4;v=n[E>>>24]<<24^n[b>>16&255]<<16^n[w>>8&255]<<8^n[255&L]^s[D],_=n[b>>>24]<<24^n[w>>16&255]<<16^n[L>>8&255]<<8^n[255&E]^s[D+1],S=n[w>>>24]<<24^n[L>>16&255]<<16^n[E>>8&255]<<8^n[255&b]^s[D+2],T=n[L>>>24]<<24^n[E>>16&255]<<16^n[b>>8&255]<<8^n[255&w]^s[D+3],y[e]=C(v^u),y[e+1]=C(T^f),y[e+2]=C(S^p),y[e+3]=C(_^m),u=A,f=x,p=k,m=R,e+=4}return y.buffer}}class Ls{constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{const t=self.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch(t){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;const i=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?function(t){const e=t.byteLength,i=e&&new DataView(t.buffer).getUint8(e-1);return i?ye(t,0,e-i):t}(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i){return this.useSoftware?new Promise(((r,s)=>{this.softwareDecrypt(new Uint8Array(t),e,i);const n=this.flush();n?r(n.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(t),e,i)}softwareDecrypt(t,e,i){const{currentIV:r,currentResult:s,remainderData:n}=this;this.logOnce("JS AES decrypt"),n&&(t=ti(n,t),this.remainderData=null);const a=this.getValidChunk(t);if(!a.length)return null;r&&(i=r);let o=this.softwareDecrypter;o||(o=this.softwareDecrypter=new ws),o.expandKey(e);const l=s;return this.currentResult=o.decrypt(a.buffer,0,i),this.currentIV=ye(a,-16).buffer,l||null}webCryptoDecrypt(t,e,i){if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(t,e,i));this.key=e,this.fastAesKey=new bs(this.subtle,e)}return this.fastAesKey.expandKey().then((e=>{if(!this.subtle)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new Es(this.subtle,new Uint8Array(i)).decrypt(t.buffer,e)})).catch((r=>(Bt.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${r.name}: ${r.message}`),this.onWebCryptoError(t,e,i))))}onWebCryptoError(t,e,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i);const r=this.flush();if(r)return r.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t;const i=t.length-t.length%16;return i!==t.length&&(e=ye(t,0,i),this.remainderData=ye(t,i)),e}logOnce(t){this.logEnabled&&(Bt.log(`[decrypter]: ${t}`),this.logEnabled=!1)}}const As=function(t){let e="";const i=t.length;for(let r=0;r<i;r++)e+=`[${t.start(r).toFixed(3)}-${t.end(r).toFixed(3)}]`;return e},xs="STOPPED",ks="IDLE",Rs="KEY_LOADING",Ds="FRAG_LOADING",Is="FRAG_LOADING_WAITING_RETRY",Cs="WAITING_TRACK",Us="PARSING",Ps="PARSED",Ms="ENDED",Fs="ERROR",Os="WAITING_INIT_PTS",Bs="WAITING_LEVEL";class Ns extends es{constructor(t,e,i,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=xs,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=Bt.log.bind(Bt,`${r}:`),this.warn=Bt.warn.bind(Bt,`${r}:`),this.hls=t,this.fragmentLoader=new vs(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new Ls(t.config),t.on(It.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const t=this.fragCurrent;null!=t&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=xs}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;const i=e.partList;if(null!=i&&i.length){const t=i[i.length-1];return ds.isBuffered(this.media,t.start+t.duration/2)}const r=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){var t;if(this.levels&&null!==this.levelLastLoaded)return null==(t=this.levelLastLoaded)?void 0:t.details}onMediaAttached(t,e){const i=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const r=this.config;this.levels&&r.autoStartLoad&&this.state===xs&&this.startLoad(r.startPosition)}onMediaDetaching(){const t=this.media;null!=t&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:t,fragCurrent:e,media:i,mediaBuffer:r,state:s}=this,n=i?i.currentTime:0,a=ds.bufferInfo(r||i,n,t.maxBufferHole);if(this.log(`media seeking to ${kt(n)?n.toFixed(3):n}, state: ${s}`),this.state===Ms)this.resetLoadingState();else if(e){const i=t.maxFragLookUpTolerance,r=e.start-i,s=e.start+e.duration+i;if(!a.len||s<a.start||r>a.end){const t=n>s;(n<r||t)&&(t&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(n,1/0,this.playlistType,!0),this.lastCurrentTime=n),this.loadedmetadata||a.len||(this.nextLoadPosition=this.startPosition=n),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(It.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=xs,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){this._doFragLoad(t,e,i,(e=>{if(this.fragContextChanged(t))return this.warn(`Fragment ${t.sn}${e.part?" p: "+e.part.index:""} of level ${t.level} was dropped during download.`),void this.fragmentTracker.removeFragment(t);t.stats.chunkCount++,this._handleFragmentLoadProgress(e)})).then((e=>{if(!e)return;const i=this.state;this.fragContextChanged(t)?(i===Ds||!this.fragCurrent&&i===Us)&&(this.fragmentTracker.removeFragment(t),this.state=ks):("payload"in e&&(this.log(`Loaded fragment ${t.sn} of level ${t.level}`),this.hls.trigger(It.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e))})).catch((e=>{this.state!==xs&&this.state!==Fs&&(this.warn(`Frag error: ${(null==e?void 0:e.message)||e}`),this.resetFragmentLoading(t))}))}clearTrackerIfNeeded(t){var e;const{fragmentTracker:i}=this;if(i.getState(t)===rs){const e=t.type,r=this.getFwdBufferInfo(this.mediaBuffer,e),s=Math.max(t.duration,r?r.len:this.config.maxBufferLength),n=this.backtrackFragment;(1===(n?t.sn-n.sn:0)||this.reduceMaxBufferLength(s,t.duration))&&i.removeFragment(t)}else 0===(null==(e=this.mediaBuffer)?void 0:e.buffered.length)?i.removeAllFragments():i.hasParts(t.type)&&(i.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),i.getState(t)===ss&&i.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){const e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}flushMainBuffer(t,e,i=null){if(!(t-e))return;const r={startOffset:t,endOffset:e,type:i};this.hls.trigger(It.BUFFER_FLUSHING,r)}_loadInitSegment(t,e){this._doFragLoad(t,e).then((e=>{if(!e||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return e})).then((e=>{const{hls:i}=this,{payload:r}=e,s=t.decryptdata;if(r&&r.byteLength>0&&null!=s&&s.key&&s.iv&&"AES-128"===s.method){const n=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),s.key.buffer,s.iv.buffer).catch((e=>{throw i.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((r=>{const s=self.performance.now();return i.trigger(It.FRAG_DECRYPTED,{frag:t,payload:r,stats:{tstart:n,tdecrypt:s}}),e.payload=r,this.completeInitSegmentLoad(e)}))}return this.completeInitSegmentLoad(e)})).catch((e=>{this.state!==xs&&this.state!==Fs&&(this.warn(e),this.resetFragmentLoading(t))}))}completeInitSegmentLoad(t){const{levels:e}=this;if(!e)throw new Error("init load aborted, missing levels");const i=t.frag.stats;this.state=ks,t.frag.data=new Uint8Array(t.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){const{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){var i,r,s,n;const a=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${t.type} sn: ${t.sn}${e?" part: "+e.index:""} of ${this.playlistType===Hi?"level":"track"} ${t.level} (frag:[${(null!=(i=t.startPTS)?i:NaN).toFixed(3)}-${(null!=(r=t.endPTS)?r:NaN).toFixed(3)}] > buffer:${a?As(ds.getBuffered(a)):"(detached)"})`),"initSegment"!==t.sn){var o;if(t.type!==Ki){const e=t.elementaryStreams;if(!Object.keys(e).some((t=>!!e[t])))return void(this.state=ks)}const e=null==(o=this.levels)?void 0:o[t.level];null!=e&&e.fragmentError&&(this.log(`Resetting level fragment error count of ${e.fragmentError} on frag buffered`),e.fragmentError=0)}this.state=ks,a&&(!this.loadedmetadata&&t.type==Hi&&a.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(n=this.fragPrevious)?void 0:n.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){const{transmuxer:e}=this;if(!e)return;const{frag:i,part:r,partsLoaded:s}=t,n=!s||0===s.length||s.some((t=>!t)),a=new cs(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!n);e.flush(a)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e,i=null,r){var s;const n=null==e?void 0:e.details;if(!this.levels||!n)throw new Error(`frag load aborted, missing level${n?"":" detail"}s`);let a=null;if(!t.encrypted||null!=(s=t.decryptdata)&&s.key?!t.encrypted&&n.encryptedFragments.length&&this.keyLoader.loadClear(t,n.encryptedFragments):(this.log(`Loading key for ${t.sn} of [${n.startSN}-${n.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${t.level}`),this.state=Rs,this.fragCurrent=t,a=this.keyLoader.load(t).then((t=>{if(!this.fragContextChanged(t.frag))return this.hls.trigger(It.KEY_LOADED,t),this.state===Rs&&(this.state=ks),t})),this.hls.trigger(It.KEY_LOADING,{frag:t}),null===this.fragCurrent&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),i=Math.max(t.start,i||0),this.config.lowLatencyMode&&"initSegment"!==t.sn){const s=n.partList;if(s&&r){i>t.end&&n.fragmentHint&&(t=n.fragmentHint);const o=this.getNextPart(s,t,i);if(o>-1){const l=s[o];let h;return this.log(`Loading part sn: ${t.sn} p: ${l.index} cc: ${t.cc} of playlist [${n.startSN}-${n.endSN}] parts [0-${o}-${s.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=l.start+l.duration,this.state=Ds,h=a?a.then((i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(t,l,e,r))).catch((t=>this.handleFragLoadError(t))):this.doFragPartsLoad(t,l,e,r).catch((t=>this.handleFragLoadError(t))),this.hls.trigger(It.FRAG_LOADING,{frag:t,part:l,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):h}if(!t.url||this.loadedEndOfParts(s,i))return Promise.resolve(null)}}this.log(`Loading fragment ${t.sn} cc: ${t.cc} ${n?"of ["+n.startSN+"-"+n.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${t.level}, target: ${parseFloat(i.toFixed(3))}`),kt(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=Ds;const o=this.config.progressive;let l;return l=o&&a?a.then((e=>!e||this.fragContextChanged(null==e?void 0:e.frag)?null:this.fragmentLoader.load(t,r))).catch((t=>this.handleFragLoadError(t))):Promise.all([this.fragmentLoader.load(t,o?r:void 0),a]).then((([t])=>(!o&&t&&r&&r(t),t))).catch((t=>this.handleFragLoadError(t))),this.hls.trigger(It.FRAG_LOADING,{frag:t,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(t,e,i,r){return new Promise(((s,n)=>{var a;const o=[],l=null==(a=i.details)?void 0:a.partList,h=e=>{this.fragmentLoader.loadPart(t,e,r).then((r=>{o[e.index]=r;const n=r.part;this.hls.trigger(It.FRAG_LOADED,r);const a=br(i,t.sn,e.index+1)||wr(l,t.sn,e.index+1);if(!a)return s({frag:t,part:n,partsLoaded:o});h(a)})).catch(n)};h(e)}))}handleFragLoadError(t){if("data"in t){const e=t.data;t.data&&e.details===Ut.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(It.ERROR,e)}else this.hls.trigger(It.ERROR,{type:Ct.OTHER_ERROR,details:Ut.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){const e=this.getCurrentContext(t);if(!e||this.state!==Us)return void(this.fragCurrent||this.state===xs||this.state===Fs||(this.state=ks));const{frag:i,part:r,level:s}=e,n=self.performance.now();i.stats.parsing.end=n,r&&(r.stats.parsing.end=n),this.updateLevelTiming(i,r,s,t.partial)}getCurrentContext(t){const{levels:e,fragCurrent:i}=this,{level:r,sn:s,part:n}=t;if(null==e||!e[r])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${r}. The current chunk will not be buffered.`),null;const a=e[r],o=n>-1?br(a,s,n):null,l=o?o.fragment:function(t,e,i){if(null==t||!t.details)return null;const r=t.details;let s=r.fragments[e-r.startSN];return s||(s=r.fragmentHint,s&&s.sn===e?s:e<r.startSN&&i&&i.sn===e?i:null)}(a,s,i);return l?(i&&i!==l&&(l.stats=i.stats),{frag:l,part:o,level:a}):null}bufferFragmentData(t,e,i,r,s){var n;if(!t||this.state!==Us)return;const{data1:a,data2:o}=t;let l=a;if(a&&o&&(l=ti(a,o)),null==(n=l)||!n.length)return;const h={type:t.type,frag:e,part:i,chunkMeta:r,parent:e.type,data:l};if(this.hls.trigger(It.BUFFER_APPENDING,h),t.dropped&&t.independent&&!i){if(s)return;this.flushBufferGap(e)}}flushBufferGap(t){const e=this.media;if(!e)return;if(!ds.isBuffered(e,e.currentTime))return void this.flushMainBuffer(0,t.start);const i=e.currentTime,r=ds.bufferInfo(e,i,0),s=t.duration,n=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),a=Math.max(Math.min(t.start-n,r.end-n),i+n);t.start-a>n&&this.flushMainBuffer(a,t.start)}getFwdBufferInfo(t,e){const i=this.getLoadPosition();return kt(i)?this.getFwdBufferInfoAtPos(t,i,e):null}getFwdBufferInfoAtPos(t,e,i){const{config:{maxBufferHole:r}}=this,s=ds.bufferInfo(t,e,r);if(0===s.len&&void 0!==s.nextStart){const n=this.fragmentTracker.getBufferedFrag(e,i);if(n&&s.nextStart<n.end)return ds.bufferInfo(t,e,Math.max(s.nextStart,r))}return s}getMaxBufferLength(t){const{config:e}=this;let i;return i=t?Math.max(8*e.maxBufferSize/t,e.maxBufferLength):e.maxBufferLength,Math.min(i,e.maxMaxBufferLength)}reduceMaxBufferLength(t,e){const i=this.config,r=Math.max(Math.min(t-e,i.maxBufferLength),e),s=Math.max(t-3*e,i.maxMaxBufferLength/2,r);return s>=r&&(i.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0)}getAppendedFrag(t,e=Hi){const i=this.fragmentTracker.getAppendedFrag(t,Hi);return i&&"fragment"in i?i.fragment:i}getNextFragment(t,e){const i=e.fragments,r=i.length;if(!r)return null;const{config:s}=this,n=i[0].start;let a;if(e.live){const o=s.initialLiveManifestSize;if(r<o)return this.warn(`Not enough fragments to start playback (have: ${r}, need: ${o})`),null;(!e.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||t<n)&&(a=this.getInitialLiveFragment(e,i),this.startPosition=this.nextLoadPosition=a?this.hls.liveSyncPosition||a.start:t)}else t<=n&&(a=i[0]);if(!a){const i=s.lowLatencyMode?e.partEnd:e.fragmentEnd;a=this.getFragmentAtPosition(t,i,e)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(t,e){const i=this.fragmentTracker.getState(t);return(i===ns||i===ss&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,r,s){const n=t.gap,a=this.getNextFragment(this.nextLoadPosition,e);if(null===a)return a;if(t=a,n&&t&&!t.gap&&i.nextStart){const e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r);if(null!==e&&i.len+e.len>=s)return this.log(`buffer full after gaps in "${r}" playlist starting at sn: ${t.sn}`),null}return t}mapToInitFragWhenRequired(t){return null==t||!t.initSegment||null!=t&&t.initSegment.data||this.bitrateTest?t:t.initSegment}getNextPart(t,e,i){let r=-1,s=!1,n=!0;for(let a=0,o=t.length;a<o;a++){const o=t[a];if(n=n&&!o.independent,r>-1&&i<o.start)break;const l=o.loaded;l?r=-1:(s||o.independent||n)&&o.fragment===e&&(r=a),s=l}return r}loadedEndOfParts(t,e){const i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t,e){const i=this.fragPrevious;let r=null;if(i){if(t.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),r=function(t,e,i){if(null===e||!Array.isArray(t)||!t.length||!kt(e))return null;if(e<(t[0].programDateTime||0))return null;if(e>=(t[t.length-1].endProgramDateTime||0))return null;i=i||0;for(let r=0;r<t.length;++r){const s=t[r];if(Pr(e,i,s))return s}return null}(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){const s=i.sn+1;if(s>=t.startSN&&s<=t.endSN){const n=e[s-t.startSN];i.cc===n.cc&&(r=n,this.log(`Live playlist, switching playlist, load frag with next SN: ${r.sn}`))}r||(r=function(t,e){return Ir(t,(t=>t.cc<e?1:t.cc>e?-1:0))}(e,i.cc),r&&this.log(`Live playlist, switching playlist, load frag with same CC: ${r.sn}`))}}else{const e=this.hls.liveSyncPosition;null!==e&&(r=this.getFragmentAtPosition(e,this.bitrateTest?t.fragmentEnd:t.edge,t))}return r}getFragmentAtPosition(t,e,i){const{config:r}=this;let{fragPrevious:s}=this,{fragments:n,endSN:a}=i;const{fragmentHint:o}=i,{maxFragLookUpTolerance:l}=r,h=i.partList,d=!!(r.lowLatencyMode&&null!=h&&h.length&&o);let c;if(d&&o&&!this.bitrateTest&&(n=n.concat(o),a=o.sn),t<e){c=Cr(s,n,t,t>e-l?0:l)}else c=n[n.length-1];if(c){const t=c.sn-i.startSN,e=this.fragmentTracker.getState(c);if((e===ns||e===ss&&c.gap)&&(s=c),s&&c.sn===s.sn&&(!d||h[0].fragment.sn>c.sn)){if(s&&c.level===s.level){const e=n[t+1];c=c.sn<a&&this.fragmentTracker.getState(e)!==ns?e:null}}}return c}synchronizeToLiveEdge(t){const{config:e,media:i}=this;if(!i)return;const r=this.hls.liveSyncPosition,s=i.currentTime,n=t.fragments[0].start,a=t.edge,o=s>=n-e.maxFragLookUpTolerance&&s<=a;if(null!==r&&i.duration>r&&(s<r||!o)){const n=void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!o&&i.readyState<4||s<a-n)&&(this.loadedmetadata||(this.nextLoadPosition=r),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${r.toFixed(3)}`),i.currentTime=r))}}alignPlaylists(t,e,i){const r=t.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;const s=t.fragments[0].start,n=!e,a=t.alignedSliding&&kt(s);if(n||!a&&!s){const{fragPrevious:s}=this;ms(s,i,t);const n=t.fragments[0].start;return this.log(`Live playlist sliding: ${n.toFixed(2)} start-sn: ${e?e.startSN:"na"}->${t.startSN} prev-sn: ${s?s.sn:"na"} fragments: ${r}`),n}return s}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,3*t.partTarget)}setStartPosition(t,e){let i=this.startPosition;if(i<e&&(i=-1),-1===i||-1===this.lastCurrentTime){const r=null!==this.startTimeOffset,s=r?this.startTimeOffset:t.startTimeOffset;null!==s&&kt(s)?(i=e+s,s<0&&(i+=t.totalduration),i=Math.min(Math.max(e,i),e+t.totalduration),this.log(`Start time offset ${s} found in ${r?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):t.live?i=this.hls.liveSyncPosition||e:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:t}=this;let e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&"initSegment"!==t.sn&&t.stats.aborted&&(this.warn(`Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} was aborted`),this.resetFragmentLoading(t))}resetFragmentLoading(t){this.fragCurrent&&(this.fragContextChanged(t)||this.state===Is)||(this.state=ks)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){const t=this.getCurrentContext(e.chunkMeta);t&&(e.frag=t.frag)}const i=e.frag;if(!i||i.type!==t||!this.levels)return;var r;if(this.fragContextChanged(i))return void this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(r=this.fragCurrent)?void 0:r.url}`);const s=e.details===Ut.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const n=e.errorAction,{action:a,retryCount:o=0,retryConfig:l}=n||{};if(n&&a===Br&&l){this.resetStartWhenNotLoaded(this.levelLastLoaded);const r=kr(l,o);this.warn(`Fragment ${i.sn} of ${t} ${i.level} errored with ${e.details}, retrying loading ${o+1}/${l.maxNumRetry} in ${r}ms`),n.resolved=!0,this.retryDate=self.performance.now()+r,this.state=Is}else if(l&&n){if(this.resetFragmentErrors(t),!(o<l.maxNumRetry))return void Bt.warn(`${e.details} reached or exceeded max retry (${o})`);s||a===Or||(n.resolved=!0)}else(null==n?void 0:n.action)===Fr?this.state=Bs:this.state=Fs;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===Us||this.state===Ps){const e=t.frag,i=t.parent,r=this.getFwdBufferInfo(this.mediaBuffer,i),s=r&&r.len>.5;s&&this.reduceMaxBufferLength(r.len,(null==e?void 0:e.duration)||10);const n=!s;return n&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),e&&(this.fragmentTracker.removeFragment(e),this.nextLoadPosition=e.start),this.resetLoadingState(),n}return!1}resetFragmentErrors(t){t===Vi&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==xs&&(this.state=ks)}afterBufferFlushed(t,e,i){if(!t)return;const r=ds.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,r,i),this.state===Ms&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=ks}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;const e=t?t.details:null;null!=e&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn(`The loading context changed while buffering fragment ${t.sn} of level ${t.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(t=0){this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,r){var s;const n=i.details;if(!n)return void this.warn("level.details undefined");if(!Object.keys(t.elementaryStreams).reduce(((e,s)=>{const a=t.elementaryStreams[s];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${t.sn} ${s} duration reliably (${o})`),e||!1;const l=r?0:_r(n,t,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(It.LEVEL_PTS_UPDATED,{details:n,level:i,drift:l,type:s,frag:t,start:a.startPTS,end:a.endPTS}),!0}return e}),!1)&&null===(null==(s=this.transmuxer)?void 0:s.error)){const e=new Error(`Found no media in fragment ${t.sn} of level ${t.level} resetting transmuxer to fallback to playlist timing`);if(0===i.fragmentError&&(i.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)),this.warn(e.message),this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_PARSING_ERROR,fatal:!1,error:e,frag:t,reason:`Found no media in msn ${t.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=Ps,this.hls.trigger(It.FRAG_PARSED,{frag:t,part:e})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){"demuxerWorker"===t.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){const e=this._state;e!==t&&(this._state=t,this.log(`${e}->${t}`))}get state(){return this._state}}class Gs{constructor(){this.chunks=[],this.dataLength=0}push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){const{chunks:t,dataLength:e}=this;let i;return t.length?(i=1===t.length?t[0]:function(t,e){const i=new Uint8Array(e);let r=0;for(let e=0;e<t.length;e++){const s=t[e];i.set(s,r),r+=s.length}return i}(t,e),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function $s(t="",e=9e4){return{type:t,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class zs{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(t,e,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){this.cachedData&&(t=ti(this.cachedData,t),this.cachedData=null);let i,r=Se(t,0),s=r?r.length:0;const n=this._audioTrack,a=this._id3Track,o=r?be(r):void 0,l=t.length;for((null===this.basePTS||0===this.frameIndex&&kt(o))&&(this.basePTS=Hs(o,e,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:tr,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(t,s)){const e=this.appendFrame(n,t,s);e?(this.frameIndex++,this.lastPTS=e.sample.pts,s+=e.length,i=s):s=l}else Ee(t,s)?(r=Se(t,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:tr,duration:Number.POSITIVE_INFINITY}),s+=r.length,i=s):s++;if(s===l&&i!==l){const e=ye(t,i);this.cachedData?this.cachedData=ti(this.cachedData,e):this.cachedData=e}}return{audioTrack:n,videoTrack:$s(),id3Track:a,textTrack:$s()}}demuxSampleAes(t,e,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(t){const e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:$s(),id3Track:this._id3Track,textTrack:$s()}}destroy(){}}const Hs=(t,e,i)=>{if(kt(t))return 90*t;return 9e4*e+(i?9e4*i.baseTime/i.timescale:0)};function Vs(t,e){return 255===t[e]&&240==(246&t[e+1])}function Ks(t,e){return 1&t[e+1]?7:9}function Ys(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function js(t,e){return e+1<t.length&&Vs(t,e)}function Ws(t,e){if(js(t,e)){const i=Ks(t,e);if(e+i>=t.length)return!1;const r=Ys(t,e);if(r<=i)return!1;const s=e+r;return s===t.length||js(t,s)}return!1}function qs(t,e,i,r,s){if(!t.samplerate){const n=function(t,e,i,r){let s,n,a,o;const l=navigator.userAgent.toLowerCase(),h=r,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&e[i+2])>>>6);const c=(60&e[i+2])>>>2;if(!(c>d.length-1))return a=(1&e[i+2])<<2,a|=(192&e[i+3])>>>6,Bt.log(`manifest codec:${r}, ADTS type:${s}, samplingIndex:${c}`),/firefox/i.test(l)?c>=6?(s=5,o=new Array(4),n=c-3):(s=2,o=new Array(2),n=c):-1!==l.indexOf("android")?(s=2,o=new Array(2),n=c):(s=5,o=new Array(4),r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&c>=6?n=c-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(c>=6&&1===a||/vivaldi/i.test(l))||!r&&1===a)&&(s=2,o=new Array(2)),n=c)),o[0]=s<<3,o[0]|=(14&c)>>1,o[1]|=(1&c)<<7,o[1]|=a<<3,5===s&&(o[1]|=(14&n)>>1,o[2]=(1&n)<<7,o[2]|=8,o[3]=0),{config:o,samplerate:d[c],channelCount:a,codec:"mp4a.40."+s,manifestCodec:h};{const e=new Error(`invalid ADTS sampling index:${c}`);t.emit(It.ERROR,It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_PARSING_ERROR,fatal:!0,error:e,reason:e.message})}}(e,i,r,s);if(!n)return;t.config=n.config,t.samplerate=n.samplerate,t.channelCount=n.channelCount,t.codec=n.codec,t.manifestCodec=n.manifestCodec,Bt.log(`parsed codec:${t.codec}, rate:${n.samplerate}, channels:${n.channelCount}`)}}function Xs(t){return 9216e4/t}function Zs(t,e,i,r,s){const n=r+s*Xs(t.samplerate),a=function(t,e){const i=Ks(t,e);if(e+i<=t.length){const r=Ys(t,e)-i;if(r>0)return{headerLength:i,frameLength:r}}}(e,i);let o;if(a){const{frameLength:r,headerLength:s}=a,l=s+r,h=Math.max(0,i+l-e.length);h?(o=new Uint8Array(l-s),o.set(e.subarray(i+s,e.length),0)):o=e.subarray(i+s,i+l);const d={unit:o,pts:n};return h||t.samples.push(d),{sample:d,length:l,missing:h}}const l=e.length-i;o=new Uint8Array(l),o.set(e.subarray(i,e.length),0);return{sample:{unit:o,pts:n},length:l,missing:-1}}let Qs=null;const Js=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],tn=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],en=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],rn=[0,1,1,4];function sn(t,e,i,r,s){if(i+24>e.length)return;const n=nn(e,i);if(n&&i+n.frameLength<=e.length){const a=r+s*(9e4*n.samplesPerFrame/n.sampleRate),o={unit:e.subarray(i,i+n.frameLength),pts:a,dts:a};return t.config=[],t.channelCount=n.channelCount,t.samplerate=n.sampleRate,t.samples.push(o),{sample:o,length:n.frameLength,missing:0}}}function nn(t,e){const i=t[e+1]>>3&3,r=t[e+1]>>1&3,s=t[e+2]>>4&15,n=t[e+2]>>2&3;if(1!==i&&0!==s&&15!==s&&3!==n){const a=t[e+2]>>1&1,o=t[e+3]>>6,l=1e3*Js[14*(3===i?3-r:3===r?3:4)+s-1],h=tn[3*(3===i?0:2===i?1:2)+n],d=3===o?1:2,c=en[i][r],u=rn[r],f=8*c*u,p=Math.floor(c*l/h+a)*u;if(null===Qs){const t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Qs=t?parseInt(t[1]):0}return!!Qs&&Qs<=87&&2===r&&l>=224e3&&0===o&&(t[e+3]=128|t[e+3]),{sampleRate:h,channelCount:d,frameLength:p,samplesPerFrame:f}}}function an(t,e){return 255===t[e]&&224==(224&t[e+1])&&0!=(6&t[e+1])}function on(t,e){return e+1<t.length&&an(t,e)}function ln(t,e){if(e+1<t.length&&an(t,e)){const i=4,r=nn(t,e);let s=i;null!=r&&r.frameLength&&(s=r.frameLength);const n=e+s;return n===t.length||on(t,n)}return!1}const hn=/\/emsg[-/]ID3/i;const dn=(t,e)=>{let i=0,r=5;e+=r;const s=new Uint32Array(1),n=new Uint32Array(1),a=new Uint8Array(1);for(;r>0;){a[0]=t[e];const o=Math.min(r,8),l=8-o;n[0]=4278190080>>>24+l<<l,s[0]=(a[0]&n[0])>>l,i=i?i<<o|s[0]:s[0],e+=1,r-=o}return i};class cn extends zs{constructor(t){super(),this.observer=void 0,this.observer=t}resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,i){const r=un(t,e,i,this.basePTS,this.frameIndex);if(-1!==r){return{sample:t.samples[t.samples.length-1],length:r,missing:0}}}static probe(t){if(!t)return!1;const e=Se(t,0);if(!e)return!1;const i=e.length;return 11===t[i]&&119===t[i+1]&&void 0!==be(e)&&dn(t,i)<16}}function un(t,e,i,r,s){if(i+8>e.length)return-1;if(11!==e[i]||119!==e[i+1])return-1;const n=e[i+4]>>6;if(n>=3)return-1;const a=[48e3,44100,32e3][n],o=63&e[i+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+n];if(i+l>e.length)return-1;const h=e[i+6]>>5;let d=0;2===h?d+=2:(1&h&&1!==h&&(d+=2),4&h&&(d+=2));const c=(e[i+6]<<8|e[i+7])>>12-d&1,u=[2,1,2,3,3,4,4,5][h]+c,f=e[i+5]>>3,p=7&e[i+5],m=new Uint8Array([n<<6|f<<1|p>>2,(3&p)<<6|h<<3|c<<2|o>>4,o<<4&224]),g=r+s*(1536/a*9e4),y=e.subarray(i,i+l);return t.config=m,t.channelCount=u,t.samplerate=a,t.samples.push({unit:y,pts:g}),l}class fn{constructor(){this.VideoSample=null}createVideoSample(t,e,i,r){return{key:t,frame:!1,pts:e,dts:i,units:[],debug:r,length:0}}getLastNalUnit(t){var e;let i,r=this.VideoSample;if(r&&0!==r.units.length||(r=t[t.length-1]),null!=(e=r)&&e.units){const t=r.units;i=t[t.length-1]}return i}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(void 0===t.pts){const i=e.samples,r=i.length;if(!r)return void e.dropped++;{const e=i[r-1];t.pts=e.pts,t.dts=e.dts}}e.samples.push(t)}t.debug.length&&Bt.log(t.pts+"/"+t.dts+":"+t.debug)}}class pn{constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const t=this.data,e=this.bytesAvailable,i=t.byteLength-e,r=new Uint8Array(4),s=Math.min(4,e);if(0===s)throw new Error("no bytes available");r.set(t.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(t){let e;t=Math.min(t,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>t?(this.word<<=t,this.bitsAvailable-=t):(e=(t-=this.bitsAvailable)>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=t,this.bitsAvailable-=t)}readBits(t){let e=Math.min(this.bitsAvailable,t);const i=this.word>>>32-e;if(t>32&&Bt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return e=t-e,e>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if(0!=(this.word&2147483648>>>t))return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e,i=8,r=8;for(let s=0;s<t;s++)0!==r&&(e=this.readEG(),r=(i+e+256)%256),i=0===r?i:r}readSPS(){let t,e,i,r=0,s=0,n=0,a=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),h=this.readUEG.bind(this),d=this.readBoolean.bind(this),c=this.skipBits.bind(this),u=this.skipEG.bind(this),f=this.skipUEG.bind(this),p=this.skipScalingList.bind(this);o();const m=o();if(l(5),c(3),o(),f(),100===m||110===m||122===m||244===m||44===m||83===m||86===m||118===m||128===m){const t=h();if(3===t&&c(1),f(),f(),c(1),d())for(e=3!==t?8:12,i=0;i<e;i++)d()&&p(i<6?16:64)}f();const g=h();if(0===g)h();else if(1===g)for(c(1),u(),u(),t=h(),i=0;i<t;i++)u();f(),c(1);const y=h(),v=h(),_=l(1);0===_&&c(1),c(1),d()&&(r=h(),s=h(),n=h(),a=h());let S=[1,1];if(d()&&d()){switch(o()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[o()<<8|o(),o()<<8|o()]}}return{width:Math.ceil(16*(y+1)-2*r-2*s),height:(2-_)*(v+1)*16-(_?2:4)*(n+a),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class mn extends fn{parseAVCPES(t,e,i,r,s){const n=this.parseAVCNALu(t,i.data);let a,o=this.VideoSample,l=!1;i.data=null,o&&n.length&&!t.audFound&&(this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),n.forEach((r=>{var n;switch(r.type){case 1:{let e=!1;a=!0;const s=r.data;if(l&&s.length>4){const t=new pn(s).readSliceType();2!==t&&4!==t&&7!==t&&9!==t||(e=!0)}var h;if(e)null!=(h=o)&&h.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null);o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.frame=!0,o.key=e;break}case 5:a=!0,null!=(n=o)&&n.frame&&!o.key&&(this.pushAccessUnit(o,t),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),o.key=!0,o.frame=!0;break;case 6:a=!0,ri(r.data,1,i.pts,e.samples);break;case 7:{var d,c;a=!0,l=!0;const e=r.data,i=new pn(e).readSPS();if(!t.sps||t.width!==i.width||t.height!==i.height||(null==(d=t.pixelRatio)?void 0:d[0])!==i.pixelRatio[0]||(null==(c=t.pixelRatio)?void 0:c[1])!==i.pixelRatio[1]){t.width=i.width,t.height=i.height,t.pixelRatio=i.pixelRatio,t.sps=[e],t.duration=s;const r=e.subarray(1,4);let n="avc1.";for(let t=0;t<3;t++){let e=r[t].toString(16);e.length<2&&(e="0"+e),n+=e}t.codec=n}break}case 8:a=!0,t.pps=[r.data];break;case 9:a=!0,t.audFound=!0,o&&this.pushAccessUnit(o,t),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:a=!0;break;default:a=!1,o&&(o.debug+="unknown NAL "+r.type+" ")}if(o&&a){o.units.push(r)}})),r&&o&&(this.pushAccessUnit(o,t),this.VideoSample=null)}parseAVCNALu(t,e){const i=e.byteLength;let r=t.naluState||0;const s=r,n=[];let a,o,l,h=0,d=-1,c=0;for(-1===r&&(d=0,c=31&e[0],r=0,h=1);h<i;)if(a=e[h++],r)if(1!==r)if(a)if(1===a){if(o=h-r-1,d>=0){const t={data:e.subarray(d,o),type:c};n.push(t)}else{const i=this.getLastNalUnit(t.samples);i&&(s&&h<=4-s&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-s)),o>0&&(i.data=ti(i.data,e.subarray(0,o)),i.state=0))}h<i?(l=31&e[h],d=h,c=l,r=0):r=-1}else r=0;else r=3;else r=a?0:2;else r=a?0:1;if(d>=0&&r>=0){const t={data:e.subarray(d,i),type:c,state:r};n.push(t)}if(0===n.length){const i=this.getLastNalUnit(t.samples);i&&(i.data=ti(i.data,e))}return t.naluState=r,n}}class gn{constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new Ls(e,{removePKCS7Padding:!1})}decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,i){const r=t[e].unit;if(r.length<=16)return;const s=r.subarray(16,r.length-r.length%16),n=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(n).then((s=>{const n=new Uint8Array(s);r.set(n,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)}))}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length)return void i();if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){const e=16*Math.floor((t.length-48)/160)+16,i=new Int8Array(e);let r=0;for(let e=32;e<t.length-16;e+=160,r+=16)i.set(t.subarray(e,e+16),r);return i}getAvcDecryptedUnit(t,e){const i=new Uint8Array(e);let r=0;for(let e=32;e<t.length-16;e+=160,r+=16)t.set(i.subarray(r,r+16),e);return t}decryptAvcSample(t,e,i,r,s){const n=si(s.data),a=this.getAvcEncryptedData(n);this.decryptBuffer(a.buffer).then((a=>{s.data=this.getAvcDecryptedUnit(n,a),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,r)}))}decryptAvcSamples(t,e,i,r){if(t instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length)return void r();const s=t[e].units;for(;!(i>=s.length);i++){const n=s[i];if(!(n.data.length<=48||1!==n.type&&5!==n.type||(this.decryptAvcSample(t,e,i,r,n),this.decrypter.isSync())))return}}}}const yn=188;class vn{constructor(t,e,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.videoParser=new mn}static probe(t){const e=vn.syncOffset(t);return e>0&&Bt.warn(`MPEG2-TS detected but first sync word found @ offset ${e}`),-1!==e}static syncOffset(t){const e=t.length;let i=Math.min(940,e-yn)+1,r=0;for(;r<i;){let s=!1,n=-1,a=0;for(let o=r;o<e;o+=yn){if(71!==t[o]||e-o!==yn&&71!==t[o+yn]){if(a)return-1;break}if(a++,-1===n&&(n=o,0!==n&&(i=Math.min(n+18612,t.length-yn)+1)),s||(s=0===_n(t,o)),s&&a>1&&(0===n&&a>2||o+yn>i))return n}r++}return-1}static createTrack(t,e){return{container:"video"===t||"audio"===t?"video/mp2t":void 0,type:t,id:Be[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===t?e:void 0}}resetInitSegment(t,e,i,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=vn.createTrack("video"),this._audioTrack=vn.createTrack("audio",r),this._id3Track=vn.createTrack("id3"),this._txtTrack=vn.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i,this._duration=r}resetTimeStamp(){}resetContiguity(){const{_audioTrack:t,_videoTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e,i=!1,r=!1){let s;i||(this.sampleAes=null);const n=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let h=n.pid,d=n.pesData,c=a.pid,u=o.pid,f=a.pesData,p=o.pesData,m=null,g=this.pmtParsed,y=this._pmtId,v=t.length;if(this.remainderData&&(v=(t=ti(this.remainderData,t)).length,this.remainderData=null),v<yn&&!r)return this.remainderData=t,{audioTrack:a,videoTrack:n,id3Track:o,textTrack:l};const _=Math.max(0,vn.syncOffset(t));v-=(v-_)%yn,v<t.byteLength&&!r&&(this.remainderData=new Uint8Array(t.buffer,v,t.buffer.byteLength-v));let S=0;for(let e=_;e<v;e+=yn)if(71===t[e]){const r=!!(64&t[e+1]),v=_n(t,e);let S;if((48&t[e+3])>>4>1){if(S=e+5+t[e+4],S===e+yn)continue}else S=e+4;switch(v){case h:r&&(d&&(s=wn(d))&&this.videoParser.parseAVCPES(n,l,s,!1,this._duration),d={data:[],size:0}),d&&(d.data.push(t.subarray(S,e+yn)),d.size+=e+yn-S);break;case c:if(r){if(f&&(s=wn(f)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s);break;case"ac3":this.parseAC3PES(a,s)}f={data:[],size:0}}f&&(f.data.push(t.subarray(S,e+yn)),f.size+=e+yn-S);break;case u:r&&(p&&(s=wn(p))&&this.parseID3PES(o,s),p={data:[],size:0}),p&&(p.data.push(t.subarray(S,e+yn)),p.size+=e+yn-S);break;case 0:r&&(S+=t[S]+1),y=this._pmtId=Sn(t,S);break;case y:{r&&(S+=t[S]+1);const s=Tn(t,S,this.typeSupported,i,this.observer);h=s.videoPid,h>0&&(n.pid=h,n.segmentCodec=s.segmentVideoCodec),c=s.audioPid,c>0&&(a.pid=c,a.segmentCodec=s.segmentAudioCodec),u=s.id3Pid,u>0&&(o.pid=u),null===m||g||(Bt.warn(`MPEG-TS PMT found at ${e} after unknown PID '${m}'. Backtracking to sync byte @${_} to parse all TS packets.`),m=null,e=_-188),g=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=v}}else S++;S>0&&En(this.observer,new Error(`Found ${S} TS packet/s that do not start with 0x47`)),n.pesData=d,a.pesData=f,o.pesData=p;const T={audioTrack:a,videoTrack:n,id3Track:o,textTrack:l};return r&&this.extractRemainingSamples(T),T}flush(){const{remainderData:t}=this;let e;return this.remainderData=null,e=t?this.demux(t,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e}extractRemainingSamples(t){const{audioTrack:e,videoTrack:i,id3Track:r,textTrack:s}=t,n=i.pesData,a=e.pesData,o=r.pesData;let l;if(n&&(l=wn(n))?(this.videoParser.parseAVCPES(i,s,l,!0,this._duration),i.pesData=null):i.pesData=n,a&&(l=wn(a))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,l);break;case"mp3":this.parseMPEGPES(e,l);break;case"ac3":this.parseAC3PES(e,l)}e.pesData=null}else null!=a&&a.size&&Bt.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=a;o&&(l=wn(o))?(this.parseID3PES(r,l),r.pesData=null):r.pesData=o}demuxSampleAes(t,e,i){const r=this.demux(t,i,!0,!this.config.progressive),s=this.sampleAes=new gn(this.observer,this.config,e);return this.decrypt(r,s)}decrypt(t,e){return new Promise((i=>{const{audioTrack:r,videoTrack:s}=t;r.samples&&"aac"===r.segmentCodec?e.decryptAacSamples(r.samples,0,(()=>{s.samples?e.decryptAvcSamples(s.samples,0,0,(()=>{i(t)})):i(t)})):s.samples&&e.decryptAvcSamples(s.samples,0,0,(()=>{i(t)}))}))}destroy(){this._duration=0}parseAACPES(t,e){let i=0;const r=this.aacOverFlow;let s,n,a,o=e.data;if(r){this.aacOverFlow=null;const e=r.missing,s=r.sample.unit.byteLength;if(-1===e)o=ti(r.sample.unit,o);else{const n=s-e;r.sample.unit.set(o.subarray(0,e),n),t.samples.push(r.sample),i=r.missing}}for(s=i,n=o.length;s<n-1&&!js(o,s);s++);if(s!==i){let t;const e=s<n-1;if(t=e?`AAC PES did not start with ADTS header,offset:${s}`:"No ADTS header found in AAC PES",En(this.observer,new Error(t),e),!e)return}if(qs(t,this.observer,o,s,this.audioCodec),void 0!==e.pts)a=e.pts;else{if(!r)return void Bt.warn("[tsdemuxer]: AAC PES unknown PTS");{const e=Xs(t.samplerate);a=r.sample.pts+e}}let l,h=0;for(;s<n;){if(l=Zs(t,o,s,a,h),s+=l.length,l.missing){this.aacOverFlow=l;break}for(h++;s<n-1&&!js(o,s);s++);}}parseMPEGPES(t,e){const i=e.data,r=i.length;let s=0,n=0;const a=e.pts;if(void 0!==a)for(;n<r;)if(on(i,n)){const e=sn(t,i,n,a,s);if(!e)break;n+=e.length,s++}else n++;else Bt.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(t,e){{const i=e.data,r=e.pts;if(void 0===r)return void Bt.warn("[tsdemuxer]: AC3 PES unknown PTS");const s=i.length;let n,a=0,o=0;for(;o<s&&(n=un(t,i,o,r,a++))>0;)o+=n}}parseID3PES(t,e){if(void 0===e.pts)return void Bt.warn("[tsdemuxer]: ID3 PES unknown PTS");const i=xt({},e,{type:this._videoTrack?ir:tr,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}}function _n(t,e){return((31&t[e+1])<<8)+t[e+2]}function Sn(t,e){return(31&t[e+10])<<8|t[e+11]}function Tn(t,e,i,r,s){const n={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=e+3+((15&t[e+1])<<8|t[e+2])-4;for(e+=12+((15&t[e+10])<<8|t[e+11]);e<a;){const a=_n(t,e),o=(15&t[e+3])<<8|t[e+4];switch(t[e]){case 207:if(!r){bn("ADTS AAC");break}case 15:-1===n.audioPid&&(n.audioPid=a);break;case 21:-1===n.id3Pid&&(n.id3Pid=a);break;case 219:if(!r){bn("H.264");break}case 27:-1===n.videoPid&&(n.videoPid=a,n.segmentVideoCodec="avc");break;case 3:case 4:i.mpeg||i.mp3?-1===n.audioPid&&(n.audioPid=a,n.segmentAudioCodec="mp3"):Bt.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){bn("AC-3");break}case 129:i.ac3?-1===n.audioPid&&(n.audioPid=a,n.segmentAudioCodec="ac3"):Bt.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===n.audioPid&&o>0){let r=e+5,s=o;for(;s>2;){if(106===t[r])!0!==i.ac3?Bt.log("AC-3 audio found, not supported in this browser for now"):(n.audioPid=a,n.segmentAudioCodec="ac3");const e=t[r+1]+2;r+=e,s-=e}}break;case 194:case 135:return En(s,new Error("Unsupported EC-3 in M2TS found")),n;case 36:return En(s,new Error("Unsupported HEVC in M2TS found")),n}e+=o+5}return n}function En(t,e,i){Bt.warn(`parsing error: ${e.message}`),t.emit(It.ERROR,It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_PARSING_ERROR,fatal:!1,levelRetry:i,error:e,reason:e.message})}function bn(t){Bt.log(`${t} with AES-128-CBC encryption found in unencrypted stream`)}function wn(t){let e,i,r,s,n,a=0;const o=t.data;if(!t||0===t.size)return null;for(;o[0].length<19&&o.length>1;)o[0]=ti(o[0],o[1]),o.splice(1,1);e=o[0];if(1===(e[0]<<16)+(e[1]<<8)+e[2]){if(i=(e[4]<<8)+e[5],i&&i>t.size-6)return null;const l=e[7];192&l&&(s=536870912*(14&e[9])+4194304*(255&e[10])+16384*(254&e[11])+128*(255&e[12])+(254&e[13])/2,64&l?(n=536870912*(14&e[14])+4194304*(255&e[15])+16384*(254&e[16])+128*(255&e[17])+(254&e[18])/2,s-n>54e5&&(Bt.warn(`${Math.round((s-n)/9e4)}s delta between PTS and DTS, align them`),s=n)):n=s),r=e[8];let h=r+9;if(t.size<=h)return null;t.size-=h;const d=new Uint8Array(t.size);for(let t=0,i=o.length;t<i;t++){e=o[t];let i=e.byteLength;if(h){if(h>i){h-=i;continue}e=e.subarray(h),i-=h,h=0}d.set(e,a),a+=i}return i&&(i-=r+3),{data:d,pts:s,dts:n,len:i}}return null}class Ln{static getSilentFrame(t,e){if("mp4a.40.2"===t){if(1===e)return new Uint8Array([0,200,0,128,35,128]);if(2===e)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===e)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const An=Math.pow(2,32)-1;class xn{static init(){let t;for(t in xn.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},xn.types)xn.types.hasOwnProperty(t)&&(xn.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);const e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);xn.HDLR_TYPES={video:e,audio:i};const r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);xn.STTS=xn.STSC=xn.STCO=s,xn.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),xn.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),xn.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),xn.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const n=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);xn.FTYP=xn.box(xn.types.ftyp,n,o,n,a),xn.DINF=xn.box(xn.types.dinf,xn.box(xn.types.dref,r))}static box(t,...e){let i=8,r=e.length;const s=r;for(;r--;)i+=e[r].byteLength;const n=new Uint8Array(i);for(n[0]=i>>24&255,n[1]=i>>16&255,n[2]=i>>8&255,n[3]=255&i,n.set(t,4),r=0,i=8;r<s;r++)n.set(e[r],i),i+=e[r].byteLength;return n}static hdlr(t){return xn.box(xn.types.hdlr,xn.HDLR_TYPES[t])}static mdat(t){return xn.box(xn.types.mdat,t)}static mdhd(t,e){e*=t;const i=Math.floor(e/(An+1)),r=Math.floor(e%(An+1));return xn.box(xn.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(t){return xn.box(xn.types.mdia,xn.mdhd(t.timescale,t.duration),xn.hdlr(t.type),xn.minf(t))}static mfhd(t){return xn.box(xn.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?xn.box(xn.types.minf,xn.box(xn.types.smhd,xn.SMHD),xn.DINF,xn.stbl(t)):xn.box(xn.types.minf,xn.box(xn.types.vmhd,xn.VMHD),xn.DINF,xn.stbl(t))}static moof(t,e,i){return xn.box(xn.types.moof,xn.mfhd(t),xn.traf(i,e))}static moov(t){let e=t.length;const i=[];for(;e--;)i[e]=xn.trak(t[e]);return xn.box.apply(null,[xn.types.moov,xn.mvhd(t[0].timescale,t[0].duration)].concat(i).concat(xn.mvex(t)))}static mvex(t){let e=t.length;const i=[];for(;e--;)i[e]=xn.trex(t[e]);return xn.box.apply(null,[xn.types.mvex,...i])}static mvhd(t,e){e*=t;const i=Math.floor(e/(An+1)),r=Math.floor(e%(An+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return xn.box(xn.types.mvhd,s)}static sdtp(t){const e=t.samples||[],i=new Uint8Array(4+e.length);let r,s;for(r=0;r<e.length;r++)s=e[r].flags,i[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return xn.box(xn.types.sdtp,i)}static stbl(t){return xn.box(xn.types.stbl,xn.stsd(t),xn.box(xn.types.stts,xn.STTS),xn.box(xn.types.stsc,xn.STSC),xn.box(xn.types.stsz,xn.STSZ),xn.box(xn.types.stco,xn.STCO))}static avc1(t){let e,i,r,s=[],n=[];for(e=0;e<t.sps.length;e++)i=t.sps[e],r=i.byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));for(e=0;e<t.pps.length;e++)i=t.pps[e],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));const a=xn.box(xn.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|t.sps.length].concat(s).concat([t.pps.length]).concat(n))),o=t.width,l=t.height,h=t.pixelRatio[0],d=t.pixelRatio[1];return xn.box(xn.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,xn.box(xn.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),xn.box(xn.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(t){const e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static audioStsd(t){const e=t.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0])}static mp4a(t){return xn.box(xn.types.mp4a,xn.audioStsd(t),xn.box(xn.types.esds,xn.esds(t)))}static mp3(t){return xn.box(xn.types[".mp3"],xn.audioStsd(t))}static ac3(t){return xn.box(xn.types["ac-3"],xn.audioStsd(t),xn.box(xn.types.dac3,t.config))}static stsd(t){return"audio"===t.type?"mp3"===t.segmentCodec&&"mp3"===t.codec?xn.box(xn.types.stsd,xn.STSD,xn.mp3(t)):"ac3"===t.segmentCodec?xn.box(xn.types.stsd,xn.STSD,xn.ac3(t)):xn.box(xn.types.stsd,xn.STSD,xn.mp4a(t)):xn.box(xn.types.stsd,xn.STSD,xn.avc1(t))}static tkhd(t){const e=t.id,i=t.duration*t.timescale,r=t.width,s=t.height,n=Math.floor(i/(An+1)),a=Math.floor(i%(An+1));return xn.box(xn.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}static traf(t,e){const i=xn.sdtp(t),r=t.id,s=Math.floor(e/(An+1)),n=Math.floor(e%(An+1));return xn.box(xn.types.traf,xn.box(xn.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),xn.box(xn.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,n>>24,n>>16&255,n>>8&255,255&n])),xn.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||4294967295,xn.box(xn.types.trak,xn.tkhd(t),xn.mdia(t))}static trex(t){const e=t.id;return xn.box(xn.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){const i=t.samples||[],r=i.length,s=12+16*r,n=new Uint8Array(s);let a,o,l,h,d,c;for(e+=8+s,n.set(["video"===t.type?1:0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),a=0;a<r;a++)o=i[a],l=o.duration,h=o.size,d=o.flags,c=o.cts,n.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,h>>>24&255,h>>>16&255,h>>>8&255,255&h,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.paddingValue<<1|d.isNonSync,61440&d.degradPrio,15&d.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*a);return xn.box(xn.types.trun,n)}static initSegment(t){xn.types||xn.init();const e=xn.moov(t);return ti(xn.FTYP,e)}}xn.types=void 0,xn.HDLR_TYPES=void 0,xn.STTS=void 0,xn.STSC=void 0,xn.STCO=void 0,xn.STSZ=void 0,xn.VMHD=void 0,xn.SMHD=void 0,xn.STSD=void 0,xn.FTYP=void 0,xn.DINF=void 0;const kn=9e4;function Rn(t,e,i=1,r=!1){const s=t*e*i;return r?Math.round(s):s}function Dn(t,e=!1){return Rn(t,1e3,1/kn,e)}let In,Cn=null,Un=null;class Pn{constructor(t,e,i,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.ISGenerated=!1,null===Cn){const t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Cn=t?parseInt(t[1]):0}if(null===Un){const t=navigator.userAgent.match(/Safari\/(\d+)/i);Un=t?parseInt(t[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){Bt.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){Bt.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){Bt.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1;const i=t.reduce(((t,i)=>{const r=i.pts-t;return r<-4294967296?(e=!0,Mn(t,i.pts)):r>0?t:i.pts}),t[0].pts);return e&&Bt.debug("PTS rollover detected"),i}remux(t,e,i,r,s,n,a,o){let l,h,d,c,u,f,p=s,m=s;const g=t.pid>-1,y=e.pid>-1,v=e.samples.length,_=t.samples.length>0,S=a&&v>0||v>1;if((!g||_)&&(!y||S)||this.ISGenerated||a){if(this.ISGenerated){var T,E,b,w;const t=this.videoTrackConfig;!t||e.width===t.width&&e.height===t.height&&(null==(T=e.pixelRatio)?void 0:T[0])===(null==(E=t.pixelRatio)?void 0:E[0])&&(null==(b=e.pixelRatio)?void 0:b[1])===(null==(w=t.pixelRatio)?void 0:w[1])||this.resetInitSegment()}else d=this.generateIS(t,e,s,n);const i=this.isVideoContiguous;let r,a=-1;if(S&&(a=function(t){for(let e=0;e<t.length;e++)if(t[e].key)return e;return-1}(e.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(f=!0,a>0){Bt.warn(`[mp4-remuxer]: Dropped ${a} out of ${v} video samples due to a missing keyframe`);const t=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(a),e.dropped+=a,m+=(e.samples[0].pts-t)/e.inputTimeScale,r=m}else-1===a&&(Bt.warn(`[mp4-remuxer]: No keyframe found out of ${v} video samples`),f=!1);if(this.ISGenerated){if(_&&S){const i=this.getVideoStartPts(e.samples),r=(Mn(t.samples[0].pts,i)-i)/e.inputTimeScale;p+=Math.max(0,r),m+=Math.max(0,-r)}if(_){if(t.samplerate||(Bt.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(t,e,s,n)),h=this.remuxAudio(t,p,this.isAudioContiguous,n,y||S||o===Vi?m:void 0),S){const r=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(Bt.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(t,e,s,n)),l=this.remuxVideo(e,m,i,r)}}else S&&(l=this.remuxVideo(e,m,i,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=r)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(u=Fn(i,s,this._initPTS,this._initDTS)),r.samples.length&&(c=On(r,s,this._initPTS))),{audio:h,video:l,initSegment:d,independent:f,text:c,id3:u}}generateIS(t,e,i,r){const s=t.samples,n=e.samples,a=this.typeSupported,o={},l=this._initPTS;let h,d,c,u=!l||r,f="audio/mp4";if(u&&(h=d=1/0),t.config&&s.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":a.mpeg?(f="audio/mpeg",t.codec=""):a.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3"}o.audio={id:"audio",container:f,codec:t.codec,initSegment:"mp3"===t.segmentCodec&&a.mpeg?new Uint8Array(0):xn.initSegment([t]),metadata:{channelCount:t.channelCount}},u&&(c=t.inputTimeScale,l&&c===l.timescale?u=!1:h=d=s[0].pts-Math.round(c*i))}if(e.sps&&e.pps&&n.length){if(e.timescale=e.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:xn.initSegment([e]),metadata:{width:e.width,height:e.height}},u)if(c=e.inputTimeScale,l&&c===l.timescale)u=!1;else{const t=this.getVideoStartPts(n),e=Math.round(c*i);d=Math.min(d,Mn(n[0].dts,t)-e),h=Math.min(h,t-e)}this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:h,timescale:c},this._initDTS={baseTime:d,timescale:c}):h=c=void 0,{tracks:o,initPTS:h,timescale:c}}remuxVideo(t,e,i,r){const s=t.inputTimeScale,n=t.samples,a=[],o=n.length,l=this._initPTS;let h,d,c=this.nextAvcDts,u=8,f=this.videoSampleDuration,p=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,g=!1;if(!i||null===c){const t=e*s,r=n[0].pts-Mn(n[0].dts,n[0].pts);Cn&&null!==c&&Math.abs(t-r-c)<15e3?i=!0:c=t-r}const y=l.baseTime*s/l.timescale;for(let t=0;t<o;t++){const e=n[t];e.pts=Mn(e.pts-y,c),e.dts=Mn(e.dts-y,c),e.dts<n[t>0?t-1:t].dts&&(g=!0)}g&&n.sort((function(t,e){const i=t.dts-e.dts,r=t.pts-e.pts;return i||r})),h=n[0].dts,d=n[n.length-1].dts;const v=d-h,_=v?Math.round(v/(o-1)):f||t.inputTimeScale/30;if(i){const t=h-c,i=t>_,r=t<-1;if((i||r)&&(i?Bt.warn(`AVC: ${Dn(t,!0)} ms (${t}dts) hole between fragments detected at ${e.toFixed(3)}`):Bt.warn(`AVC: ${Dn(-t,!0)} ms (${t}dts) overlapping between fragments detected at ${e.toFixed(3)}`),!r||c>=n[0].pts||Cn)){h=c;const e=n[0].pts-t;if(i)n[0].dts=h,n[0].pts=e;else for(let i=0;i<n.length&&!(n[i].dts>e);i++)n[i].dts-=t,n[i].pts-=t;Bt.log(`Video: Initial PTS/DTS adjusted: ${Dn(e,!0)}/${Dn(h,!0)}, delta: ${Dn(t,!0)} ms`)}}h=Math.max(0,h);let S=0,T=0,E=h;for(let t=0;t<o;t++){const e=n[t],i=e.units,r=i.length;let s=0;for(let t=0;t<r;t++)s+=i[t].data.length;T+=s,S+=r,e.length=s,e.dts<E?(e.dts=E,E+=_/4|0||1):E=e.dts,p=Math.min(e.pts,p),m=Math.max(e.pts,m)}d=n[o-1].dts;const b=T+4*S+8;let w;try{w=new Uint8Array(b)}catch(t){return void this.observer.emit(It.ERROR,It.ERROR,{type:Ct.MUX_ERROR,details:Ut.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:b,reason:`fail allocating video mdat ${b}`})}const L=new DataView(w.buffer);L.setUint32(0,b),w.set(xn.types.mdat,4);let A=!1,x=Number.POSITIVE_INFINITY,k=Number.POSITIVE_INFINITY,R=Number.NEGATIVE_INFINITY,D=Number.NEGATIVE_INFINITY;for(let t=0;t<o;t++){const e=n[t],i=e.units;let l,h=0;for(let t=0,e=i.length;t<e;t++){const e=i[t],r=e.data,s=e.data.byteLength;L.setUint32(u,s),u+=4,w.set(r,u),u+=s,h+=4+s}if(t<o-1)f=n[t+1].dts-e.dts,l=n[t+1].pts-e.pts;else{const i=this.config,a=t>0?e.dts-n[t-1].dts:_;if(l=t>0?e.pts-n[t-1].pts:_,i.stretchShortVideoTrack&&null!==this.nextAudioPts){const t=Math.floor(i.maxBufferHole*s),n=(r?p+r*s:this.nextAudioPts)-e.pts;n>t?(f=n-a,f<0?f=a:A=!0,Bt.log(`[mp4-remuxer]: It is approximately ${n/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=a}else f=a}const d=Math.round(e.pts-e.dts);x=Math.min(x,f),R=Math.max(R,f),k=Math.min(k,l),D=Math.max(D,l),a.push(new Bn(e.key,f,h,d))}if(a.length)if(Cn){if(Cn<70){const t=a[0].flags;t.dependsOn=2,t.isNonSync=0}}else if(Un&&D-k<R-x&&_/R<.025&&0===a[0].cts){Bt.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let t=h;for(let e=0,i=a.length;e<i;e++){const r=t+a[e].duration,s=t+a[e].cts;if(e<i-1){const t=r+a[e+1].cts;a[e].duration=t-s}else a[e].duration=e?a[e-1].duration:_;a[e].cts=0,t=r}}f=A||!f?_:f,this.nextAvcDts=c=d+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const I={data1:xn.moof(t.sequenceNumber++,h,xt({},t,{samples:a})),data2:w,startPTS:p/s,endPTS:(m+f)/s,startDTS:h/s,endDTS:c/s,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:t.dropped};return t.samples=[],t.dropped=0,I}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(t,e,i,r,s){const n=t.inputTimeScale,a=n/(t.samplerate?t.samplerate:n),o=this.getSamplesPerFrame(t),l=o*a,h=this._initPTS,d="mp3"===t.segmentCodec&&this.typeSupported.mpeg,c=[],u=void 0!==s;let f=t.samples,p=d?0:8,m=this.nextAudioPts||-1;const g=e*n,y=h.baseTime*n/h.timescale;if(this.isAudioContiguous=i=i||f.length&&m>0&&(r&&Math.abs(g-m)<9e3||Math.abs(Mn(f[0].pts-y,g)-m)<20*l),f.forEach((function(t){t.pts=Mn(t.pts-y,g)})),!i||m<0){if(f=f.filter((t=>t.pts>=0)),!f.length)return;m=0===s?0:r&&!u?Math.max(0,g):f[0].pts}if("aac"===t.segmentCodec){const e=this.config.maxAudioFramesDrift;for(let i=0,r=m;i<f.length;i++){const s=f[i],a=s.pts,o=a-r,h=Math.abs(1e3*o/n);if(o<=-e*l&&u)0===i&&(Bt.warn(`Audio frame @ ${(a/n).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*o/n)} ms.`),this.nextAudioPts=m=r=a);else if(o>=e*l&&h<1e4&&u){let e=Math.round(o/l);r=a-e*l,r<0&&(e--,r+=l),0===i&&(this.nextAudioPts=m=r),Bt.warn(`[mp4-remuxer]: Injecting ${e} audio frame @ ${(r/n).toFixed(3)}s due to ${Math.round(1e3*o/n)} ms gap.`);for(let n=0;n<e;n++){const e=Math.max(r,0);let n=Ln.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);n||(Bt.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),n=s.unit.subarray()),f.splice(i,0,{unit:n,pts:e}),r+=l,i++}}s.pts=r,r+=l}}let v,_=null,S=null,T=0,E=f.length;for(;E--;)T+=f[E].unit.byteLength;for(let e=0,r=f.length;e<r;e++){const r=f[e],s=r.unit;let n=r.pts;if(null!==S){c[e-1].duration=Math.round((n-S)/a)}else{if(i&&"aac"===t.segmentCodec&&(n=m),_=n,!(T>0))return;T+=p;try{v=new Uint8Array(T)}catch(t){return void this.observer.emit(It.ERROR,It.ERROR,{type:Ct.MUX_ERROR,details:Ut.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:T,reason:`fail allocating audio mdat ${T}`})}if(!d){new DataView(v.buffer).setUint32(0,T),v.set(xn.types.mdat,4)}}v.set(s,p);const l=s.byteLength;p+=l,c.push(new Bn(!0,o,l,0)),S=n}const b=c.length;if(!b)return;const w=c[c.length-1];this.nextAudioPts=m=S+a*w.duration;const L=d?new Uint8Array(0):xn.moof(t.sequenceNumber++,_/a,xt({},t,{samples:c}));t.samples=[];const A=_/n,x=m/n,k={data1:L,data2:v,startPTS:A,endPTS:x,startDTS:A,endDTS:x,type:"audio",hasAudio:!0,hasVideo:!1,nb:b};return this.isAudioContiguous=!0,k}remuxEmptyAudio(t,e,i,r){const s=t.inputTimeScale,n=s/(t.samplerate?t.samplerate:s),a=this.nextAudioPts,o=this._initDTS,l=9e4*o.baseTime/o.timescale,h=(null!==a?a:r.startDTS*s)+l,d=r.endDTS*s+l,c=1024*n,u=Math.ceil((d-h)/c),f=Ln.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(Bt.warn("[mp4-remuxer]: remux empty Audio"),!f)return void Bt.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const p=[];for(let t=0;t<u;t++){const e=h+t*c;p.push({unit:f,pts:e,dts:e})}return t.samples=p,this.remuxAudio(t,e,i,!1)}}function Mn(t,e){let i;if(null===e)return t;for(i=e<t?-8589934592:8589934592;Math.abs(t-e)>4294967296;)t+=i;return t}function Fn(t,e,i,r){const s=t.samples.length;if(!s)return;const n=t.inputTimeScale;for(let a=0;a<s;a++){const s=t.samples[a];s.pts=Mn(s.pts-i.baseTime*n/i.timescale,e*n)/n,s.dts=Mn(s.dts-r.baseTime*n/r.timescale,e*n)/n}const a=t.samples;return t.samples=[],{samples:a}}function On(t,e,i){const r=t.samples.length;if(!r)return;const s=t.inputTimeScale;for(let n=0;n<r;n++){const r=t.samples[n];r.pts=Mn(r.pts-i.baseTime*s/i.timescale,e*s)/s}t.samples.sort(((t,e)=>t.pts-e.pts));const n=t.samples;return t.samples=[],{samples:n}}class Bn{constructor(t,e,i,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=i,this.cts=r,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}}}function Nn(t,e){const i=null==t?void 0:t.codec;if(i&&i.length>4)return i;if(e===Kt){if("ec-3"===i||"ac-3"===i||"alac"===i)return i;if("fLaC"===i||"Opus"===i){return wi(i,!1)}const t="mp4a.40.5";return Bt.info(`Parsed audio codec "${i}" or audio object type not handled. Using "${t}"`),t}return Bt.warn(`Unhandled video codec "${i}"`),"hvc1"===i||"hev1"===i?"hvc1.1.6.L120.90":"av01"===i?"av01.0.04M.08":"avc1.42e01e"}try{In=self.performance.now.bind(self.performance)}catch(t){Bt.debug("Unable to use Performance API on this environment"),In=null==ee?void 0:ee.Date.now}const Gn=[{demux:class{constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}resetTimeStamp(){}resetInitSegment(t,e,i,r){const s=this.videoTrack=$s("video",1),n=this.audioTrack=$s("audio",1),a=this.txtTrack=$s("text",1);if(this.id3Track=$s("id3",1),this.timeOffset=0,null==t||!t.byteLength)return;const o=je(t);if(o.video){const{id:t,timescale:e,codec:i}=o.video;s.id=t,s.timescale=a.timescale=e,s.codec=i}if(o.audio){const{id:t,timescale:e,codec:i}=o.audio;n.id=t,n.timescale=e,n.codec=i}a.id=Be.text,s.sampleDuration=0,s.duration=n.duration=r}resetContiguity(){this.remainderData=null}static probe(t){return function(t){const e=t.byteLength;for(let i=0;i<e;){const r=$e(t,i);if(r>8&&109===t[i+4]&&111===t[i+5]&&111===t[i+6]&&102===t[i+7])return!0;i=r>1?i+r:e}return!1}(t)}demux(t,e){this.timeOffset=e;let i=t;const r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=ti(this.remainderData,t));const e=function(t){const e={valid:null,remainder:null},i=Ke(t,["moof"]);if(i.length<2)return e.remainder=t,e;const r=i[i.length-1];return e.valid=ye(t,0,r.byteOffset-8),e.remainder=ye(t,r.byteOffset-8),e}(i);this.remainderData=e.remainder,r.samples=e.valid||new Uint8Array}else r.samples=i;const n=this.extractID3Track(r,e);return s.samples=ei(e,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:n,textTrack:this.txtTrack}}flush(){const t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;const r=this.extractID3Track(e,this.timeOffset);return i.samples=ei(t,e),{videoTrack:e,audioTrack:$s(),id3Track:r,textTrack:$s()}}extractID3Track(t,e){const i=this.id3Track;if(t.samples.length){const r=Ke(t.samples,["emsg"]);r&&r.forEach((t=>{const r=function(t){const e=t[0];let i="",r="",s=0,n=0,a=0,o=0,l=0,h=0;if(0===e){for(;"\0"!==Ne(t.subarray(h,h+1));)i+=Ne(t.subarray(h,h+1)),h+=1;for(i+=Ne(t.subarray(h,h+1)),h+=1;"\0"!==Ne(t.subarray(h,h+1));)r+=Ne(t.subarray(h,h+1)),h+=1;r+=Ne(t.subarray(h,h+1)),h+=1,s=$e(t,12),n=$e(t,16),o=$e(t,20),l=$e(t,24),h=28}else if(1===e){h+=4,s=$e(t,h),h+=4;const e=$e(t,h);h+=4;const n=$e(t,h);for(h+=4,a=2**32*e+n,Rt(a)||(a=Number.MAX_SAFE_INTEGER,Bt.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=$e(t,h),h+=4,l=$e(t,h),h+=4;"\0"!==Ne(t.subarray(h,h+1));)i+=Ne(t.subarray(h,h+1)),h+=1;for(i+=Ne(t.subarray(h,h+1)),h+=1;"\0"!==Ne(t.subarray(h,h+1));)r+=Ne(t.subarray(h,h+1)),h+=1;r+=Ne(t.subarray(h,h+1)),h+=1}return{schemeIdUri:i,value:r,timeScale:s,presentationTime:a,presentationTimeDelta:n,eventDuration:o,id:l,payload:t.subarray(h,t.byteLength)}}(t);if(hn.test(r.schemeIdUri)){const t=kt(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale;let s=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);const n=r.payload;i.samples.push({data:n,len:n.byteLength,dts:t,pts:t,type:ir,duration:s})}}))}return i}demuxSampleAes(t,e,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,i,r){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(function(t,e){if(!t||!e)return t;const i=e.keyId;i&&e.isCommonEncryption&&Ke(t,["moov","trak"]).forEach((t=>{const e=Ke(t,["mdia","minf","stbl","stsd"])[0].subarray(8);let r=Ke(e,["enca"]);const s=r.length>0;s||(r=Ke(e,["encv"])),r.forEach((t=>{Ke(s?t.subarray(28):t.subarray(78),["sinf"]).forEach((t=>{const e=Qe(t);if(e){const t=e.subarray(8,24);t.some((t=>0!==t))||(Bt.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${Me.hexDump(t)} -> ${Me.hexDump(i)}`),e.set(i,8))}}))}))}));return t}(t,r)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(null==t||!t.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const r=this.initData=je(t);r.audio&&(e=Nn(r.audio,Kt)),r.video&&(i=Nn(r.video,Yt));const s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:e+","+i,initSegment:t,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:r.video?s.video={container:"video/mp4",codec:i,initSegment:t,id:"main"}:Bt.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(t,e,i,r,s,n){var a,o;let{initPTS:l,lastEndTime:h}=this;const d={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};kt(h)||(h=this.lastEndTime=s||0);const c=e.samples;if(null==c||!c.length)return d;const u={initPTS:void 0,timescale:1};let f=this.initData;if(null!=(a=f)&&a.length||(this.generateInitSegment(c),f=this.initData),null==(o=f)||!o.length)return Bt.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),d;this.emitInitSegment&&(u.tracks=this.initTracks,this.emitInitSegment=!1);const p=function(t,e){let i=0,r=0,s=0;const n=Ke(t,["moof","traf"]);for(let t=0;t<n.length;t++){const a=n[t],o=Ke(a,["tfhd"])[0],l=e[$e(o,4)];if(!l)continue;const h=l.default,d=$e(o,0)|(null==h?void 0:h.flags);let c=null==h?void 0:h.duration;8&d&&(c=$e(o,2&d?12:8));const u=l.timescale||9e4,f=Ke(a,["trun"]);for(let t=0;t<f.length;t++)i=Je(f[t]),!i&&c&&(i=c*$e(f[t],4)),l.type===Yt?r+=i/u:l.type===Kt&&(s+=i/u)}if(0===r&&0===s){let e=1/0,i=0,r=0;const s=Ke(t,["sidx"]);for(let t=0;t<s.length;t++){const n=Ye(s[t]);if(null!=n&&n.references){e=Math.min(e,n.earliestPresentationTime/n.timescale);const t=n.references.reduce(((t,e)=>t+e.info.duration||0),0);i=Math.max(i,t+n.earliestPresentationTime/n.timescale),r=i-e}}if(r&&kt(r))return r}return r||s}(c,f),m=function(t,e){return Ke(e,["moof","traf"]).reduce(((e,i)=>{const r=Ke(i,["tfdt"])[0],s=r[0],n=Ke(i,["tfhd"]).reduce(((e,i)=>{const n=$e(i,4),a=t[n];if(a){let t=$e(r,4);if(1===s){if(t===Fe)return Bt.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),e;t*=Fe+1,t+=$e(r,8)}const i=t/(a.timescale||9e4);if(kt(i)&&(null===e||i<e))return i}return e}),null);return null!==n&&kt(n)&&(null===e||n<e)?n:e}),null)}(f,c),g=null===m?s:m;(function(t,e,i,r){if(null===t)return!0;const s=Math.max(r,1),n=e-t.baseTime/t.timescale;return Math.abs(n-i)>s}(l,g,s,p)||u.timescale!==l.timescale&&n)&&(u.initPTS=g-s,l&&1===l.timescale&&Bt.warn("Adjusting initPTS by "+(u.initPTS-l.baseTime)),this.initPTS=l={baseTime:u.initPTS,timescale:1});const y=t?g-l.baseTime/l.timescale:h,v=y+p;!function(t,e,i){Ke(e,["moof","traf"]).forEach((e=>{Ke(e,["tfhd"]).forEach((r=>{const s=$e(r,4),n=t[s];if(!n)return;const a=n.timescale||9e4;Ke(e,["tfdt"]).forEach((t=>{const e=t[0],r=i*a;if(r){let i=$e(t,4);if(0===e)i-=r,i=Math.max(i,0),Ve(t,4,i);else{i*=Math.pow(2,32),i+=$e(t,8),i-=r,i=Math.max(i,0);const e=Math.floor(i/(Fe+1)),s=Math.floor(i%(Fe+1));Ve(t,4,e),Ve(t,8,s)}}}))}))}))}(f,c,l.baseTime/l.timescale),p>0?this.lastEndTime=v:(Bt.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const _=!!f.audio,S=!!f.video;let T="";_&&(T+="audio"),S&&(T+="video");const E={data1:c,startPTS:y,startDTS:y,endPTS:v,endDTS:v,type:T,hasAudio:_,hasVideo:S,nb:1,dropped:0};return d.audio="audio"===E.type?E:void 0,d.video="audio"!==E.type?E:void 0,d.initSegment=u,d.id3=Fn(i,s,l,l),r.samples.length&&(d.text=On(r,s,l)),d}}},{demux:vn,remux:Pn},{demux:class extends zs{constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=Se(t,0);let i=(null==e?void 0:e.length)||0;if(ln(t,i))return!1;for(let e=t.length;i<e;i++)if(Ws(t,i))return Bt.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return function(t,e){return function(t,e){return e+5<t.length}(t,e)&&Vs(t,e)&&Ys(t,e)<=t.length-e}(t,e)}appendFrame(t,e,i){qs(t,this.observer,e,i,t.manifestCodec);const r=Zs(t,e,i,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}},remux:Pn},{demux:class extends zs{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;const e=Se(t,0);let i=(null==e?void 0:e.length)||0;if(e&&11===t[i]&&119===t[i+1]&&void 0!==be(e)&&dn(t,i)<=16)return!1;for(let e=t.length;i<e;i++)if(ln(t,i))return Bt.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return function(t,e){return an(t,e)&&4<=t.length-e}(t,e)}appendFrame(t,e,i){if(null!==this.basePTS)return sn(t,e,i,this.basePTS,this.frameIndex)}},remux:Pn}];Gn.splice(2,0,{demux:cn,remux:Pn});class $n{constructor(t,e,i,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.vendor=r,this.id=s}configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,i,r){const s=i.transmuxing;s.executeStart=In();let n=new Uint8Array(t);const{currentTransmuxState:a,transmuxConfig:o}=this;r&&(this.currentTransmuxState=r);const{contiguous:l,discontinuity:h,trackSwitch:d,accurateTimeOffset:c,timeOffset:u,initSegmentChange:f}=r||a,{audioCodec:p,videoCodec:m,defaultInitPts:g,duration:y,initSegmentData:v}=o,_=function(t,e){let i=null;t.byteLength>0&&null!=(null==e?void 0:e.key)&&null!==e.iv&&null!=e.method&&(i=e);return i}(n,e);if(_&&"AES-128"===_.method){const t=this.getDecrypter();if(!t.isSync())return this.decryptionPromise=t.webCryptoDecrypt(n,_.key.buffer,_.iv.buffer).then((t=>{const e=this.push(t,null,i);return this.decryptionPromise=null,e})),this.decryptionPromise;{let e=t.softwareDecrypt(n,_.key.buffer,_.iv.buffer);if(i.part>-1&&(e=t.flush()),!e)return s.executeEnd=In(),zn(i);n=new Uint8Array(e)}}const S=this.needsProbing(h,d);if(S){const t=this.configureTransmuxer(n);if(t)return Bt.warn(`[transmuxer] ${t.message}`),this.observer.emit(It.ERROR,It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_PARSING_ERROR,fatal:!1,error:t,reason:t.message}),s.executeEnd=In(),zn(i)}(h||d||f||S)&&this.resetInitSegment(v,p,m,y,e),(h||f||S)&&this.resetInitialTimestamp(g),l||this.resetContiguity();const T=this.transmux(n,_,u,c,i),E=this.currentTransmuxState;return E.contiguous=!0,E.discontinuity=!1,E.trackSwitch=!1,s.executeEnd=In(),T}flush(t){const e=t.transmuxing;e.executeStart=In();const{decrypter:i,currentTransmuxState:r,decryptionPromise:s}=this;if(s)return s.then((()=>this.flush(t)));const n=[],{timeOffset:a}=r;if(i){const e=i.flush();e&&n.push(this.push(e,null,t))}const{demuxer:o,remuxer:l}=this;if(!o||!l)return e.executeEnd=In(),[zn(t)];const h=o.flush(a);return Hn(h)?h.then((e=>(this.flushRemux(n,e,t),n))):(this.flushRemux(n,h,t),n)}flushRemux(t,e,i){const{audioTrack:r,videoTrack:s,id3Track:n,textTrack:a}=e,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;Bt.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const h=this.remuxer.remux(r,s,n,a,l,o,!0,this.id);t.push({remuxResult:h,chunkMeta:i}),i.transmuxing.executeEnd=In()}resetInitialTimestamp(t){const{demuxer:e,remuxer:i}=this;e&&i&&(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){const{demuxer:t,remuxer:e}=this;t&&e&&(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,r,s){const{demuxer:n,remuxer:a}=this;n&&a&&(n.resetInitSegment(t,e,i,r),a.resetInitSegment(t,e,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,r,s){let n;return n=e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(t,e,i,r,s):this.transmuxUnencrypted(t,i,r,s),n}transmuxUnencrypted(t,e,i,r){const{audioTrack:s,videoTrack:n,id3Track:a,textTrack:o}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,n,a,o,e,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(t,e,i,r,s){return this.demuxer.demuxSampleAes(t,e,i).then((t=>({remuxResult:this.remuxer.remux(t.audioTrack,t.videoTrack,t.id3Track,t.textTrack,i,r,!1,this.id),chunkMeta:s})))}configureTransmuxer(t){const{config:e,observer:i,typeSupported:r,vendor:s}=this;let n;for(let e=0,i=Gn.length;e<i;e++){var a;if(null!=(a=Gn[e].demux)&&a.probe(t)){n=Gn[e];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const o=this.demuxer,l=this.remuxer,h=n.remux,d=n.demux;l&&l instanceof h||(this.remuxer=new h(i,e,r,s)),o&&o instanceof d||(this.demuxer=new d(i,e,r),this.probe=d.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new Ls(this.config)),t}}const zn=t=>({remuxResult:{},chunkMeta:t});function Hn(t){return"then"in t&&t.then instanceof Function}class Vn{constructor(t,e,i,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=r,this.defaultInitPts=s||null}}class Kn{constructor(t,e,i,r,s,n){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=n}}var Yn={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,i="~";function r(){}function s(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function n(t,e,r,n,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,n||t,a),l=i?i+e:e;return t._events[l]?t._events[l].fn?t._events[l]=[t._events[l],o]:t._events[l].push(o):(t._events[l]=o,t._eventsCount++),t}function a(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),o.prototype.eventNames=function(){var t,r,s=[];if(0===this._eventsCount)return s;for(r in t=this._events)e.call(t,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(t)):s},o.prototype.listeners=function(t){var e=i?i+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,n=r.length,a=new Array(n);s<n;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(t){var e=i?i+t:t,r=this._events[e];return r?r.fn?1:r.length:0},o.prototype.emit=function(t,e,r,s,n,a){var o=i?i+t:t;if(!this._events[o])return!1;var l,h,d=this._events[o],c=arguments.length;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),c){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,r),!0;case 4:return d.fn.call(d.context,e,r,s),!0;case 5:return d.fn.call(d.context,e,r,s,n),!0;case 6:return d.fn.call(d.context,e,r,s,n,a),!0}for(h=1,l=new Array(c-1);h<c;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var u,f=d.length;for(h=0;h<f;h++)switch(d[h].once&&this.removeListener(t,d[h].fn,void 0,!0),c){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,e);break;case 3:d[h].fn.call(d[h].context,e,r);break;case 4:d[h].fn.call(d[h].context,e,r,s);break;default:if(!l)for(u=1,l=new Array(c-1);u<c;u++)l[u-1]=arguments[u];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(t,e,i){return n(this,t,e,i,!1)},o.prototype.once=function(t,e,i){return n(this,t,e,i,!0)},o.prototype.removeListener=function(t,e,r,s){var n=i?i+t:t;if(!this._events[n])return this;if(!e)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==e||s&&!o.once||r&&o.context!==r||a(this,n);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==e||s&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[n]=1===h.length?h[0]:h:a(this,n)}return this},o.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&a(this,e)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,t.exports=o}(Yn);var jn=mt(Yn.exports);class Wn{constructor(t,e,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=t.config;this.hls=t,this.id=e,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;const n=(t,e)=>{(e=e||{}).frag=this.frag,e.id=this.id,t===It.ERROR&&(this.error=e.error),this.hls.trigger(t,e)};this.observer=new jn,this.observer.on(It.FRAG_DECRYPTED,n),this.observer.on(It.ERROR,n);const a=mi(s.preferManagedMediaSource)||{isTypeSupported:()=>!1},o={mpeg:a.isTypeSupported("audio/mpeg"),mp3:a.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:a.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&"undefined"!=typeof Worker){if(s.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{s.workerPath?(Bt.log(`loading Web Worker ${s.workerPath} for "${e}"`),this.workerContext=function(t){const e=new self.URL(t,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}(s.workerPath)):(Bt.log(`injecting Web Worker for "${e}"`),this.workerContext=function(){const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(t);return{worker:new self.Worker(e),objectURL:e}}()),this.onwmsg=t=>this.onWorkerMessage(t);const{worker:t}=this.workerContext;t.addEventListener("message",this.onwmsg),t.onerror=t=>{const i=new Error(`${t.message}  (${t.filename}:${t.lineno})`);s.enableWorker=!1,Bt.warn(`Error in "${e}" Web Worker, fallback to inline`),this.hls.trigger(It.ERROR,{type:Ct.OTHER_ERROR,details:Ut.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:i})},t.postMessage({cmd:"init",typeSupported:o,vendor:"",id:e,config:JSON.stringify(s)})}catch(t){Bt.warn(`Error setting up "${e}" Web Worker, fallback to inline`,t),this.resetWorker(),this.error=null,this.transmuxer=new $n(this.observer,o,s,"",e)}return}}this.transmuxer=new $n(this.observer,o,s,"",e)}resetWorker(){if(this.workerContext){const{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,i,r,s,n,a,o,l,h){var d,c;l.transmuxing.start=self.performance.now();const{transmuxer:u}=this,f=n?n.start:s.start,p=s.decryptdata,m=this.frag,g=!(m&&s.cc===m.cc),y=!(m&&l.level===m.level),v=m?l.sn-m.sn:-1,_=this.part?l.part-this.part.index:-1,S=0===v&&l.id>1&&l.id===(null==m?void 0:m.stats.chunkCount),T=!y&&(1===v||0===v&&(1===_||S&&_<=0)),E=self.performance.now();(y||v||0===s.stats.parsing.start)&&(s.stats.parsing.start=E),!n||!_&&T||(n.stats.parsing.start=E);const b=!(m&&(null==(d=s.initSegment)?void 0:d.url)===(null==(c=m.initSegment)?void 0:c.url)),w=new Kn(g,T,o,y,f,b);if(!T||g||b){Bt.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}\n        discontinuity: ${g}\n        trackSwitch: ${y}\n        contiguous: ${T}\n        accurateTimeOffset: ${o}\n        timeOffset: ${f}\n        initSegmentChange: ${b}`);const t=new Vn(i,r,e,a,h);this.configureTransmuxer(t)}if(this.frag=s,this.part=n,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:p,chunkMeta:l,state:w},t instanceof ArrayBuffer?[t]:[]);else if(u){const e=u.push(t,p,l,w);Hn(e)?(u.async=!0,e.then((t=>{this.handleTransmuxComplete(t)})).catch((t=>{this.transmuxerError(t,l,"transmuxer-interface push error")}))):(u.async=!1,this.handleTransmuxComplete(e))}}flush(t){t.transmuxing.start=self.performance.now();const{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let i=e.flush(t);Hn(i)||e.async?(Hn(i)||(i=Promise.resolve(i)),i.then((e=>{this.handleFlushResult(e,t)})).catch((e=>{this.transmuxerError(e,t,"transmuxer-interface flush error")}))):this.handleFlushResult(i,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach((t=>{this.handleTransmuxComplete(t)})),this.onFlush(e)}onWorkerMessage(t){const e=t.data;if(null==e||!e.event)return void Bt.warn("worker message received with no "+(e?"event name":"data"));const i=this.hls;if(this.hls)switch(e.event){case"init":{var r;const t=null==(r=this.workerContext)?void 0:r.objectURL;t&&self.URL.revokeObjectURL(t);break}case"transmuxComplete":this.handleTransmuxComplete(e.data);break;case"flush":this.onFlush(e.data);break;case"workerLog":Bt[e.data.logType]&&Bt[e.data.logType](e.data.message);break;default:e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,i.trigger(e.event,e.data)}}configureTransmuxer(t){const{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}}function qn(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!Xn(t[i].attrs,e[i].attrs))return!1;return!0}function Xn(t,e,i){const r=t["STABLE-RENDITION-ID"];return r&&!i?r===e["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((i=>t[i]!==e[i]))}function Zn(t,e){return e.label.toLowerCase()===t.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(t.lang||"").toLowerCase())}class Qn{constructor(t){this.buffered=void 0;const e=(e,i,r)=>{if((i>>>=0)>r-1)throw new DOMException(`Failed to execute '${e}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${r})`);return t[i][e]};this.buffered={get length(){return t.length},end:i=>e("end",i,t.length),start:i=>e("start",i,t.length)}}}class Jn{constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}append(t,e,i){const r=this.queues[e];r.push(t),1!==r.length||i||this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;const i=new Promise((t=>{e=t})),r={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,t),i}executeNext(t){const e=this.queues[t];if(e.length){const i=e[0];try{i.execute()}catch(e){Bt.warn(`[buffer-operation-queue]: Exception executing "${t}" SourceBuffer operation: ${e}`),i.onError(e);const r=this.buffers[t];null!=r&&r.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}}const ta=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;function ea(t){const e=t.querySelectorAll("source");[].slice.call(e).forEach((e=>{t.removeChild(e)}))}const ia={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},ra=t=>String.fromCharCode(ia[t]||t),sa=15,na=100,aa={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},oa={17:2,18:4,21:6,22:8,23:10,19:13,20:15},la={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},ha={25:2,26:4,29:6,30:8,31:10,27:13,28:15},da=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class ca{constructor(){this.time=null,this.verboseLevel=0}log(t,e){if(this.verboseLevel>=t){const i="function"==typeof e?e():e;Bt.log(`${this.time} [${t}] ${i}`)}}}const ua=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].toString(16));return e};class fa{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){const e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){const r=e[i];t.hasOwnProperty(r)&&(this[r]=t[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class pa{constructor(){this.uchar=" ",this.penState=new fa}reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class ma{constructor(t){this.chars=[],this.pos=0,this.currPenState=new fa,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<na;t++)this.chars.push(new pa);this.logger=t}equals(t){for(let e=0;e<na;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<na;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<na;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>na&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=na)}moveCursor(t){const e=this.pos+t;if(t>1)for(let t=this.pos+1;t<e+1;t++)this.chars[t].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();const e=ra(t);this.pos>=na?this.logger.log(0,(()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1))}clearFromPos(t){let e;for(e=t;e<na;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let e=!0;for(let i=0;i<na;i++){const r=this.chars[i].uchar;" "!==r&&(e=!1),t.push(r)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t);this.chars[this.pos].setPenState(this.currPenState)}}class ga{constructor(t){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<sa;e++)this.rows.push(new ma(t));this.logger=t}reset(){for(let t=0;t<sa;t++)this.rows[t].clear();this.currRow=14}equals(t){let e=!0;for(let i=0;i<sa;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<sa;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<sa;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t);this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,(()=>"pacData = "+JSON.stringify(t)));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let t=0;t<sa;t++)this.rows[t].clear();const t=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const r=i.rows[t].cueStartTime,s=this.logger.time;if(null!==r&&null!==s&&r<s)for(let r=0;r<this.nrRollUpRows;r++)this.rows[e-this.nrRollUpRows+r+1].copy(i.rows[t+r])}}this.currRow=e;const i=this.rows[this.currRow];if(null!==t.indent){const e=t.indent,r=Math.max(e-1,0);i.setCursor(t.indent),t.color=i.chars[r].penState.foreground}const r={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(t){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(t))),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;const e=[];let i="",r=-1;for(let i=0;i<sa;i++){const s=this.rows[i].getTextString();s&&(r=i+1,t?e.push("Row "+r+": '"+s+"'"):e.push(s.trim()))}return e.length>0&&(i=t?"["+e.join(" | ")+"]":e.join("\n")),i}getTextAndFormat(){return this.rows}}class ya{constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new ga(i),this.nonDisplayedMemory=new ga(i),this.lastOutputScreen=new ga(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,(()=>"MODE="+t)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);const e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>e+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){const e={flash:!1};if(e.underline=t%2==1,e.italics=t>=46,e.italics)e.foreground="white";else{const i=Math.floor(t/2)-16,r=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=r[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(e)),this.writeScreen.setPen(e)}outputDataUpdate(t=!1){const e=this.logger.time;null!==e&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e):this.cueStartTime=e,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t))}}class va{constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const r=this.logger=new ca;this.channels=[null,new ya(t,e,r),new ya(t+1,i,r)]}getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){this.logger.time=t;for(let t=0;t<e.length;t+=2){const i=127&e[t],r=127&e[t+1];let s=!1,n=null;if(0===i&&0===r)continue;this.logger.log(3,(()=>"["+ua([e[t],e[t+1]])+"] -> ("+ua([i,r])+")"));const a=this.cmdHistory;if(i>=16&&i<=31){if(Sa(i,r,a)){_a(null,null,a),this.logger.log(3,(()=>"Repeated command ("+ua([i,r])+") is dropped"));continue}_a(i,r,this.cmdHistory),s=this.parseCmd(i,r),s||(s=this.parseMidrow(i,r)),s||(s=this.parsePAC(i,r)),s||(s=this.parseBackgroundAttributes(i,r))}else _a(null,null,a);if(!s&&(n=this.parseChars(i,r),n)){const t=this.currentChannel;if(t&&t>0){this.channels[t].insertChars(n)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}s||n||this.logger.log(2,(()=>"Couldn't parse cleaned data "+ua([i,r])+" orig: "+ua([e[t],e[t+1]])))}}parseCmd(t,e){if(!((20===t||28===t||21===t||29===t)&&e>=32&&e<=47)&&!((23===t||31===t)&&e>=33&&e<=35))return!1;const i=20===t||21===t||23===t?1:2,r=this.channels[i];return 20===t||21===t||28===t||29===t?32===e?r.ccRCL():33===e?r.ccBS():34===e?r.ccAOF():35===e?r.ccAON():36===e?r.ccDER():37===e?r.ccRU(2):38===e?r.ccRU(3):39===e?r.ccRU(4):40===e?r.ccFON():41===e?r.ccRDC():42===e?r.ccTR():43===e?r.ccRTD():44===e?r.ccEDM():45===e?r.ccCR():46===e?r.ccENM():47===e&&r.ccEOC():r.ccTO(e-32),this.currentChannel=i,!0}parseMidrow(t,e){let i=0;if((17===t||25===t)&&e>=32&&e<=47){if(i=17===t?1:2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const r=this.channels[i];return!!r&&(r.ccMIDROW(e),this.logger.log(3,(()=>"MIDROW ("+ua([t,e])+")")),!0)}return!1}parsePAC(t,e){let i;if(!((t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127)&&!((16===t||24===t)&&e>=64&&e<=95))return!1;const r=t<=23?1:2;i=e>=64&&e<=95?1===r?aa[t]:la[t]:1===r?oa[t]:ha[t];const s=this.channels[r];return!!s&&(s.setPAC(this.interpretPAC(i,e)),this.currentChannel=r,!0)}interpretPAC(t,e){let i;const r={color:null,italics:!1,indent:null,underline:!1,row:t};return i=e>95?e-96:e-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(t,e){let i,r=null,s=null;if(t>=25?(i=2,s=t-8):(i=1,s=t),s>=17&&s<=19){let t;t=17===s?e+80:18===s?e+112:e+144,this.logger.log(2,(()=>"Special char '"+ra(t)+"' in channel "+i)),r=[t]}else t>=32&&t<=127&&(r=0===e?[t]:[t,e]);return r&&this.logger.log(3,(()=>"Char codes =  "+ua(r).join(","))),r}parseBackgroundAttributes(t,e){if(!((16===t||24===t)&&e>=32&&e<=47)&&!((23===t||31===t)&&e>=45&&e<=47))return!1;let i;const r={};16===t||24===t?(i=Math.floor((e-32)/2),r.background=da[i],e%2==1&&(r.background=r.background+"_semi")):45===e?r.background="transparent":(r.foreground="black",47===e&&(r.underline=!0));const s=t<=23?1:2;return this.channels[s].setBkgData(r),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){const e=this.channels[t];e&&e.reset()}_a(null,null,this.cmdHistory)}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){const i=this.channels[e];i&&i.cueSplitAtTime(t)}}}function _a(t,e,i){i.a=t,i.b=e}function Sa(t,e,i){return i.a===t&&i.b===e}class Ta{constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(null===this.startTime||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var Ea=function(){if(null!=ee&&ee.VTTCue)return self.VTTCue;const t=["","lr","rl"],e=["start","middle","end","left","right"];function i(t,e){if("string"!=typeof e)return!1;if(!Array.isArray(t))return!1;const i=e.toLowerCase();return!!~t.indexOf(i)&&i}function r(t){return i(e,t)}function s(t,...e){let i=1;for(;i<arguments.length;i++){const e=arguments[i];for(const i in e)t[i]=e[i]}return t}function n(e,n,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let h="",d=!1,c=e,u=n,f=a,p=null,m="",g=!0,y="auto",v="start",_=50,S="middle",T=50,E="middle";Object.defineProperty(o,"id",s({},l,{get:function(){return h},set:function(t){h=""+t}})),Object.defineProperty(o,"pauseOnExit",s({},l,{get:function(){return d},set:function(t){d=!!t}})),Object.defineProperty(o,"startTime",s({},l,{get:function(){return c},set:function(t){if("number"!=typeof t)throw new TypeError("Start time must be set to a number.");c=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",s({},l,{get:function(){return u},set:function(t){if("number"!=typeof t)throw new TypeError("End time must be set to a number.");u=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",s({},l,{get:function(){return f},set:function(t){f=""+t,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",s({},l,{get:function(){return p},set:function(t){p=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",s({},l,{get:function(){return m},set:function(e){const r=function(e){return i(t,e)}(e);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",s({},l,{get:function(){return g},set:function(t){g=!!t,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",s({},l,{get:function(){return y},set:function(t){if("number"!=typeof t&&"auto"!==t)throw new SyntaxError("An invalid number or illegal string was specified.");y=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",s({},l,{get:function(){return v},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",s({},l,{get:function(){return _},set:function(t){if(t<0||t>100)throw new Error("Position must be between 0 and 100.");_=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",s({},l,{get:function(){return S},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",s({},l,{get:function(){return T},set:function(t){if(t<0||t>100)throw new Error("Size must be between 0 and 100.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",s({},l,{get:function(){return E},set:function(t){const e=r(t);if(!e)throw new SyntaxError("An invalid or illegal string was specified.");E=e,this.hasBeenReset=!0}})),o.displayState=void 0}return n.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},n}();class ba{decode(t,e){if(!t)return"";if("string"!=typeof t)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function wa(t){function e(t,e,i,r){return 3600*(0|t)+60*(0|e)+(0|i)+parseFloat(r||0)}const i=t.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?e(i[2],i[3],0,i[4]):e(i[1],i[2],i[3],i[4]):null}class La{constructor(){this.values=Object.create(null)}set(t,e){this.get(t)||""===e||(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let r=0;r<i.length;++r)if(e===i[r]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){const i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}}function Aa(t,e,i,r){const s=r?t.split(r):[t];for(const t in s){if("string"!=typeof s[t])continue;const r=s[t].split(i);if(2!==r.length)continue;e(r[0],r[1])}}const xa=new Ea(0,0,""),ka="middle"===xa.align?"middle":"center";function Ra(t,e,i){const r=t;function s(){const e=wa(t);if(null===e)throw new Error("Malformed timestamp: "+r);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e}function n(){t=t.replace(/^\s+/,"")}if(n(),e.startTime=s(),n(),"--\x3e"!==t.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+r);t=t.slice(3),n(),e.endTime=s(),n(),function(t,e){const r=new La;Aa(t,(function(t,e){let s;switch(t){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===e){r.set(t,i[s].region);break}break;case"vertical":r.alt(t,e,["rl","lr"]);break;case"line":s=e.split(","),r.integer(t,s[0]),r.percent(t,s[0])&&r.set("snapToLines",!1),r.alt(t,s[0],["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start",ka,"end"]);break;case"position":s=e.split(","),r.percent(t,s[0]),2===s.length&&r.alt("positionAlign",s[1],["start",ka,"end","line-left","line-right","auto"]);break;case"size":r.percent(t,e);break;case"align":r.alt(t,e,["start",ka,"end","left","right"])}}),/:/,/\s/),e.region=r.get("region",null),e.vertical=r.get("vertical","");let s=r.get("line","auto");"auto"===s&&-1===xa.line&&(s=-1),e.line=s,e.lineAlign=r.get("lineAlign","start"),e.snapToLines=r.get("snapToLines",!0),e.size=r.get("size",100),e.align=r.get("align",ka);let n=r.get("position","auto");"auto"===n&&50===xa.position&&(n="start"===e.align||"left"===e.align?0:"end"===e.align||"right"===e.align?100:50),e.position=n}(t,e)}function Da(t){return t.replace(/<br(?: \/)?>/gi,"\n")}class Ia{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ba,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(t){const e=this;function i(){let t=e.buffer,i=0;for(t=Da(t);i<t.length&&"\r"!==t[i]&&"\n"!==t[i];)++i;const r=t.slice(0,i);return"\r"===t[i]&&++i,"\n"===t[i]&&++i,e.buffer=t.slice(i),r}t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));try{let t="";if("INITIAL"===e.state){if(!/\r\n|\n/.test(e.buffer))return this;t=i();const r=t.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(null==r||!r[0])throw new Error("Malformed WebVTT signature.");e.state="HEADER"}let r=!1;for(;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(r?r=!1:t=i(),e.state){case"HEADER":/:/.test(t)?Aa(t,(function(t,e){}),/:/):t||(e.state="ID");continue;case"NOTE":t||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(t)){e.state="NOTE";break}if(!t)continue;if(e.cue=new Ea(0,0,""),e.state="CUE",-1===t.indexOf("--\x3e")){e.cue.id=t;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{Ra(t,e.cue,e.regionList)}catch(t){e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{const i=-1!==t.indexOf("--\x3e");if(!t||i&&(r=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(null===e.cue)continue;e.cue.text&&(e.cue.text+="\n"),e.cue.text+=t}continue;case"BADCUE":t||(e.state="ID")}}}catch(t){"CUETEXT"===e.state&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state="INITIAL"===e.state?"BADWEBVTT":"BADCUE"}return this}flush(){const t=this;try{if((t.cue||"HEADER"===t.state)&&(t.buffer+="\n\n",t.parse()),"INITIAL"===t.state||"BADWEBVTT"===t.state)throw new Error("Malformed WebVTT signature.")}catch(e){t.onparsingerror&&t.onparsingerror(e)}return t.onflush&&t.onflush(),this}}const Ca=/\r\n|\n\r|\n|\r/g,Ua=function(t,e,i=0){return t.slice(i,i+e.length)===e},Pa=function(t){let e=5381,i=t.length;for(;i;)e=33*e^t.charCodeAt(--i);return(e>>>0).toString()};function Ma(t,e,i){return Pa(t.toString())+Pa(e.toString())+Pa(i)}function Fa(t,e,i,r,s,n,a){const o=new Ia,l=Ce(new Uint8Array(t)).trim().replace(Ca,"\n").split("\n"),h=[],d=e?function(t,e=1){return Rn(t,kn,1/e)}(e.baseTime,e.timescale):0;let c,u="00:00.000",f=0,p=0,m=!0;o.oncue=function(t){const n=i[r];let a=i.ccOffset;const o=(f-d)/9e4;if(null!=n&&n.new&&(void 0!==p?a=i.ccOffset=n.start:function(t,e,i){let r=t[e],s=t[r.prevCC];if(!s||!s.new&&r.new)return t.ccOffset=t.presentationOffset=r.start,void(r.new=!1);for(;null!=(n=s)&&n.new;){var n;t.ccOffset+=r.start-s.start,r.new=!1,r=s,s=t[r.prevCC]}t.presentationOffset=i}(i,r,o)),o){if(!e)return void(c=new Error("Missing initPTS for VTT MPEGTS"));a=o-i.presentationOffset}const l=t.endTime-t.startTime,u=Mn(9e4*(t.startTime+a-p),9e4*s)/9e4;t.startTime=Math.max(u,0),t.endTime=Math.max(u+l,0);const m=t.text.trim();t.text=decodeURIComponent(encodeURIComponent(m)),t.id||(t.id=Ma(t.startTime,t.endTime,m)),t.endTime>0&&h.push(t)},o.onparsingerror=function(t){c=t},o.onflush=function(){c?a(c):n(h)},l.forEach((t=>{if(m){if(Ua(t,"X-TIMESTAMP-MAP=")){m=!1,t.slice(16).split(",").forEach((t=>{Ua(t,"LOCAL:")?u=t.slice(6):Ua(t,"MPEGTS:")&&(f=parseInt(t.slice(7)))}));try{p=function(t){let e=parseInt(t.slice(-3));const i=parseInt(t.slice(-6,-4)),r=parseInt(t.slice(-9,-7)),s=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!(kt(e)&&kt(i)&&kt(r)&&kt(s)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${t}`);return e+=1e3*i,e+=6e4*r,e+=36e5*s,e}(u)/1e3}catch(t){c=t}return}""===t&&(m=!1)}o.parse(t+"\n")})),o.flush()}const Oa="stpp.ttml.im1t",Ba=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Na=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Ga={left:"start",center:"center",right:"end",start:"start",end:"end"};function $a(t,e,i,r){const s=Ke(new Uint8Array(t),["mdat"]);if(0===s.length)return void r(new Error("Could not parse IMSC1 mdat"));const n=s.map((t=>Ce(t))),a=function(t,e,i=1,r=!1){return Rn(t,e,1/i,r)}(e.baseTime,1,e.timescale);try{n.forEach((t=>i(function(t,e){const i=(new DOMParser).parseFromString(t,"text/xml"),r=i.getElementsByTagName("tt")[0];if(!r)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},n=Object.keys(s).reduce(((t,e)=>(t[e]=r.getAttribute(`ttp:${e}`)||s[e],t)),{}),a="preserve"!==r.getAttribute("xml:space"),o=Ha(za(r,"styling","style")),l=Ha(za(r,"layout","region")),h=za(r,"body","[begin]");return[].map.call(h,(t=>{const i=Va(t,a);if(!i||!t.hasAttribute("begin"))return null;const r=ja(t.getAttribute("begin"),n),s=ja(t.getAttribute("dur"),n);let h=ja(t.getAttribute("end"),n);if(null===r)throw Ya(t);if(null===h){if(null===s)throw Ya(t);h=r+s}const d=new Ea(r-e,h-e,i);d.id=Ma(d.startTime,d.endTime,d.text);const c=function(t,e,i){const r="http://www.w3.org/ns/ttml#styling";let s=null;const n=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],a=null!=t&&t.hasAttribute("style")?t.getAttribute("style"):null;a&&i.hasOwnProperty(a)&&(s=i[a]);return n.reduce(((i,n)=>{const a=Ka(e,r,n)||Ka(t,r,n)||Ka(s,r,n);return a&&(i[n]=a),i}),{})}(l[t.getAttribute("region")],o[t.getAttribute("style")],o),{textAlign:u}=c;if(u){const t=Ga[u];t&&(d.lineAlign=t),d.align=u}return xt(d,c),d})).filter((t=>null!==t))}(t,a))))}catch(t){r(t)}}function za(t,e,i){const r=t.getElementsByTagName(e)[0];return r?[].slice.call(r.querySelectorAll(i)):[]}function Ha(t){return t.reduce(((t,e)=>{const i=e.getAttribute("xml:id");return i&&(t[i]=e),t}),{})}function Va(t,e){return[].slice.call(t.childNodes).reduce(((t,i,r)=>{var s;return"br"===i.nodeName&&r?t+"\n":null!=(s=i.childNodes)&&s.length?Va(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent}),"")}function Ka(t,e,i){return t&&t.hasAttributeNS(e,i)?t.getAttributeNS(e,i):null}function Ya(t){return new Error(`Could not parse ttml timestamp ${t}`)}function ja(t,e){if(!t)return null;let i=wa(t);return null===i&&(Ba.test(t)?i=function(t,e){const i=Ba.exec(t),r=(0|i[4])+(0|i[5])/e.subFrameRate;return 3600*(0|i[1])+60*(0|i[2])+(0|i[3])+r/e.frameRate}(t,e):Na.test(t)&&(i=function(t,e){const i=Na.exec(t),r=Number(i[1]);switch(i[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/e.frameRate;case"t":return r/e.tickRate}return r}(t,e))),i}function Wa(t){return t.characteristics&&/transcribes-spoken-dialog/gi.test(t.characteristics)&&/describes-music-and-sound/gi.test(t.characteristics)?"captions":"subtitles"}function qa(t,e){return!!t&&t.kind===Wa(e)&&Zn(e,t)}class Xa{constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(It.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(It.BUFFER_CODECS,this.onBufferCodecs,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(It.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(It.BUFFER_CODECS,this.onBufferCodecs,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){const i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){const i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&kt(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const t=this.hls.levels;if(t.length){const e=this.hls,i=this.getMaxLevel(t.length-1);i!==this.autoLevelCapping&&Bt.log(`Setting autoLevelCapping to ${i}: ${t[i].height}p@${t[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),e.autoLevelCapping=i,e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const i=e.filter(((e,i)=>this.isLevelAllowed(e)&&i<=t));return this.clientRect=null,Xa.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.width||e.height||(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch(t){}return t}isLevelAllowed(t){return!this.restrictedLevels.some((e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height))}static getMaxLevelByMediaSize(t,e,i){if(null==t||!t.length)return-1;let r=t.length-1;const s=Math.max(e,i);for(let e=0;e<t.length;e+=1){const i=t[e];if((i.width>=s||i.height>=s)&&(n=i,!(a=t[e+1])||n.width!==a.width||n.height!==a.height)){r=e;break}}var n,a;return r}}const Za="[eme]";class Qa{constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=Qa.CDMCleanupPromise?[Qa.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=Bt.debug.bind(Bt,Za),this.log=Bt.log.bind(Bt,Za),this.warn=Bt.warn.bind(Bt,Za),this.error=Bt.error.bind(Bt,Za),this.hls=t,this.config=t.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(It.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(It.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(It.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(It.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(It.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(It.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(t){const{drmSystems:e,widevineLicenseUrl:i}=this.config,r=e[t];if(r)return r.licenseUrl;if(t===ie.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${t}"`)}getServerCertificateUrl(t){const{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${t}"]`)}attemptKeySystemAccess(t){const e=this.hls.levels,i=(t,e,i)=>!!t&&i.indexOf(t)===e,r=e.map((t=>t.audioCodec)).filter(i),s=e.map((t=>t.videoCodec)).filter(i);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise(((e,i)=>{const n=t=>{const a=t.shift();this.getMediaKeysPromise(a,r,s).then((t=>e({keySystem:a,mediaKeys:t}))).catch((e=>{t.length?n(t):i(e instanceof Ja?e:new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_NO_ACCESS,error:e,fatal:!0},e.message))}))};n(t)}))}requestMediaKeySystemAccess(t,e){const{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let t=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===me&&"http:"===self.location.protocol&&(t=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(t))}return i(t,e)}getMediaKeysPromise(t,e,i){const r=function(t,e,i,r){let s;switch(t){case ie.FAIRPLAY:s=["cenc","sinf"];break;case ie.WIDEVINE:case ie.PLAYREADY:s=["cenc"];break;case ie.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${t}`)}return function(t,e,i,r){return[{initDataTypes:t,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:e.map((t=>({contentType:`audio/mp4; codecs="${t}"`,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}))),videoCapabilities:i.map((t=>({contentType:`video/mp4; codecs="${t}"`,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null})))}]}(s,e,i,r)}(t,e,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[t];let n=null==s?void 0:s.keySystemAccess;if(!n){this.log(`Requesting encrypted media "${t}" key-system access with config: ${JSON.stringify(r)}`),n=this.requestMediaKeySystemAccess(t,r);const e=this.keySystemAccessPromises[t]={keySystemAccess:n};return n.catch((e=>{this.log(`Failed to obtain access to key-system "${t}": ${e}`)})),n.then((i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);const r=this.fetchServerCertificate(t);return this.log(`Create media-keys for "${t}"`),e.mediaKeys=i.createMediaKeys().then((e=>(this.log(`Media-keys created for "${t}"`),r.then((i=>i?this.setMediaKeysServerCertificate(e,t,i):e))))),e.mediaKeys.catch((e=>{this.error(`Failed to create media-keys for "${t}"}: ${e}`)})),e.mediaKeys}))}return n.then((()=>s.mediaKeys))}createMediaKeySessionContext({decryptdata:t,keySystem:e,mediaKeys:i}){this.log(`Creating key-system session "${e}" keyId: ${Me.hexDump(t.keyId||[])}`);const r=i.createSession(),s={decryptdata:t,keySystem:e,mediaKeys:i,mediaKeysSession:r,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(t){const e=t.decryptdata;if(e.pssh){const i=this.createMediaKeySessionContext(t),r=this.getKeyIdString(e),s="cenc";this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,s,e.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw new Error("Could not read keyId of undefined decryptdata");if(null===t.keyId)throw new Error("keyId is null");return Me.hexDump(t.keyId)}updateKeySession(t,e){var i;const r=t.mediaKeysSession;return this.log(`Updating key-session "${r.sessionId}" for keyID ${Me.hexDump((null==(i=t.decryptdata)?void 0:i.keyId)||[])}\n      } (data length: ${e?e.byteLength:e})`),r.update(e)}selectKeySystemFormat(t){const e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${t.sn} ${t.type}: ${t.level}) key formats ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){return new Promise(((e,i)=>{const r=pe(this.config),s=t.map(oe).filter((t=>!!t&&-1!==r.indexOf(t)));return this.getKeySystemSelectionPromise(s).then((({keySystem:t})=>{const r=fe(t);r?e(r):i(new Error(`Unable to find format for key-system "${t}"`))})).catch(i)}))}loadKey(t){const e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),r=`(keyId: ${i} format: "${e.keyFormat}" method: ${e.method} uri: ${e.uri})`;this.log(`Starting session for key ${r}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(e).then((({keySystem:i,mediaKeys:s})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${t.frag.sn} ${t.frag.type}: ${t.frag.level} using key ${r}`),this.attemptSetMediaKeys(i,s).then((()=>{this.throwIfDestroyed();const t=this.createMediaKeySessionContext({keySystem:i,mediaKeys:s,decryptdata:e});return this.generateRequestWithPreferredKeySession(t,"cenc",e.pssh,"playlist-key")}))))),s.catch((t=>this.handleError(t)))),s}throwIfDestroyed(t="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof Ja?this.hls.trigger(It.ERROR,t.data):this.hls.trigger(It.ERROR,{type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){const e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){const e=oe(t.keyFormat),i=e?[e]:pe(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=pe(this.config)),0===t.length)throw new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(t)}_onMediaEncrypted(t){const{initDataType:e,initData:i}=t,r=`"${t.type}" event: init data type: "${e}"`;if(this.debug(r),null===i)return;let s,n;if("sinf"===e&&this.config.drmSystems[ie.FAIRPLAY]){const t=Ne(new Uint8Array(i));try{const e=Qt(JSON.parse(t).sinf),i=Qe(new Uint8Array(e));if(!i)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");s=i.subarray(8,24),n=ie.FAIRPLAY}catch(t){return void this.warn(`${r} Failed to parse sinf: ${t}`)}}else{const t=function(t){const e=[];if(t instanceof ArrayBuffer){const i=t.byteLength;let r=0;for(;r+32<i;){const i=ai(new DataView(t,r));e.push(i),r+=i.size}}return e}(i),e=t.filter((t=>t.systemId===ce))[0];if(!e)return void(0===t.length||t.some((t=>!t.systemId))?this.warn(`${r} contains incomplete or invalid pssh data`):this.log(`ignoring ${r} for ${t.map((t=>ue(t.systemId))).join(",")} pssh data in favor of playlist keys`));if(n=ue(e.systemId),0===e.version&&e.data){const t=e.data.length-22;s=e.data.subarray(t,t+16)}}if(!n||!s)return;const a=Me.hexDump(s),{keyIdToKeySessionPromise:o,mediaKeySessions:l}=this;let h=o[a];for(let t=0;t<l.length;t++){const r=l[t],n=r.decryptdata;if(!n.keyId)continue;const d=Me.hexDump(n.keyId);if(a===d||-1!==n.uri.replace(/-/g,"").indexOf(a)){if(h=o[d],n.pssh)break;delete o[d],n.pssh=new Uint8Array(i),n.keyId=s,h=o[a]=h.then((()=>this.generateRequestWithPreferredKeySession(r,e,i,"encrypted-event-key-match")));break}}h||(h=o[a]=this.getKeySystemSelectionPromise([n]).then((({keySystem:t,mediaKeys:r})=>{var n;this.throwIfDestroyed();const o=new li("ISO-23001-7",a,null!=(n=fe(t))?n:"");return o.pssh=new Uint8Array(i),o.keyId=s,this.attemptSetMediaKeys(t,r).then((()=>{this.throwIfDestroyed();const s=this.createMediaKeySessionContext({decryptdata:o,keySystem:t,mediaKeys:r});return this.generateRequestWithPreferredKeySession(s,e,i,"encrypted-event-no-match")}))}))),h.catch((t=>this.handleError(t)))}_onWaitingForKey(t){this.log(`"${t.type}" event`)}attemptSetMediaKeys(t,e){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${t}"`);const r=Promise.all(i).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)}));return this.setMediaKeysQueue.push(r),r.then((()=>{this.log(`Media-keys set for "${t}"`),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((t=>-1===i.indexOf(t)))}))}generateRequestWithPreferredKeySession(t,e,i,r){var s,n;const a=null==(s=this.config.drmSystems)||null==(n=s[t.keySystem])?void 0:n.generateRequest;if(a)try{const r=a.call(this.hls,e,i,t);if(!r)throw new Error("Invalid response from configured generateRequest filter");e=r.initDataType,i=t.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(t){var o;if(this.warn(t.message),null!=(o=this.hls)&&o.config.debug)throw t}if(null===i)return this.log(`Skipping key-session request for "${r}" (no initData)`),Promise.resolve(t);const l=this.getKeyIdString(t.decryptdata);this.log(`Generating key-session request for "${r}": ${l} (init data type: ${e} length: ${i?i.byteLength:null})`);const h=new jn,d=t._onmessage=e=>{const i=t.mediaKeysSession;if(!i)return void h.emit("error",new Error("invalid state"));const{messageType:r,message:s}=e;this.log(`"${r}" message event for session "${i.sessionId}" message size: ${s.byteLength}`),"license-request"===r||"license-renewal"===r?this.renewLicense(t,s).catch((t=>{this.handleError(t),h.emit("error",t)})):"license-release"===r?t.keySystem===ie.FAIRPLAY&&(this.updateKeySession(t,te("acknowledged")),this.removeSession(t)):this.warn(`unhandled media key message type "${r}"`)},c=t._onkeystatuseschange=e=>{if(!t.mediaKeysSession)return void h.emit("error",new Error("invalid state"));this.onKeyStatusChange(t);const i=t.keyStatus;h.emit("keyStatus",i),"expired"===i&&(this.warn(`${t.keySystem} expired for key ${l}`),this.renewKeySession(t))};t.mediaKeysSession.addEventListener("message",d),t.mediaKeysSession.addEventListener("keystatuseschange",c);const u=new Promise(((t,e)=>{h.on("error",e),h.on("keyStatus",(i=>{i.startsWith("usable")?t():"output-restricted"===i?e(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?e(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?e(new Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)}))}));return t.mediaKeysSession.generateRequest(e,i).then((()=>{var e;this.log(`Request generated for key-session "${null==(e=t.mediaKeysSession)?void 0:e.sessionId}" keyId: ${l}`)})).catch((t=>{throw new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_NO_SESSION,error:t,fatal:!1},`Error generating key-session request: ${t}`)})).then((()=>u)).catch((e=>{throw h.removeAllListeners(),this.removeSession(t),e})).then((()=>(h.removeAllListeners(),t)))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach(((e,i)=>{this.log(`key status change "${e}" for keyStatuses keyId: ${Me.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Me.hexDump(new Uint8Array(t.decryptdata.keyId||[]))} uri: ${t.decryptdata.uri}`),t.keyStatus=e}))}fetchServerCertificate(t){const e=this.config,i=new(0,e.loader)(e),r=this.getServerCertificateUrl(t);return r?(this.log(`Fetching server certificate for "${t}"`),new Promise(((s,n)=>{const a={responseType:"arraybuffer",url:r},o=e.certLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(t,e,i,r)=>{s(t.data)},onError:(e,i,s,o)=>{n(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:wt({url:a.url,data:void 0},e)},`"${t}" certificate request failed (${r}). Status: ${e.code} (${e.text})`))},onTimeout:(e,i,s)=>{n(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:a.url,data:void 0}},`"${t}" certificate request timed out (${r})`))},onAbort:(t,e,i)=>{n(new Error("aborted"))}};i.load(a,l,h)}))):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise(((r,s)=>{t.setServerCertificate(i).then((s=>{this.log(`setServerCertificate ${s?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${e}"`),r(t)})).catch((t=>{s(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:t,fatal:!0},t.message))}))}))}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then((e=>this.updateKeySession(t,new Uint8Array(e)).catch((t=>{throw new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:t,fatal:!0},t.message)}))))}unpackPlayReadyKeyMessage(t,e){const i=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!i.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;const r=(new DOMParser).parseFromString(i,"application/xml"),s=r.querySelectorAll("HttpHeader");if(s.length>0){let e;for(let i=0,r=s.length;i<r;i++){var n,a;e=s[i];const r=null==(n=e.querySelector("name"))?void 0:n.textContent,o=null==(a=e.querySelector("value"))?void 0:a.textContent;r&&o&&t.setRequestHeader(r,o)}}const o=r.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return te(atob(l))}setupLicenseXHR(t,e,i,r){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then((()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,t,e,i,r)})).catch((n=>{if(!i.decryptdata)throw n;return t.open("POST",e,!0),s.call(this.hls,t,e,i,r)})).then((i=>{t.readyState||t.open("POST",e,!0);return{xhr:t,licenseChallenge:i||r}})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:r}))}requestLicense(t,e){const i=this.config.keyLoadPolicy.default;return new Promise(((r,s)=>{const n=this.getLicenseServerUrl(t.keySystem);this.log(`Sending license request to URL: ${n}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return s(new Error("invalid state"));if(4===a.readyState)if(200===a.status){this._requestLicenseFailureCount=0;let e=a.response;this.log(`License received ${e instanceof ArrayBuffer?e.byteLength:e}`);const i=this.config.licenseResponseCallback;if(i)try{e=i.call(this.hls,a,n,t)}catch(t){this.error(t)}r(e)}else{const o=i.errorRetry,l=o?o.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)s(new Ja({type:Ct.KEY_SYSTEM_ERROR,details:Ut.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:n,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${n}). Status: ${a.status} (${a.statusText})`));else{const i=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(t,e).then(r,s)}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=a,this.setupLicenseXHR(a,n,t,e).then((({xhr:e,licenseChallenge:i})=>{t.keySystem==ie.PLAYREADY&&(i=this.unpackPlayReadyKeyMessage(e,i)),e.send(i)}))}))}onMediaAttached(t,e){if(!this.config.emeEnabled)return;const i=e.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const t=this.media,e=this.mediaKeySessions;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},li.clearKeyUriToKeyIdMap();const i=e.length;Qa.CDMCleanupPromise=Promise.all(e.map((t=>this.removeSession(t))).concat(null==t?void 0:t.setMediaKeys(null).catch((t=>{this.log(`Could not clear media keys: ${t}`)})))).then((()=>{i&&(this.log("finished closing key sessions and clearing media keys"),e.length=0)})).catch((t=>{this.log(`Could not close sessions and clear media keys: ${t}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,{sessionKeys:e}){if(e&&this.config.emeEnabled&&!this.keyFormatPromise){const t=e.reduce(((t,e)=>(-1===t.indexOf(e.keyFormat)&&t.push(e.keyFormat),t)),[]);this.log(`Selecting key-system from session-keys ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)}}removeSession(t){const{mediaKeysSession:e,licenseXhr:i}=t;if(e){this.log(`Remove licenses and keys and close session ${e.sessionId}`),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;const r=this.mediaKeySessions.indexOf(t);return r>-1&&this.mediaKeySessions.splice(r,1),e.remove().catch((t=>{this.log(`Could not remove session: ${t}`)})).then((()=>e.close())).catch((t=>{this.log(`Could not close session: ${t}`)}))}}}Qa.CDMCleanupPromise=void 0;class Ja extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=new Error(e)),this.data=t,t.err=t.error}}var to,eo,io;!function(t){t.MANIFEST="m",t.AUDIO="a",t.VIDEO="v",t.MUXED="av",t.INIT="i",t.CAPTION="c",t.TIMED_TEXT="tt",t.KEY="k",t.OTHER="o"}(to||(to={})),function(t){t.DASH="d",t.HLS="h",t.SMOOTH="s",t.OTHER="o"}(eo||(eo={})),function(t){t.OBJECT="CMCD-Object",t.REQUEST="CMCD-Request",t.SESSION="CMCD-Session",t.STATUS="CMCD-Status"}(io||(io={}));const ro={[io.OBJECT]:["br","d","ot","tb"],[io.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[io.SESSION]:["cid","pr","sf","sid","st","v"],[io.STATUS]:["bs","rtp"]};class so{constructor(t,e){this.value=void 0,this.params=void 0,Array.isArray(t)&&(t=t.map((t=>t instanceof so?t:new so(t)))),this.value=t,this.params=e}}class no{constructor(t){this.description=void 0,this.description=t}}const ao="Dict";function oo(t,e,i,r){return new Error(`failed to ${t} "${s=e,Array.isArray(s)?JSON.stringify(s):s instanceof Map?"Map{}":s instanceof Set?"Set{}":"object"==typeof s?JSON.stringify(s):String(s)}" as ${i}`,{cause:r});var s}const lo="Bare Item",ho="Boolean",co="Byte Sequence",uo="Decimal",fo="Integer";const po=/[\x00-\x1f\x7f]+/,mo="Token",go="Key";function yo(t,e,i){return oo("serialize",t,e,i)}function vo(t){if(!1===ArrayBuffer.isView(t))throw yo(t,co);return`:${e=t,btoa(String.fromCharCode(...e))}:`;var e}function _o(t){if(function(t){return t<-999999999999999||999999999999999<t}(t))throw yo(t,fo);return t.toString()}function So(t,e){if(t<0)return-So(-t,e);const i=Math.pow(10,e);if(Math.abs(t*i%1-.5)<Number.EPSILON){const e=Math.floor(t*i);return(e%2==0?e:e+1)/i}return Math.round(t*i)/i}function To(t){const e=So(t,3);if(Math.floor(Math.abs(e)).toString().length>12)throw yo(t,uo);const i=e.toString();return i.includes(".")?i:`${i}.0`}const Eo="String";function bo(t){const e=(i=t).description||i.toString().slice(7,-1);var i;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e))throw yo(e,mo);return e}function wo(t){switch(typeof t){case"number":if(!kt(t))throw yo(t,lo);return Number.isInteger(t)?_o(t):To(t);case"string":return function(t){if(po.test(t))throw yo(t,Eo);return`"${t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(t);case"symbol":return bo(t);case"boolean":return function(t){if("boolean"!=typeof t)throw yo(t,ho);return t?"?1":"?0"}(t);case"object":if(t instanceof Date)return function(t){return`@${_o(t.getTime()/1e3)}`}(t);if(t instanceof Uint8Array)return vo(t);if(t instanceof no)return bo(t);default:throw yo(t,lo)}}function Lo(t){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(t))throw yo(t,go);return t}function Ao(t){return null==t?"":Object.entries(t).map((([t,e])=>!0===e?`;${Lo(t)}`:`;${Lo(t)}=${wo(e)}`)).join("")}function xo(t){return t instanceof so?`${wo(t.value)}${Ao(t.params)}`:wo(t)}function ko(t,e={whitespace:!0}){if("object"!=typeof t)throw yo(t,ao);const i=t instanceof Map?t.entries():Object.entries(t),r=null!=e&&e.whitespace?" ":"";return Array.from(i).map((([t,e])=>{e instanceof so==!1&&(e=new so(e));let i=Lo(t);var r;return!0===e.value?i+=Ao(e.params):(i+="=",Array.isArray(e.value)?i+=`(${(r=e).value.map(xo).join(" ")})${Ao(r.params)}`:i+=xo(e)),i})).join(`,${r}`)}const Ro=t=>"ot"===t||"sf"===t||"st"===t,Do=t=>"number"==typeof t?kt(t):null!=t&&""!==t&&!1!==t;const Io=t=>Math.round(t),Co=t=>100*Io(t/100),Uo={br:Io,d:Io,bl:Co,dl:Co,mtp:Co,nor:(t,e)=>(null!=e&&e.baseUrl&&(t=function(t,e){const i=new URL(t),r=new URL(e);if(i.origin!==r.origin)return t;const s=i.pathname.split("/").slice(1),n=r.pathname.split("/").slice(1,-1);for(;s[0]===n[0];)s.shift(),n.shift();for(;n.length;)n.shift(),s.unshift("..");return s.join("/")}(t,e.baseUrl)),encodeURIComponent(t)),rtp:Co,tb:Io};function Po(t,e={}){return t?function(t,e){return ko(t,e)}(function(t,e){const i={};if(null==t||"object"!=typeof t)return i;const r=Object.keys(t).sort(),s=xt({},Uo,null==e?void 0:e.formatters),n=null==e?void 0:e.filter;return r.forEach((r=>{if(null!=n&&n(r))return;let a=t[r];const o=s[r];o&&(a=o(a,e)),"v"===r&&1===a||"pr"==r&&1===a||Do(a)&&(Ro(r)&&"string"==typeof a&&(a=new no(a)),i[r]=a)})),i}(t,e),xt({whitespace:!1},e)):""}function Mo(t,e,i){return xt(t,function(t,e={}){if(!t)return{};const i=Object.entries(t),r=Object.entries(ro).concat(Object.entries((null==e?void 0:e.customHeaderMap)||{})),s=i.reduce(((t,e)=>{var i;const[s,n]=e,a=(null==(i=r.find((t=>t[1].includes(s))))?void 0:i[0])||io.REQUEST;return null!=t[a]||(t[a]={}),t[a][s]=n,t}),{});return Object.entries(s).reduce(((t,[i,r])=>(t[i]=Po(r,e),t)),{})}(e,i))}const Fo="CMCD";const Oo=/CMCD=[^&#]+/;function Bo(t,e,i){const r=function(t,e={}){if(!t)return"";const i=Po(t,e);return`${Fo}=${encodeURIComponent(i)}`}(e,i);if(!r)return t;if(Oo.test(t))return t.replace(Oo,r);const s=t.includes("?")?"&":"?";return`${t}${s}${r}`}function No(t,e,i,r){t&&Object.keys(e).forEach((s=>{const n=t.filter((t=>t.groupId===s)).map((t=>{const n=xt({},t);return n.details=void 0,n.attrs=new $t(n.attrs),n.url=n.attrs.URI=Go(t.url,t.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),n.groupId=n.attrs["GROUP-ID"]=e[s],n.attrs["PATHWAY-ID"]=r,n}));t.push(...n)}))}function Go(t,e,i,r){const{HOST:s,PARAMS:n,[i]:a}=r;let o;e&&(o=null==a?void 0:a[e],o&&(t=o));const l=new self.URL(t);return s&&!o&&(l.host=s),n&&Object.keys(n).sort().forEach((t=>{t&&l.searchParams.set(t,n[t])})),l.href}const $o=/^age:\s*[\d.]+\s*$/im;class zo{constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new Vt,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,4!==t.readyState&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:t,context:e}=this;if(!t||!e)return;const i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then((()=>{if(this.loader===i&&!this.stats.aborted)return s(i,e.url)})).catch((t=>{if(this.loader===i&&!this.stats.aborted)return i.open("GET",e.url,!0),s(i,e.url)})).then((()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,e,t)})).catch((t=>{this.callbacks.onError({code:i.status,text:t.message},e,i,r)})):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);const r=e.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:n}=i.loadPolicy;if(r)for(const e in r)t.setRequestHeader(e,r[e]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&kt(s)?s:n,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){const{context:t,loader:e,stats:i}=this;if(!t||!e)return;const r=e.readyState,s=this.config;if(!i.aborted&&r>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;const r=e.status,n="text"!==e.responseType;if(r>=200&&r<300&&(n&&e.response||null!==e.responseText)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const s=n?e.response:e.responseText,a="arraybuffer"===e.responseType?s.byteLength:s.length;if(i.loaded=i.total=a,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first),!this.callbacks)return;const o=this.callbacks.onProgress;if(o&&o(i,t,s,e),!this.callbacks)return;const l={url:e.responseURL,data:s,code:r};this.callbacks.onSuccess(l,i,t,e)}else{const n=s.loadPolicy.errorRetry;Dr(n,i.retry,!1,{url:t.url,data:void 0,code:r})?this.retry(n):(Bt.error(`${r} while loading ${t.url}`),this.callbacks.onError({code:r,text:e.statusText},t,e,i))}}}loadtimeout(){if(!this.config)return;const t=this.config.loadPolicy.timeoutRetry;if(Dr(t,this.stats.retry,!0))this.retry(t);else{var e;Bt.warn(`timeout while loading ${null==(e=this.context)?void 0:e.url}`);const t=this.callbacks;t&&(this.abortInternal(),t.onTimeout(this.stats,this.context,this.loader))}}retry(t){const{context:e,stats:i}=this;this.retryDelay=kr(t,i.retry),i.retry++,Bt.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==e?void 0:e.url}, retrying ${i.retry}/${t.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){const e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&$o.test(this.loader.getAllResponseHeaders())){const e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&new RegExp(`^${t}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}}const Ho=/(\d+)-(\d+)\/(\d+)/;class Vo{constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||Ko,this.controller=new self.AbortController,this.stats=new Vt}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){const r=this.stats;if(r.loading.start)throw new Error("Loader can only be used once.");r.loading.start=self.performance.now();const s=function(t,e){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(xt({},t.headers))};t.rangeEnd&&i.headers.set("Range","bytes="+t.rangeStart+"-"+String(t.rangeEnd-1));return i}(t,this.controller.signal),n=i.onProgress,a="arraybuffer"===t.responseType,o=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:h}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,s),self.clearTimeout(this.requestTimeout),e.timeout=l&&kt(l)?l:h,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,t,this.response)}),e.timeout),self.fetch(this.request).then((s=>{this.response=this.loader=s;const o=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=h,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(r,t,this.response)}),h-(o-r.loading.start)),!s.ok){const{status:t,statusText:e}=s;throw new Yo(e||"fetch, bad network response",t,s)}return r.loading.first=o,r.total=function(t){const e=t.get("Content-Range");if(e){const t=function(t){const e=Ho.exec(t);if(e)return parseInt(e[2])-parseInt(e[1])+1}(e);if(kt(t))return t}const i=t.get("Content-Length");if(i)return parseInt(i)}(s.headers)||r.total,n&&kt(e.highWaterMark)?this.loadProgressively(s,r,t,e.highWaterMark,n):a?s.arrayBuffer():"json"===t.responseType?s.json():s.text()})).then((s=>{const a=this.response;if(!a)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);const l=s[o];l&&(r.loaded=r.total=l);const h={url:a.url,data:s,code:a.status};n&&!kt(e.highWaterMark)&&n(r,t,s,a),i.onSuccess(h,r,t,a)})).catch((e=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;const s=e&&e.code||0,n=e?e.message:null;i.onError({code:s,text:n},t,e?e.details:null,r)}))}getCacheAge(){let t=null;if(this.response){const e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i,r=0,s){const n=new Gs,a=t.body.getReader(),o=()=>a.read().then((a=>{if(a.done)return n.dataLength&&s(e,i,n.flush(),t),Promise.resolve(new ArrayBuffer(0));const l=a.value,h=l.length;return e.loaded+=h,h<r||n.dataLength?(n.push(l),n.dataLength>=r&&s(e,i,n.flush(),t)):s(e,i,l,t),o()})).catch((()=>Promise.reject()));return o()}}function Ko(t,e){return new self.Request(t.url,e)}class Yo extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}const jo=/\s/,Wo={newCue(t,e,i,r){const s=[];let n,a,o,l,h;const d=self.VTTCue||self.TextTrackCue;for(let u=0;u<r.rows.length;u++)if(n=r.rows[u],o=!0,l=0,h="",!n.isEmpty()){var c;for(let t=0;t<n.chars.length;t++)jo.test(n.chars[t].uchar)&&o?l++:(h+=n.chars[t].uchar,o=!1);n.cueStartTime=e,e===i&&(i+=1e-4),l>=16?l--:l++;const r=Da(h.trim()),f=Ma(e,i,r);null!=t&&null!=(c=t.cues)&&c.getCueById(f)||(a=new d(e,i,r),a.id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),s.push(a))}return t&&s.length&&(s.sort(((t,e)=>"auto"===t.line||"auto"===e.line?0:t.line>8&&e.line>8?e.line-t.line:t.line-e.line)),s.forEach((e=>Xi(t,e)))),s}},qo=wt(wt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:zo,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:t,partCurrent:e,hls:i}=this,{autoLevelEnabled:r,media:s}=i;if(!t||!s)return;const n=performance.now(),a=e?e.stats:t.stats,o=e?e.duration:t.duration,l=n-a.loading.start,h=i.minAutoLevel;if(a.aborted||a.loaded&&a.loaded===a.total||t.level<=h)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!r||s.paused||!s.playbackRate||!s.readyState)return;const d=i.mainForwardBufferInfo;if(null===d)return;const c=this.bwEstimator.getEstimateTTFB(),u=Math.abs(s.playbackRate);if(l<=Math.max(c,o/(2*u)*1e3))return;const f=d.len/u,p=a.loading.first?a.loading.first-a.loading.start:-1,m=a.loaded&&p>-1,g=this.getBwEstimate(),y=i.levels,v=y[t.level],_=a.total||Math.max(a.loaded,Math.round(o*v.averageBitrate/8));let S=m?l-p:l;S<1&&m&&(S=Math.min(l,8*a.loaded/g));const T=m?1e3*a.loaded/S:0,E=T?(_-a.loaded)/T:8*_/g+c/1e3;if(E<=f)return;const b=T?8*T:g;let w,L=Number.POSITIVE_INFINITY;for(w=t.level-1;w>h;w--){const t=y[w].maxBitrate;if(L=this.getTimeToLoadFrag(c/1e3,b,o*t,!y[w].details),L<f)break}if(L>=E)return;if(L>10*o)return;i.nextLoadLevel=i.nextAutoLevel=w,m?this.bwEstimator.sample(l-Math.min(c,p),a.loaded):this.bwEstimator.sampleTTFB(l);const A=y[w].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>A&&this.resetEstimator(A),this.clearTimer(),Bt.warn(`[abr] Fragment ${t.sn}${e?" part "+e.index:""} of level ${t.level} is loading too slowly;\n      Time to underbuffer: ${f.toFixed(3)} s\n      Estimated load time for current fragment: ${E.toFixed(3)} s\n      Estimated load time for down switch fragment: ${L.toFixed(3)} s\n      TTFB estimate: ${0|p} ms\n      Current BW estimate: ${kt(g)?0|g:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${w} @ ${0|A} bps`),i.trigger(It.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:e,stats:a})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(t){t&&(Bt.log(`setting initial bwe to ${t}`),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const t=this.hls.config;return new Vr(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){const{hls:t}=this;t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.FRAG_LOADING,this.onFragLoading,this),t.on(It.FRAG_LOADED,this.onFragLoaded,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this),t.on(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(It.LEVEL_LOADED,this.onLevelLoaded,this),t.on(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(It.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(It.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t&&(t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.FRAG_LOADING,this.onFragLoading,this),t.off(It.FRAG_LOADED,this.onFragLoaded,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this),t.off(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(It.LEVEL_LOADED,this.onLevelLoaded,this),t.off(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(It.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(It.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){const i=e.frag;if(!this.ignoreFragment(i)){var r;if(!i.bitrateTest)this.fragCurrent=i,this.partCurrent=null!=(r=e.part)?r:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case Ut.BUFFER_ADD_CODEC_ERROR:case Ut.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case Ut.FRAG_LOAD_TIMEOUT:{const t=e.frag,{fragCurrent:i,partCurrent:r}=this;if(t&&i&&t.sn===i.sn&&t.level===i.level){const e=performance.now(),i=r?r.stats:t.stats,s=e-i.loading.start,n=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&n>-1){const t=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(s-Math.min(t,n),i.loaded)}else this.bwEstimator.sampleTTFB(s)}break}}}getTimeToLoadFrag(t,e,i,r){return t+i/e+(r?this.lastLevelLoadSec:0)}onLevelLoaded(t,e){const i=this.hls.config,{loading:r}=e.stats,s=r.end-r.start;kt(s)&&(this.lastLevelLoadSec=s/1e3),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(t,{frag:e,part:i}){const r=i?i.stats:e.stats;if(e.type===Hi&&this.bwEstimator.sampleTTFB(r.loading.first-r.loading.start),!this.ignoreFragment(e)){if(this.clearTimer(),e.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const t=i?i.duration:e.duration,s=this.hls.levels[e.level],n=(s.loaded?s.loaded.bytes:0)+r.loaded,a=(s.loaded?s.loaded.duration:0)+t;s.loaded={bytes:n,duration:a},s.realBitrate=Math.round(8*n/a)}if(e.bitrateTest){const t={stats:r,frag:e,part:i,id:e.type};this.onFragBuffered(It.FRAG_BUFFERED,t),e.bitrateTest=!1}else this.lastLoadedFragLevel=e.level}}onFragBuffered(t,e){const{frag:i,part:r}=e,s=null!=r&&r.stats.loaded?r.stats:i.stats;if(s.aborted)return;if(this.ignoreFragment(i))return;const n=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(n,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=n/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==Hi||"initSegment"===t.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:t,minAutoLevel:e}=this.hls,i=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,e,t,0,r,1,1);if(s>-1)return s;const n=this.hls.firstLevel,a=Math.min(Math.max(n,e),t);return Bt.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${n} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const t=this.forcedAutoLevel,e=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(!(-1===t||e&&i&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return t;const r=e&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==t){const e=this.hls.levels;if(e.length>Math.max(t,r)&&e[t].loadError<=e[r].loadError)return t}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:t,partCurrent:e,hls:i}=this,{maxAutoLevel:r,config:s,minAutoLevel:n}=i,a=e?e.duration:t?t.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let h=s.abrBandWidthFactor,d=s.abrBandWidthUpFactor;if(l){const t=this.findBestLevel(o,n,r,l,0,h,d);if(t>=0)return t}let c=a?Math.min(a,s.maxStarvationDelay):s.maxStarvationDelay;if(!l){const t=this.bitrateTestDelay;if(t){c=(a?Math.min(a,s.maxLoadingDelay):s.maxLoadingDelay)-t,Bt.info(`[abr] bitrate test took ${Math.round(1e3*t)}ms, set first fragment max fetchDuration to ${Math.round(1e3*c)} ms`),h=d=1}}const u=this.findBestLevel(o,n,r,l,c,h,d);if(Bt.info(`[abr] ${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${u}`),u>-1)return u;const f=i.levels[n],p=i.levels[i.loadLevel];return(null==f?void 0:f.bitrate)<(null==p?void 0:p.bitrate)?n:i.loadLevel}getStarvationDelay(){const t=this.hls,e=t.media;if(!e)return 1/0;const i=e&&0!==e.playbackRate?Math.abs(e.playbackRate):1,r=t.mainForwardBufferInfo;return(r?r.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,i,r,s,n,a){var o;const l=r+s,h=this.lastLoadedFragLevel,d=-1===h?this.hls.firstLevel:h,{fragCurrent:c,partCurrent:u}=this,{levels:f,allAudioTracks:p,loadLevel:m,config:g}=this.hls;if(1===f.length)return 0;const y=f[d],v=!(null==y||null==(o=y.details)||!o.live),_=-1===m||-1===h;let S,T="SDR",E=(null==y?void 0:y.frameRate)||0;const{audioPreference:b,videoPreference:w}=g,L=this.audioTracksByGroup||(this.audioTracksByGroup=function(t){return t.reduce(((t,e)=>{let i=t.groups[e.groupId];i||(i=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(e);const r=e.channels||"2";return i.channels[r]=(i.channels[r]||0)+1,i.hasDefault=i.hasDefault||e.default,i.hasAutoSelect=i.hasAutoSelect||e.autoselect,i.hasDefault&&(t.hasDefaultAudio=!0),i.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(p));if(_){if(-1!==this.firstSelection)return this.firstSelection;const r=this.codecTiers||(this.codecTiers=function(t,e,i,r){return t.slice(i,r+1).reduce(((t,i)=>{if(!i.codecSet)return t;const r=i.audioGroups;let s=t[i.codecSet];s||(t[i.codecSet]=s={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!r,fragmentError:0}),s.minBitrate=Math.min(s.minBitrate,i.bitrate);const n=Math.min(i.height,i.width);return s.minHeight=Math.min(s.minHeight,n),s.minFramerate=Math.min(s.minFramerate,i.frameRate),s.maxScore=Math.max(s.maxScore,i.score),s.fragmentError+=i.fragmentError,s.videoRanges[i.videoRange]=(s.videoRanges[i.videoRange]||0)+1,r&&r.forEach((t=>{if(!t)return;const i=e.groups[t];i&&(s.hasDefaultAudio=s.hasDefaultAudio||e.hasDefaultAudio?i.hasDefault:i.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(i.channels).forEach((t=>{s.channels[t]=(s.channels[t]||0)+i.channels[t]})))})),t}),{})}(f,L,e,i)),s=function(t,e,i,r,s){const n=Object.keys(t),a=null==r?void 0:r.channels,o=null==r?void 0:r.audioCodec,l=a&&2===parseInt(a);let h=!0,d=!1,c=1/0,u=1/0,f=1/0,p=0,m=[];const{preferHDR:g,allowedVideoRanges:y}=qr(e,s);for(let e=n.length;e--;){const i=t[n[e]];h=i.channels[2]>0,c=Math.min(c,i.minHeight),u=Math.min(u,i.minFramerate),f=Math.min(f,i.minBitrate);const r=y.filter((t=>i.videoRanges[t]>0));r.length>0&&(d=!0,m=r)}c=kt(c)?c:0,u=kt(u)?u:0;const v=Math.max(1080,c),_=Math.max(30,u);return f=kt(f)?f:i,i=Math.max(f,i),d||(e=void 0,m=[]),{codecSet:n.reduce(((e,r)=>{const s=t[r];if(r===e)return e;if(s.minBitrate>i)return Xr(r,`min bitrate of ${s.minBitrate} > current estimate of ${i}`),e;if(!s.hasDefaultAudio)return Xr(r,"no renditions with default or auto-select sound found"),e;if(o&&r.indexOf(o.substring(0,4))%5!=0)return Xr(r,`audio codec preference "${o}" not found`),e;if(a&&!l){if(!s.channels[a])return Xr(r,`no renditions with ${a} channel sound found (channels options: ${Object.keys(s.channels)})`),e}else if((!o||l)&&h&&0===s.channels[2])return Xr(r,"no renditions with stereo sound found"),e;return s.minHeight>v?(Xr(r,`min resolution of ${s.minHeight} > maximum of ${v}`),e):s.minFramerate>_?(Xr(r,`min framerate of ${s.minFramerate} > maximum of ${_}`),e):m.some((t=>s.videoRanges[t]>0))?s.maxScore<p?(Xr(r,`max score of ${s.maxScore} < selected max of ${p}`),e):e&&(Ti(r)>=Ti(e)||s.fragmentError>t[e].fragmentError)?e:(p=s.maxScore,r):(Xr(r,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),e)}),void 0),videoRanges:m,preferHDR:g,minFramerate:u,minBitrate:f}}(r,T,t,b,w),{codecSet:n,videoRanges:a,minFramerate:o,minBitrate:l,preferHDR:h}=s;S=n,T=h?a[a.length-1]:a[0],E=o,t=Math.max(t,l),Bt.log(`[abr] picked start tier ${JSON.stringify(s)}`)}else S=null==y?void 0:y.codecSet,T=null==y?void 0:y.videoRange;const A=u?u.duration:c?c.duration:0,x=this.bwEstimator.getEstimateTTFB()/1e3,k=[];for(let o=i;o>=e;o--){var R;const e=f[o],c=o>d;if(!e)continue;if(g.useMediaCapabilities&&!e.supportedResult&&!e.supportedPromise){const i=navigator.mediaCapabilities;"function"==typeof(null==i?void 0:i.decodingInfo)&&jr(e,L,T,E,t,b)?(e.supportedPromise=Wr(e,L,i),e.supportedPromise.then((t=>{if(!this.hls)return;e.supportedResult=t;const i=this.hls.levels,r=i.indexOf(e);t.error?Bt.warn(`[abr] MediaCapabilities decodingInfo error: "${t.error}" for level ${r} ${JSON.stringify(t)}`):t.supported||(Bt.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${r} ${JSON.stringify(t)}`),r>-1&&i.length>1&&(Bt.log(`[abr] Removing unsupported level ${r}`),this.hls.removeLevel(r)))}))):e.supportedResult=Kr}if(S&&e.codecSet!==S||T&&e.videoRange!==T||c&&E>e.frameRate||!c&&E>0&&E<e.frameRate||e.supportedResult&&(null==(R=e.supportedResult.decodingInfoResults)||!R[0].smooth)){k.push(o);continue}const p=e.details,w=(u?null==p?void 0:p.partTarget:null==p?void 0:p.averagetargetduration)||A;let D;D=c?a*t:n*t;const I=A&&r>=2*A&&0===s?f[o].averageBitrate:f[o].maxBitrate,C=this.getTimeToLoadFrag(x,D,I*w,void 0===p);if(D>=I&&(o===h||0===e.loadError&&0===e.fragmentError)&&(C<=x||!kt(C)||v&&!this.bitrateTestDelay||C<l)){const t=this.forcedAutoLevel;return o===m||-1!==t&&t===m||(k.length&&Bt.trace(`[abr] Skipped level(s) ${k.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${f[k[0]].codecs}" ${f[k[0]].videoRange}; not compatible with "${y.codecs}" ${T}`),Bt.info(`[abr] switch candidate:${d}->${o} adjustedbw(${Math.round(D)})-bitrate=${Math.round(D-I)} ttfb:${x.toFixed(1)} avgDuration:${w.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${C.toFixed(1)} firstSelection:${_} codecSet:${S} videoRange:${T} hls.loadLevel:${m}`)),_&&(this.firstSelection=o),o}}return-1}set nextAutoLevel(t){const{maxAutoLevel:e,minAutoLevel:i}=this.hls,r=Math.min(Math.max(t,i),e);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}},bufferController:class{constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=t=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=t=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:t,mediaSource:e}=this;this.log("Media source opened"),t&&(t.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(It.MEDIA_ATTACHED,{media:t,mediaSource:e})),e&&e.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:t,_objectUrl:e}=this;t!==e&&Bt.error(`Media element src was set while attaching MediaSource (${e} > ${t})`)},this.hls=t;const e="[buffer-controller]";var i;this.appendSource=(i=mi(t.config.preferManagedMediaSource),"undefined"!=typeof self&&i===self.ManagedMediaSource),this.log=Bt.log.bind(Bt,e),this.warn=Bt.warn.bind(Bt,e),this.error=Bt.error.bind(Bt,e),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.BUFFER_RESET,this.onBufferReset,this),t.on(It.BUFFER_APPENDING,this.onBufferAppending,this),t.on(It.BUFFER_CODECS,this.onBufferCodecs,this),t.on(It.BUFFER_EOS,this.onBufferEos,this),t.on(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(It.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(It.FRAG_PARSED,this.onFragParsed,this),t.on(It.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.BUFFER_RESET,this.onBufferReset,this),t.off(It.BUFFER_APPENDING,this.onBufferAppending,this),t.off(It.BUFFER_CODECS,this.onBufferCodecs,this),t.off(It.BUFFER_EOS,this.onBufferEos,this),t.off(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(It.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(It.FRAG_PARSED,this.onFragParsed,this),t.off(It.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new Jn(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){let i=2;(e.audio&&!e.video||!e.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(t,e){const i=this.media=e.media,r=mi(this.appendSource);if(i&&r){var s;const t=this.mediaSource=new r;this.log(`created media source: ${null==(s=t.constructor)?void 0:s.name}`),t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.addEventListener("startstreaming",this._onStartStreaming),t.addEventListener("endstreaming",this._onEndStreaming));const e=this._objectUrl=self.URL.createObjectURL(t);if(this.appendSource)try{i.removeAttribute("src");const r=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||r&&t instanceof r,ea(i),function(t,e){const i=self.document.createElement("source");i.type="video/mp4",i.src=e,t.appendChild(i)}(i,e),i.load()}catch(t){i.src=e}else i.src=e;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:t,mediaSource:e,_objectUrl:i}=this;if(e){if(this.log("media source detaching"),"open"===e.readyState)try{e.endOfStream()}catch(t){this.warn(`onMediaDetaching: ${t.message} while calling endOfStream`)}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.removeEventListener("startstreaming",this._onStartStreaming),e.removeEventListener("endstreaming",this._onEndStreaming)),t&&(t.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(t.removeAttribute("src"),this.appendSource&&ea(t),t.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(It.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((t=>{this.resetBuffer(t)})),this._initSourceBuffer()}resetBuffer(t){const e=this.sourceBuffer[t];try{var i;if(e)this.removeBufferListeners(t),this.sourceBuffer[t]=void 0,null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(e)}catch(e){this.warn(`onBufferReset ${t}`,e)}}onBufferCodecs(t,e){const i=this.getSourceBufferTypes().length,r=Object.keys(e);if(r.forEach((t=>{if(i){const i=this.tracks[t];if(i&&"function"==typeof i.buffer.changeType){var r;const{id:s,codec:n,levelCodec:a,container:o,metadata:l}=e[t],h=Li(i.codec,i.levelCodec),d=null==h?void 0:h.replace(ta,"$1");let c=Li(n,a);const u=null==(r=c)?void 0:r.replace(ta,"$1");if(c&&d!==u){"audio"===t.slice(0,5)&&(c=wi(c,this.appendSource));const e=`${o};codecs=${c}`;this.appendChangeType(t,e),this.log(`switching codec ${h} to ${c}`),this.tracks[t]={buffer:i.buffer,codec:n,container:o,levelCodec:a,metadata:l,id:s}}}}else this.pendingTracks[t]=e[t]})),i)return;const s=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==s&&(this.log(`${s} bufferCodec event(s) expected ${r.join(",")}`),this.bufferCodecEventsExpected=s),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(t,e){const{operationQueue:i}=this,r={execute:()=>{const r=this.sourceBuffer[t];r&&(this.log(`changing ${t} sourceBuffer type to ${e}`),r.changeType(e)),i.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn(`Failed to change ${t} SourceBuffer type`,e)}};i.append(r,t,!!this.pendingTracks[t])}onBufferAppending(t,e){const{hls:i,operationQueue:r,tracks:s}=this,{data:n,type:a,frag:o,part:l,chunkMeta:h}=e,d=h.buffering[a],c=self.performance.now();d.start=c;const u=o.stats.buffering,f=l?l.stats.buffering:null;0===u.start&&(u.start=c),f&&0===f.start&&(f.start=c);const p=s.audio;let m=!1;"audio"===a&&"audio/mpeg"===(null==p?void 0:p.container)&&(m=!this.lastMpegAudioChunk||1===h.id||this.lastMpegAudioChunk.sn!==h.sn,this.lastMpegAudioChunk=h);const g=o.start,y={execute:()=>{if(d.executeStart=self.performance.now(),m){const t=this.sourceBuffer[a];if(t){const e=g-t.timestampOffset;Math.abs(e)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${g} (delta: ${e}) sn: ${o.sn})`),t.timestampOffset=g)}}this.appendExecutor(n,a)},onStart:()=>{},onComplete:()=>{const t=self.performance.now();d.executeEnd=d.end=t,0===u.first&&(u.first=t),f&&0===f.first&&(f.first=t);const{sourceBuffer:e}=this,i={};for(const t in e)i[t]=ds.getBuffered(e[t]);this.appendErrors[a]=0,"audio"===a||"video"===a?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(It.BUFFER_APPENDED,{type:a,frag:o,part:l,chunkMeta:h,parent:o.type,timeRanges:i})},onError:t=>{const e={type:Ct.MEDIA_ERROR,parent:o.type,details:Ut.BUFFER_APPEND_ERROR,sourceBufferName:a,frag:o,part:l,chunkMeta:h,error:t,err:t,fatal:!1};if(t.code===DOMException.QUOTA_EXCEEDED_ERR)e.details=Ut.BUFFER_FULL_ERROR;else{const t=++this.appendErrors[a];e.details=Ut.BUFFER_APPEND_ERROR,this.warn(`Failed ${t}/${i.config.appendErrorMaxRetry} times to append segment in "${a}" sourceBuffer`),t>=i.config.appendErrorMaxRetry&&(e.fatal=!0)}i.trigger(It.ERROR,e)}};r.append(y,a,!!this.pendingTracks[a])}onBufferFlushing(t,e){const{operationQueue:i}=this,r=t=>({execute:this.removeExecutor.bind(this,t,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(It.BUFFER_FLUSHED,{type:t})},onError:e=>{this.warn(`Failed to remove from ${t} SourceBuffer`,e)}});e.type?i.append(r(e.type),e.type):this.getSourceBufferTypes().forEach((t=>{i.append(r(t),t)}))}onFragParsed(t,e){const{frag:i,part:r}=e,s=[],n=r?r.elementaryStreams:i.elementaryStreams;n[jt]?s.push("audiovideo"):(n[Kt]&&s.push("audio"),n[Yt]&&s.push("video"));0===s.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers((()=>{const t=self.performance.now();i.stats.buffering.end=t,r&&(r.stats.buffering.end=t);const e=r?r.stats:i.stats;this.hls.trigger(It.FRAG_BUFFERED,{frag:i,part:r,stats:e,id:i.type})}),s)}onFragChanged(t,e){this.trimBuffers()}onBufferEos(t,e){this.getSourceBufferTypes().reduce(((t,i)=>{const r=this.sourceBuffer[i];return!r||e.type&&e.type!==i||(r.ending=!0,r.ended||(r.ended=!0,this.log(`${i} sourceBuffer now EOS`))),t&&!(r&&!r.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((t=>{const e=this.sourceBuffer[t];e&&(e.ending=!1)}));const{mediaSource:t}=this;t&&"open"===t.readyState?(this.log("Calling mediaSource.endOfStream()"),t.endOfStream()):t&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${t.readyState}`)})))}onLevelUpdated(t,{details:e}){e.fragments.length&&(this.details=e,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:t,details:e,media:i}=this;if(!i||null===e)return;if(!this.getSourceBufferTypes().length)return;const r=t.config,s=i.currentTime,n=e.levelTargetDuration,a=e.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(kt(a)&&a>0){const t=Math.max(a,n),e=Math.floor(s/n)*n-t;this.flushBackBuffer(s,n,e)}if(kt(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const t=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),e=Math.max(t,n),i=Math.floor(s/n)*n+e;this.flushFrontBuffer(s,n,i)}}flushBackBuffer(t,e,i){const{details:r,sourceBuffer:s}=this;this.getSourceBufferTypes().forEach((n=>{const a=s[n];if(a){const s=ds.getBuffered(a);if(s.length>0&&i>s.start(0)){if(this.hls.trigger(It.BACK_BUFFER_REACHED,{bufferEnd:i}),null!=r&&r.live)this.hls.trigger(It.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(a.ended&&s.end(s.length-1)-t<2*e)return void this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);this.hls.trigger(It.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}}))}flushFrontBuffer(t,e,i){const{sourceBuffer:r}=this;this.getSourceBufferTypes().forEach((s=>{const n=r[s];if(n){const r=ds.getBuffered(n),a=r.length;if(a<2)return;const o=r.start(a-1),l=r.end(a-1);if(i>o||t>=o&&t<=l)return;if(n.ended&&t-l<2*e)return void this.log(`Cannot flush ${s} front buffer while SourceBuffer is in ended state`);this.hls.trigger(It.BUFFER_FLUSHING,{startOffset:o,endOffset:1/0,type:s})}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:t,hls:e,media:i,mediaSource:r}=this,s=t.fragments[0].start+t.totalduration,n=i.duration,a=kt(r.duration)?r.duration:0;t.live&&e.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(t)):(s>a&&s>n||!kt(n))&&(this.log(`Updating Media Source duration to ${s.toFixed(3)}`),r.duration=s)}updateSeekableRange(t){const e=this.mediaSource,i=t.fragments;if(i.length&&t.live&&null!=e&&e.setLiveSeekableRange){const r=Math.max(0,i[0].start),s=Math.max(r,r+t.totalduration);this.log(`Media Source duration is set to ${e.duration}. Setting seekable range to ${r}-${s}.`),e.setLiveSeekableRange(r,s)}}checkPendingTracks(){const{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:i}=this,r=Object.keys(i).length;if(r&&(!t||2===r||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const t=this.getSourceBufferTypes();if(t.length)this.hls.trigger(It.BUFFER_CREATED,{tracks:this.tracks}),t.forEach((t=>{e.executeNext(t)}));else{const t=new Error("could not create source buffer for media codec(s)");this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:t,reason:t.message})}}}createSourceBuffers(t){const{sourceBuffer:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const s in t)if(!e[s]){var r;const n=t[s];if(!n)throw Error(`source buffer exists for track ${s}, however track does not`);let a=-1===(null==(r=n.levelCodec)?void 0:r.indexOf(","))?n.levelCodec:n.codec;a&&"audio"===s.slice(0,5)&&(a=wi(a,this.appendSource));const o=`${n.container};codecs=${a}`;this.log(`creating sourceBuffer(${o})`);try{const t=e[s]=i.addSourceBuffer(o),r=s;this.addBufferListener(r,"updatestart",this._onSBUpdateStart),this.addBufferListener(r,"updateend",this._onSBUpdateEnd),this.addBufferListener(r,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(r,"bufferedchange",((t,e)=>{const i=e.removedRanges;null!=i&&i.length&&this.hls.trigger(It.BUFFER_FLUSHED,{type:s})})),this.tracks[s]={buffer:t,codec:a,container:n.container,levelCodec:n.levelCodec,metadata:n.metadata,id:n.id}}catch(t){this.error(`error while trying to add sourceBuffer: ${t.message}`),this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:t,sourceBufferName:s,mimeType:o})}}}get mediaSrc(){var t,e;const i=(null==(t=this.media)||null==(e=t.querySelector)?void 0:e.call(t,"source"))||this.media;return null==i?void 0:i.src}_onSBUpdateStart(t){const{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){var e;if("closed"===(null==(e=this.mediaSource)?void 0:e.readyState))return void this.resetBuffer(t);const{operationQueue:i}=this;i.current(t).onComplete(),i.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){var i;const r=new Error(`${t} SourceBuffer error. MediaSource readyState: ${null==(i=this.mediaSource)?void 0:i.readyState}`);this.error(`${r}`,e),this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:r,fatal:!1});const s=this.operationQueue.current(t);s&&s.onError(r)}removeExecutor(t,e,i){const{media:r,mediaSource:s,operationQueue:n,sourceBuffer:a}=this,o=a[t];if(!r||!s||!o)return this.warn(`Attempting to remove from the ${t} SourceBuffer, but it does not exist`),void n.shiftAndExecuteNext(t);const l=kt(r.duration)?r.duration:1/0,h=kt(s.duration)?s.duration:1/0,d=Math.max(0,e),c=Math.min(i,l,h);c>d&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${d},${c}] from the ${t} SourceBuffer`),o.remove(d,c)):n.shiftAndExecuteNext(t)}appendExecutor(t,e){const i=this.sourceBuffer[e];if(i)i.ended=!1,i.appendBuffer(t);else if(!this.pendingTracks[e])throw new Error(`Attempting to append to the ${e} SourceBuffer, but it does not exist`)}blockBuffers(t,e=this.getSourceBufferTypes()){if(!e.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(t);const{operationQueue:i}=this,r=e.map((t=>i.appendBlocker(t)));Promise.all(r).then((()=>{t(),e.forEach((t=>{const e=this.sourceBuffer[t];null!=e&&e.updating||i.shiftAndExecuteNext(t)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,i){const r=this.sourceBuffer[t];if(!r)return;const s=i.bind(this,t);this.listeners[t].push({event:e,listener:s}),r.addEventListener(e,s)}removeBufferListeners(t){const e=this.sourceBuffer[t];e&&this.listeners[t].forEach((t=>{e.removeEventListener(t.event,t.listener)}))}},capLevelController:Xa,errorController:class{constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=Bt.log.bind(Bt,"[info]:"),this.warn=Bt.warn.bind(Bt,"[warning]:"),this.error=Bt.error.bind(Bt,"[error]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(It.ERROR,this.onError,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const t=this.hls;t&&(t.off(It.ERROR,this.onError,this),t.off(It.ERROR,this.onErrorOut,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(null==t?void 0:t.type)===Hi?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var i,r;if(e.fatal)return;const s=this.hls,n=e.context;switch(e.details){case Ut.FRAG_LOAD_ERROR:case Ut.FRAG_LOAD_TIMEOUT:case Ut.KEY_LOAD_ERROR:case Ut.KEY_LOAD_TIMEOUT:return void(e.errorAction=this.getFragRetryOrSwitchAction(e));case Ut.FRAG_PARSING_ERROR:if(null!=(i=e.frag)&&i.gap)return void(e.errorAction={action:Mr,flags:Nr});case Ut.FRAG_GAP:case Ut.FRAG_DECRYPT_ERROR:return e.errorAction=this.getFragRetryOrSwitchAction(e),void(e.errorAction.action=Fr);case Ut.LEVEL_EMPTY_ERROR:case Ut.LEVEL_PARSING_ERROR:{var a,o;const t=e.parent===Hi?e.level:s.loadLevel;e.details===Ut.LEVEL_EMPTY_ERROR&&null!=(a=e.context)&&null!=(o=a.levelDetails)&&o.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,t):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t))}return;case Ut.LEVEL_LOAD_ERROR:case Ut.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==n?void 0:n.level)&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,n.level)));case Ut.AUDIO_TRACK_LOAD_ERROR:case Ut.AUDIO_TRACK_LOAD_TIMEOUT:case Ut.SUBTITLE_LOAD_ERROR:case Ut.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const t=s.levels[s.loadLevel];if(t&&(n.type===$i&&t.hasAudioGroup(n.groupId)||n.type===zi&&t.hasSubtitleGroup(n.groupId)))return e.errorAction=this.getPlaylistRetryOrSwitchAction(e,s.loadLevel),e.errorAction.action=Fr,void(e.errorAction.flags=Gr)}return;case Ut.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const t=s.levels[s.loadLevel],i=null==t?void 0:t.attrs["HDCP-LEVEL"];i?e.errorAction={action:Fr,flags:$r,hdcpLevel:i}:this.keySystemError(e)}return;case Ut.BUFFER_ADD_CODEC_ERROR:case Ut.REMUX_ALLOC_ERROR:case Ut.BUFFER_APPEND_ERROR:return void(e.errorAction=this.getLevelSwitchAction(e,null!=(r=e.level)?r:s.loadLevel));case Ut.INTERNAL_EXCEPTION:case Ut.BUFFER_APPENDING_ERROR:case Ut.BUFFER_FULL_ERROR:case Ut.LEVEL_SWITCH_ERROR:case Ut.BUFFER_STALLED_ERROR:case Ut.BUFFER_SEEK_OVER_HOLE:case Ut.BUFFER_NUDGE_ON_STALL:return void(e.errorAction={action:Mr,flags:Nr})}e.type===Ct.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){const e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){const i=xr(this.hls.config.playlistLoadPolicy,t),r=this.playlistError++;if(Dr(i,r,Ar(t),t.response))return{action:Br,flags:Nr,retryConfig:i,retryCount:r};const s=this.getLevelSwitchAction(t,e);return i&&(s.retryConfig=i,s.retryCount=r),s}getFragRetryOrSwitchAction(t){const e=this.hls,i=this.getVariantLevelIndex(t.frag),r=e.levels[i],{fragLoadPolicy:s,keyLoadPolicy:n}=e.config,a=xr(t.details.startsWith("key")?n:s,t),o=e.levels.reduce(((t,e)=>t+e.fragmentError),0);if(r){t.details!==Ut.FRAG_GAP&&r.fragmentError++;if(Dr(a,o,Ar(t),t.response))return{action:Br,flags:Nr,retryConfig:a,retryCount:o}}const l=this.getLevelSwitchAction(t,i);return a&&(l.retryConfig=a,l.retryCount=o),l}getLevelSwitchAction(t,e){const i=this.hls;null==e&&(e=i.loadLevel);const r=this.hls.levels[e];if(r){var s,n;const e=t.details;r.loadError++,e===Ut.BUFFER_APPEND_ERROR&&r.fragmentError++;let l=-1;const{levels:h,loadLevel:d,minAutoLevel:c,maxAutoLevel:u}=i;i.autoLevelEnabled||(i.loadLevel=-1);const f=null==(s=t.frag)?void 0:s.type,p=(f===Vi&&e===Ut.FRAG_PARSING_ERROR||"audio"===t.sourceBufferName&&(e===Ut.BUFFER_ADD_CODEC_ERROR||e===Ut.BUFFER_APPEND_ERROR))&&h.some((({audioCodec:t})=>r.audioCodec!==t)),m="video"===t.sourceBufferName&&(e===Ut.BUFFER_ADD_CODEC_ERROR||e===Ut.BUFFER_APPEND_ERROR)&&h.some((({codecSet:t,audioCodec:e})=>r.codecSet!==t&&r.audioCodec===e)),{type:g,groupId:y}=null!=(n=t.context)?n:{};for(let i=h.length;i--;){const s=(i+d)%h.length;if(s!==d&&s>=c&&s<=u&&0===h[s].loadError){var a,o;const i=h[s];if(e===Ut.FRAG_GAP&&f===Hi&&t.frag){const e=h[s].details;if(e){const i=Cr(t.frag,e.fragments,t.frag.start);if(null!=i&&i.gap)continue}}else{if(g===$i&&i.hasAudioGroup(y)||g===zi&&i.hasSubtitleGroup(y))continue;if(f===Vi&&null!=(a=r.audioGroups)&&a.some((t=>i.hasAudioGroup(t)))||f===Ki&&null!=(o=r.subtitleGroups)&&o.some((t=>i.hasSubtitleGroup(t)))||p&&r.audioCodec===i.audioCodec||!p&&r.audioCodec!==i.audioCodec||m&&r.codecSet===i.codecSet)continue}l=s;break}}if(l>-1&&i.loadLevel!==l)return t.levelRetry=!0,this.playlistError=0,{action:Fr,flags:Nr,nextAutoLevel:l}}return{action:Fr,flags:Gr}}onErrorOut(t,e){var i;switch(null==(i=e.errorAction)?void 0:i.action){case Mr:break;case Fr:this.sendAlternateToPenaltyBox(e),e.errorAction.resolved||e.details===Ut.FRAG_GAP?/MediaSource readyState: ended/.test(e.error.message)&&(this.warn(`MediaSource ended after "${e.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):e.fatal=!0}e.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(t){const e=this.hls,i=t.errorAction;if(!i)return;const{flags:r,hdcpLevel:s,nextAutoLevel:n}=i;switch(r){case Nr:this.switchLevel(t,n);break;case $r:s&&(e.maxHdcpLevel=hr[hr.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${e.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(t,n)}switchLevel(t,e){void 0!==e&&t.errorAction&&(this.warn(`switching to level ${e} after ${t.details}`),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}},fpsController:class{constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(It.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(It.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){const i=this.hls.config;if(i.capLevelOnFPSDrop){const t=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=t,t&&"function"==typeof t.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,i){const r=performance.now();if(e){if(this.lastTime){const t=r-this.lastTime,s=i-this.lastDroppedFrames,n=e-this.lastDecodedFrames,a=1e3*s/t,o=this.hls;if(o.trigger(It.FPS_DROP,{currentDropped:s,currentDecoded:n,totalDroppedFrames:i}),a>0&&s>o.config.fpsDroppedMonitoringThreshold*n){let t=o.currentLevel;Bt.warn("drop FPS ratio greater than max allowed value for currentLevel: "+t),t>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=t)&&(t-=1,o.trigger(It.FPS_DROP_LEVEL_CAPPING,{level:t,droppedLevel:o.currentLevel}),o.autoLevelCapping=t,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){const t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){const e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:me,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:Wo,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends Ns{constructor(t,e,i){super(t,e,i,"[subtitle-stream-controller]",Ki),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.LEVEL_LOADED,this.onLevelLoaded,this),t.on(It.ERROR,this.onError,this),t.on(It.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(It.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(It.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(It.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.LEVEL_LOADED,this.onLevelLoaded,this),t.off(It.ERROR,this.onError,this),t.off(It.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(It.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(It.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(It.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(t){this.stopLoad(),this.state=ks,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){const{frag:i,success:r}=e;if(this.fragPrevious=i,this.state=ks,!r)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let n;const a=i.start;for(let t=0;t<s.length;t++)if(a>=s[t].start&&a<=s[t].end){n=s[t];break}const o=i.start+i.duration;n?n.end=o:(n={start:a,end:o},s.push(n)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(t,e){const{startOffset:i,endOffset:r}=e;if(0===i&&r!==Number.POSITIVE_INFINITY){const t=r-1;if(t<=0)return;e.endOffsetSubtitles=Math.max(0,t),this.tracksBuffered.forEach((e=>{for(let i=0;i<e.length;)if(e[i].end<=t)e.shift();else{if(!(e[i].start<t))break;e[i].start=t,i++}})),this.fragmentTracker.removeFragmentsInRange(i,t,Ki)}}onFragBuffered(t,e){var i;this.loadedmetadata||e.frag.type!==Hi||null!=(i=this.media)&&i.buffered.length&&(this.loadedmetadata=!0)}onError(t,e){const i=e.frag;(null==i?void 0:i.type)===Ki&&(e.details===Ut.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==xs&&(this.state=ks))}onSubtitleTracksUpdated(t,{subtitleTracks:e}){this.levels&&qn(this.levels,e)?this.levels=e.map((t=>new gr(t))):(this.tracksBuffered=[],this.levels=e.map((t=>{const e=new gr(t);return this.tracksBuffered[e.id]=[],e})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,Ki),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(t,e){var i;if(this.currentTrackId=e.id,null==(i=this.levels)||!i.length||-1===this.currentTrackId)return void this.clearInterval();const r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(500)}onSubtitleTrackLoaded(t,e){var i;const{currentTrackId:r,levels:s}=this,{details:n,id:a}=e;if(!s)return void this.warn(`Subtitle tracks were reset while loading level ${a}`);const o=s[a];if(a>=s.length||!o)return;this.log(`Subtitle track ${a} loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(n.live||null!=(i=o.details)&&i.live){const t=this.mainDetails;if(n.deltaUpdateFailed||!t)return;const e=t.fragments[0];var h;if(o.details)l=this.alignPlaylists(n,o.details,null==(h=this.levelLastLoaded)?void 0:h.details),0===l&&e&&(l=e.start,Er(n,l));else n.hasProgramDateTime&&t.hasProgramDateTime?(gs(n,t),l=n.fragments[0].start):e&&(l=e.start,Er(n,l))}if(o.details=n,this.levelLastLoaded=o,a===r&&(this.startFragRequested||!this.mainDetails&&n.live||this.setStartPosition(this.mainDetails||n,l),this.tick(),n.live&&!this.fragCurrent&&this.media&&this.state===ks)){Cr(null,n.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}}_handleFragmentLoadComplete(t){const{frag:e,payload:i}=t,r=e.decryptdata,s=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&null!=r&&r.key&&r.iv&&"AES-128"===r.method){const t=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch((t=>{throw s.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((i=>{const r=performance.now();s.trigger(It.FRAG_DECRYPTED,{frag:e,payload:i,stats:{tstart:t,tdecrypt:r}})})).catch((t=>{this.warn(`${t.name}: ${t.message}`),this.state=ks}))}}doTick(){if(this.media){if(this.state===ks){const{currentTrackId:t,levels:e}=this,i=null==e?void 0:e[t];if(!i||!e.length||!i.details)return;const{config:r}=this,s=this.getLoadPosition(),n=ds.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,r.maxBufferHole),{end:a,len:o}=n,l=this.getFwdBufferInfo(this.media,Hi),h=i.details;if(o>this.getMaxBufferLength(null==l?void 0:l.len)+h.levelTargetDuration)return;const d=h.fragments,c=d.length,u=h.edge;let f=null;const p=this.fragPrevious;if(a<u){const t=r.maxFragLookUpTolerance,e=a>u-t?0:t;f=Cr(p,d,Math.max(d[0].start,a),e),!f&&p&&p.start<d[0].start&&(f=d[0])}else f=d[c-1];if(!f)return;if(f=this.mapToInitFragWhenRequired(f),"initSegment"!==f.sn){const t=d[f.sn-h.startSN-1];t&&t.cc===f.cc&&this.fragmentTracker.getState(t)===is&&(f=t)}this.fragmentTracker.getState(f)===is&&this.loadFragment(f,i,a)}}else this.state=ks}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.max(e,t):e}loadFragment(t,e,i){this.fragCurrent=t,"initSegment"===t.sn?this._loadInitSegment(t,e):(this.startFragRequested=!0,super.loadFragment(t,e,i))}get mediaBufferTimeRanges(){return new Qn(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends zr{constructor(t){super(t,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const e=Ji(this.media.textTracks);for(let i=0;i<e.length;i++)if("hidden"===e[i].mode)t=e[i];else if("showing"===e[i].mode){t=e[i];break}const i=this.findTrackForTextTrack(t);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.LEVEL_LOADING,this.onLevelLoading,this),t.on(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(It.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(It.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.LEVEL_LOADING,this.onLevelLoading,this),t.off(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(It.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(It.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);Ji(this.media.textTracks).forEach((t=>{Zi(t)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){const{id:i,groupId:r,details:s}=e,n=this.tracksInGroup[i];if(!n||n.groupId!==r)return void this.warn(`Subtitle track with id:${i} and group:${r} not found in active group ${null==n?void 0:n.groupId}`);const a=n.details;n.details=e.details,this.log(`Subtitle track ${i} "${n.name}" lang:${n.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.subtitleGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some((t=>-1===(null==r?void 0:r.indexOf(t))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const t=this.tracks.filter((t=>!i||-1!==i.indexOf(t.groupId)));if(t.length)this.selectDefaultTrack&&!t.some((t=>t.default))&&(this.selectDefaultTrack=!1),t.forEach(((t,e)=>{t.id=e}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=t;const e=this.hls.config.subtitlePreference;if(!s&&e){this.selectDefaultTrack=!1;const i=Zr(e,t);if(i>-1)s=t[i];else{const t=Zr(e,this.tracks);s=this.tracks[t]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null));const n={subtitleTracks:t};this.log(`Updating subtitle tracks, ${t.length} track(s) found in "${null==i?void 0:i.join(",")}" group-id`),this.hls.trigger(It.SUBTITLE_TRACKS_UPDATED,n),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId)}findTrackId(t){const e=this.tracksInGroup,i=this.selectDefaultTrack;for(let r=0;r<e.length;r++){const s=e[r];if((!i||s.default)&&(i||t)&&(!t||Qr(s,t)))return r}if(t){for(let i=0;i<e.length;i++){const r=e[i];if(Xn(t.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){const r=e[i];if(Xn(t.attrs,r.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(t){if(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){if(Zn(e[i],t))return i}}return-1}onError(t,e){!e.fatal&&e.context&&(e.context.type!==zi||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||this.checkRetry(e))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){const e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){const i=this.currentTrack;if(i&&Qr(t,i))return i;const r=Zr(t,this.tracksInGroup);if(r>-1){const t=this.tracksInGroup[r];return this.setSubtitleTrack(r),t}if(i)return null;{const i=Zr(t,e);if(i>-1)return e[i]}}}return null}loadPlaylist(t){super.loadPlaylist();const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(It.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}toggleTrackModes(){const{media:t}=this;if(!t)return;const e=Ji(t.textTracks),i=this.currentTrack;let r;if(i&&(r=e.filter((t=>Zn(i,t)))[0],r||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(e).forEach((t=>{"disabled"!==t.mode&&t!==r&&(t.mode="disabled")})),r){const t=this.subtitleDisplay?"showing":"hidden";r.mode!==t&&(r.mode=t)}}setSubtitleTrack(t){const e=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=t);if(t<-1||t>=e.length||!kt(t))return void this.warn(`Invalid subtitle track id: ${t}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=e[t]||null;if(this.trackId=t,this.currentTrack=r,this.toggleTrackModes(),!r)return void this.hls.trigger(It.SUBTITLE_TRACK_SWITCH,{id:t});const s=!!r.details&&!r.details.live;if(t===this.trackId&&r===i&&s)return;this.log(`Switching to subtitle-track ${t}`+(r?` "${r.name}" lang:${r.lang} group:${r.groupId}`:""));const{id:n,groupId:a="",name:o,type:l,url:h}=r;this.hls.trigger(It.SUBTITLE_TRACK_SWITCH,{id:n,groupId:a,name:o,type:l,url:h});const d=this.switchParams(r.url,null==i?void 0:i.details,r.details);this.loadPlaylist(d)}},timelineController:class{constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(It.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(It.FRAG_LOADING,this.onFragLoading,this),t.on(It.FRAG_LOADED,this.onFragLoaded,this),t.on(It.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(It.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(It.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(It.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(It.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:t}=this;t.off(It.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(It.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(It.FRAG_LOADING,this.onFragLoading,this),t.off(It.FRAG_LOADED,this.onFragLoaded,this),t.off(It.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(It.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(It.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(It.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(It.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const t=new Ta(this,"textTrack1"),e=new Ta(this,"textTrack2"),i=new Ta(this,"textTrack3"),r=new Ta(this,"textTrack4");this.cea608Parser1=new va(1,t,e),this.cea608Parser2=new va(3,i,r)}}addCues(t,e,i,r,s){let n=!1;for(let t=s.length;t--;){const r=s[t],d=(a=r[0],o=r[1],l=e,h=i,Math.min(o,h)-Math.max(a,l));if(d>=0&&(r[0]=Math.min(r[0],e),r[1]=Math.max(r[1],i),n=!0,d/(i-e)>.5))return}var a,o,l,h;if(n||s.push([e,i]),this.config.renderTextTracksNatively){const s=this.captionsTracks[t];this.Cues.newCue(s,e,i,r)}else{const s=this.Cues.newCue(null,e,i,r);this.hls.trigger(It.CUES_PARSED,{type:"captions",cues:s,track:t})}}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){const{unparsedVttFrags:n}=this;"main"===i&&(this.initPTS[e.cc]={baseTime:r,timescale:s}),n.length&&(this.unparsedVttFrags=[],n.forEach((t=>{this.onFragLoaded(It.FRAG_LOADED,t)})))}getExistingTrack(t,e){const{media:i}=this;if(i)for(let r=0;r<i.textTracks.length;r++){const s=i.textTracks[r];if(qa(s,{name:t,lang:e,attrs:{}}))return s}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;const{captionsProperties:e,captionsTracks:i,media:r}=this,{label:s,languageCode:n}=e[t],a=this.getExistingTrack(s,n);if(a)i[t]=a,Zi(i[t]),qi(i[t],r);else{const e=this.createTextTrack("captions",s,n);e&&(e[t]=!0,i[t]=e)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;const e=this.captionsProperties[t];if(!e)return;const i={_id:t,label:e.label,kind:"captions",default:!!e.media&&!!e.media.default,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=i,this.hls.trigger(It.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(t,e,i){const r=this.media;if(r)return r.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:t}=this;Object.keys(t).forEach((e=>{Zi(t[e]),delete t[e]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:t}=this;if(!t)return;const e=t.textTracks;if(e)for(let t=0;t<e.length;t++)Zi(e[t])}onSubtitleTracksUpdated(t,e){const i=e.subtitleTracks||[],r=i.some((t=>t.textCodec===Oa));if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(qn(this.tracks,i))return void(this.tracks=i);if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const t=this.media,e=t?Ji(t.textTracks):null;if(this.tracks.forEach(((t,i)=>{let r;if(e){let i=null;for(let r=0;r<e.length;r++)if(e[r]&&qa(e[r],t)){i=e[r],e[r]=null;break}i&&(r=i)}if(r)Zi(r);else{const e=Wa(t);r=this.createTextTrack(e,t.name,t.lang),r&&(r.mode="disabled")}r&&this.textTracks.push(r)})),null!=e&&e.length){const t=e.filter((t=>null!==t)).map((t=>t.label));t.length&&Bt.warn(`Media element contains unused subtitle tracks: ${t.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const t=this.tracks.map((t=>({label:t.name,kind:t.type.toLowerCase(),default:t.default,subtitleTrack:t})));this.hls.trigger(It.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:t})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach((t=>{const e=/(?:CC|SERVICE)([1-4])/.exec(t.instreamId);if(!e)return;const i=`textTrack${e[1]}`,r=this.captionsProperties[i];r&&(r.label=t.name,t.lang&&(r.languageCode=t.lang),r.media=t)}))}closedCaptionsForLevel(t){const e=this.hls.levels[t.level];return null==e?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){if(this.enabled&&e.frag.type===Hi){var i,r;const{cea608Parser1:t,cea608Parser2:s,lastSn:n}=this,{cc:a,sn:o}=e.frag,l=null!=(i=null==(r=e.part)?void 0:r.index)?i:-1;t&&s&&(o!==n+1||o===n&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(t.reset(),s.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(t,e){const{frag:i,payload:r}=e;if(i.type===Ki)if(r.byteLength){const t=i.decryptdata,s="stats"in e;if(null==t||!t.encrypted||s){const t=this.tracks[i.level],s=this.vttCCs;s[i.cc]||(s[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),t&&t.textCodec===Oa?this._parseIMSC1(i,r):this._parseVTTs(e)}}else this.hls.trigger(It.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(t,e){const i=this.hls;$a(e,this.initPTS[t.cc],(e=>{this._appendCues(e,t.level),i.trigger(It.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})}),(e=>{Bt.log(`Failed to parse IMSC1: ${e}`),i.trigger(It.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:e})}))}_parseVTTs(t){var e;const{frag:i,payload:r}=t,{initPTS:s,unparsedVttFrags:n}=this,a=s.length-1;if(!s[i.cc]&&-1===a)return void n.push(t);const o=this.hls;Fa(null!=(e=i.initSegment)&&e.data?ti(i.initSegment.data,new Uint8Array(r)):r,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,(t=>{this._appendCues(t,i.level),o.trigger(It.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})}),(e=>{const s="Missing initPTS for VTT MPEGTS"===e.message;s?n.push(t):this._fallbackToIMSC1(i,r),Bt.log(`Failed to parse VTT cue: ${e}`),s&&a>i.cc||o.trigger(It.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:e})}))}_fallbackToIMSC1(t,e){const i=this.tracks[t.level];i.textCodec||$a(e,this.initPTS[t.cc],(()=>{i.textCodec=Oa,this._parseIMSC1(t,e)}),(()=>{i.textCodec="wvtt"}))}_appendCues(t,e){const i=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[e];if(!i||"disabled"===i.mode)return;t.forEach((t=>Xi(i,t)))}else{const r=this.tracks[e];if(!r)return;const s=r.default?"default":"subtitles"+e;i.trigger(It.CUES_PARSED,{type:"subtitles",cues:t,track:s})}}onFragDecrypted(t,e){const{frag:i}=e;i.type===Ki&&this.onFragLoaded(It.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:r}=this;if(!this.enabled||!i||!r)return;const{frag:s,samples:n}=e;if(s.type!==Hi||"NONE"!==this.closedCaptionsForLevel(s))for(let t=0;t<n.length;t++){const e=n[t].bytes;if(e){const s=this.extractCea608Data(e);i.addData(n[t].pts,s[0]),r.addData(n[t].pts,s[1])}}}onBufferFlushing(t,{startOffset:e,endOffset:i,endOffsetSubtitles:r,type:s}){const{media:n}=this;if(n&&!(n.currentTime<i)){if(!s||"video"===s){const{captionsTracks:t}=this;Object.keys(t).forEach((r=>Qi(t[r],e,i)))}if(this.config.renderTextTracksNatively&&0===e&&void 0!==r){const{textTracks:t}=this;Object.keys(t).forEach((i=>Qi(t[i],e,r)))}}}extractCea608Data(t){const e=[[],[]],i=31&t[0];let r=2;for(let s=0;s<i;s++){const i=t[r++],s=127&t[r++],n=127&t[r++];if(0===s&&0===n)continue;if(0!=(4&i)){const t=3&i;0!==t&&1!==t||(e[t].push(s),e[t].push(n))}}return e}},audioStreamController:class extends Ns{constructor(t,e,i){super(t,e,i,"[audio-stream-controller]",Vi),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.LEVEL_LOADED,this.onLevelLoaded,this),t.on(It.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(It.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(It.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(It.ERROR,this.onError,this),t.on(It.BUFFER_RESET,this.onBufferReset,this),t.on(It.BUFFER_CREATED,this.onBufferCreated,this),t.on(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(It.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(It.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.LEVEL_LOADED,this.onLevelLoaded,this),t.off(It.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(It.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(It.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(It.ERROR,this.onError,this),t.off(It.BUFFER_RESET,this.onBufferReset,this),t.off(It.BUFFER_CREATED,this.onBufferCreated,this),t.off(It.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(It.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(It.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(t,{frag:e,id:i,initPTS:r,timescale:s}){if("main"===i){const t=e.cc;this.initPTS[e.cc]={baseTime:r,timescale:s},this.log(`InitPTS for cc: ${t} found from main: ${r}`),this.videoTrackCC=t,this.state===Os&&this.tick()}}startLoad(t){if(!this.levels)return this.startPosition=t,void(this.state=xs);const e=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),e>0&&-1===t?(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e,this.state=ks):(this.loadedmetadata=!1,this.state=Cs),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}doTick(){switch(this.state){case ks:this.doTickIdle();break;case Cs:{var t;const{levels:e,trackId:i}=this,r=null==e||null==(t=e[i])?void 0:t.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=Os}break}case Is:{var e;const t=performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){const{levels:t,trackId:e}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==t?void 0:t[e])||null),this.state=ks}break}case Os:{const t=this.waitingData;if(t){const{frag:e,part:i,cache:r,complete:s}=t;if(void 0!==this.initPTS[e.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=Ds;const t={frag:e,part:i,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(t),s&&super._handleFragmentLoadComplete(t)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${e.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const t=this.getLoadPosition(),i=ds.bufferInfo(this.mediaBuffer,t,this.config.maxBufferHole);Ur(i.end,this.config.maxFragLookUpTolerance,e)<0&&(this.log(`Waiting fragment cc (${e.cc}) @ ${e.start} cancelled because another fragment at ${i.end} is needed`),this.clearWaitingFragment())}}else this.state=ks}}this.onTickEnd()}clearWaitingFragment(){const t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=ks)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:t}=this;null!=t&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){const{hls:t,levels:e,media:i,trackId:r}=this,s=t.config;if(!i&&(this.startFragRequested||!s.startFragPrefetch)||null==e||!e[r])return;const n=e[r],a=n.details;if(!a||a.live&&this.levelLastLoaded!==n||this.waitForCdnTuneIn(a))return void(this.state=Cs);const o=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&o&&(this.bufferFlushed=!1,this.afterBufferFlushed(o,Kt,Vi));const l=this.getFwdBufferInfo(o,Vi);if(null===l)return;const{bufferedTrack:h,switchingTrack:d}=this;if(!d&&this._streamEnded(l,a))return t.trigger(It.BUFFER_EOS,{type:"audio"}),void(this.state=Ms);const c=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,Hi),u=l.len,f=this.getMaxBufferLength(null==c?void 0:c.len),p=a.fragments,m=p[0].start;let g=this.flushing?this.getLoadPosition():l.end;if(d&&i){const t=this.getLoadPosition();h&&!Xn(d.attrs,h.attrs)&&(g=t),a.PTSKnown&&t<m&&(l.end>m||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=m+.05)}if(u>=f&&!d&&g<p[p.length-1].start)return;let y=this.getNextFragment(g,a),v=!1;if(y&&this.isLoopLoading(y,g)&&(v=!!y.gap,y=this.getNextFragmentLoopLoading(y,a,l,Hi,f)),!y)return void(this.bufferFlushed=!0);const _=c&&y.start>c.end+a.targetduration;if(_||(null==c||!c.len)&&l.len){const t=this.getAppendedFrag(y.start,Hi);if(null===t)return;if(v||(v=!!t.gap||!!_&&0===c.len),_&&!v||v&&l.nextStart&&l.nextStart<t.end)return}this.loadFragment(y,n,g)}getMaxBufferLength(t){const e=super.getMaxBufferLength();return t?Math.min(Math.max(e,t),this.config.maxMaxBufferLength):e}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(t,{audioTracks:e}){this.resetTransmuxer(),this.levels=e.map((t=>new gr(t)))}onAudioTrackSwitching(t,e){const i=!!e.url;this.trackId=e.id;const{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?this.setInterval(100):this.resetTransmuxer(),i?(this.switchingTrack=e,this.state=ks,this.flushAudioIfNeeded(e)):(this.switchingTrack=null,this.bufferedTrack=e,this.state=xs),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(t,e){this.mainDetails=e.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(It.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(t,e){var i;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=e);const{levels:r}=this,{details:s,id:n}=e;if(!r)return void this.warn(`Audio tracks were reset while loading level ${n}`);this.log(`Audio track ${n} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const a=r[n];let o=0;if(s.live||null!=(i=a.details)&&i.live){this.checkLiveUpdate(s);const t=this.mainDetails;if(s.deltaUpdateFailed||!t)return;var l;if(!a.details&&s.hasProgramDateTime&&t.hasProgramDateTime)gs(s,t),o=s.fragments[0].start;else o=this.alignPlaylists(s,a.details,null==(l=this.levelLastLoaded)?void 0:l.details)}a.details=s,this.levelLastLoaded=a,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(this.mainDetails||s,o),this.state!==Cs||this.waitForCdnTuneIn(s)||(this.state=ks),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{config:n,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const h=l.details;if(!h)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(i.start);const d=n.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let c=this.transmuxer;c||(c=this.transmuxer=new Wn(this.hls,Vi,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[i.cc],f=null==(e=i.initSegment)?void 0:e.data;if(void 0!==u){const t=!1,e=r?r.index:-1,n=-1!==e,a=new cs(i.level,i.sn,i.stats.chunkCount,s.byteLength,e,n);c.push(s,f,d,"",i,r,h.totalduration,t,a,u)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${h.startSN} ,${h.endSN}],track ${a}`);const{cache:t}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new Gs,complete:!1};t.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=Os}}_handleFragmentLoadComplete(t){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(t,e){const i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),e.tracks.video&&(this.videoBuffer=e.tracks.video.buffer||null)}onFragBuffered(t,e){const{frag:i,part:r}=e;if(i.type===Vi)if(this.fragContextChanged(i))this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==i.sn){this.fragPrevious=i;const t=this.switchingTrack;t&&(this.bufferedTrack=t,this.switchingTrack=null,this.hls.trigger(It.AUDIO_TRACK_SWITCHED,wt({},t)))}this.fragBufferedComplete(i,r)}else if(!this.loadedmetadata&&i.type===Hi){const t=this.videoBuffer||this.media;if(t){ds.getBuffered(t).length&&(this.loadedmetadata=!0)}}}onError(t,e){var i;if(e.fatal)this.state=Fs;else switch(e.details){case Ut.FRAG_GAP:case Ut.FRAG_PARSING_ERROR:case Ut.FRAG_DECRYPT_ERROR:case Ut.FRAG_LOAD_ERROR:case Ut.FRAG_LOAD_TIMEOUT:case Ut.KEY_LOAD_ERROR:case Ut.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(Vi,e);break;case Ut.AUDIO_TRACK_LOAD_ERROR:case Ut.AUDIO_TRACK_LOAD_TIMEOUT:case Ut.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==Cs||(null==(i=e.context)?void 0:i.type)!==$i||(this.state=ks);break;case Ut.BUFFER_APPEND_ERROR:case Ut.BUFFER_FULL_ERROR:if(!e.parent||"audio"!==e.parent)return;if(e.details===Ut.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case Ut.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}onBufferFlushing(t,{type:e}){e!==Yt&&(this.flushing=!0)}onBufferFlushed(t,{type:e}){if(e!==Yt){this.flushing=!1,this.bufferFlushed=!0,this.state===Ms&&(this.state=ks);const t=this.mediaBuffer||this.media;t&&(this.afterBufferFlushed(t,e,Vi),this.tick())}}_handleTransmuxComplete(t){var e;const i="audio",{hls:r}=this,{remuxResult:s,chunkMeta:n}=t,a=this.getCurrentContext(n);if(!a)return void this.resetWhenMissingContext(n);const{frag:o,part:l,level:h}=a,{details:d}=h,{audio:c,text:u,id3:f,initSegment:p}=s;if(!this.fragContextChanged(o)&&d){if(this.state=Us,this.switchingTrack&&c&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){const t=o.initSegment||o;this._bufferInitSegment(h,p.tracks,t,n),r.trigger(It.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:p.tracks})}if(c){const{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=c;l&&(l.elementaryStreams[Kt]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(Kt,t,e,i,r),this.bufferFragmentData(c,o,l,n)}if(null!=f&&null!=(e=f.samples)&&e.length){const t=xt({id:i,frag:o,details:d},f);r.trigger(It.FRAG_PARSING_METADATA,t)}if(u){const t=xt({id:i,frag:o,details:d},u);r.trigger(It.FRAG_PARSING_USERDATA,t)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(t,e,i,r){if(this.state!==Us)return;e.video&&delete e.video;const s=e.audio;if(!s)return;s.id="audio";const n=t.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${n}/${s.codec}]`),n&&1===n.split(",").length&&(s.levelCodec=n),this.hls.trigger(It.BUFFER_CODECS,e);const a=s.initSegment;if(null!=a&&a.byteLength){const t={type:"audio",frag:i,part:null,chunkMeta:r,parent:i.type,data:a};this.hls.trigger(It.BUFFER_APPENDING,t)}this.tickImmediate()}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);var s;if(this.fragCurrent=t,this.switchingTrack||r===is||r===ss)if("initSegment"===t.sn)this._loadInitSegment(t,e);else if(null!=(s=e.details)&&s.live&&!this.initPTS[t.cc]){this.log(`Waiting for video PTS in continuity counter ${t.cc} of live stream before loading audio fragment ${t.sn} of level ${this.trackId}`),this.state=Os;const i=this.mainDetails;i&&i.fragments[0].start!==e.details.fragments[0].start&&gs(e.details,i)}else this.startFragRequested=!0,super.loadFragment(t,e,i);else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){const{media:e,bufferedTrack:i}=this,r=null==i?void 0:i.attrs,s=t.attrs;e&&r&&(r.CHANNELS!==s.CHANNELS||i.name!==t.name||i.lang!==t.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(t){const{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(It.AUDIO_TRACK_SWITCHED,wt({},t))}},audioTrackController:class extends zr{constructor(t){super(t,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:t}=this;t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.LEVEL_LOADING,this.onLevelLoading,this),t.on(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(It.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(It.ERROR,this.onError,this)}unregisterListeners(){const{hls:t}=this;t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.LEVEL_LOADING,this.onLevelLoading,this),t.off(It.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(It.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(It.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){const{id:i,groupId:r,details:s}=e,n=this.tracksInGroup[i];if(!n||n.groupId!==r)return void this.warn(`Audio track with id:${i} and group:${r} not found in active group ${null==n?void 0:n.groupId}`);const a=n.details;n.details=e.details,this.log(`Audio track ${i} "${n.name}" lang:${n.lang} group:${r} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,e,a)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){const e=this.hls.levels[t];if(!e)return;const i=e.audioGroups||null,r=this.groupIds;let s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some((t=>-1===(null==r?void 0:r.indexOf(t))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const t=this.tracks.filter((t=>!i||-1!==i.indexOf(t.groupId)));if(t.length)this.selectDefaultTrack&&!t.some((t=>t.default))&&(this.selectDefaultTrack=!1),t.forEach(((t,e)=>{t.id=e}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=t;const e=this.hls.config.audioPreference;if(!s&&e){const i=Zr(e,t,Jr);if(i>-1)s=t[i];else{const t=Zr(e,this.tracks);s=this.tracks[t]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null));const a={audioTracks:t};this.log(`Updating audio tracks, ${t.length} track(s) found in group(s): ${null==i?void 0:i.join(",")}`),this.hls.trigger(It.AUDIO_TRACKS_UPDATED,a);const o=this.trackId;if(-1!==r&&-1===o)this.setAudioTrack(r);else if(t.length&&-1===o){var n;const e=new Error(`No audio track selected for current audio group-ID(s): ${null==(n=this.groupIds)?void 0:n.join(",")} track count: ${t.length}`);this.warn(e.message),this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:e})}}else this.shouldReloadPlaylist(s)&&this.setAudioTrack(this.trackId)}onError(t,e){!e.fatal&&e.context&&(e.context.type!==$i||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||(this.requestScheduled=-1,this.checkRetry(e)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){const e=this.hls;if(e.config.audioPreference=t,t){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const r=this.currentTrack;if(r&&Qr(t,r,Jr))return r;const s=Zr(t,this.tracksInGroup,Jr);if(s>-1){const t=this.tracksInGroup[s];return this.setAudioTrack(s),t}if(r){let r=e.loadLevel;-1===r&&(r=e.firstAutoLevel);const s=function(t,e,i,r,s){const n=e[r],a=e.reduce(((t,e,i)=>{const r=e.uri;return(t[r]||(t[r]=[])).push(i),t}),{})[n.uri];a.length>1&&(r=Math.max.apply(Math,a));const o=n.videoRange,l=n.frameRate,h=n.codecSet.substring(0,4),d=ts(e,r,(e=>{if(e.videoRange!==o||e.frameRate!==l||e.codecSet.substring(0,4)!==h)return!1;const r=e.audioGroups,n=i.filter((t=>!r||-1!==r.indexOf(t.groupId)));return Zr(t,n,s)>-1}));return d>-1?d:ts(e,r,(e=>{const r=e.audioGroups,n=i.filter((t=>!r||-1!==r.indexOf(t.groupId)));return Zr(t,n,s)>-1}))}(t,e.levels,i,r,Jr);if(-1===s)return null;e.nextLoadLevel=s}if(t.channels||t.audioCodec){const e=Zr(t,i);if(e>-1)return i[e]}}}return null}setAudioTrack(t){const e=this.tracksInGroup;if(t<0||t>=e.length)return void this.warn(`Invalid audio track id: ${t}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,r=e[t],s=r.details&&!r.details.live;if(t===this.trackId&&r===i&&s)return;if(this.log(`Switching to audio-track ${t} "${r.name}" lang:${r.lang} group:${r.groupId} channels:${r.channels}`),this.trackId=t,this.currentTrack=r,this.hls.trigger(It.AUDIO_TRACK_SWITCHING,wt({},r)),s)return;const n=this.switchParams(r.url,null==i?void 0:i.details,r.details);this.loadPlaylist(n)}findTrackId(t){const e=this.tracksInGroup;for(let i=0;i<e.length;i++){const r=e[i];if((!this.selectDefaultTrack||r.default)&&(!t||Qr(t,r,Jr)))return i}if(t){const{name:i,lang:r,assocLang:s,characteristics:n,audioCodec:a,channels:o}=t;for(let t=0;t<e.length;t++){if(Qr({name:i,lang:r,assocLang:s,characteristics:n,audioCodec:a,channels:o},e[t],Jr))return t}for(let i=0;i<e.length;i++){const r=e[i];if(Xn(t.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){const r=e[i];if(Xn(t.attrs,r.attrs,["LANGUAGE"]))return i}}return-1}loadPlaylist(t){const e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){super.loadPlaylist();const i=e.id,r=e.groupId;let s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}this.log(`loading audio-track playlist ${i} "${e.name}" lang:${e.lang} group:${r}`),this.clearTimer(),this.hls.trigger(It.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}},emeController:Qa,cmcdController:class{constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=t=>{try{this.apply(t,{ot:to.MANIFEST,su:!this.initialized})}catch(t){Bt.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=t=>{try{const e=t.frag,i=this.hls.levels[e.level],r=this.getObjectType(e),s={d:1e3*e.duration,ot:r};r!==to.VIDEO&&r!==to.AUDIO&&r!=to.MUXED||(s.br=i.bitrate/1e3,s.tb=this.getTopBandwidth(r)/1e3,s.bl=this.getBufferLength(r)),this.apply(t,s)}catch(t){Bt.warn("Could not generate segment CMCD data.",t)}},this.hls=t;const e=this.config=t.config,{cmcd:i}=e;null!=i&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||function(){try{return crypto.randomUUID()}catch(t){try{const t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}catch(t){let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)}))}}}(),this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const t=this.hls;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHED,this.onMediaDetached,this),t.on(It.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const t=this.hls;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHED,this.onMediaDetached,this),t.off(It.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,r;this.audioBuffer=null==(i=e.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(r=e.tracks.video)?void 0:r.buffer}createData(){var t;return{v:1,sf:eo.HLS,sid:this.sid,cid:this.cid,pr:null==(t=this.media)?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t,e={}){xt(e,this.createData());const i=e.ot===to.INIT||e.ot===to.VIDEO||e.ot===to.MUXED;this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),null==e.su&&(e.su=this.buffering);const{includeKeys:r}=this;r&&(e=Object.keys(e).reduce(((t,i)=>(r.includes(i)&&(t[i]=e[i]),t)),{})),this.useHeaders?(t.headers||(t.headers={}),Mo(t.headers,e)):t.url=Bo(t.url,e)}getObjectType(t){const{type:e}=t;return"subtitle"===e?to.TIMED_TEXT:"initSegment"===t.sn?to.INIT:"audio"===e?to.AUDIO:"main"===e?this.hls.audioTracks.length?to.VIDEO:to.MUXED:void 0}getTopBandwidth(t){let e,i=0;const r=this.hls;if(t===to.AUDIO)e=r.audioTracks;else{const t=r.maxAutoLevel,i=t>-1?t+1:r.levels.length;e=r.levels.slice(0,i)}for(const t of e)t.bitrate>i&&(i=t.bitrate);return i>0?i:NaN}getBufferLength(t){const e=this.hls.media,i=t===to.AUDIO?this.audioBuffer:this.videoBuffer;if(!i||!e)return NaN;return 1e3*ds.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}}}createFragmentLoader(){const{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{constructor(t){this.loader=void 0,this.loader=new i(t)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}}}},contentSteeringController:class{constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=Bt.log.bind(Bt,"[content-steering]:"),this.registerListeners()}registerListeners(){const t=this.hls;t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.ERROR,this.onError,this)}unregisterListeners(){const t=this.hls;t&&(t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const t=1e3*this.timeToLoad-(performance.now()-this.updated);if(t>0)return void this.scheduleRefresh(this.uri,t)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){const e=this.levels;e&&(this.levels=e.filter((e=>e!==t)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){const{contentSteering:i}=e;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){const{errorAction:i}=e;if((null==i?void 0:i.action)===Fr&&i.flags===Gr){const t=this.levels;let r=this.pathwayPriority,s=this.pathwayId;if(e.context){const{groupId:i,pathwayId:r,type:n}=e.context;i&&t?s=this.getPathwayForGroupId(i,n,s):r&&(s=r)}s in this.penalizedPathways||(this.penalizedPathways[s]=performance.now()),!r&&t&&(r=t.reduce(((t,e)=>(-1===t.indexOf(e.pathwayId)&&t.push(e.pathwayId),t)),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==s),i.resolved||Bt.warn(`Could not resolve ${e.details} ("${e.error.message}") with content-steering for Pathway: ${s} levels: ${t?t.length:t} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(0===e.length){const i=t[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length&&this.log(`Found ${e.length}/${t.length} levels in Pathway "${this.pathwayId}"`),e}getLevelsForPathway(t){return null===this.levels?[]:this.levels.filter((e=>t===e.pathwayId))}updatePathwayPriority(t){let e;this.pathwayPriority=t;const i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach((t=>{r-i[t]>3e5&&delete i[t]}));for(let r=0;r<t.length;r++){const s=t[r];if(s in i)continue;if(s===this.pathwayId)return;const n=this.hls.nextLoadLevel,a=this.hls.levels[n];if(e=this.getLevelsForPathway(s),e.length>0){this.log(`Setting Pathway to "${s}"`),this.pathwayId=s,Lr(e),this.hls.trigger(It.LEVELS_UPDATED,{levels:e});const t=this.hls.levels[n];a&&t&&this.levels&&(t.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&t.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${t.bitrate}`),this.hls.nextLoadLevel=n);break}}}getPathwayForGroupId(t,e,i){const r=this.getLevelsForPathway(i).concat(this.levels||[]);for(let i=0;i<r.length;i++)if(e===$i&&r[i].hasAudioGroup(t)||e===zi&&r[i].hasSubtitleGroup(t))return r[i].pathwayId;return i}clonePathways(t){const e=this.levels;if(!e)return;const i={},r={};t.forEach((t=>{const{ID:s,"BASE-ID":n,"URI-REPLACEMENT":a}=t;if(e.some((t=>t.pathwayId===s)))return;const o=this.getLevelsForPathway(n).map((t=>{const e=new $t(t.attrs);e["PATHWAY-ID"]=s;const n=e.AUDIO&&`${e.AUDIO}_clone_${s}`,o=e.SUBTITLES&&`${e.SUBTITLES}_clone_${s}`;n&&(i[e.AUDIO]=n,e.AUDIO=n),o&&(r[e.SUBTITLES]=o,e.SUBTITLES=o);const l=Go(t.uri,e["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),h=new gr({attrs:e,audioCodec:t.audioCodec,bitrate:t.bitrate,height:t.height,name:t.name,url:l,videoCodec:t.videoCodec,width:t.width});if(t.audioGroups)for(let e=1;e<t.audioGroups.length;e++)h.addGroupId("audio",`${t.audioGroups[e]}_clone_${s}`);if(t.subtitleGroups)for(let e=1;e<t.subtitleGroups.length;e++)h.addGroupId("text",`${t.subtitleGroups[e]}_clone_${s}`);return h}));e.push(...o),No(this.audioTracks,i,a,s),No(this.subtitleTracks,r,a,s)}))}loadSteeringManifest(t){const e=this.hls.config,i=e.loader;let r;this.loader&&this.loader.destroy(),this.loader=new i(e);try{r=new self.URL(t)}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${t}`)}if("data:"!==r.protocol){const t=0|(this.hls.bandwidthEstimate||e.abrEwmaDefaultEstimate);r.searchParams.set("_HLS_pathway",this.pathwayId),r.searchParams.set("_HLS_throughput",""+t)}const s={responseType:"json",url:r.href},n=e.steeringManifestLoadPolicy.default,a=n.errorRetry||n.timeoutRetry||{},o={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(t,e,i,s)=>{this.log(`Loaded steering manifest: "${r}"`);const n=t.data;if(1!==n.VERSION)return void this.log(`Steering VERSION ${n.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=n.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":l}=n;if(a)try{this.uri=new self.URL(a,r).href}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||i.url),o&&this.clonePathways(o);const h={steeringManifest:n,url:r.toString()};this.hls.trigger(It.STEERING_MANIFEST_LOADED,h),l&&this.updatePathwayPriority(l)},onError:(t,e,i,r)=>{if(this.log(`Error loading steering manifest: ${t.code} ${t.text} (${e.url})`),this.stopLoad(),410===t.code)return this.enabled=!1,void this.log(`Steering manifest ${e.url} no longer available`);let s=1e3*this.timeToLoad;if(429!==t.code)this.scheduleRefresh(this.uri||e.url,s);else{const t=this.loader;if("function"==typeof(null==t?void 0:t.getResponseHeader)){const e=t.getResponseHeader("Retry-After");e&&(s=1e3*parseFloat(e))}this.log(`Steering manifest ${e.url} rate limited`)}},onTimeout:(t,e,i)=>{this.log(`Timeout loading steering manifest (${e.url})`),this.scheduleRefresh(this.uri||e.url)}};this.log(`Requesting steering manifest: ${r}`),this.loader.load(s,o,l)}scheduleRefresh(t,e=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout((()=>{var e;const i=null==(e=this.hls)?void 0:e.media;!i||i.ended?this.scheduleRefresh(t,1e3*this.timeToLoad):this.loadSteeringManifest(t)}),e)}}});function Xo(t){return t&&"object"==typeof t?Array.isArray(t)?t.map(Xo):Object.keys(t).reduce(((e,i)=>(e[i]=Xo(t[i]),e)),{}):t}function Zo(t){const e=t.loader;if(e!==Vo&&e!==zo)Bt.log("[config]: Custom loader detected, cannot enable progressive streaming"),t.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1})()&&(t.loader=Vo,t.progressive=!0,t.enableSoftwareAES=!0,Bt.log("[config]: Progressive streaming enabled, using FetchLoader"))}}let Qo;class Jo extends zr{constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(It.LEVEL_LOADED,this.onLevelLoaded,this),t.on(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this),t.on(It.ERROR,this.onError,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(It.LEVEL_LOADED,this.onLevelLoaded,this),t.off(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this),t.off(It.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((t=>{t.loadError=0,t.fragmentError=0})),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){const i=this.hls.config.preferManagedMediaSource,r=[],s={},n={};let a=!1,o=!1,l=!1;e.levels.forEach((t=>{var e,h;const d=t.attrs;let{audioCodec:c,videoCodec:u}=t;-1!==(null==(e=c)?void 0:e.indexOf("mp4a.40.34"))&&(Qo||(Qo=/chrome|firefox/i.test(navigator.userAgent)),Qo&&(t.audioCodec=c=void 0)),c&&(t.audioCodec=c=wi(c,i)),0===(null==(h=u)?void 0:h.indexOf("avc1"))&&(u=t.videoCodec=function(t){const e=t.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");if(i.length>2){let r=i.shift()+".";r+=parseInt(i.shift()).toString(16),r+=("000"+parseInt(i.shift()).toString(16)).slice(-4),e[t]=r}}return e.join(",")}(u));const{width:f,height:p,unknownCodecs:m}=t;if(a||(a=!(!f||!p)),o||(o=!!u),l||(l=!!c),null!=m&&m.length||c&&!yi(c,"audio",i)||u&&!yi(u,"video",i))return;const{CODECS:g,"FRAME-RATE":y,"HDCP-LEVEL":v,"PATHWAY-ID":_,RESOLUTION:S,"VIDEO-RANGE":T}=d,E=`${`${_||"."}-`}${t.bitrate}-${S}-${y}-${g}-${T}-${v}`;if(s[E])if(s[E].uri===t.url||t.attrs["PATHWAY-ID"])s[E].addGroupId("audio",d.AUDIO),s[E].addGroupId("text",d.SUBTITLES);else{const e=n[E]+=1;t.attrs["PATHWAY-ID"]=new Array(e+1).join(".");const i=new gr(t);s[E]=i,r.push(i)}else{const e=new gr(t);s[E]=e,n[E]=1,r.push(e)}})),this.filterAndSortMediaOptions(r,e,a,o,l)}filterAndSortMediaOptions(t,e,i,r,s){let n=[],a=[],o=t;if((i||r)&&s&&(o=o.filter((({videoCodec:t,videoRange:e,width:i,height:r})=>{return(!!t||!(!i||!r))&&(!!(s=e)&&dr.indexOf(s)>-1);var s}))),0===o.length)return void Promise.resolve().then((()=>{if(this.hls){e.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(e.levels[0].attrs)}`);const t=new Error("no level with compatible codecs found in manifest");this.hls.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:t,reason:t.message})}}));if(e.audioTracks){const{preferManagedMediaSource:t}=this.hls.config;n=e.audioTracks.filter((e=>!e.audioCodec||yi(e.audioCodec,"audio",t))),tl(n)}e.subtitles&&(a=e.subtitles,tl(a));const l=o.slice(0);o.sort(((t,e)=>{if(t.attrs["HDCP-LEVEL"]!==e.attrs["HDCP-LEVEL"])return(t.attrs["HDCP-LEVEL"]||"")>(e.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&t.height!==e.height)return t.height-e.height;if(t.frameRate!==e.frameRate)return t.frameRate-e.frameRate;if(t.videoRange!==e.videoRange)return dr.indexOf(t.videoRange)-dr.indexOf(e.videoRange);if(t.videoCodec!==e.videoCodec){const i=Si(t.videoCodec),r=Si(e.videoCodec);if(i!==r)return r-i}if(t.uri===e.uri&&t.codecSet!==e.codecSet){const i=Ti(t.codecSet),r=Ti(e.codecSet);if(i!==r)return r-i}return t.averageBitrate!==e.averageBitrate?t.averageBitrate-e.averageBitrate:0}));let h=l[0];if(this.steering&&(o=this.steering.filterParsedLevels(o),o.length!==l.length))for(let t=0;t<l.length;t++)if(l[t].pathwayId===o[0].pathwayId){h=l[t];break}this._levels=o;for(let t=0;t<o.length;t++)if(o[t]===h){var d;this._firstLevel=t;const e=h.bitrate,i=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${o.length} level(s) found, first bitrate: ${e}`),void 0===(null==(d=this.hls.userConfig)?void 0:d.abrEwmaDefaultEstimate)){const t=Math.min(e,this.hls.config.abrEwmaDefaultEstimateMax);t>i&&i===qo.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=t)}break}const c=s&&!r,u={levels:o,audioTracks:n,subtitleTracks:a,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:s,video:r,altAudio:!c&&n.some((t=>!!t.url))};this.hls.trigger(It.MANIFEST_PARSED,u),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(t){const e=this._levels;if(0===e.length)return;if(t<0||t>=e.length){const i=new Error("invalid level idx"),r=t<0;if(this.hls.trigger(It.ERROR,{type:Ct.OTHER_ERROR,details:Ut.LEVEL_SWITCH_ERROR,level:t,fatal:r,error:i,reason:i.message}),r)return;t=Math.min(t,e.length-1)}const i=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,n=e[t],a=n.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=n,i===t&&n.details&&r&&s===a)return;this.log(`Switching to level ${t} (${n.height?n.height+"p ":""}${n.videoRange?n.videoRange+" ":""}${n.codecSet?n.codecSet+" ":""}@${n.bitrate})${a?" with Pathway "+a:""} from level ${i}${s?" with Pathway "+s:""}`);const o={level:t,attrs:n.attrs,details:n.details,bitrate:n.bitrate,averageBitrate:n.averageBitrate,maxBitrate:n.maxBitrate,realBitrate:n.realBitrate,width:n.width,height:n.height,codecSet:n.codecSet,audioCodec:n.audioCodec,videoCodec:n.videoCodec,audioGroups:n.audioGroups,subtitleGroups:n.subtitleGroups,loaded:n.loaded,loadError:n.loadError,fragmentError:n.fragmentError,name:n.name,id:n.id,uri:n.uri,url:n.url,urlId:0,audioGroupIds:n.audioGroupIds,textGroupIds:n.textGroupIds};this.hls.trigger(It.LEVEL_SWITCHING,o);const l=n.details;if(!l||l.live){const t=this.switchParams(n.uri,null==r?void 0:r.details,l);this.loadPlaylist(t)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,void 0===this._startLevel&&(this._startLevel=t),-1!==t&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(void 0===this._startLevel){const t=this.hls.config.startLevel;return void 0!==t?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){!e.fatal&&e.context&&e.context.type===Gi&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,{frag:e}){if(void 0!==e&&e.type===Hi){const t=e.elementaryStreams;if(!Object.keys(t).some((e=>!!t[e])))return;const i=this._levels[e.level];null!=i&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(t,e){var i;const{level:r,details:s}=e,n=this._levels[r];var a;if(!n)return this.warn(`Invalid level index ${r}`),void(null!=(a=e.deliveryDirectives)&&a.skip&&(s.deltaUpdateFailed=!0));r===this.currentLevelIndex?(0===n.fragmentError&&(n.loadError=0),this.playlistLoaded(r,e,n.details)):null!=(i=e.deliveryDirectives)&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist();const e=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let r=i.uri;if(t)try{r=t.addDirectives(r)}catch(t){this.warn(`Could not construct new URL with HLS Delivery Directives: ${t}`)}const s=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${e}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""} with${s?" Pathway "+s:""} ${r}`),this.clearTimer(),this.hls.trigger(It.LEVEL_LOADING,{url:r,level:e,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;const i=this._levels.filter(((e,i)=>i!==t||(this.steering&&this.steering.removeLevel(e),e===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,e.details&&e.details.fragments.forEach((t=>t.level=-1))),!1)));Lr(i),this._levels=i,this.currentLevelIndex>-1&&null!=(e=this.currentLevel)&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(It.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(t,{levels:e}){this._levels=e}checkMaxAutoUpdated(){const{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(It.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function tl(t){const e={};t.forEach((t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++}))}class el{constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}abort(t){for(const i in this.keyUriToKeyInfo){const r=this.keyUriToKeyInfo[i].loader;if(r){var e;if(t&&t!==(null==(e=r.context)?void 0:e.frag.type))return;r.abort()}}}detach(){for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){this.detach();for(const t in this.keyUriToKeyInfo){const e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t,e=Ut.KEY_LOAD_ERROR,i,r,s){return new Ts({type:Ct.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:s,error:i,networkDetails:r})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:r}=t;for(let t=0;t<e.length;t++){const s=e[t];if(r<=s.cc&&("initSegment"===i||"initSegment"===s.sn||i<s.sn)){this.emeController.selectKeySystemFormat(s).then((t=>{s.setKeyFormat(t)}));break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(t).then((e=>this.loadInternal(t,e))):this.loadInternal(t)}loadInternal(t,e){var i,r;e&&t.setKeyFormat(e);const s=t.decryptdata;if(!s){const i=new Error(e?`Expected frag.decryptdata to be defined after setting format ${e}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,Ut.KEY_LOAD_ERROR,i))}const n=s.uri;if(!n)return Promise.reject(this.createKeyLoadError(t,Ut.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${n}"`)));let a=this.keyUriToKeyInfo[n];if(null!=(i=a)&&i.decryptdata.key)return s.key=a.decryptdata.key,Promise.resolve({frag:t,keyInfo:a});var o;if(null!=(r=a)&&r.keyLoadPromise)switch(null==(o=a.mediaKeySessionContext)?void 0:o.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then((e=>(s.key=e.keyInfo.decryptdata.key,{frag:t,keyInfo:a})))}switch(a=this.keyUriToKeyInfo[n]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===s.keyFormat?this.loadKeyHTTP(a,t):this.loadKeyEME(a,t);case"AES-128":return this.loadKeyHTTP(a,t);default:return Promise.reject(this.createKeyLoadError(t,Ut.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(t,e){const i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){const e=this.emeController.loadKey(i);if(e)return(t.keyLoadPromise=e.then((e=>(t.mediaKeySessionContext=e,i)))).catch((e=>{throw t.keyLoadPromise=null,e}))}return Promise.resolve(i)}loadKeyHTTP(t,e){const i=this.config,r=new(0,i.loader)(i);return e.keyLoader=t.loader=r,t.keyLoadPromise=new Promise(((s,n)=>{const a={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},o=i.keyLoadPolicy.default,l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(t,e,i,r)=>{const{frag:a,keyInfo:o,url:l}=i;if(!a.decryptdata||o!==this.keyUriToKeyInfo[l])return n(this.createKeyLoadError(a,Ut.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),r));o.decryptdata.key=a.decryptdata.key=new Uint8Array(t.data),a.keyLoader=null,o.loader=null,s({frag:a,keyInfo:o})},onError:(t,i,r,s)=>{this.resetLoader(i),n(this.createKeyLoadError(e,Ut.KEY_LOAD_ERROR,new Error(`HTTP Error ${t.code} loading key ${t.text}`),r,wt({url:a.url,data:void 0},t)))},onTimeout:(t,i,r)=>{this.resetLoader(i),n(this.createKeyLoadError(e,Ut.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),r))},onAbort:(t,i,r)=>{this.resetLoader(i),n(this.createKeyLoadError(e,Ut.INTERNAL_ABORTED,new Error("key loading aborted"),r))}};r.load(a,l,h)}))}resetLoader(t){const{frag:e,keyInfo:i,url:r}=t,s=i.loader;e.keyLoader===s&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}}function il(){return self.SourceBuffer||self.WebKitSourceBuffer}function rl(){if(!mi())return!1;const t=il();return!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove}class sl{constructor(t,e,i,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=i,this.hls=r}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){const{config:i,media:r,stalled:s}=this;if(null===r)return;const{currentTime:n,seeking:a}=r,o=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,n!==t){if(this.moved=!0,a||(this.nudgeRetry=0),null!==s){if(this.stallReported){const t=self.performance.now()-s;Bt.warn(`playback not stuck anymore @${n}, after ${Math.round(t)}ms`),this.stallReported=!1}this.stalled=null}return}if(l||o)return void(this.stalled=null);if(r.paused&&!a||r.ended||0===r.playbackRate||!ds.getBuffered(r).length)return void(this.nudgeRetry=0);const h=ds.bufferInfo(r,n,0),d=h.nextStart||0;if(a){const t=h.len>2,i=!d||e&&e.start<=n||d-n>2&&!this.fragmentTracker.getPartialFragment(n);if(t||i)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var c;if(!(h.len>0)&&!d)return;const t=Math.max(d,h.start||0)-n,e=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,i=(null==e||null==(c=e.details)?void 0:c.live)?2*e.details.targetduration:2,s=this.fragmentTracker.getPartialFragment(n);if(t>0&&(t<=i||s))return void(r.paused||this._trySkipBufferHole(s))}const u=self.performance.now();if(null===s)return void(this.stalled=u);const f=u-s;if(!a&&f>=250&&(this._reportStall(h),!this.media))return;const p=ds.bufferInfo(r,n,i.maxBufferHole);this._tryFixBufferStall(p,f)}_tryFixBufferStall(t,e){const{config:i,fragmentTracker:r,media:s}=this;if(null===s)return;const n=s.currentTime,a=r.getPartialFragment(n);if(a){if(this._trySkipBufferHole(a)||!this.media)return}(t.len>i.maxBufferHole||t.nextStart&&t.nextStart-n<i.maxBufferHole)&&e>1e3*i.highBufferWatchdogPeriod&&(Bt.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){const{hls:e,media:i,stallReported:r}=this;if(!r&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(t)})`);Bt.warn(r.message),e.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:t.len})}}_trySkipBufferHole(t){const{config:e,hls:i,media:r}=this;if(null===r)return 0;const s=r.currentTime,n=ds.bufferInfo(r,s,0),a=s<n.start?n.start:n.nextStart;if(a){const o=n.len<=e.maxBufferHole,l=n.len>0&&n.len<1&&r.readyState<3,h=a-s;if(h>0&&(o||l)){if(h>e.maxBufferHole){const{fragmentTracker:e}=this;let i=!1;if(0===s){const t=e.getAppendedFrag(0,Hi);t&&a<t.end&&(i=!0)}if(!i){const i=t||e.getAppendedFrag(s,Hi);if(i){let t=!1,r=i.end;for(;r<a;){const i=e.getPartialFragment(r);if(!i){t=!0;break}r+=i.duration}if(t)return 0}}}const n=Math.max(a+.05,s+.1);if(Bt.warn(`skipping hole, adjusting currentTime from ${s} to ${n}`),this.moved=!0,this.stalled=null,r.currentTime=n,t&&!t.gap){const e=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${n}`);i.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:e,reason:e.message,frag:t})}return n}}return 0}_tryNudgeBuffer(){const{config:t,hls:e,media:i,nudgeRetry:r}=this;if(null===i)return;const s=i.currentTime;if(this.nudgeRetry++,r<t.nudgeMaxRetry){const n=s+(r+1)*t.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${s} to ${n}`);Bt.warn(a.message),i.currentTime=n,e.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const i=new Error(`Playhead still not moving while enough data buffered @${s} after ${t.nudgeMaxRetry} nudges`);Bt.error(i.message),e.trigger(It.ERROR,{type:Ct.MEDIA_ERROR,details:Ut.BUFFER_STALLED_ERROR,error:i,fatal:!0})}}}class nl extends Ns{constructor(t,e,i){super(t,e,i,"[stream-controller]",Hi),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:t}=this;t.on(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(It.MANIFEST_LOADING,this.onManifestLoading,this),t.on(It.MANIFEST_PARSED,this.onManifestParsed,this),t.on(It.LEVEL_LOADING,this.onLevelLoading,this),t.on(It.LEVEL_LOADED,this.onLevelLoaded,this),t.on(It.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(It.ERROR,this.onError,this),t.on(It.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(It.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(It.BUFFER_CREATED,this.onBufferCreated,this),t.on(It.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(It.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:t}=this;t.off(It.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(It.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(It.MANIFEST_LOADING,this.onManifestLoading,this),t.off(It.MANIFEST_PARSED,this.onManifestParsed,this),t.off(It.LEVEL_LOADED,this.onLevelLoaded,this),t.off(It.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(It.ERROR,this.onError,this),t.off(It.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(It.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(It.BUFFER_CREATED,this.onBufferCreated,this),t.off(It.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(It.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(It.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(t){if(this.levels){const{lastCurrentTime:e,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let t=i.startLevel;-1===t&&(i.config.testBandwidth&&this.levels.length>1?(t=0,this.bitrateTest=!0):t=i.firstAutoLevel),i.nextLoadLevel=t,this.level=i.loadLevel,this.loadedmetadata=!1}e>0&&-1===t&&(this.log(`Override startPosition with lastCurrentTime @${e.toFixed(3)}`),t=e),this.state=ks,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=xs}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case Bs:{const{levels:t,level:e}=this,i=null==t?void 0:t[e],r=null==i?void 0:i.details;if(r&&(!r.live||this.levelLastLoaded===i)){if(this.waitForCdnTuneIn(r))break;this.state=ks;break}if(this.hls.nextLoadLevel!==this.level){this.state=ks;break}break}case Is:{var t;const e=self.performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){const{levels:t,level:e}=this,i=null==t?void 0:t[e];this.resetStartWhenNotLoaded(i||null),this.state=ks}}}this.state===ks&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:t,levelLastLoaded:e,levels:i,media:r}=this;if(null===e||!r&&(this.startFragRequested||!t.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const s=t.nextLoadLevel;if(null==i||!i[s])return;const n=i[s],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const t={};return this.altAudio&&(t.type="video"),this.hls.trigger(It.BUFFER_EOS,t),void(this.state=Ms)}t.loadLevel!==s&&-1===t.manualLevel&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=t.nextLoadLevel=s;const l=n.details;if(!l||this.state===Bs||l.live&&this.levelLastLoaded!==n)return this.level=s,void(this.state=Bs);const h=a.len,d=this.getMaxBufferLength(n.maxBitrate);if(h>=d)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const c=this.backtrackFragment?this.backtrackFragment.start:a.end;let u=this.getNextFragment(c,l);if(this.couldBacktrack&&!this.fragPrevious&&u&&"initSegment"!==u.sn&&this.fragmentTracker.getState(u)!==ns){var f;const t=(null!=(f=this.backtrackFragment)?f:u).sn-l.startSN,e=l.fragments[t-1];e&&u.cc===e.cc&&(u=e,this.fragmentTracker.removeFragment(e))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(u&&this.isLoopLoading(u,c)){if(!u.gap){const t=this.audioOnly&&!this.altAudio?Kt:Yt,e=(t===Yt?this.videoBuffer:this.mediaBuffer)||this.media;e&&this.afterBufferFlushed(e,t,Hi)}u=this.getNextFragmentLoopLoading(u,l,a,Hi,d)}u&&(!u.initSegment||u.initSegment.data||this.bitrateTest||(u=u.initSegment),this.loadFragment(u,n,c))}loadFragment(t,e,i){const r=this.fragmentTracker.getState(t);this.fragCurrent=t,r===is||r===ss?"initSegment"===t.sn?this._loadInitSegment(t,e):this.bitrateTest?(this.log(`Fragment ${t.sn} of level ${t.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,Hi)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:t,media:e}=this;if(null!=e&&e.readyState){let i;const r=this.getAppendedFrag(e.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);const s=this.getLevelDetails();if(null!=s&&s.live){const t=this.getMainFwdBufferInfo();if(!t||t.len<2*s.targetduration)return}if(!e.paused&&t){const e=t[this.hls.nextLoadLevel],r=this.fragLastKbps;i=r&&this.fragCurrent?this.fragCurrent.duration*e.maxBitrate/(1e3*r)+1:0}else i=0;const n=this.getBufferedFrag(e.currentTime+i);if(n){const t=this.followingBufferedFrag(n);if(t){this.abortCurrentFrag();const e=t.maxStartPTS?t.maxStartPTS:t.start,i=t.duration,r=Math.max(n.end,e+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case Rs:case Ds:case Is:case Us:case Ps:this.state=ks}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);const i=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new sl(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const t=this.media,e=t?t.currentTime:null;kt(e)&&this.log(`Media seeked to ${e.toFixed(3)}`);const i=this.getMainFwdBufferInfo();null!==i&&0!==i.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(It.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(t,e){let i=!1,r=!1;e.levels.forEach((t=>{const e=t.audioCodec;e&&(i=i||-1!==e.indexOf("mp4a.40.2"),r=r||-1!==e.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=i&&r&&!function(){var t;const e=il();return"function"==typeof(null==e||null==(t=e.prototype)?void 0:t.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){const{levels:i}=this;if(!i||this.state!==ks)return;const r=i[e.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=Bs)}onLevelLoaded(t,e){var i;const{levels:r}=this,s=e.level,n=e.details,a=n.totalduration;if(!r)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""}, cc [${n.startCC}, ${n.endCC}] duration:${a}`);const o=r[s],l=this.fragCurrent;!l||this.state!==Ds&&this.state!==Is||l.level!==e.level&&l.loader&&this.abortCurrentFrag();let h=0;if(n.live||null!=(i=o.details)&&i.live){var d;if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;h=this.alignPlaylists(n,o.details,null==(d=this.levelLastLoaded)?void 0:d.details)}if(o.details=n,this.levelLastLoaded=o,this.hls.trigger(It.LEVEL_UPDATED,{details:n,level:s}),this.state===Bs){if(this.waitForCdnTuneIn(n))return;this.state=ks}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,h),this.tick()}_handleFragmentLoadProgress(t){var e;const{frag:i,part:r,payload:s}=t,{levels:n}=this;if(!n)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const a=n[i.level],o=a.details;if(!o)return this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),void this.fragmentTracker.removeFragment(i);const l=a.videoCodec,h=o.PTSKnown||!o.live,d=null==(e=i.initSegment)?void 0:e.data,c=this._getAudioCodec(a),u=this.transmuxer=this.transmuxer||new Wn(this.hls,Hi,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,p=-1!==f,m=new cs(i.level,i.sn,i.stats.chunkCount,s.byteLength,f,p),g=this.initPTS[i.cc];u.push(s,d,c,l,i,r,o.totalduration,h,m,g)}onAudioTrackSwitching(t,e){const i=this.altAudio;if(!!!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const t=this.fragCurrent;t&&(this.log("Switching to main audio track, cancel main fragment load"),t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const t=this.hls;i&&(t.trigger(It.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),t.trigger(It.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){const i=e.id,r=!!this.hls.audioTracks[i].url;if(r){const t=this.videoBuffer;t&&this.mediaBuffer!==t&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=t)}this.altAudio=r,this.tick()}onBufferCreated(t,e){const i=e.tracks;let r,s,n=!1;for(const t in i){const e=i[t];if("main"===e.id){if(s=t,r=e,"video"===t){const e=i[t];e&&(this.videoBuffer=e.buffer)}}else n=!0}n&&r?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=r.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){const{frag:i,part:r}=e;if(i&&i.type!==Hi)return;if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${r?" p: "+r.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===Ps&&(this.state=ks));const s=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal)this.state=Fs;else switch(e.details){case Ut.FRAG_GAP:case Ut.FRAG_PARSING_ERROR:case Ut.FRAG_DECRYPT_ERROR:case Ut.FRAG_LOAD_ERROR:case Ut.FRAG_LOAD_TIMEOUT:case Ut.KEY_LOAD_ERROR:case Ut.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(Hi,e);break;case Ut.LEVEL_LOAD_ERROR:case Ut.LEVEL_LOAD_TIMEOUT:case Ut.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==Bs||(null==(i=e.context)?void 0:i.type)!==Gi||(this.state=ks);break;case Ut.BUFFER_APPEND_ERROR:case Ut.BUFFER_FULL_ERROR:if(!e.parent||"main"!==e.parent)return;if(e.details===Ut.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case Ut.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}checkBuffer(){const{media:t,gapController:e}=this;if(t&&e&&t.readyState){if(this.loadedmetadata||!ds.getBuffered(t).length){const t=this.state!==ks?this.fragCurrent:null;e.poll(this.lastCurrentTime,t)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=ks,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,{type:e}){if(e!==Kt||this.audioOnly&&!this.altAudio){const t=(e===Yt?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(t,e,Hi),this.tick()}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:t}=this;if(!t)return;const e=t.currentTime;let i=this.startPosition;if(i>=0&&e<i){if(t.seeking)return void this.log(`could not seek to ${i}, already seeking at ${e}`);const r=ds.getBuffered(t),s=(r.length?r.start(0):0)-i;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${s} to match buffer start`),i+=s,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${e}`),t.currentTime=i}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then((i=>{const{hls:r}=this;if(!i||this.fragContextChanged(t))return;e.fragmentError=0,this.state=ks,this.startFragRequested=!1,this.bitrateTest=!1;const s=t.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(It.FRAG_LOADED,i),t.bitrateTest=!1}))}_handleTransmuxComplete(t){var e;const i="main",{hls:r}=this,{remuxResult:s,chunkMeta:n}=t,a=this.getCurrentContext(n);if(!a)return void this.resetWhenMissingContext(n);const{frag:o,part:l,level:h}=a,{video:d,text:c,id3:u,initSegment:f}=s,{details:p}=h,m=this.altAudio?void 0:s.audio;if(this.fragContextChanged(o))this.fragmentTracker.removeFragment(o);else{if(this.state=Us,f){if(null!=f&&f.tracks){const t=o.initSegment||o;this._bufferInitSegment(h,f.tracks,t,n),r.trigger(It.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:f.tracks})}const t=f.initPTS,e=f.timescale;kt(t)&&(this.initPTS[o.cc]={baseTime:t,timescale:e},r.trigger(It.INIT_PTS_FOUND,{frag:o,id:i,initPTS:t,timescale:e}))}if(d&&p&&"initSegment"!==o.sn){const t=p.fragments[o.sn-1-p.startSN],e=o.sn===p.startSN,i=!t||o.cc>t.cc;if(!1!==s.independent){const{startPTS:t,endPTS:r,startDTS:s,endDTS:a}=d;if(l)l.elementaryStreams[d.type]={startPTS:t,endPTS:r,startDTS:s,endDTS:a};else if(d.firstKeyFrame&&d.independent&&1===n.id&&!i&&(this.couldBacktrack=!0),d.dropped&&d.independent){const s=this.getMainFwdBufferInfo(),n=(s?s.end:this.getLoadPosition())+this.config.maxBufferHole,l=d.firstKeyFramePTS?d.firstKeyFramePTS:t;if(!e&&n<l-this.config.maxBufferHole&&!i)return void this.backtrack(o);i&&(o.gap=!0),o.setElementaryStreamInfo(d.type,o.start,r,o.start,a,!0)}else e&&t>2&&(o.gap=!0);o.setElementaryStreamInfo(d.type,t,r,s,a),this.backtrackFragment&&(this.backtrackFragment=o),this.bufferFragmentData(d,o,l,n,e||i)}else{if(!e&&!i)return void this.backtrack(o);o.gap=!0}}if(m){const{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=m;l&&(l.elementaryStreams[Kt]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),o.setElementaryStreamInfo(Kt,t,e,i,r),this.bufferFragmentData(m,o,l,n)}if(p&&null!=u&&null!=(e=u.samples)&&e.length){const t={id:i,frag:o,details:p,samples:u.samples};r.trigger(It.FRAG_PARSING_METADATA,t)}if(p&&c){const t={id:i,frag:o,details:p,samples:c.samples};r.trigger(It.FRAG_PARSING_USERDATA,t)}}}_bufferInitSegment(t,e,i,r){if(this.state!==Us)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;const{audio:s,video:n,audiovideo:a}=e;if(s){let e=t.audioCodec;const i=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){e&&(e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const t=s.metadata;t&&"channelCount"in t&&1!==(t.channelCount||1)&&-1===i.indexOf("firefox")&&(e="mp4a.40.5")}e&&-1!==e.indexOf("mp4a.40.5")&&-1!==i.indexOf("android")&&"audio/mpeg"!==s.container&&(e="mp4a.40.2",this.log(`Android: force audio codec to ${e}`)),t.audioCodec&&t.audioCodec!==e&&this.log(`Swapping manifest audio codec "${t.audioCodec}" for "${e}"`),s.levelCodec=e,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${e||""}/${t.audioCodec||""}/${s.codec}]`)}n&&(n.levelCodec=t.videoCodec,n.id="main",this.log(`Init video buffer, container:${n.container}, codecs[level/parsed]=[${t.videoCodec||""}/${n.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${t.codecs}/${a.codec}]`),this.hls.trigger(It.BUFFER_CODECS,e),Object.keys(e).forEach((t=>{const s=e[t].initSegment;null!=s&&s.byteLength&&this.hls.trigger(It.BUFFER_APPENDING,{type:t,data:s,frag:i,part:null,chunkMeta:r,parent:i.type})})),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,Hi)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=ks}checkFragmentChanged(){const t=this.media;let e=null;if(t&&t.readyState>1&&!1===t.seeking){const i=t.currentTime;if(ds.isBuffered(t,i)?e=this.getAppendedFrag(i):ds.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;const t=this.fragPlaying,i=e.level;t&&e.sn===t.sn&&t.level===i||(this.fragPlaying=e,this.hls.trigger(It.FRAG_CHANGED,{frag:e}),t&&t.level===i||this.hls.trigger(It.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){const t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){const t=this.media;if(t){const e=t.currentTime,i=this.currentFrag;if(i&&kt(e)&&kt(i.programDateTime)){const t=i.programDateTime+1e3*(e-i.start);return new Date(t)}}return null}get currentLevel(){const t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){const t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}}class al{static get version(){return"1.5.17"}static isMSESupported(){return rl()}static isSupported(){return function(){if(!rl())return!1;const t=mi();return"function"==typeof(null==t?void 0:t.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((e=>t.isTypeSupported(_i(e,"video"))))||["mp4a.40.2","fLaC"].some((e=>t.isTypeSupported(_i(e,"audio")))))}()}static getMediaSource(){return mi()}static get Events(){return It}static get ErrorTypes(){return Ct}static get ErrorDetails(){return Ut}static get DefaultConfig(){return al.defaultConfig?al.defaultConfig:qo}static set DefaultConfig(t){al.defaultConfig=t}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new jn,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(t,e){if("object"==typeof console&&!0===t||"object"==typeof t){Ot(t,"debug","log","info","warn","error");try{Ft.log(`Debug logs enabled for "${e}" in hls.js version 1.5.17`)}catch(t){Ft=Mt}}else Ft=Mt}(t.debug||!1,"Hls instance");const e=this.config=function(t,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==e.liveMaxLatencyDurationCount&&(void 0===e.liveSyncDurationCount||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==e.liveMaxLatencyDuration&&(void 0===e.liveSyncDuration||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Xo(t),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((t=>{const s=`${"level"===t?"playlist":t}LoadPolicy`,n=void 0===e[s],a=[];r.forEach((r=>{const o=`${t}Loading${r}`,l=e[o];if(void 0!==l&&n){a.push(o);const t=i[s].default;switch(e[s]={default:t},r){case"TimeOut":t.maxLoadTimeMs=l,t.maxTimeToFirstByteMs=l;break;case"MaxRetry":t.errorRetry.maxNumRetry=l,t.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":t.errorRetry.retryDelayMs=l,t.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":t.errorRetry.maxRetryDelayMs=l,t.timeoutRetry.maxRetryDelayMs=l}}})),a.length&&Bt.warn(`hls.js config: "${a.join('", "')}" setting(s) are deprecated, use "${s}": ${JSON.stringify(e[s])}`)})),wt(wt({},i),e)}(al.DefaultConfig,t);this.userConfig=t,e.progressive&&Zo(e);const{abrController:i,bufferController:r,capLevelController:s,errorController:n,fpsController:a}=e,o=new n(this),l=this.abrController=new i(this),h=this.bufferController=new r(this),d=this.capLevelController=new s(this),c=new a(this),u=new Wi(this),f=new or(this),p=e.contentSteeringController,m=p?new p(this):null,g=this.levelController=new Jo(this,m),y=new as(this),v=new el(this.config),_=this.streamController=new nl(this,y,v);d.setStreamController(_),c.setStreamController(_);const S=[u,g,_];m&&S.splice(1,0,m),this.networkControllers=S;const T=[l,h,d,c,f,y];this.audioTrackController=this.createController(e.audioTrackController,S);const E=e.audioStreamController;E&&S.push(new E(this,y,v)),this.subtitleTrackController=this.createController(e.subtitleTrackController,S);const b=e.subtitleStreamController;b&&S.push(new b(this,y,v)),this.createController(e.timelineController,T),v.emeController=this.emeController=this.createController(e.emeController,T),this.cmcdController=this.createController(e.cmcdController,T),this.latencyController=this.createController(lr,T),this.coreComponents=T,S.push(o);const w=o.onErrorOut;"function"==typeof w&&this.on(It.ERROR,w,o)}createController(t,e){if(t){const i=new t(this);return e&&e.push(i),i}return null}on(t,e,i=this){this._emitter.on(t,e,i)}once(t,e,i=this){this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e,i=this,r){this._emitter.off(t,e,i,r)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(e){if(Bt.error("An internal error happened while handling event "+t+'. Error message: "'+e.message+'". Here is a stacktrace:',e),!this.triggeringException){this.triggeringException=!0;const i=t===It.ERROR;this.trigger(It.ERROR,{type:Ct.OTHER_ERROR,details:Ut.INTERNAL_EXCEPTION,fatal:i,event:t,error:e}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){Bt.log("destroy"),this.trigger(It.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((t=>t.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((t=>t.destroy())),this.coreComponents.length=0;const t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){Bt.log("attachMedia"),this._media=t,this.trigger(It.MEDIA_ATTACHING,{media:t})}detachMedia(){Bt.log("detachMedia"),this.trigger(It.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();const e=this.media,i=this.url,r=this.url=Et.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,Bt.log(`loadSource:${r}`),e&&i&&(i!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(It.MANIFEST_LOADING,{url:t})}startLoad(t=-1){Bt.log(`startLoad(${t})`),this.started=!0,this.networkControllers.forEach((e=>{e.startLoad(t)}))}stopLoad(){Bt.log("stopLoad"),this.started=!1,this.networkControllers.forEach((t=>{t.stopLoad()}))}resumeBuffering(){this.started&&this.networkControllers.forEach((t=>{"fragmentLoader"in t&&t.startLoad(-1)}))}pauseBuffering(){this.networkControllers.forEach((t=>{"fragmentLoader"in t&&t.stopLoad()}))}swapAudioCodec(){Bt.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){Bt.log("recoverMediaError");const t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t){this.levelController.removeLevel(t)}get levels(){const t=this.levelController.levels;return t||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){Bt.log(`set currentLevel:${t}`),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){Bt.log(`set nextLevel:${t}`),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){Bt.log(`set loadLevel:${t}`),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){Bt.log(`set firstLevel:${t}`),this.levelController.firstLevel=t}get startLevel(){const t=this.levelController.startLevel;return-1===t&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){Bt.log(`set startLevel:${t}`),-1!==t&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){const e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get ttfbEstimate(){const{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(Bt.log(`set autoLevelCapping:${t}`),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){(function(t){return hr.indexOf(t)>-1})(t)&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;const i=t.length;for(let r=0;r<i;r++)if(t[r].maxBitrate>=e)return r;return 0}get maxAutoLevel(){const{levels:t,autoLevelCapping:e,maxHdcpLevel:i}=this;let r;if(r=-1===e&&null!=t&&t.length?t.length-1:e,i)for(let e=r;e--;){const r=t[e].attrs["HDCP-LEVEL"];if(r&&r<=i)return e}return r}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(t){var e;return null==(e=this.audioTrackController)?void 0:e.setAudioOption(t)}setSubtitleOption(t){var e;return null==(e=this.subtitleTrackController)||e.setSubtitleOption(t),null}get allAudioTracks(){const t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){const t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){const t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){const e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){const t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){const t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){const t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){const e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){const t=this.subtitleTrackController;return!!t&&t.subtitleDisplay}set subtitleDisplay(t){const e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}al.defaultConfig=void 0;var ol=i(500);function ll(t){return!t||t<1024?0:t<1048576?(t/1024).toFixed(1)+"KB":t<1073741824?(t/1024/1024).toFixed(1)+"MB":(t/1024/1024/1024).toFixed(1)+"GB"}var hl=function(t){return new Promise((function(e){return setTimeout(e,t)}))};function dl(t){return new Promise((function(e,i){var r=new FileReader;r.onload=function(t){e(t.target.result)},r.onerror=function(t){i(new Error("Error reading Blob as ArrayBuffer."))},r.readAsArrayBuffer(t)}))}var cl=i(940);function ul(t,e){if(e&&("object"===(0,cl.Z)(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function fl(t){return fl=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},fl(t)}function pl(t,e){return pl=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},pl(t,e)}function ml(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&pl(t,e)}function gl(t){var e=t.replace(/[^a-zA-Z0-9]/g,"_");return/^[0-9]/.test(e)?"_"+e:e}function yl(t,e){var i=document.createElement("a");i.download=e,i.href=URL.createObjectURL(t),i.style.display="none",document.body.appendChild(i),i.onclick=function(t){t.stopPropagation()},i.click(),i.remove()}var vl=function(){var t=localStorage.dl_option,e={r0:0,r1:0};try{t&&(t=window.atob(t),Object.assign(e,JSON.parse(t))),e.r0=Math.max(0,Math.floor(Number(e.r0)||0)),e.r1=Math.max(0,Math.floor(Number(e.r1)||0)),_l(e)}catch(t){}return e},_l=function(t){localStorage.dl_option=window.btoa(JSON.stringify(t))};function Sl(t){var e=localStorage.getItem(t);if(!e)return null;var i=JSON.parse(e);return(new Date).getTime()>i.expiry?(localStorage.removeItem(t),null):i.value}function Tl(t){return new URL(window.location.href).searchParams.has(t)}function El(t){return t.split(".")[0]}function bl(t){var e=t.replace(/[<>:"|?*\x00-\x1F]/g,"_");return((e=e.replace(/\s+/g,(function(t){return"_"===t?t:"_"}))).startsWith("_")||e.startsWith("."))&&(e="file_".concat(e)),e=e.replace(/^\_+|\_+$/g,"")}function wl(t){try{return new URL(t).hostname}catch(t){return null}}var Ll=chrome.i18n,Al="HLS_DL_BOOST",xl="HLS_DL_PAUSE",kl="HLS_DL_RESUME",Rl="HLS_DL_DOWNLOAD",Dl="HLS_DL_SEND2DRIVE",Il="HLS_DL_CAPTURE_DL_MEDIA",Cl="HLS_DL_CAPTURE_DL_ALL",Ul="HLS_DL_CLOSE_VIDEO",Pl="HLS_DL_DELETE_CAPTURE_ONE_ITEM",Ml="HLS_DL_SAVE2DISKCHECKED",Fl="HLS_DL_CLOSESAVE2DISK",Ol=function(){function t(i){var r=this;C(this,t);var n=document.createElement("div"),a=document.getElementById("oneDownVideo").innerHTML;n.innerHTML=a;var o=document.getElementById("videos"),l=o.firstChild;o.insertBefore(n,l),this.container=n,this.m3u8DlManager=i,this.isCaptureMode=!1;var h=function(){var t=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r.saveButton.classList.contains("disabled")){t.next=2;break}return t.abrupt("return");case 2:return r.saveButton.classList.add("disabled"),r.saveButton.classList.add("loading"),r.m3u8DlManager.uiCmdsHandler({cmd:Rl,isForceSave:i}),t.next=7,hl(1e3);case 7:r.saveButton.classList.remove("disabled"),r.saveButton.classList.remove("loading");case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();this.save2GdriveButton&&this.save2GdriveButton.addEventListener("click",(function(){r.m3u8DlManager.uiCmdsHandler({cmd:Dl})})),this.saveButton.addEventListener("click",(function(){h(!1)})),this.forceRenderLink.addEventListener("click",(function(){h(!0)}));var d={};(localStorage.getItem("cococutDlSettings")&&(d=JSON.parse(localStorage.getItem("cococutDlSettings"))),this.setAutoSaveDiv)&&(this.setAutoSaveDiv.querySelector("#setAutoSave").checked=d.setAutoSave);var c=document.getElementById("loadingNotice");c&&(c.style.display="none"),this.closeButton.addEventListener("click",(function(){r.m3u8DlManager.uiCmdsHandler({cmd:Ul})})),this.initSave2DiskUi(),this.initSetAutoFixMp4()}return M(t,[{key:"initSave2DiskUi",value:function(){var t=this;try{this.container.querySelector(".save2diskDiv").style.display="block",this.save2diskCheck.addEventListener("click",(function(){t.save2diskCheck.checked&&t.save2diskChecked()})),this.closeStreamSaverBtn.addEventListener("click",(function(){t.m3u8DlManager.uiCmdsHandler({cmd:Fl}),t.closeStreamSaverBtn.classList.add("disabled")}))}catch(t){}}},{key:"save2diskChecked",value:function(){this.m3u8DlManager.uiCmdsHandler({cmd:Ml});for(var t=this.container.querySelectorAll(".nsave2disk"),e=0;e<t.length;e++)t[e].style.display="none";var i=this.container.querySelectorAll(".fsave2disk");for(e=0;e<i.length;e++)i[e].style.display=""}},{key:"appendLog",value:function(t){var e=this.container.querySelector("#logContainer");if(e){var i=document.createElement("p");i.textContent=t,e.prepend(i),e.style.display="block",e.scrollTop=0}}},{key:"appendAudioListItems",value:function(t){this.container.appendChild(t)}},{key:"setDlFileName",value:function(){this.titleLabel.innerHTML=this.m3u8DlManager.getFileName4dl()}},{key:"setStatus",value:function(t,e){void 0!==e&&(this.statusLabel.style.background=e),void 0!==t&&(this.statusLabel.innerText=t,"HLS"==t?(this.recordCached.style.display="none",this.downloadProgress.style.display="block",this.bufferedLabel.style.display="block"):"Live"==t?(this.recordCached.style.display="none",this.downloadProgress.style.display="none",this.bufferedLabel.style.display="none"):"Recording"==t&&(this.recordCached.style.display="block",this.downloadProgress.style.display="none",this.bufferedLabel.style.display="none",this.downDurationShow.style.display="none",this.fileSizeShow.style.display="none")),document.getElementById("dlHlsInfo").style.display="none"}},{key:"showControl",value:function(t){this.loadCtrls.forEach((function(e){e.style.display=t?"inline":"none"}))}},{key:"showSaveButton",value:function(t){this.saveButton.style.display=t?"inline":"none",this.save2GdriveButton&&(this.save2GdriveButton.style.display=t?"inline":"none")}},{key:"updateFDS",value:function(t){var e=t.fileSize,i=t.downDuration,r=t.segments;this.fileSizeShow.innerText=e,this.downDurationShow.innerText=function(t){var e=t/3600|0,i=t%3600/60|0;t=t%60|0;var r=e>0?e+":":"";return r+=i.toString().padStart(2,"0")+":",r+t.toString().padStart(2,"0")}(i),this.segmentsDl.innerText=r}},{key:"terminate",value:function(){(this.setStatus("Finished","green"),this.showControl(!1),this.showSaveButton(!0),this.setAutoSaveDiv)&&(this.setAutoSaveDiv.querySelector("#setAutoSave").checked&&this.m3u8DlManager.uiCmdsHandler({cmd:Rl}));setTimeout((function(){document.title=Ll.getMessage("Tdone")}),1e3)}},{key:"showImportantNotice",value:function(t){document.getElementById("Notice_closeTabRec").style.display="capture"===t?"inline":"none"}},{key:"setError",value:function(t){this.errorLabel.innerHTML=t,this.errorLabel.style.display="inline"}},{key:"initSetAutoFixMp4",value:function(){var t=document.getElementById("setAutoFixMp4");if(t){var e=localStorage.getItem("autoFixMp4");e&&(t.checked="true"===e),t.addEventListener("click",(function(){localStorage.setItem("autoFixMp4",this.checked)})),this.isNeedStopSetAutoFixMp4()}}},{key:"isNeedStopSetAutoFixMp4",value:function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ut();case 2:if(!t.sent){t.next=4;break}return t.abrupt("return");case 4:((i=vl()).r0>30||i.r1>30)&&((r=document.getElementById("setAutoFixMp4")).checked=!1,localStorage.setItem("autoFixMp4","false"),r.removeAttribute("id"),document.getElementById("setAutoFixMp4Div").classList.add("proNotice"),document.getElementById("setAutoFixMp4Div").style.display="inline");case 6:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}()},{key:"video",get:function(){return this.container.querySelector("video")}},{key:"progress",get:function(){return this.container.querySelector(".progress")}},{key:"loadCtrls",get:function(){return this.container.querySelectorAll(".dlVprocessBtns")}},{key:"downloadLink",get:function(){return this.container.querySelector("#dlVfinalFile")}},{key:"stopButton",get:function(){return this.container.querySelector("#dlVstopBtn")}},{key:"startButton",get:function(){return this.container.querySelector("#dlVstartBtn")}},{key:"saveButton",get:function(){return this.container.querySelector("#dlVsaveBtn")}},{key:"save2GdriveButton",get:function(){return this.container.querySelector("#save2GDrive")}},{key:"closeButton",get:function(){return this.container.querySelector(".dlVignoreThis")}},{key:"forceRenderLink",get:function(){return this.container.querySelector("#dlVforceSaveBtn")}},{key:"titleLabel",get:function(){return this.container.querySelector("#dlStatusS")}},{key:"titleLink",get:function(){return this.container.querySelector("#dlStatusA")}},{key:"boostLabel",get:function(){return this.container.querySelector("#dlVaccelerate")}},{key:"errorLabel",get:function(){return this.container.querySelector("#dlVerr")}},{key:"statusLabel",get:function(){return this.container.querySelector("#dlType")}},{key:"recordCached",get:function(){return this.container.querySelector("#recordCached")}},{key:"downloadProgress",get:function(){return this.container.querySelector("#downloadProgress")}},{key:"bufferedLabel",get:function(){return this.container.querySelector("#bufferedLabel")}},{key:"setAutoSaveDiv",get:function(){return this.container.querySelector("#setAutoSaveDiv")}},{key:"setSpeedUpRecDiv",get:function(){return this.container.querySelector("#setSpeedUpRecDiv")}},{key:"maxRecTimeLimit",get:function(){return this.container.querySelector("#maxRecTimeLimit")}},{key:"fileSizeShow",get:function(){return this.container.querySelector("#videoCachedSize")}},{key:"downDurationShow",get:function(){return this.container.querySelector("#videoCachedTime")}},{key:"segmentsDl",get:function(){return this.container.querySelector("#videoCachedSegments")}},{key:"mediaExtrinfo",get:function(){return this.container.querySelector("#mediaExtrinfo")}},{key:"save2diskCheck",get:function(){return this.container.querySelector("#save2disk")}},{key:"closeStreamSaverBtn",get:function(){return this.container.querySelector("#closeStreamSaver")}}]),t}(),Bl=function(t){function i(t){var r;return C(this,i),(r=ul(this,fl(i).call(this,t))).setStatus("HLS"),r.downDurationShow.style.display="none",r.segmentsDl.style.display="inline",r.setAutoSaveDiv&&(r.setAutoSaveDiv.style.display="inline"),r.isBoosting=!1,r.boostLabel&&r.boostLabel.addEventListener("click",(function(){r.isBoosting=!r.isBoosting,r.boostLabel.style.setProperty("color",r.isBoosting?"#007bff":"#000");r.m3u8DlManager.uiCmdsHandler({cmd:Al,params:{bootTimes:6}})})),r.showImportantNotice("hls"),r.startButton.addEventListener("click",s(e().mark((function t(){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.m3u8DlManager.uiCmdsHandler({cmd:kl});case 1:case"end":return t.stop()}}),t)})))),r.stopButton.addEventListener("click",s(e().mark((function t(){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.m3u8DlManager.uiCmdsHandler({cmd:xl});case 1:case"end":return t.stop()}}),t)})))),r}return ml(i,t),M(i,[{key:"start",value:function(){this.startButton.classList.add("disabled"),this.stopButton.classList.remove("disabled"),this.forceRenderLink.style.display="none",this.save2GdriveButton&&(this.save2GdriveButton.style.display="none"),this.progress.style.removeProperty("background"),this.errorLabel.innerHTML="&nbsp;",document.title=document.title.replace("! ","")}},{key:"pause",value:function(t){this.startButton.classList.remove("disabled"),this.stopButton.classList.add("disabled"),this.forceRenderLink.style.display="inline",this.save2GdriveButton&&(this.save2GdriveButton.style.display="inline"),t&&this.setError(t)}},{key:"update_videoProgress",value:function(t){var e=t.progress,i=t.fds;this.updateFDS(i);var r=e.max,s=e.value;this.progress.max=r,this.progress.value=s;var n=(s/r*100).toFixed(2);this.segmentsDl.innerText="".concat(n,"%");var a=100===n?Ll.getMessage("Tdone"):Ll.getMessage("Tloading");document.title=n+"% - "+a}}]),i}(Ol),Nl=function(t){function e(t){var i;return C(this,e),(i=ul(this,fl(e).call(this,t))).setStatus("Live","red"),i.showControl(!1),i.showSaveButton(!0),i.statusLabel.style.marginTop="8px",i.boostLabel&&(i.boostLabel.style.display="none"),i.showImportantNotice("live"),i}return ml(e,t),M(e,[{key:"update_videoProgress",value:function(t){this.updateFDS(t.fds),document.title=this.downDurationShow.innerText+" - "+Ll.getMessage("TRecording")}},{key:"pause",value:function(t){t&&this.setError(t)}}]),e}(Ol),Gl=function(t){function i(t){var e;if(C(this,i),(e=ul(this,fl(i).call(this,t))).isCaptureMode=!0,e.setStatus("Recording","red"),e.showControl(!1),e.showSaveButton(!0),e.boostLabel&&(e.boostLabel.style.display="none"),e.showImportantNotice("capture"),e.container.querySelector("#recordInfo").style.display="block",e.success=!1,e.setSpeedUpRecDiv&&(e.setSpeedUpRecDiv.style.display="inline"),e.setAutoSaveDiv&&(e.setAutoSaveDiv.style.display="inline"),e.saveButton.classList.add("disabled"),e.saveButton.classList.add("loading"),e.showFfmpegLoading(),e.save2GdriveButton.classList.add("disabled"),e.save2GdriveButton.classList.add("loading"),e.setSpeedUpRecDiv){var r={};localStorage.getItem("cococutDlSettings")&&(r=JSON.parse(localStorage.getItem("cococutDlSettings")));var s=document.querySelectorAll("#setSpeedUpRec");s.forEach((function(t){t.checked=r.setSpeedUpRec;var i=function(){var e={checked:t.checked};R(d,e)};t.checked&&e.isCaptureMode&&i(),t.addEventListener("click",(function(){var t=this.checked;s.forEach((function(e){e.checked=t})),i()}))}))}return e.container.addEventListener("click",(function(t){t.target.classList.contains("dlAllMediaBtn")&&e.dlAllMedia()})),e}return ml(i,t),M(i,[{key:"showFfmpegLoading",value:function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t1='\n        <p class="text-primary">('.concat(Ll.getMessage("Tm3u8ReqFfmpegTrans"),': Loading ffmpeg...)</p>\n        <p>Or: <button class="btn btn-outline-primary btn-sm dlAllMediaBtn">').concat(Ll.getMessage("Tm3u8DlExistData"),'</button> , <a target="_blank" href="'),t.next=3,st();case 3:return t.t2=t.sent,t.t3=Ll.getMessage("ThlsGoToMergeAV"),t.t0=t.t1.concat.call(t.t1,t.t2,'">').concat(t.t3," "),t.next=8,st();case 8:t.t4=t.sent,i=t.t0.concat.call(t.t0,t.t4,"</a></p>\n        "),(r=document.createElement("div")).innerHTML=i,r.id="ffmpegLoading",this.saveButton.parentNode.appendChild(r);case 14:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"showSaveButton",value:function(t){this.saveButton.style.display=t?"inline":"none",this.save2GdriveButton&&(this.save2GdriveButton.style.display="none")}},{key:"appendOneMediaUI",value:function(t){var e=this,i=t.split(";")[0].split("/")[0],r=t.split(";")[1],s=gl(t),n='\n        <div class="media-item mb-1 p-1" id="'.concat(s,'" data-mime="').concat(t,'">\n            <span class="media-item-mime"><button class="media-item-button btn btn-outline-secondary btn-sm">').concat(i,'</button></span>\n            <span class="media-item-size"></span>\n            <small> (').concat(r,')</small><button class="media-item-delete btn btn-outline-danger btn-sm">').concat(Ll.getMessage("Tm3u8RefererDelete"),"</button>\n        </div>\n        "),a=document.createElement("div");a.innerHTML=n,a.querySelector(".media-item-button").addEventListener("click",(function(){e.dlMedia(t,i)})),a.querySelector(".media-item-delete").addEventListener("click",(function(){e.deleteMediaItem(t,s)})),this.statusLabel.parentNode.insertBefore(a,this.statusLabel.nextSibling)}},{key:"update_videoProgress",value:function(t){this.container.querySelector("#recordInfo").style.display="none";var e=t.fds.fileSize,i=t.mime,r=i.split(";")[0].split("/")[0];document.title="".concat(r,":").concat(e,"-").concat(Ll.getMessage("TRecording")),document.querySelector("#".concat(gl(i))).querySelector(".media-item-size").innerText=e}},{key:"terminate",value:function(){(this.setStatus("Finished","green"),this.showControl(!1),this.showSaveButton(!0),setTimeout((function(){document.title=Ll.getMessage("Tdone")}),1e3),this.setAutoSaveDiv)&&(this.setAutoSaveDiv.querySelector("#setAutoSave").checked&&this.m3u8DlManager.uiCmdsHandler({cmd:Rl}))}},{key:"ffmpegLoade",value:function(){this.saveButton.classList.remove("disabled"),this.saveButton.classList.remove("loading"),this.saveButton.parentNode.removeChild(document.getElementById("ffmpegLoading")),this.save2GdriveButton.classList.remove("disabled"),this.save2GdriveButton.classList.remove("loading")}},{key:"ffmpegError",value:function(){var t=s(e().mark((function t(i){var r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.errorLabel.innerHTML=i.msg,this.errorLabel.style.display="block","ffmpeg merge fail"!==i.msg){t.next=15;break}return r=document.createElement("div"),t.t1=' <button class="btn btn-outline-primary btn-sm dlAllMediaBtn">'.concat(Ll.getMessage("Tm3u8DlExistData"),'</button><p><a target="_blank" href="'),t.next=7,st();case 7:return t.t2=t.sent,t.t3=Ll.getMessage("ThlsGoToMergeAV"),t.t0=t.t1.concat.call(t.t1,t.t2,'">').concat(t.t3," "),t.next=12,st();case 12:t.t4=t.sent,r.innerHTML=t.t0.concat.call(t.t0,t.t4,"</a></p>"),this.errorLabel.appendChild(r);case 15:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"dlMedia",value:function(t,e){this.m3u8DlManager.uiCmdsHandler({cmd:Il,params:{mimeInfo:t,mediaType:e}})}},{key:"dlAllMedia",value:function(){this.m3u8DlManager.uiCmdsHandler({cmd:Cl})}},{key:"deleteMediaItem",value:function(t,e){var i=document.getElementById(e);i&&(i.parentNode.removeChild(i),this.m3u8DlManager.uiCmdsHandler({cmd:Pl,params:{mime:t}}))}}]),i}(Ol);function $l(t,i){var r=document.getElementById("confirm-switch"),n=document.getElementById("adVancedModeCtn");r.addEventListener("click",s(e().mark((function s(){var a;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.checked){e.next=12;break}return n&&(n.style.display="none"),a=document.getElementById("switchRecMode"),document.getElementById("showSwitchRecModeDialog").click(),a.classList.add("active"),e.next=7,new Promise((function(t,e){var i=a.querySelectorAll(".close-modal"),r=function e(){var r=!0,s=!1,n=void 0;try{for(var a,o=i[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){a.value.removeEventListener("click",e)}}catch(t){s=!0,n=t}finally{try{r||null==o.return||o.return()}finally{if(s)throw n}}t(!1)},s=!0,n=!1,o=void 0;try{for(var l,h=i[Symbol.iterator]();!(s=(l=h.next()).done);s=!0){l.value.addEventListener("click",r)}}catch(t){n=!0,o=t}finally{try{s||null==h.return||h.return()}finally{if(n)throw o}}var d=document.getElementById("confirmCaptureOKButton");d.addEventListener("click",(function e(){d.removeEventListener("click",e),t(!0)}))}));case 7:e.sent?R(y.ASK_VPAGE_START_CAPTURE,{videoTabId:t,m3u8dlPageTabId:i}):(r.checked=!1,document.querySelector("#switchRecMode .modal-title").innerHTML=Ll.getMessage("TswichtRecMode")),a.classList.remove("active"),e.next=13;break;case 12:n&&(n.style.display="block");case 13:case"end":return e.stop()}}),s)})))),document.querySelector("#switchRecMode .modal-title").innerHTML=Ll.getMessage("TswichtRecMode")}var zl=function(){function t(){if(C(this,t),t.instance)return t.instance;t.instance=this,this.fixedRuleIds={blockAdsense:30086,blockAds:30087}}return M(t,[{key:"updateSessionRules",value:function(){var t=s(e().mark((function t(i,r){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:r,addRules:i});case 3:t.next=8;break;case 5:t.prev=5,t.t0=t.catch(0);case 8:case"end":return t.stop()}}),t,null,[[0,5]])})));return function(e,i){return t.apply(this,arguments)}}()},{key:"updateDynamicRules",value:function(){var t=s(e().mark((function t(i,r,s){var n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:r,addRules:i});case 3:n=t.sent,s&&s(n),t.next=10;break;case 7:t.prev=7,t.t0=t.catch(0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])})));return function(e,i,r){return t.apply(this,arguments)}}()},{key:"filterDynamicRules",value:function(t){chrome.declarativeNetRequest.getDynamicRules((function(e){t&&t(e)}))}}],[{key:"hlsMheaderRuleId",get:function(){return 30088}}]),t}();zl.getInstance=function(){return zl.instance||(zl.instance=new zl),zl.instance};var Hl=i(34),Vl=function(){function t(e){var i=e.onChunk,r=e.isDetector,s=e.onDetect,n=e.targetTrackId;C(this,t),this.onChunk=i,this.isDetector=r,this.onDetect=s,this.nextBufferStart=0,this.targetTrackId=n,this.file=Hl.createFile(),this.file.onError=function(t){},this.file.onReady=this.onReady.bind(this),this.file.onSamples=this.onSamples.bind(this)}return M(t,[{key:"appendBuffer",value:function(t){t.fileStart=this.nextBufferStart,this.nextBufferStart=this.file.appendBuffer(t)}},{key:"flush",value:function(){this.file.flush()}},{key:"save",value:function(t){this.file.save(t)}},{key:"onReady",value:function(t){if(this.isDetector){var e=this.countTracksWithVideoAndAudio(t.tracks),i=e.hasVideoAndAudio,r=e.media,s={hasVideoAndAudio:i,duration:t.duration/t.timescale,media:r};this.onDetect(s)}else;}},{key:"onSamples",value:function(t,e,i){}},{key:"countTracksWithVideoAndAudio",value:function(t){var e=0,i=0,r=null;return t.forEach((function(t){t.video&&Object.keys(t.video).length>0&&(e++,r={type:"video",info:t.video,codec:t.codec,trackId:t.id}),t.audio&&Object.keys(t.audio).length>0&&(i++,r={type:"audio",info:t.audio,codec:t.codec,trackId:t.id})})),{hasVideoAndAudio:e>0&&i>0,media:r}}}]),t}();function Kl(t){var e=Object.entries(t).filter((function(t){var e=(0,I.Z)(t,2);e[0];return!e[1].detectInfo.hasVideoAndAudio})).map((function(t){var e=(0,I.Z)(t,2),i=e[0];return{item:e[1],key:i}}));e.sort((function(t,e){return e.item.detectInfo.duration-t.item.detectInfo.duration}));var i=[];if(2===e.length)i=e;else if(e.length>2){i.push(e[0].item);for(var r=1,s=Math.abs(e[0].item.detectInfo.duration-e[1].item.detectInfo.duration),n=2;n<e.length;n++){var a=Math.abs(e[0].item.detectInfo.duration-e[n].item.detectInfo.duration);a<s&&(r=n,s=a)}i.push(e[r])}return i}var Yl=i(6),jl=i.n(Yl),Wl=function(){var t=s(e().mark((function t(){var i,r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=wl(location.href),!["cococut.net","pro.cococut.net","www.cococut.net"].includes(i)){t.next=4;break}return t.abrupt("return",!0);case 4:return t.next=6,it();case 6:return r=t.sent,t.next=9,nt();case 9:if(s=t.sent,i!==r&&i!==s){t.next=12;break}return t.abrupt("return",!0);case 12:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();var ql=function(){var t=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=Sl("speedo")){t.next=5;break}return t.next=4,H("speedo");case 4:i=t.sent;case 5:return i?(r=V("mySecretSalt2021"),i=r(i),i=JSON.parse(i)):Zl(i={okTotry:"0",tried:"0"}),t.abrupt("return",i);case 7:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}();i(619);var Xl=chrome.i18n;function Zl(t){var e,i,r,s,n,a,o,l,h=JSON.stringify(t),d=60*K()*1e3,c=(e="mySecretSalt2021",i=function(t){return t.split("").map((function(t){return t.charCodeAt(0)}))},r=function(t){return("0"+Number(t).toString(16)).substr(-2)},s=function(t){return i(e).reduce((function(t,e){return t^e}),t)},function(t){return t.split("").map(i).map(s).map(r).join("")});n="speedo",a=c(h),o=d,l={value:a,expiry:(new Date).getTime()+o},localStorage.setItem(n,JSON.stringify(l)),z("speedo",c(h),d)}var Ql=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"hls";C(this,t),this.sendMsg2Page({ffmpegaction:"loadFfmpeg"}),this.dlMode=e,this.url="",this.tips="",this.title="",this.isPause=!1,this.needDlMP4=!1,this.durationSecond=0,this.downDuration=0,this.isShowRefer=!1,this.downloading=!1,this.beginTime="",this.errorNum=0,this.finishNum=0,this.downloadIndex=0,this.finishList=[],this.tsUrlList=[],this.mediaFileList=[],this.isSupportStreamWrite=jl().supported,this.writeStream=null,this.streamWriter=null,this.streamDownloadIndex=0,this.rangeDownload={isShowRange:!1,startSegment:"",endSegment:"",targetSegment:1},this.aesConf={method:"",uri:"",iv:"",key:"",decryptor:null,stringToBuffer:function(t){return(new TextEncoder).encode(t)}},this.fileSize=0,this.hls=null,this.isLive=!1,this.pauseDlLive=!1,this.liveSegments=[],this.beginTime=new Date,"capture"!==this.dlMode?this.initHls():(this.captureMediaList={},this.initUI()),this.maxThreadDefault=6,this.maxThread=this.maxThreadDefault,this.threadCtlIntervalIdleId,this.events={},this.myOptOption,this.videoPageInfo,this.initiator,this.requestHeaders={},this.targetDomains=[],this.retryLoadHlsCount=0,this.normalDelay=1500,this.tryingProSpeed=!1,this.initData=new Map,this.mp4Demuxers=new Map,new URL(document.location.href).pathname.indexOf("hls.vhtml")>0&&(this.normalDelay=1e3),this.isStreamDownloadRunning=!1,this.streamDownloadQueue=[]}var i,r,n,a,o,l,h,d,c,u,f,p;return M(t,[{key:"mapTag",value:function(){return this.finishList[0].initSegment&&this.finishList[0].initSegment.url?this.finishList[0].initSegment.url:""}},{key:"addInitSegmentData",value:function(t,e){var i=this.initData.get(e.url);!i&&e.data&&(i=e.data.buffer);var r=i.byteLength,s=new Uint8Array(r+t.byteLength);return s.set(new Uint8Array(i),0),s.set(new Uint8Array(t),r),s.buffer}},{key:"getRequestHeaders",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this.initiator||"",i=function(t){if(!t)return null;try{var e=new URL(t),i=e.protocol+"//"+e.hostname;return e.port&&(i+=":"+e.port),i}catch(t){return null}}(e)||"",r=!function(t){if(null==t)return!0;for(var e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}(this.requestHeaders),s=r?this.requestHeaders:{Referer:e,Origin:i};return t?r?{Referer:e,Origin:i}:{}:s}},{key:"segmentsUniqueDomains",value:function(){var t=this;(function(t){var e=/^(?:https?:\/\/)?(?:www\.)?([^\/:]+).*/,i=new Set;return t.forEach((function(t){var r=t.match(e);r&&i.add(r[1])})),Array.from(i)})(this.tsUrlList).forEach((function(e){t.appendTargetDoman(e)}))}},{key:"appendTargetDoman",value:function(t){this.targetDomains.includes(t)||this.targetDomains.push(t)}},{key:"setRequestHeaders",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i={ruleId:null!==(t=this.videoPageInfo)&&void 0!==t&&t.tabId?this.videoPageInfo.tabId:zl.hlsMheaderRuleId,reqHeadersKV:this.getRequestHeaders(e),requestDomains:this.targetDomains};R(y.SET_HLSDL_HEADERS,i)}},{key:"getMyOptOption",value:function(){var t=s(e().mark((function t(){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.myOptOption){t.next=4;break}return t.next=3,tt();case 3:this.myOptOption=t.sent;case 4:return t.abrupt("return",this.myOptOption);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"pauseSelf",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.threadCtlIntervalIdleId&&clearInterval(this.threadCtlIntervalIdleId),this.maxThread=0,this.isPause=!0,this.togglePause(t)}},{key:"initUI",value:function(){this.isLive?(this.dlMode="live",this.videoUI=new Nl(this)):"capture"===this.dlMode?this.videoUI=new Gl(this):(this.videoUI=new Bl(this),this.videoUI.start(),this.checkProAndDoSth(["initTryProSpeed"]))}},{key:"checkProAndDoSth",value:function(){var t=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ut();case 2:!t.sent&&i.includes("initTryProSpeed")&&this.initTryProSpeed();case 4:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"reSetHeaders",value:function(){1==this.retryLoadHlsCount?this.setRequestHeaders():2==this.retryLoadHlsCount&&this.setRequestHeaders(!0)}},{key:"hlsTryLoad",value:function(){this.hls.startLoad(),this.retryLoadHlsCount++}},{key:"hlsFatalRestart",value:function(){this.initHls(),this.hls.loadSource(this.url),this.hls.startLoad()}},{key:"initHls",value:function(){var t=this,i={debug:!1,enableWorker:!1,pLoader:function(t){var e=this,i=new al.DefaultConfig.loader(t);this.stats=i.stats,this.abort=function(){return i.abort()},this.destroy=function(){return i.destroy()},this.load=function(t,i,r){var s={url:t.url};D(s).then((function(i){if(i.OK){var n={url:s.url};r.onSuccess(i,e.stats,t,n)}else r.onError({code:0,text:i.errorMsg},t,i.errorMsg,e.stats)}))}},fLoader:function(t){var i=this,r=new al.DefaultConfig.loader(t);this.stats=r.stats,this.abort=function(){return r.abort()},this.destroy=function(){return r.destroy()},this.load=function(t,r,n){var a=t.url;D({url:a,type:"file"}).then(function(){var r=s(e().mark((function r(s){var a;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s.OK){e.next=7;break}return e.next=3,Y(s.data);case 3:a=e.sent,n.onSuccess({data:a},i.stats,t,void 0),e.next=10;break;case 7:n.onError({code:0,text:s.errorMsg},t,s.errorMsg,i.stats);case 10:case"end":return e.stop()}}),r)})));return function(t){return r.apply(this,arguments)}}())}},autoStartLoad:!1};this.hls=new al(i),this.hls.on(al.Events.LEVEL_LOADED,(function(e,i){if(0===t.tsUrlList.length?t.parseHlsData(i.details):t.updateLiveSegment(i.details),""==t.videoUI.mediaExtrinfo.innerHTML){var r=document.createElement("video");r.muted=!0,r.autoplay=!1,t.hls.attachMedia(r),t.hls.on(al.Events.MEDIA_ATTACHED,(function(){r.play()})),r.oncanplay=function(){t.hls.detachMedia(r),r.remove(),r=null}}})),this.hls.on(al.Events.MANIFEST_PARSED,(function(e,i){var r,s=!1;i.levels.length+i.audioTracks.length+i.subtitleTracks.length>=2&&(s=!0,r=document.getElementById("msgModal"));var n=Tl("selaudio");if(s&&i.levels.length&&!n){var a="",o=!0,l=!1,h=void 0;try{for(var d,c=i.levels[Symbol.iterator]();!(o=(d=c.next()).done);o=!0){var u=d.value,f=$(u),p=(0,I.Z)(f,2),m=p[0],g=p[1];a+='<li class="list-group-item  d-flex justify-content-between align-items-center">\n                            '.concat(u.attrs.RESOLUTION?Xl.getMessage("Tm3u8Resolution")+":"+u.attrs.RESOLUTION:"").concat(u.attrs.BANDWIDTH?" | "+Xl.getMessage("Tm3u8Bitrate")+":"+parseInt(u.attrs.BANDWIDTH/1e3)+" Kbps":"",'\n                            <span><button style="max-width: 300px;" data-url="').concat(g,'" class="reschoose-btn btn btn-primary">').concat(m,"</button></span>\n                        </li>")}}catch(t){l=!0,h=t}finally{try{o||null==c.return||c.return()}finally{if(l)throw h}}r.querySelector(".modal-title").innerHTML=Xl.getMessage("TpopupTab1");var y='<div class="mb-2">'.concat(Xl.getMessage("TmpdSelectVideo"),'</div><ul class="list-group">').concat(a,"</ul>"),v=document.createElement("div");v.innerHTML=y,r.querySelector(".modal-body").appendChild(v)}if(s&&i.audioTracks.length){var _="",S=null,T=!0,E=!1,b=void 0;try{for(var w,L=i.audioTracks[Symbol.iterator]();!(T=(w=L.next()).done);T=!0){var A=w.value;if(""==A.url){var x=A.groupId,k=!0,R=!1,D=void 0;try{for(var C,U=i.levels[Symbol.iterator]();!(k=(C=U.next()).done);k=!0){var P=C.value;if(P.audioGroupIds.includes(x)){A.url=P.uri;break}}}catch(t){R=!0,D=t}finally{try{k||null==U.return||U.return()}finally{if(R)throw D}}}var M=$(A),F=(0,I.Z)(M,2),O=F[0],B=F[1];_+='<li class="list-group-item  d-flex justify-content-between align-items-center">'.concat(A.name?A.name:""," | ").concat(A.lang?A.lang:""," | ").concat(A.groupId?A.groupId:"",'\n                    <span><button style="max-width: 300px;" data-url="').concat(B,'" class="reschoose-btn btn btn-primary">').concat(O,"</button></span>\n                        </li>");var N='<div class="mb-2">'.concat(Xl.getMessage("TmpdSelectAudio"),'</div><ul class="list-group">').concat(_,"</ul>");(S=document.createElement("div")).innerHTML=N,r.querySelector(".modal-body").appendChild(S)}}catch(t){E=!0,b=t}finally{try{T||null==L.return||L.return()}finally{if(E)throw b}}t.hasAudioListElement=!0}if(s&&i.subtitleTracks.length,s){var G=r.querySelector(".close-modal");return document.querySelectorAll(".reschoose-btn").forEach((function(e){e.addEventListener("click",(function(){t.url=e.dataset.url,t.getMP4(),G.click()}))})),void document.getElementById("msgModalBtn").click()}function $(t){var e,i,r,s=null!==(e=t.uri)&&void 0!==e?e:t.url;return["data:"!=(r=(r=null!==(i=t.uri)&&void 0!==i?i:t.url).split("?")[0]).substr(0,5)&&"skd:"!=r.substr(0,4)?r.split("/").pop():r,s]}t.hls.startLoad()})),this.hls.on(al.Events.BUFFER_CREATED,(function(i,r){var n=t.videoUI.mediaExtrinfo;if(r.tracks&&""==n.innerHTML){var a,o;if(r.tracks.audiovideo)return void(null!==(o=r.tracks.audiovideo)&&void 0!==o&&o.metadata&&(n.innerHTML+="<p>".concat(Xl.getMessage("TAudio"),"-").concat(Xl.getMessage("Tm3u8Resolution"),":").concat(r.tracks.audiovideo.metadata.width," x ").concat(r.tracks.audiovideo.metadata.height,"</p>")));if(!r.tracks.audio&&(n.innerHTML+=" (".concat(Xl.getMessage("Tm3u8NoAudio"),")")),!r.tracks.video){n.innerHTML+=" (".concat(Xl.getMessage("TAudio"),")");var l={type:"file",url:t.tsUrlList[0],success:function(){var i=s(e().mark((function i(r){var s,a,o;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Y(r);case 2:if(s=e.sent,71==(a=new Uint8Array(s))[0]&&64==a[1]){e.next=6;break}return e.abrupt("return");case 6:o=0;case 7:if(!(o<a.length)){e.next=14;break}if(71!=a[o]||64==a[o+1]){e.next=11;break}return 36==a[o+17]&&(n.innerHTML=n.innerHTML.replace(Xl.getMessage("TAudio"),"<b>h.265 encoding video, cannot be merged to mp4</b>"),t.needDlMP4=!1),e.abrupt("return");case 11:o++,e.next=7;break;case 14:case"end":return e.stop()}}),i)})));return function(t){return i.apply(this,arguments)}}(),fail:function(t){}};t.ajax(l)}null!==(a=r.tracks.video)&&void 0!==a&&a.metadata&&(n.innerHTML+="<p>".concat(Xl.getMessage("Tm3u8Resolution"),":").concat(r.tracks.video.metadata.width," x ").concat(r.tracks.video.metadata.height,"</p>"))}})),this.hls.on(al.Events.ERROR,(function(e,i){var r=i.type,s=i.details,n=i.fatal;switch(r){case al.ErrorTypes.NETWORK_ERROR:if(t.retryLoadHlsCount>2){t.videoUI.appendLog("HLS.js: Network Error",s);break}t.reSetHeaders(),setTimeout((function(){t.hlsTryLoad()}),1e3);break;case al.ErrorTypes.MEDIA_ERROR:t.hls.recoverMediaError();break;default:t.videoUI.appendLog("HLS.js other error: "+s)}if(n){if(t.reSetHeaders(),t.retryLoadHlsCount>2)return t.videoUI.appendLog("HLS.js: "+s),void t.videoUI.appendLog("".concat(Xl.getMessage("Tm3u8ErrInParseM3u8"),". ").concat(Xl.getMessage("ThlsCloseVideoPageRetry")));t.hls.destroy(),setTimeout((function(){t.hlsFatalRestart()}),1e3)}}))}},{key:"ajax",value:function(){var t=s(e().mark((function t(i){var r,n,a,o=this,l=arguments;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=(r=l.length>1&&void 0!==l[1]?l[1]:3)||3,function(t,e,i){i.forEach((function(i){t.hasOwnProperty(i)&&(e[i]=t[i],delete t[i])}))}(i=i||{},n={},["success","fail"]),a=function(){var t=s(e().mark((function t(){var s,l,h=arguments;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return 1==(s=h.length>0&&void 0!==h[0]?h[0]:0)?o.setRequestHeaders():2==s&&o.setRequestHeaders(!0),t.prev=2,t.next=5,D(i);case 5:if(!(l=t.sent).OK){t.next=10;break}n.success&&n.success(l.data),t.next=18;break;case 10:if(!(s<r)){t.next=17;break}return t.next=14,hl(1e3);case 14:return t.abrupt("return",a(s+1));case 17:n.fail&&n.fail("All retries failed");case 18:t.next=31;break;case 20:if(t.prev=20,t.t0=t.catch(2),!(s<r)){t.next=30;break}return t.next=27,hl(1e3);case 27:return t.abrupt("return",a(s+1));case 30:n.fail&&n.fail("All retries failed due to an error");case 31:case"end":return t.stop()}}),t,null,[[2,20]])})));return function(){return t.apply(this,arguments)}}(),t.next=9,a();case 9:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()},{key:"alertError",value:function(t){alert(t),this.downloading=!1,this.tips="hls downloader"}},{key:"initTransMuxer",value:function(){var t=this;if(!this.transmuxer){this.transmuxer=new muxjs.Transmuxer({remux:!0});var e=!0,i=null,r=!1;this.transmuxer.on("data",(function(s){if(e){var n=r?t.downDuration:t.durationSecond,a=new Uint8Array(s.initSegment.byteLength+s.data.byteLength);a.set(s.initSegment,0),a.set(s.data,s.initSegment.byteLength),i=function(t,e){var i=9e4*e;function r(t,e,i){var r="";return r+=t[i+=16].toString(16),r+=t[++i].toString(16),r+=t[++i].toString(16),r+=t[++i].toString(16),(r=parseInt(r,16))*e}for(var s=0;s<t.length;s++)if(109!=t[s]||118!=t[s+1]||104!=t[s+2]||100!=t[s+3])if(116!=t[s]||107!=t[s+1]||104!=t[s+2]||100!=t[s+3])if(109!=t[s]||100!=t[s+1]||104!=t[s+2]||100!=t[s+3]){if(109==t[s]&&100==t[s+1]&&97==t[s+2]&&116==t[s+3])return t}else{var n=r(t,e,s);t[s+=20]=(4278190080&n)>>24,t[++s]=(16711680&n)>>16,t[++s]=(65280&n)>>8,t[++s]=255&n}else t[s+=24]=(4278190080&i)>>24,t[++s]=(16711680&i)>>16,t[++s]=(65280&i)>>8,t[++s]=255&i;else i=r(t,e,s),t[s+11]=0,t[s+=20]=(4278190080&i)>>24,t[++s]=(16711680&i)>>16,t[++s]=(65280&i)>>8,t[++s]=255&i;return t}(a,n)}else i=s.data})),this.transmuxer.on("end",(function(){})),this.transmuxer.on("error",(function(t){reject(t)})),this.conversionMp4=function(t,s,n){var a=this;return r=n,new Promise((function(r,n){a.needDlMP4?(e=0===s,a.transmuxer.push(new Uint8Array(t)),a.transmuxer.flush(),r(i.buffer)):r(t)}))}}}},{key:"getMP4",value:function(){this.needDlMP4=!0,this.initTransMuxer(),this.getM3U8()}},{key:"getM3U8",value:function(){this.url?this.downloading?alert("downloading now, please wait"):(this.appendTargetDoman(new URL(this.url).hostname),this.hls.loadSource(this.url),this.tips="downloading m3u8 file, please wait"):alert("no m3u8 url")}},{key:"setStartEnd",value:function(){var t=Math.max(this.rangeDownload.startSegment||1,1),e=Math.max(this.rangeDownload.endSegment,this.tsUrlList.length);e=e||1,t=Math.min(t,this.tsUrlList.length),e=Math.min(e,this.tsUrlList.length),this.rangeDownload.startSegment=Math.min(t,e),this.rangeDownload.endSegment=Math.max(t,e),this.rangeDownload.targetSegment=this.rangeDownload.endSegment-this.rangeDownload.startSegment+1}},{key:"totalDuration",value:function(){return this.finishList.reduce((function(t,e){return t+e.duration}),0)}},{key:"initStreamDownload",value:function(){var t=s(e().mark((function t(){var i,r,s=this;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=this.getFileName4dl(),t.next=3,rt(!0);case 3:r=t.sent,jl().mitm="".concat(r,"/pub/stream-saver-mitm.html"),this.writeStream=jl().createWriteStream(i),this.streamWriter=this.writeStream.getWriter(),window.onunload=function(){s.writeStream.abort(),s.streamWriter.abort()},window.onbeforeunload=function(t){s.streamWriter&&(t.returnValue="Are you sure you want to leave?")},this.streamDownload();case 10:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"parseHlsData",value:function(t){var i=this;this.isLive=t.live,this.initUI(),this.tsUrlList=[],this.finishList=[];var r=!0,n=!1,a=void 0;try{for(var o,l=function(){var t=(0,I.Z)(o.value,2),r=t[0],n=t[1],a=null;if(n.initSegment&&!i.initData.get(n.initSegment.url)){a=n.initSegment,i.initData.set(n.initSegment.url,!0);var l={url:n.initSegment.url,type:"file",success:function(){var t=s(e().mark((function t(r){var s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,Y(r);case 2:s=t.sent,i.initData.set(n.initSegment.url,s);case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),fail:function(t){}};a.byteRange.length>0&&(l.range={byteRangeStart:a.byteRange[0],byteRangeEnd:a.byteRange[1]}),i.ajax(l)}i.isLive&&n.initSegment&&0==i.tsUrlList.length&&(a=n.initSegment);var h=null;n.byteRange.length>0&&(h={range:{byteRangeStart:n.byteRange[0],byteRangeEnd:n.byteRange[1]}}),i.tsUrlList.push(n.url),i.finishList.push({title:n.relurl,status:"",duration:n.duration,initSegment:a,segmentInfo:h}),i.liveSegments.push({index:r,sn:n.sn})},h=t.fragments.entries()[Symbol.iterator]();!(r=(o=h.next()).done);r=!0)l()}catch(t){n=!0,a=t}finally{try{r||null==h.return||h.return()}finally{if(n)throw a}}if(this.videoUI.setDlFileName(),this.segmentsUniqueDomains(),this.onlyGetRange&&!this.isLive)return this.rangeDownload.isShowRange=!0,this.rangeDownload.endSegment=this.tsUrlList.length,void(this.rangeDownload.targetSegment=this.tsUrlList.length);this.setStartEnd(),this.downloadIndex=this.rangeDownload.startSegment-1,this.downloading=!0,this.needDlMP4&&(this.durationSecond=t.totalduration);var d=t.m3u8;d.indexOf("#EXT-X-KEY")>-1?(this.aesConf.method=(d.match(/(.*METHOD=([^,\s]+))/)||["","",""])[2],this.aesConf.uri=(d.match(/(.*URI="([^"]+))"/)||["","",""])[2],this.aesConf.iv=(d.match(/(.*IV=([^,\s]+))/)||["","",""])[2],this.aesConf.iv=this.aesConf.iv?this.aesConf.stringToBuffer(this.aesConf.iv):"",this.aesConf.uri=function(t,e){if(e=e||location.href,0===t.indexOf("http"))return 0===location.href.indexOf("https")?t.replace("http://","https://"):t;if("/"===t[0]){var i=e.split("/");return i[0]+"//"+i[2]+t}var r=e.split("/");return r.pop(),r.join("/")+"/"+t}(this.aesConf.uri,this.url),this.getAES()):this.tsUrlList.length>0?this.downloadTS():this.alertError("no ts file found"),this.hasAudioListElement&&st().then((function(t){var e;e=Tl("selaudio")?"<div><strong>".concat(Xl.getMessage("ThlsGoToMergeAV"),'<a href="').concat(t,'" target="_blank">').concat(t,"</a></strong></div>"):"<div>".concat(Xl.getMessage("ThlsNeedSelectAudio"),'</div><button id="needselaudio" class="btn btn-primary">').concat(Xl.getMessage("TAudio"),"</button><div><strong>").concat(Xl.getMessage("ThlsGoToMergeAV"),'<a href="').concat(t,'" target="_blank">').concat(t,"</a></strong></div>");var r=document.createElement("div");r.innerHTML=e,i.videoUI.appendAudioListItems(r),document.getElementById("needselaudio").addEventListener("click",(function(){var t=function(t,e){var i=window.location.href,r=i.split("?")[1],s=i.split("?")[0];if(r){var n=new URLSearchParams(r);n.set(t,e),s+="?"+n.toString()}else s+="?"+t+"="+e;return s}("selaudio","true");window.location.href=t}))}))}},{key:"getAES",value:function(){var t=this;this.ajax({type:"file",url:this.aesConf.uri,success:function(){var i=s(e().mark((function i(r){return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Y(r);case 2:r=e.sent,t.aesConf.key=r,t.aesConf.decryptor=new pt,t.aesConf.decryptor.expandKey(t.aesConf.key),t.downloadTS();case 7:case"end":return e.stop()}}),i)})));return function(t){return i.apply(this,arguments)}}(),fail:function(){t.alertError(Xl.getMessage("TErrorNoVideo"))}})}},{key:"aesDecrypt",value:function(t,e){var i=this.aesConf.iv||new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,e]);return this.aesConf.decryptor.decrypt(t,0,i.buffer||i,!0)}},{key:"adjustMaxThread",value:function(){var t=s(e().mark((function t(){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(new URL(document.location.href).pathname.indexOf("hls.vhtml")<0)){t.next=6;break}return t.next=4,this.getMyOptOption();case 4:t.sent.counter>50&&!this.tryingProSpeed&&(this.maxThread=1);case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"downloadTS",value:function(){var t=s(e().mark((function t(){var i,r,n,a,o,l=this;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=0,r=function(t){l.adjustMaxThread();var r=l.isPause,n=l.downloadIndex;if(!(n>=l.rangeDownload.endSegment))if(l.downloadIndex++,i++,l.finishList[n]&&""===l.finishList[n].status){var a;l.finishList[n].status="downloading";var o={url:l.tsUrlList[n],type:"file",success:function(){var a=s(e().mark((function a(o){var h;return e().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Y(o);case 2:h=a.sent,l.dealTS(h,n,s(e().mark((function s(){var a,h;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.fileSize+=l.finishList[n].byteLength,l.downDuration+=l.finishList[n].duration,a={max:l.rangeDownload.targetSegment,value:l.finishNum},h={fds:{fileSize:ll(l.fileSize),downDuration:l.downDuration,segmentsDl:"".concat(l.finishNum,"/").concat(l.rangeDownload.targetSegment)},progress:a},l.videoUI.update_videoProgress(h),URL.revokeObjectURL(o),e.next=8,hl(l.normalDelay);case 8:return e.next=10,l.limitDlSpeed();case 10:if(!l.isLive){e.next=13;break}return e.next=13,l.limitDuration();case 13:i--,l.downloadIndex<l.rangeDownload.endSegment&&!r&&t();case 15:case"end":return e.stop()}}),s)}))));case 4:case"end":return a.stop()}}),a)})));return function(t){return a.apply(this,arguments)}}(),fail:function(e){i--,l.errorNum++,!l.isLive&&l.showSegmentsFailDlInfo(),l.finishList[n].status="error",l.downloadIndex<l.rangeDownload.endSegment&&!r&&t()}};if(null!==(a=l.finishList[n].segmentInfo)&&void 0!==a&&a.range){var h=l.finishList[n].segmentInfo.range;o.range=h}l.ajax(o)}else l.downloadIndex<l.rangeDownload.endSegment&&(i--,!r&&t())},n=function t(){i<l.maxThread&&!l.isPause&&r((function(){t()}))},a=function(){for(var t=0;t<l.maxThread-i;t++)n()},this.threadCtlIntervalIdleId=setInterval(a,2e3),t.next=7,this.adjustMaxThread();case 7:for(o=0;o<Math.min(this.maxThread,this.rangeDownload.targetSegment-this.finishNum);o++)n();case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"showSegmentsFailDlInfo",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=document.getElementById("failDlInfoContainer");r&&r.parentNode.removeChild(r);var s=document.getElementById("switchToRecBtnContainerParent");if(s&&s.parentNode.removeChild(s),!e){var n=document.createElement("span");n.setAttribute("id","failDlInfoContainer");var a=Xl.getMessage("ThlsSegmentsDlFaile",this.errorNum.toString()),o='(<a href="javascript:void(0)" class="retry"><i>'.concat(a,"</i></a>)");if(n.innerHTML=o,n.querySelector(".retry").addEventListener("click",(function(){t.retryAll(!0)})),this.videoUI.segmentsDl.parentNode.appendChild(n),this.errorNum>5||i){var l=document.getElementById("switchToRecBtnContainer").innerHTML,h=document.createElement("div");h.setAttribute("id","switchToRecBtnContainerParent"),h.innerHTML=l,h.querySelector(".switchToRecBtn").addEventListener("click",(function(){document.getElementById("confirm-switch").click()})),this.videoUI.segmentsDl.parentNode.appendChild(h)}}}},{key:"limitDuration",value:(p=s(e().mark((function t(){var i,r,n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=!1,new URL(document.location.href).pathname.indexOf("hls.vhtml")>0&&(i=!0),!i&&!this.pauseDlLive){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,tt();case 7:r=t.sent,(!(n=r.durationMax)||n>7200)&&(n=7200),this.downDuration>n&&(this.pauseDlLive=!0,this.pauseSelf(Xl.getMessage("ThlsLiveDurationLimit")),a="",o=Xl.getMessage("ThlsLiveDurationLimit"),l=void 0,document.querySelector("#msgModal .modal-title").textContent=a,document.querySelector("#msgModal .modal-body").innerHTML=o,document.getElementById("msgModalBtn").click(),l&&setTimeout((function(){msgModal.style.display="none"}),1e3*l),document.querySelectorAll(".up2pro-btn").forEach(function(){var t=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.t0="",t.next=3,at();case 3:t.t1=t.sent,i.href=t.t0.concat.call(t.t0,t.t1,"/member/checkout/"),i.setAttribute("target","_blank"),i.classList.add("text-wite");case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 12:case"end":return t.stop()}var a,o,l}),t,this)}))),function(){return p.apply(this,arguments)})},{key:"limitDlSpeed",value:(f=s(e().mark((function t(){var i,r,s,n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getMyOptOption();case 2:if(!((i=t.sent).counter>50)){t.next=22;break}if(!(new URL(document.location.href).pathname.indexOf("hls.vhtml")<0)){t.next=22;break}return r=!1,t.next=9,ql();case 9:if(s=t.sent)try{"1"==s.okTotry&&(r=!0)}catch(t){}if(r){t.next=21;break}return this.changeProgressUi("add"),i.waittime||(i.waittime=1e3),i.waittime<1e3&&(i.waittime=1e3),n=Math.floor(Math.random()*(1e4-i.waittime+1))+i.waittime,t.next=18,hl(n);case 18:setTimeout(this.showDlSpeedTooSlow,6e4),t.next=22;break;case 21:this.changeProgressUi("remove");case 22:case"end":return t.stop()}}),t,this)}))),function(){return f.apply(this,arguments)})},{key:"changeProgressUi",value:function(t){for(var e=document.getElementsByClassName("html5-progress-bar"),i=0;i<e.length;++i){var r=e[i];"add"==t?r.classList.add("html5-progress-bar-slow"):r.classList.remove("html5-progress-bar-slow")}}},{key:"showDlSpeedTooSlow",value:(u=s(e().mark((function t(){var i,r;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ql();case 2:if("1"!=(null==(i=t.sent)?void 0:i.okTotry)){t.next=5;break}return t.abrupt("return");case 5:if(!(Math.random()<.3)){t.next=8;break}return t.abrupt("return");case 8:(r=document.getElementById("dlSpeedNotice"))&&(r.style.display="block");case 10:case"end":return t.stop()}}),t)}))),function(){return u.apply(this,arguments)})},{key:"updateSpeedoUi",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{var i=document.getElementById("trySpeedo"),r=document.getElementById("triedSpeedo"),s=document.getElementById("tringSpeedo");switch(t.tried){case"0":r.style.display="none",i.style.display="inline";break;case"1":i.style.display="none"}e&&(r.style.display="inline"),"1"==t.okTotry?s.style.display="inline":s.style.display="none"}catch(t){}}},{key:"initTryProSpeed",value:(c=s(e().mark((function t(){var i,r,n,a=this,o=this;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=function(){var t={okTotry:"0",tried:"1"};Zl(t),a.updateSpeedoUi(t,!0),a.tryingProSpeed=!1,a.maxThread=1},t.next=3,ql();case 3:"1"==(r=t.sent).okTotry&&i(),this.updateSpeedoUi(r),(n=document.getElementById("trySpeedo"))&&(n.onclick=s(e().mark((function t(){var r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,ql();case 2:r=t.sent;try{"0"==r.tried?(Zl(s={okTotry:"1",tried:"1"}),o.updateSpeedoUi(s),o.tryingProSpeed=!0,o.maxThread=o.maxThreadDefault,setTimeout(i,6e4)):(r.okTotry="0",o.updateSpeedoUi(r,!0))}catch(t){}case 4:case"end":return t.stop()}}),t)}))));case 8:case"end":return t.stop()}}),t,this)}))),function(){return c.apply(this,arguments)})},{key:"dealTS",value:(d=s(e().mark((function t(i,r,s){var n,a,o;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.prev=0,n=this.aesConf.uri?this.aesDecrypt(i,r):i,t.next=10;break;case 4:return t.prev=4,t.t0=t.catch(0),this.errorNum++,this.finishList[r].status="error",!this.isLive&&this.showSegmentsFailDlInfo(!1,!0),t.abrupt("return");case 10:if((a=this.finishList[r]).initSegment&&(n=this.addInitSegmentData(n,a.initSegment)),this.finishList[r].status="finish",this.finishNum++,!this.needDlMP4){t.next=27;break}if(!this.mapTag()){t.next=19;break}t.t1=n,t.next=22;break;case 19:return t.next=21,this.conversionMp4(n,r,!0);case 21:t.t1=t.sent;case 22:o=t.t1,this.mediaFileList[r-this.rangeDownload.startSegment+1]=o,this.finishList[r].byteLength=o.byteLength,t.next=29;break;case 27:this.mediaFileList[r-this.rangeDownload.startSegment+1]=n,this.finishList[r].byteLength=n.byteLength;case 29:this.streamWriter&&this.streamDownload(),this.finishNum!==this.rangeDownload.targetSegment||this.isLive||this.videoUI.terminate(),s&&s();case 32:case"end":return t.stop()}}),t,this,[[0,4]])}))),function(t,e,i){return d.apply(this,arguments)})},{key:"streamDownload",value:function(){var t=this;if(this.isStreamDownloadRunning)this.streamDownloadQueue.push(!0);else{this.isStreamDownloadRunning=!0;var e=function(){t.streamDownloadQueue.length>0?(t.streamDownloadQueue.shift(),t.streamDownload()):t.isStreamDownloadRunning=!1};if(this.streamWriter){for(var i=this.streamDownloadIndex;i<this.mediaFileList.length&&this.mediaFileList[i];i++)this.streamWriter.write(new Uint8Array(this.mediaFileList[i])),this.mediaFileList[i]=null,this.streamDownloadIndex=i+1;this.streamDownloadIndex>=this.rangeDownload.targetSegment&&!this.isLive?setTimeout((function(){t.streamWriter.close(),t.streamWriter=null}),1e3):e()}else e()}}},{key:"togglePause",value:function(){var t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.isPause?null===(t=this.videoUI)||void 0===t||t.pause(e):(this.retryAll(!0),this.videoUI.start())}},{key:"retryAll",value:function(t){if(this.showSegmentsFailDlInfo(!0),this.finishList.length&&!this.isPause){var e=this.downloadIndex;this.finishList.forEach((function(t,i){"error"===t.status&&(t.status="",e=Math.min(e,i))})),this.errorNum=0,this.downloadIndex>=this.rangeDownload.endSegment||t?(this.downloadIndex=e,this.downloadTS()):this.downloadIndex=e}}},{key:"buildWholeMp4",value:(h=s(e().mark((function t(){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.mediaFileList.length){t.next=3;break}return alert(Xl.getMessage("TnoResource")),t.abrupt("return");case 3:case"end":return t.stop()}}),t,this)}))),function(){return h.apply(this,arguments)})},{key:"getFileName4dl",value:function(){var t=(this.mapTag()?this.mapTag():this.tsUrlList[0]).split("/").pop();t=(t=(t=t.split("?").shift()).split(".").pop())||"ts",t=this.needDlMP4?"mp4":t;var e=El(this.title)||this.formatTime(this.beginTime,"YYYY_MM_DD hh_mm_ss");return e=(e=bl(e))+"."+t}},{key:"downloadFile",value:(l=s(e().mark((function t(){var i,r,s,n;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.videoUI.isCaptureMode){t.next=3;break}return this.downloadCaptureMedia(null,!0),t.abrupt("return");case 3:if(this.mediaFileList.length){t.next=6;break}return alert(Xl.getMessage("TnoResource")),t.abrupt("return");case 6:if(i=this.getFileName4dl(),r=null,!this.needDlMP4||this.mapTag()){t.next=24;break}return t.next=11,this.buildWholeMp4();case 11:if(r=new Blob(this.mediaFileList,{type:"video/mp4"}),!((document.getElementById("uiVersion")?parseInt(document.getElementById("uiVersion").textContent):0)>174)){t.next=21;break}return t.next=16,dl(r);case 16:s=t.sent,n={fileName:i,ffmpegaction:"dlFixedMp4",fileBuffer:s},window.postMessage(n,location.href,[s]),t.next=22;break;case 21:yl(r,i);case 22:t.next=26;break;case 24:yl(r=new Blob(this.mediaFileList,{type:"video/MP2T"}),i);case 26:case"end":return t.stop()}}),t,this)}))),function(){return l.apply(this,arguments)})},{key:"formatTime",value:function(t,e){var i={Y:t.getFullYear(),M:t.getMonth()+1,D:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()};return e.replace(/Y+|M+|D+|h+|m+|s+/g,(function(t){return(new Array(t.length).join("0")+i[t[0]]).substr(-t.length)}))}},{key:"forceDownload",value:function(){this.downloadFile()}},{key:"send2GDrive",value:(o=s(e().mark((function t(){var i,r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.mediaFileList.length){t.next=3;break}return alert(Xl.getMessage("TnoResource")),t.abrupt("return");case 3:return i=null,i=this.needDlMP4?new Blob(this.mediaFileList,{type:"video/mp4"}):new Blob(this.mediaFileList,{type:"video/MP2T"}),t.next=7,dl(i);case 7:r=t.sent,s=this.getFileName4dl(),window.postMessage({type:"webResVideoFile",videoFile:r,fileName:s},location.href,[r]);case 10:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})},{key:"updateLiveSegment",value:function(t){t.advanced&&(!function(t,e,i,r,s){for(var n=new Set(e.map((function(t){return t.sn}))),a=0;a<t.length;a++){var o=t[a];if(!n.has(o.sn)){var l=o.url,h=o.duration,d=o.relurl;i.push(l),r.push({title:d,status:"",duration:h});var c=i.length-1;e.push({sn:o.sn,index:c}),n.add(o.sn)}}}(t.fragments,this.liveSegments,this.tsUrlList,this.finishList,this.url),this.setStartEnd(),this.pauseDlLive||this.retryAll(!0))}},{key:"uiCmdsHandler",value:function(t){var e=this;switch(t.cmd){case Al:break;case xl:this.isPause=!0,this.togglePause();break;case kl:this.isPause=!1,this.togglePause();break;case Rl:this.downloadFile();break;case Dl:this.send2GDrive();break;case Il:this.downloadCaptureMedia(t.params);break;case Cl:this.downloadCaptureMedia(null,!1,!0);break;case Ul:this.selfDestroy();break;case Pl:this.deleteOneCaptureMime(t.params.mime);break;case Ml:this.initStreamDownload();break;case Fl:this.isLive||this.pauseSelf(),setTimeout((function(){e.streamWriter.close(),e.streamWriter=null}),1e3)}}},{key:"updateCaptureMediaList",value:(a=s(e().mark((function t(i){var r,s,n=this;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.terminateCapture){t.next=2;break}return t.abrupt("return");case 2:if(this.captureMediaList.hasOwnProperty(i.mime)||(this.captureMediaList[i.mime]=new j,this.captureMediaList[i.mime].fileSize=0,this.videoUI.appendOneMediaUI(i.mime),this.mp4Demuxers[i.mime]=new Vl({onChunk:function(t){},isDetector:!0,onDetect:function(t){n.captureMediaList[i.mime].detectInfo=t}})),!this.captureMediaList[i.mime].del){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,Y(i.blobUrl);case 7:r=t.sent,this.captureMediaList[i.mime].push(r,i.fragmentIndex),this.captureMediaList[i.mime].fileSize+=r.byteLength,s={fds:{fileSize:ll(this.captureMediaList[i.mime].fileSize)},mime:i.mime},this.videoUI.update_videoProgress(s),this.limitCaptureDuration(this.captureMediaList[i.mime].fileSize),this.captureMediaList[i.mime].detectInfo||this.mp4Demuxers[i.mime].appendBuffer(r);case 14:case"end":return t.stop()}}),t,this)}))),function(t){return a.apply(this,arguments)})},{key:"limitCaptureDuration",value:(n=s(e().mark((function t(i){var r,s;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(new URL(document.location.href).pathname.indexOf("hls.vhtml")<0)){t.next=14;break}return t.next=4,this.getMyOptOption();case 4:if(r=t.sent,s=i/1048576,!(r.rcounterr>30)){t.next=14;break}if(r.reclsize>100&&(r.reclsize=100),!(s>=r.reclsize)){t.next=14;break}return this.videoUI.terminate(),this.videoUI.maxRecTimeLimit.style.display="block",document.title="! Maximum recording time limit has been reached",this.terminateCapture=!0,t.abrupt("return");case 14:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})},{key:"deleteOneCaptureMime",value:(r=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.captureMediaList.hasOwnProperty(i)){t.next=2;break}return t.abrupt("return");case 2:this.captureMediaList[i].del=!0;case 3:case"end":return t.stop()}}),t,this)}))),function(t){return r.apply(this,arguments)})},{key:"downloadCaptureMedia",value:(i=s(e().mark((function t(i){var r,s,n,a,o,l,h,d,c,u,f,p,m,g,y,v=this,_=arguments;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=_.length>1&&void 0!==_[1]&&_[1],s=_.length>2&&void 0!==_[2]&&_[2],Object.keys(this.captureMediaList).length){t.next=5;break}return alert(Xl.getMessage("TnoResource")),t.abrupt("return");case 5:if(n=bl(n=El(this.title)||this.formatTime(this.beginTime,"YYYY_MM_DD hh_mm_ss")),a=function(t){if(v.captureMediaList.hasOwnProperty(t)&&!v.captureMediaList[t].del){var e,i=v.captureMediaList[t].toArray(),r=t.split(";")[0],s=r.split("/")[1],a=new Blob(i,{type:r});e=t.indexOf("video")>-1?"video":t.indexOf("audio")>-1?"audio":"unknown_media_type",yl(a,(n="".concat(n,"_").concat(e))+"."+s)}else alert(Xl.getMessage("TnoResource"))},!r){t.next=39;break}o=Kl(this.captureMediaList),l={fileName:n,ffmpegaction:"merge"},h=0;case 12:if(!(h<o.length)){t.next=37;break}if(d=o[h].item.toArray(),c=o[h].key,!((u=c.split(";")[0]).indexOf("video")>-1)){t.next=25;break}return f=new Blob(d,{type:c}),t.next=20,dl(f);case 20:p=t.sent,l.videoFile=p,l.videoMime=c,t.next=32;break;case 25:if(!(u.indexOf("audio")>-1)){t.next=32;break}return m=new Blob(d,{type:c}),t.next=29,dl(m);case 29:g=t.sent,l.audioFile=g,l.audioMime=c;case 32:if(!l.hasOwnProperty("videoFile")||!l.hasOwnProperty("audioFile")){t.next=34;break}return t.abrupt("break",37);case 34:h++,t.next=12;break;case 37:return l.hasOwnProperty("videoFile")?l.hasOwnProperty("audioFile")?window.postMessage(l,location.href,[l.videoFile,l.audioFile]):a(l.videoMime):a(l.audioMime),t.abrupt("return");case 39:if(!s){t.next=42;break}for(y in this.captureMediaList)a(y);return t.abrupt("return");case 42:i.mimeInfo&&a(i.mimeInfo);case 43:case"end":return t.stop()}}),t,this)}))),function(t){return i.apply(this,arguments)})},{key:"sendMsg2Page",value:function(t){window.postMessage(t,location.href)}},{key:"onEvt",value:function(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}},{key:"off",value:function(t,e){this.events[t]&&(this.events[t]=this.events[t].filter((function(t){return t!==e})))}},{key:"emit",value:function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this.events[t]&&this.events[t].forEach((function(t){return t.apply(void 0,i)}))}},{key:"selfDestroy",value:function(){var t;this.threadCtlIntervalIdleId&&clearInterval(this.threadCtlIntervalIdleId),this.hls&&this.hls.loader&&this.hls.loader.abort(),this.streamWriter&&(this.streamWriter.close(),this.streamWriter=null),this.videoUI&&this.videoUI.terminate(),this.mediaFileList=[],this.captureMediaList={},this.isPause=!1,this.downloading=!1,this.beginTime="",this.errorNum=0,this.finishNum=0,this.downloadIndex=0,this.finishList=[],this.tsUrlList=[],this.liveSegments=[],(null===(t=this.transmuxer)||void 0===t?void 0:t.off)&&this.transmuxer.off("data"),this.transmuxer=void 0,document.getElementById("videos").removeChild(this.videoUI.container),this.videoUI=null,this.emit("selfDestroy"),this.mp4Demuxers=[]}}]),t}();function Jl(t){t=t.split("\n");var e="#EXTM3U\n";for(var i in e+="#EXT-X-TARGETDURATION:10\n",t)t[i]&&(e+="#EXTINF:1\n",e+=t[i]+"\n");return e+="#EXT-X-ENDLIST"}s(e().mark((function t(){var i,r,n,a,o,l,h,d,c=function(){var t=s(e().mark((function t(i,s){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:try{ft.getTabById(i).then((function(t){(a=t.m3u8dlPageTabs[s]).videoPageTitle=t.videoPageTitle,$l(t.id,s),o(a.m3u8Data,i)}))}catch(t){alert(r.getMessage("TbgTryLater"))}case 1:case"end":return t.stop()}}),t)})));return function(e,i){return t.apply(this,arguments)}}(),u=function(){var t=s(e().mark((function t(){var i,s,n,a,o,l,h;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=new URL(location.href).searchParams,!(s=parseInt(i.get("mpdtid")))){t.next=5;break}return p(s),t.abrupt("return");case 5:return t.next=7,R(y.GET_parentVideoPageTabId);case 7:n=t.sent,a=n.videoTabId,o=n.m3u8dlPageTabId,a?c(a,o):(l=document.getElementById("loadingNotice"),(h=document.createElement("p")).innerHTML="<strong style='color: red; font-weight: bold;'>".concat(r.getMessage("Tm3u8ErrInParseM3u8"),". ").concat(r.getMessage("ThlsCloseVideoPageRetry"),"</strong>"),l.parentNode.insertBefore(h,l.nextSibling));case 11:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),p=function(){var t=s(e().mark((function t(i){var r,s,a,o,l,h;return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,R(y.GET_MPD_M3U8_TEXT,{mpdtid:i});case 2:r=t.sent,s=Jl(r.m3u8Content),a=URL.createObjectURL(new Blob([new TextEncoder("utf-8").encode(s)])),(o=new Ql).onEvt("selfDestroy",(function(t){o=null;var e=n.indexOf(o);-1!==e&&n.splice(e,1)})),n.push(o),o.url=a,l=new Date,h=l.toISOString(),o.title="".concat(h,"_").concat(r.mediaType),o.getMP4();case 13:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}();return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return d=function(){n.forEach((function(t){t.pauseSelf()}))},h=function(){document.getElementById("dlHlsInfo").style.display="block"},l=function(){var t;(i=new Ql("capture")).title=(null===(t=a.m3u8Data)||void 0===t?void 0:t.fileName)||(0,ol.tZ)(a.videoPageTitle)||"capture",i.onEvt("selfDestroy",(function(t){i=null})),d()},o=function(t,e){var i=new Ql;i.onEvt("selfDestroy",(function(t){i=null;var e=n.indexOf(i);-1!==e&&n.splice(e,1)})),n.push(i),t&&t.m3u8Url?(i.url=t.m3u8Url,i.title=t.fileName,i.videoPageInfo=ol.mu[e],i.requestHeaders=t.requestHeaders,i.initiator=t.initiator,i.getMP4()):h()},t.next=7,Wl();case 7:if(t.sent){t.next=9;break}return t.abrupt("return");case 9:r=chrome.i18n,n=[],document.addEventListener("DOMContentLoaded",(function(){u()})),v(y.SEND_ONE_BUFFER_TO_DLPAGE,function(){var t=s(e().mark((function t(r){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i&&i.updateCaptureMediaList(r);case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),v(f,function(){var t=s(e().mark((function t(i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:t.t0=i.type,t.next=t.t0===y.CAPTURE_STARTED?3:5;break;case 3:return l(),t.abrupt("break",6);case 5:return t.abrupt("break",6);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),v(y.CAPTURE_DONE,function(){var t=s(e().mark((function t(r){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i.videoUI.terminate();case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),v(y.CAPTURE_ABORT,function(){var t=s(e().mark((function t(r){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i.videoUI.terminate();case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),window.addEventListener("message",(function(t){if(t.source==window&&t.data&&t.data.ffmpegbackcall)switch(t.data.ffmpegbackcall){case"ffmpeg_loade":try{i.videoUI.ffmpegLoade()}catch(t){}break;case"ffmpeg_error":try{i.videoUI.ffmpegError(t.data.msgContent)}catch(t){}}}),!1);case 17:case"end":return t.stop()}}),t)})))()})()})();